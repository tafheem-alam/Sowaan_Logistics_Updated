[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 1,
  "modified": "2024-05-29 17:08:48.663412",
  "module": null,
  "name": "Sales Inquiry",
  "script": "frappe.ui.form.on(\"Opportunity\", {\n    refresh: function(frm) {\n        // Add your custom button\n        frm.add_custom_button(\n            __(\"Sales Inquiry\"),\n            function() {\n               \n                createSalesInquiry(frm.doc);\n                \n            },\n            __(\"Create\")\n        );\n    }\n});\n\nfunction createSalesInquiry(opportunity) {\n    console.log(\"Creating Sales Inquiry with Opportunity:\", opportunity);\n\n    frappe.model.with_doctype('Sales Inquiry', function() {\n        var salesInquiry = frappe.model.get_new_doc('Sales Inquiry');\n        \n        console.log(\"New Sales Inquiry:\", salesInquiry);\n\n        // Populate Sales Inquiry fields with data from Opportunity\n        // salesInquiry.customer = opportunity.customer;\n        // salesInquiry.contact_person = opportunity.contact_person;\n        // Add more fields as needed\n        salesInquiry.opportunity = opportunity.name;\n        salesInquiry.project = opportunity.custom_project;\n        // Copy child table items from Opportunity to Sales Inquiry\n        opportunity.items.map(function(item) {\n            var row = frappe.model.add_child(\n                salesInquiry,\n                \"Sales Inquiry Item\",\n                \"items\"\n              );\n        \n            \n\n            // Map fields from Opportunity Item to Sales Inquiry Item\n            row.item_code = item.item_code;\n            row.qty = item.qty;\n            row.uom = item.uom;\n            row.item_name = item.item_name;\n            row.brand = item.brand;\n            row.item_group = item.item_group;\n            row.custom_sample_status = item.custom_sample_status;\n            row.custom_pq_status = item.custom_pq_status;\n            row.custom_ms_status = item.custom_ms_status;\n            row.base_rate = item.base_rate;\n            row.base_amount = item.base_amount;\n            row.rate = item.rate;\n            item.amount= row.rate*row.qty;// Calculate amount for each item\n            \n            row.description = item.description;\n        });\n        // refresh_field('amount');\n       \n        console.log(\"Sales Inquiry with Items:\", salesInquiry);\n\n        // Open the Sales Inquiry in a new tab without saving\n        frappe.set_route('Form', 'Sales Inquiry', salesInquiry.name);\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Inquiry",
  "enabled": 0,
  "modified": "2024-08-23 10:09:50.773001",
  "module": null,
  "name": "Sales Inquiry Items Sum",
  "script": "frappe.ui.form.on('Sales Inquiry', {\n   \n});\nfrappe.ui.form.on('Opportunity Item', {\n    rate: function(frm, cdt, cdn) {\n        var total=0;\n        var item = locals[cdt][cdn];\n        total= item.qty * item.rate;\n        frappe.model.set_value(item.doctype,item.name,'amount',total);\n        frappe.model.set_value(item.doctype,item.name,'base_rate',item.rate);\n        frappe.model.set_value(item.doctype,item.name,'base_amount',total);\n        updateTotalValues(frm);\n        \n        \n        \n    },\n     qty: function(frm, cdt, cdn) {\n        var total=0;\n        var item = locals[cdt][cdn];\n        total= item.qty * item.rate;\n        frappe.model.set_value(item.doctype,item.name,'amount',total);\n        frappe.model.set_value(item.doctype,item.name,'base_rate',item.rate);\n        frappe.model.set_value(item.doctype,item.name,'base_amount',total);\n        updateTotalValues(frm);\n        \n    },\n    items_remove: function(frm, cdt, cdn) {\n       updateTotalValues(frm);\n        \n    }\n    \n    \n});\nfunction updateTotalValues(frm) {\n    var total_qty = 0;\n    var total_amount = 0;\n    var items = frm.doc.items || [];\n\n    // Calculate total quantity and total amount for all items\n    for (var i = 0; i < items.length; i++) {\n        var item = items[i];\n        total_qty += flt(item.qty);\n        total_amount += flt(item.amount);\n    }\n\n    // Set total quantity and total amount in the Opportunity form\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_quantity', total_qty);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_amount', total_amount);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Inquiry",
  "enabled": 0,
  "modified": "2024-08-23 09:55:56.745769",
  "module": null,
  "name": "Quotation",
  "script": "frappe.ui.form.on(\"Sales Inquiry\", {\n    refresh: function(frm) {\n        // Add your custom button\n        if((frm.doc.workflow_state == \"Approved for Quotation\") || (frm.doc.workflow_state == \"QTN Pending\"))\n        {\n            frm.add_custom_button(\n            __(\"Sales Quotation\"),\n            function() {\n                // Define the action for the Sales Inquiry button\n                createQuotation(frm.doc);\n            },\n            __(\"Create\")\n     \n        );}\n    }\n});\nfunction createQuotation(salesInquiry) {\n    console.log(\"Creating Quotation from Sales Inquiry:\", salesInquiry);\n\n    frappe.model.with_doctype('Quotation', function() {\n        var quotation = frappe.model.get_new_doc('Quotation');\n\n        // Set fields in the Quotation document\n        quotation.custom_refrence = salesInquiry.name;\n        quotation.party_name = salesInquiry.customer;\n        quotation.opportunity = salesInquiry.opportunity;\n\n        // Copy items from Sales Inquiry to Quotation\n        \n        salesInquiry.items.map(function(item) {\n            var row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n            row.item_code = item.item_code;\n            row.qty = item.qty;\n            row.uom = item.uom;\n            row.item_name = item.item_name;\n            row.brand = item.brand;\n            row.item_group = item.item_group;\n            row.rate = item.rate;\n            row.amount = item.amount;\n            row.description = item.description;\n        });\n\n        // Calculate total amount\n        quotation.total_amount = quotation.items.reduce(function(acc, item) {\n            return acc + item.amount;\n        }, 0);\n\n        console.log(\"Quotation with Items:\", quotation);\n\n        // Open the Quotation in a new tab without saving\n        frappe.set_route('Form', 'Quotation', quotation.name);\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 0,
  "modified": "2024-07-11 16:40:33.552444",
  "module": null,
  "name": "Fetch item price list",
  "script": "frappe.ui.form.on('Quotation Item', 'item_code', function(frm, cdt, cdn) {\r\n    var child = locals[cdt][cdn];\r\n    frappe.call({\r\n        method: \"frappe.client.get_list\",\r\n        args: {\r\n            doctype: \"Item Price\",\r\n            filters: {\r\n                // \"selling\": true,\r\n                \"item_code\": child.item_code,\r\n            }\r\n        },\r\n        callback: function(r) {\r\n            frm.set_value('custom_item_price_list', []);\r\n            if (r && r.message && r.message.length > 0) {\r\n                // console.log(r)\r\n                var len = r.message.length;\r\n                var doc_names = r.message.map(function(item) {\r\n                    return item.name;\r\n                });\r\n                \r\n                for (var j = 0; j < len; j++) {\r\n                    (function(j) {\r\n                        var doc_name = doc_names[j];\r\n                        frappe.db.get_doc(\"Item Price\", doc_name).then(function(x) {\r\n                            var add = cur_frm.add_child(\"custom_item_price_list\");\r\n                            add.item = x.item_code;\r\n                            add.item_name = x.item_name;\r\n                            add.price_list = x.price_list;\r\n                            add.rate = x.price_list_rate;\r\n                            add.posting_date = x.valid_from\r\n                            cur_frm.refresh_fields(\"custom_item_price_list\");\r\n                        });\r\n                    })(j);\r\n                }\r\n            }\r\n        }\r\n    });\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2024-07-11 16:20:17.034330",
  "module": null,
  "name": "Lead in Quotation",
  "script": "\n\nfrappe.ui.form.on('Quotation', {\n\trefresh(frm) {\n\n\t\t\n\t},\n\t\n\tquotation_to: async function(frm) {\n        \n        if (frm.doc.quotation_to == 'Lead' )\n        {\n            if( frm.doc.custom_refrence )\n            {\n                var s_inq_doc = await frappe.db.get_doc('Sales Inquiry',frm.doc.custom_refrence);\n                frm.set_value(\"party_name\",s_inq_doc.lead);\n            }\n        }\n        else\n        {\n            if ( frm.doc.party_name )\n            {\n                frm.set_value(\"party_name\",'');    \n            }\n        }\n\t},\n\t\n\t\n\tcustom_reference : async function(frm) {\n\t    if ( frm.doc.quotation_to == 'Lead' )\n\t    {\n                if ( frm.doc.custom_refrence ) \n                {\n                    var s_inq_doc = await frappe.db.get_doc('Sales Inquiry',frm.doc.custom_refrence);\n                    frm.set_value(\"party_name\",s_inq_doc.lead);   \n                }\n            \n        }\n        else\n        {\n                if ( frm.doc.party_name )\n                {\n                    frm.set_value(\"party_name\",'');    \n                }\n            \n        }\n\t},\n\t\n});\n\t",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pricing Sheet",
  "enabled": 1,
  "modified": "2024-09-26 11:19:41.115495",
  "module": null,
  "name": "Hide Add Row Button In Costing Factor Table",
  "script": "frappe.ui.form.on('Pricing Sheet', {\n    refresh: function(frm) {\n      // Hide the button with the specified HTML structure\n        $('button.btn.btn-xs.btn-secondary.grid-add-row').eq(0).hide();\n        $('button.btn.btn-xs.btn-secondary.grid-add-row').eq(2).hide();\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Inquiry",
  "enabled": 0,
  "modified": "2024-08-23 09:56:22.516954",
  "module": null,
  "name": "Sales Inquiry To Costing Sheet",
  "script": "frappe.ui.form.on(\"Sales Inquiry\", {\n    refresh: function(frm) {\n        // Add your custom button\n        if(frm.doc.workflow_state == \"Started\"){\n        frm.add_custom_button(\n            __(\"Pricing Sheet\"),\n            function() {\n               \n                createCostingSheet(frm.doc);\n                \n            },\n            __(\"Create\")\n        );\n    }}\n});\n\nfunction createCostingSheet(salesInquiryDoc) {\n    frappe.model.with_doctype('Pricing Sheet', function() {\n        var costingSheet = frappe.model.get_new_doc('Pricing Sheet');\n        costingSheet.sales_inquiry = salesInquiryDoc.name;\n        costingSheet.project = salesInquiryDoc.project;\n        frappe.set_route('Form', 'Pricing Sheet', costingSheet.name);\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pricing Sheet",
  "enabled": 1,
  "modified": "2024-07-11 11:12:54.979762",
  "module": null,
  "name": "Costing Factor Table On Brand",
  "script": "frappe.ui.form.on('Pricing Sheet', {\n    brand: function(frm) {\n        var brand = frm.doc.brand;\n        if (brand) {\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Brand',\n                    name: brand\n                },\n                callback: function(response) {\n                    if (!response.exc) {\n                        var brand_doc = response.message;\n                        if (brand_doc && brand_doc.custom_costing_factors) {\n                            frm.clear_table('factor');\n                            // Iterate over custom_costing_factors\n                            brand_doc.custom_costing_factors.forEach(function(factor) {\n                                var row = frm.add_child('factor');\n                                row.factors = factor.factors;\n                                row.standard = factor.standard;\n                                row.a = factor.a;\n                                row.b = factor.b;\n                                row.c = factor.c;\n                                // Set other fields as needed\n                            });\n                            frm.refresh_field('factor');\n                        } else {\n                            console.log('Brand document or its custom_costing_factors not found.');\n                        }\n                    } else {\n                        console.error('Error fetching Brand document:', response.exc);\n                    }\n                }\n            });\n        }\n    },\n    \n    accessory: function(frm) {\n        var access = frm.doc.accessory;\n        if (access) {\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Accessories',\n                    name: access\n                },\n                callback: function(response) {\n                    if (!response.exc) {\n                        var brand_doc = response.message;\n                        if (brand_doc && brand_doc.factors) {\n                            frm.clear_table('accessories_factors');\n                            frm.clear_table('accessories_pricing');\n                            // Iterate over custom_costing_factors\n                            brand_doc.factors.forEach(function(factor) {\n                                var row = frm.add_child('accessories_factors');\n                                row.factors = factor.factors;\n                                row.standard = factor.standard;\n                                row.a = factor.a;\n                                row.b = factor.b;\n                                row.c = factor.c;\n                                // Set other fields as needed\n                            });\n                            frm.refresh_field('accessories_factors');\n                            \n                            \n                            brand_doc.accessories_pricing.forEach(function(factor) {\n                                var row = frm.add_child('accessories_pricing');\n                                row.item = factor.item;\n                                row.thickness = factor.thickness;\n                                row.description = factor.description;\n                                row.standard_cost__sqm = factor.standard_cost__sqm;\n                                row.standard_rate__sqm = factor.standard_rate__sqm;\n                                row.a_cost__sqm = factor.a_cost__sqm;\n                                row.a_rate__sqm = factor.a_rate__sqm;\n                                row.b_cost__sqm = factor.b_cost__sqm;\n                                row.b_rate__sqm = factor.b_rate__sqm;\n                                row.c_cost__sqm = factor.c_cost__sqm;\n                                row.c_rate__sqm = factor.c_rate__sqm;\n                                // Set other fields as needed\n                            });\n                            frm.refresh_field('accessories_pricing');\n                            \n                            \n                            \n                            \n                            \n                            \n                        } else {\n                            console.log('Brand document or its custom_costing_factors not found.');\n                        }\n                    } else {\n                        console.error('Error fetching Brand document:', response.exc);\n                    }\n                }\n            });\n        }\n    },\n    \n    \n    \n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event",
  "enabled": 1,
  "modified": "2024-07-08 18:32:28.095981",
  "module": null,
  "name": "Capture Meeting Date",
  "script": "frappe.ui.form.on('Event', {\n\trefresh(frm) {\n\t   // if(!frm.doc.__unsaved) frm.set_df_property(\"custom_start_on\", \"reqd\", 1);\n\t    if (frm.doc.starts_on) {\n    \t    if (frm.doc.docstatus == 0) {\n        \t    if (!frm.doc.custom_start_on) {\n                    frm.add_custom_button(__(\"Start Meeting\"), function() {\n                        frm.set_value(\"custom_start_on\", frappe.datetime.now_datetime());\n                        frm.save();\n                    });   \n        \t    }\n        \t    \n        \t    if (!frm.doc.ends_on && frm.doc.custom_start_on) {\n                    frm.add_custom_button(__(\"End Meeting\"), function() {\n                        frm.set_value(\"ends_on\", frappe.datetime.now_datetime());\n                        frm.save();\n                    });   \n        \t    }\n    \t    }\n\t    }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Opportunity",
  "enabled": 0,
  "modified": "2024-11-05 13:14:46.174407",
  "module": null,
  "name": "Fetch Customer from Lead",
  "script": "frappe.ui.form.on('Opportunity', {\n\trefresh(frm) {\n\t    let doc = frm.doc;\n\t\tif (doc.opportunity_from == \"Lead\" && doc.party_name) {\n\t\t    frappe.call({\n                method: \"frappe.client.get\",\n                args: {\n                    doctype: doc.opportunity_from,\n                    name: doc.party_name,\n                },\n                callback(r) {\n                    if(r.message) {\n                        var lead = r.message;\n                        console.log(lead, \"checking lead\");\n                        frm.set_value(\"custom_customer\", lead.customer);\n                    }\n                },\n                freeze: true,\n            });\n\t\t}\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pricing Sheet",
  "enabled": 1,
  "modified": "2024-07-11 17:58:35.394076",
  "module": null,
  "name": "Costing Sheet To Quotation",
  "script": "frappe.ui.form.on(\"Pricing Sheet\", {\n    refresh: function(frm) {\n        // Check if the Costing Sheet is submitted\n        if (frm.doc.docstatus == 1) {\n            // Add custom button for Quotation\n            frm.add_custom_button(\n                __(\"Quotation\"),\n                function() {\n                    createQuotation(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n    }\n});\n\nfunction createQuotation(costingSheetDoc) {\n    frappe.model.with_doctype('Quotation', function() {\n        frappe.db.get_value('Sales Inquiry', costingSheetDoc.sales_inquiry, 'lead', function(response) {\n            if (response && response.lead) {\n                var quotation = frappe.model.get_new_doc('Quotation');\n                quotation.costing_sheet = costingSheetDoc.name;\n                quotation.quotation_to = \"Lead\";\n                quotation.valid_till = frappe.datetime.nowdate();\n                \n                \n                // Set other fields as needed from the Costing Sheet\n                // Example: quotation.customer = costingSheetDoc.customer;\n                costingSheetDoc.additional_factors.map(item => {\n                    var row = frappe.model.add_child(\n                    quotation,\n                    \"Quotation Item\",\n                    \"items\"\n                  );\n                    // Map fields from Opportunity Item to Sales Inquiry Item\n                    row.item_code = item.item;\n                    \n                    row.rate = item.target_rate;\n                    row.custom_target_ratee = 1;\n                    var v = item.item;\n                    frappe.db.get_value('Item', v, ['item_name', 'stock_uom','description'], function(response) {\n                            var item_name = response.item_name;\n                            var stock_uom = response.stock_uom;\n                            var description = response.description;\n                            row.item_name = item_name;\n                            row.uom = stock_uom;\n                            row.description = description;\n                            // Here you can use the fetched values as needed\n                            });\n                                            \n                });\n                \n                costingSheetDoc.accessory_fixing.map(item => {\n                    var row = frappe.model.add_child(\n                    quotation,\n                    \"Quotation Item\",\n                    \"items\"\n                  );\n                    // Map fields from Opportunity Item to Sales Inquiry Item\n                    row.item_code = item.item;\n                    \n                    row.rate = item.target_rate;\n                    row.custom_target_ratee = 1;\n                    var b = item.item;\n                    frappe.db.get_value('Item', b, ['item_name', 'stock_uom', 'stock_uom','description'], function(response) {\n                            var item_name = response.item_name;\n                            var stock_uom = response.stock_uom;\n                            var description = response.description;\n                            row.item_name = item_name;\n                            row.uom = stock_uom;\n                            row.description = description;\n                            // Here you can use the fetched values as needed\n                           });\n                    \n                });\n                \n                \n                \n                if(quotation.quotation_to == \"Lead\")\n                {quotation.party_name = response.lead;}\n                \n                frappe.set_route('Form', 'Quotation', quotation.name);\n            } else {\n                frappe.msgprint(\"Lead not found for the Sales Inquiry.\");\n                return;\n            }\n        });\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2024-07-11 17:43:46.545771",
  "module": null,
  "name": "Check Quotation",
  "script": "// Declare lead as a global variable\nlet lead = null;\nvar ratesArray = [];\nfrappe.ui.form.on('Quotation', {\n    refresh(frm) {\n        // console.log(frm.doc.party_name, \"Party Name\");\n        lead = frm.doc.party_name;  // Assign frm.doc.party_name to the global lead variable\n        // console.log(frm.doc);\n         // Iterate over each row in the items table\n        frm.doc.items.forEach(function(item, index) {\n\n            // Push the rate into the ratesArray\n            ratesArray.push(item.rate);\n        });\n    },\n\n    party_name(frm) {\n        // console.log(lead);\n        if (frm.doc.__unsaved == 1 && !frm.doc.party_name && lead) {\n            frm.set_value(\"party_name\", lead);  // Set party_name using the global lead variable\n        }\n    }\n    \n});\n\n\tfrappe.ui.form.on('Quotation Item', {\n\t    \n\t\n    rate: function(frm) {\n     \n       frm.doc.items.forEach(function(item, index) {\n            // Set the rate field in the current Quotation Item\n            if( item.custom_target_ratee == 1){\n            frappe.model.set_value(item.doctype, item.name, 'rate', ratesArray[index]);}\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier Quotation Comparison",
  "enabled": 0,
  "modified": "2024-07-12 15:16:54.202200",
  "module": null,
  "name": "Filter material request to only submitted records",
  "script": "frappe.ui.form.on('Supplier Quotation Comparison', {\n    refresh: function(frm) {\n        frm.fields_dict['material_request'].get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    docstatus: 1  // 1 means 'Submitted'\n                }\n            };\n        };\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2024-07-23 10:39:08.495221",
  "module": null,
  "name": "Work Order In Production",
  "script": "frappe.ui.form.on('Work Order', {\n    sales_order: function(frm) {\n        var sales_order = frm.doc.sales_order;\n        var item_name = frm.doc.item_name;\n\n        if (sales_order && item_name) {\n            frappe.model.with_doc(\"Sales Order\", sales_order, function() {\n                var sales_order_doc = frappe.get_doc(\"Sales Order\", sales_order);\n                \n                if (sales_order_doc && sales_order_doc.items) {\n                    var item_amount = 0;\n                    \n                    // Loop through Sales Order items to find matching item_name\n                    sales_order_doc.items.forEach(function(item) {\n                        if (item_name === item.item_name) { // Compare item_name with Sales Order item_name\n                            item_amount = item.amount;\n                            return false; // Exit loop early once item is found\n                        }\n                    });\n                    \n                    // Log or use item_amount as needed\n                    console.log(\"Amount for item \" + item_name + \": \" + item_amount);\n                    \n                    // Set value in the field in Work Order form\n                    frm.set_value('custom_work_order_in_production', item_amount);\n                } else {\n                    console.log(\"Sales Order not found or has no items.\");\n                }\n            });\n        }\n    },\n    before_save: function(frm) {\n        var sales_order = frm.doc.sales_order;\n        var item_name = frm.doc.item_name;\n\n        if (sales_order && item_name) {\n            frappe.model.with_doc(\"Sales Order\", sales_order, function() {\n                var sales_order_doc = frappe.get_doc(\"Sales Order\", sales_order);\n                \n                if (sales_order_doc && sales_order_doc.items) {\n                    var item_amount = 0;\n                    \n                    // Loop through Sales Order items to find matching item_name\n                    sales_order_doc.items.forEach(function(item) {\n                        if (item_name === item.item_name) { // Compare item_name with Sales Order item_name\n                            item_amount = item.amount;\n                            return false; // Exit loop early once item is found\n                        }\n                    });\n                    \n                    // Log or use item_amount as needed\n                    console.log(\"Amount for item \" + item_name + \": \" + item_amount);\n                    \n                    // Set value in the field in Work Order form\n                    frm.set_value('custom_work_order_in_production', item_amount);\n                } else {\n                    console.log(\"Sales Order not found or has no items.\");\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Supplier Quotation Comparison",
  "enabled": 0,
  "modified": "2024-07-29 10:08:25.558973",
  "module": null,
  "name": "Restrict material request only submitted records",
  "script": "// frappe.ui.form.on('Supplier Quotation Comparison', {\n//     material_request: function(frm) {\n//         frm.fields_dict['material_request'].get_query = function(doc, cdt, cdn) {\n//             return {\n//                 filters: {\n//                     docstatus: 1  // 1 means 'Submitted'\n//                 }\n//             };\n//         };\n//     }\n// });",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication List",
  "enabled": 0,
  "modified": "2024-07-31 11:28:23.951355",
  "module": null,
  "name": "Fabrication list to Sales Quotation",
  "script": "frappe.ui.form.on('Fabrication List', {\n    refresh: function(frm) {\n        \n        if (frm.doc.docstatus === 1) {\n            // Add custom button\n            frm.add_custom_button(\n                __(\"Sales Quotation\"), // Fixed the typo here\n                function() {\n                   createQuotation(frm.doc);\n                   \n                },\n                __(\"Create\")\n            );\n        }\n    }\n});\n\nfunction createQuotation(fabrication) {\n    frappe.model.with_doctype('Quotation', function() {\n        \n                var quotation = frappe.model.get_new_doc('Quotation');\n                \n                fabrication.fabrication_table.map(item => {\n                    var row = frappe.model.add_child(\n                    quotation,\n                    \"Fabrication Table\",\n                    \"custom_fabrication_table\"\n                  );\n                    // Map fields from Opportunity Item to Sales Inquiry Item\n                    row.item = item.item;\n                    row.s1 = item.s1;\n                    row.s2 = item.s2;\n                    row.s3 = item.s3;\n                    row.s4 = item.s4;\n                    row.lengthangle = item.lengthangle;\n                    row.gaugethickess = item.gaugethickess;\n                    row.quantity = item.quantity;\n                    row.fixing_1st_side = item.fixing_1st_side;\n                    row.stiffener_total_qty = item.stiffener_total_qty;\n                    row.fixing_2nd_side = item.fixing_2nd_side;\n                    row.vanes_nos = item.vanes_nos;\n                    row.stiffener = item.stiffener;\n                    row.joint = item.joint;\n                    row.name1 = item.name1;\n                    \n                                            \n                });\n                frappe.set_route('Form', 'Quotation', quotation.name);\n        \n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "HR Letters and Certificates",
  "enabled": 1,
  "modified": "2024-10-02 11:08:41.637317",
  "module": null,
  "name": "Salary Structure Naming Series",
  "script": "frappe.ui.form.on(\"HR Letters and Certificates\", {\n    refresh: function(frm) {\n        // You can add custom buttons or logic here if needed\n    },\n    \n    certificate: function(frm) {\n        // Check if the certificate type is \"Salary Certificate\"\n        if (frm.doc.certificate === \"Salary Certificate\") {\n            var naming_series = \"HR-SC-SASCO-.YYYY.-\";\n            \n            // Set the naming series for the document\n            frm.set_value(\"naming_series\", naming_series);\n        }\n        else if (frm.doc.certificate === \"Passport Withdrawal Form\") {\n            var naming_ser = \"HR-PWF-SASCO-.YYYY.-\";\n            frm.set_value(\"naming_series\", naming_ser);\n        }\n         else if (frm.doc.certificate === \"\") {\n            var naming_ser = \"\";\n            frm.set_value(\"naming_series\", naming_ser);\n        }\n    },\n    \n    letter: function(frm) {\n        // Check if the certificate type is \"Salary Certificate\"\n        if (frm.doc.letter === \"Warning Letter\") {\n            var naming_series = \"HR-WL-SASCO-.YYYY.-\";\n            \n            // Set the naming series for the document\n            frm.set_value(\"naming_series\", naming_series);\n        }\n        else if (frm.doc.letter === \"NOC Letter\") {\n            var naming_ser = \"HR-NOC-SASCO-.YYYY.-\";\n            frm.set_value(\"naming_series\", naming_ser);\n        }\n        else if (frm.doc.letter === \"\") {\n            var naming_ser = \"\";\n            frm.set_value(\"naming_series\", naming_ser);\n        }\n    },\n    \n    salary_structure: function(frm) {\n            console.log(\"Function invoked\");\n            \n            if (frm.doc.salary_structure) {\n                // Fetch the Salary Structure document\n                console.log(\"Inside the Condition\");\n                frappe.db.get_doc(\"Salary Structure\", frm.doc.salary_structure)\n                    .then(salary_structure_doc => {\n                        console.log(salary_structure_doc);\n        \n                        // Clear the custom salary details table\n                        frm.clear_table('salary_details');\n        \n                        // Populate the custom salary details table with salary components\n                        salary_structure_doc.earnings.forEach((item) => {\n                            let row = frm.add_child('salary_details');\n                            row.salary_component = item.salary_component; // Assuming 'salary_component' is the field name\n                        });\n                        \n                        // Refresh the custom salary details table\n                        frm.refresh_field('salary_details');\n                    })\n                    .catch(error => {\n                        console.error(\"Error fetching Salary Structure:\", error);\n                        frappe.msgprint(__('Could not fetch Salary Structure. Please try again.'));\n                    });\n            }\n        }\n    \n    \n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "HR Letters and Certificates",
  "enabled": 1,
  "modified": "2024-07-29 14:02:08.086132",
  "module": null,
  "name": "Salary Sum Hr Letters And Certificates",
  "script": "frappe.ui.form.on('Salary Components HR', {\n    // Triggered when 'amount' field is changed\n    amount: function(frm) {\n        updateTotalValues(frm);\n    },\n\n    // Triggered when a row is removed from the child table\n    salary_details_remove: function(frm) {\n        updateTotalValues(frm);\n    },\n\n    // Triggered when a row is added to the child table\n    salary_details_add: function(frm) {\n        updateTotalValues(frm);\n    }\n});\n\n// Function to update total values\nfunction updateTotalValues(frm) {\n    var total_amount = 0;\n\n    // Ensure salary_details is an array or set it to an empty array if undefined\n    var items = frm.doc.salary_details || [];\n\n    // Calculate total amount for all items\n    items.forEach(function(item) {\n        total_amount += flt(item.amount); // Convert to float and sum up\n    });\n\n    // Set the total amount in the form\n    frm.set_value('total_salary', total_amount);\n\n    // Optionally clear total_salary if no items are present\n    if (items.length === 0) {\n        frm.set_value('total_salary', 0);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "HR Letters and Certificates",
  "enabled": 1,
  "modified": "2024-10-02 11:07:39.741262",
  "module": null,
  "name": "Salary Component Filter in Hr letter and Certificate",
  "script": "frappe.ui.form.on('Salary Components HR', {\n    // Triggered when the form is loaded\n    onload: function(frm) {\n        // Filter options for link field in table\n        filter_salary_component_options(frm);\n    },\n\n    // Triggered when a row is added to the child table\n    salary_details_add: function(frm) {\n        // Filter options for link field in table\n        filter_salary_component_options(frm);\n    },\n\n    // Triggered when a row is removed from the child table\n    salary_details_remove: function(frm) {\n        // Filter options for link field in table\n        filter_salary_component_options(frm);\n    }\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n});\n\nfunction filter_salary_component_options(frm) {\n    // Clear existing options\n    frm.fields_dict['salary_details'].grid.get_field('salary_component').get_query = function() {\n        return {\n            filters: [\n                ['type', '=', 'earning']\n            ]\n        };\n    };\n\n    // Refresh the field to apply the filter\n    frm.refresh_field('salary_details');\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Inquiry",
  "enabled": 0,
  "modified": "2024-08-23 09:56:03.140517",
  "module": null,
  "name": "Sales Inquiry to Fabrication List",
  "script": "frappe.ui.form.on(\"Sales Inquiry\", {\n    refresh: function(frm) {\n        // Add your custom button\n        if(frm.doc.workflow_state == \"Started\"){\n        frm.add_custom_button(\n            __(\"Fabrication\"),\n            function() {\n               \n                createFabrication(frm.doc);\n                \n            },\n            __(\"Create\")\n        );\n    }}\n});\n\nfunction createFabrication(salesInquiryDoc) {\n    frappe.model.with_doctype('Fabrication List', function() {\n        var fabrication = frappe.model.get_new_doc('Fabrication List');\n        fabrication.oppurtunity = salesInquiryDoc.opportunity;\n        fabrication.lead = salesInquiryDoc.lead;\n        fabrication.opportunity_owner = salesInquiryDoc.opportunity_owner;\n        fabrication.project_ref = salesInquiryDoc.project;\n        fabrication.priority = salesInquiryDoc.name;\n        frappe.set_route('Form', 'Fabrication List', fabrication.name);\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2024-12-19 15:21:04.164626",
  "module": null,
  "name": "Set Customer To Qutotation from Fabrication",
  "script": "let customer = null;\n\nfrappe.ui.form.on('Quotation', {\n    setup: function(frm) {\n        // Store party_name in the global variable when the form is refreshed\n        if (frm.doc.party_name) {\n            customer = frm.doc.party_name;\n            // console.log(customer)\n        }\n    },\n\n    party_name: function(frm) {\n        // Set party_name using the global variable if the form is unsaved\n        if (frm.doc.__unsaved && !frm.doc.party_name && customer && frm.doc.quotation_to == \"Customer\") {\n            frm.doc.party_name = customer;\n            // frm.set_value(\"party_name\", customer);\n            // console.log(customer)\n        }\n    },\n    quotation_to:function(frm) {\n        // Set party_name using the global variable if the form is unsaved\n        if (frm.doc.__unsaved && !frm.doc.party_name && customer && frm.doc.quotation_to == \"Customer\") {\n            frm.doc.party_name = customer;\n            // frm.set_value(\"party_name\", customer);\n            // console.log(customer)\n        }\n    },\n    valid_till:function(frm) {\n        // Set party_name using the global variable if the form is unsaved\n        if (frm.doc.__unsaved && !frm.doc.party_name && customer && frm.doc.quotation_to == \"Customer\") {\n            frm.doc.party_name = customer;\n            // frm.set_value(\"party_name\", customer);\n            // console.log(customer)\n        }\n    }\n    \n    \n    \n    \n    \n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Checkin Request",
  "enabled": 0,
  "modified": "2024-07-31 17:57:11.922857",
  "module": null,
  "name": "test",
  "script": "frappe.ui.form.on('Employee Checkin Request', {\n    custom_comment: function(frm) {\n        // Check if the workflow state is 'Pending By HOD' and custom_comment is empty\n        if (frm.doc.workflow_state === 'Pending By HOD' && frm.doc.custom_comment === None) {\n            // Show message to user\n            frappe.msgprint(__('You cannot proceed until you enter a comment'));\n            // Prevent form submission\n            frappe.validated = false;\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2024-12-19 15:22:00.991731",
  "module": null,
  "name": "Fabrication Range In Quotation",
  "script": "frappe.ui.form.on('Quotation', {\n    // Trigger this function when the form is loaded or refreshed\n    custom_caluclate_ranges: function(frm) {\n        \n        if(frm.doc.custom_range_fabrication === 1 && frm.doc.custom_quantity == 0){\n        distributeValuesAcrossRanges(frm);\n        }\n        \n        if (frm.doc.custom_quantity == 1 && frm.doc.custom_range_fabrication === 0){\n            distributeQuantitiesIntoRanges(frm);\n        }\n        \n    }\n});\n\nfunction distributeValuesAcrossRanges(frm) {\n    let ranges = frm.doc.custom_fabrication_ranges || [];\n    let highestValues = [];\n\n    // Collect highest values from each item\n    frm.doc.items.forEach(function(item) {\n        let values = [item.custom_s1 || 0, item.custom_s2 || 0, item.custom_s3 || 0, item.custom_s4 || 0];\n        let itemHighestValue = Math.max(...values);\n        if (itemHighestValue > 0) {\n            highestValues.push(itemHighestValue);\n        }\n    });\n\n    // console.log('Highest values: ' + highestValues);\n\n    // Initialize range limits with empty lists for matching values and a sum for each range\n    let rangeLimits = ranges.map(r => ({\n        from: parseFloat(r.from_range) || 0,\n        to: parseFloat(r.to_range) || 0,\n        values: [],\n        sum: 0\n    }));\n\n    // Distribute values across ranges\n    highestValues.forEach(value => {\n        let placed = false;\n        rangeLimits.forEach(r => {\n            if (r.from <= value && value <= r.to) {\n                r.values.push(value);\n                r.sum += value;  // Add the value to the sum for this range\n                placed = true;\n                return;  // Exit the loop once the value is placed\n            }\n        });\n        if (!placed) {\n            // console.log(`Value ${value} does not fit into any defined range.`);\n        }\n    });\n\n    // Update the `custom_quantity_in_ranges` table with the results\n    updateRangeTable(frm, rangeLimits, ranges);\n}\n\nfunction updateRangeTable(frm, rangeLimits, allRanges) {\n    // Create a map to keep track of existing ranges and their sums\n    let existingRanges = new Map();\n\n    // Initialize the map with all defined ranges\n    allRanges.forEach(r => {\n        existingRanges.set(`${r.from_range}-${r.to_range}`, {\n            from_range: r.from_range,\n            to_range: r.to_range,\n            quantity: 0\n        });\n    });\n\n    // Update the map with computed sums from rangeLimits\n    rangeLimits.forEach(r => {\n        if (existingRanges.has(`${r.from}-${r.to}`)) {\n            let rangeData = existingRanges.get(`${r.from}-${r.to}`);\n            rangeData.quantity = r.sum;\n        }\n    });\n\n    // Clear existing rows in the table\n    frm.clear_table('custom_quantity_in_ranges');\n\n    // Add new rows to the table based on the updated ranges\n    existingRanges.forEach(rangeData => {\n        let newRow = frm.add_child('custom_quantity_in_ranges');\n        newRow.from_range = rangeData.from_range;\n        newRow.to_range = rangeData.to_range;\n        newRow.quantity = rangeData.quantity;\n    });\n\n    // Refresh the table to show the updated rows\n    frm.refresh_field('custom_quantity_in_ranges');\n    \n    // Save the document to persist changes\n \n}\n\n\nfunction distributeQuantitiesIntoRanges(frm) {\n    let ranges = frm.doc.custom_fabrication_ranges || [];\n    let allQuantities = [];\n\n    // Collect all quantities from the Quantity field in each item\n    frm.doc.items.forEach(function(item) {\n        let quantity = item.qty || 0;  // Assuming 'qty' is the field name for quantity\n        if (quantity > 0) {\n            allQuantities.push(quantity);\n        }\n    });\n\n    // console.log('All quantities: ' + allQuantities);\n\n    // Initialize range limits with empty lists for matching quantities and a sum for each range\n    let rangeLimits = ranges.map(r => ({\n        from: parseFloat(r.from_range) || 0,\n        to: parseFloat(r.to_range) || 0,\n        quantities: [],\n        sum: 0\n    }));\n\n    // Distribute quantities across ranges\n    allQuantities.forEach(quantity => {\n        let placed = false;\n        rangeLimits.forEach(r => {\n            if (r.from <= quantity && quantity <= r.to) {\n                r.quantities.push(quantity);\n                r.sum += quantity;  // Add the quantity to the sum for this range\n                placed = true;\n                return;  // Exit the loop once the quantity is placed\n            }\n        });\n        if (!placed) {\n            // console.log(`Quantity ${quantity} does not fit into any defined range.`);\n        }\n    });\n\n    // Update the `custom_quantity_in_ranges` table with the results\n    refreshRangeTable(frm, rangeLimits, ranges);\n}\n\nfunction refreshRangeTable(frm, rangeLimits, allRanges) {\n    // Create a map to keep track of existing ranges and their sums\n    let existingRanges = new Map();\n\n    // Initialize the map with all defined ranges\n    allRanges.forEach(r => {\n        existingRanges.set(`${r.from_range}-${r.to_range}`, {\n            from_range: r.from_range,\n            to_range: r.to_range,\n            quantity: 0\n        });\n    });\n\n    // Update the map with computed sums from rangeLimits\n    rangeLimits.forEach(r => {\n        if (existingRanges.has(`${r.from}-${r.to}`)) {\n            let rangeData = existingRanges.get(`${r.from}-${r.to}`);\n            rangeData.quantity = r.sum;\n        }\n    });\n\n    // Clear existing rows in the table\n    frm.clear_table('custom_quantity_in_ranges');\n\n    // Add new rows to the table based on the updated ranges\n    existingRanges.forEach(rangeData => {\n        let newRow = frm.add_child('custom_quantity_in_ranges');\n        newRow.from_range = rangeData.from_range;\n        newRow.to_range = rangeData.to_range;\n        newRow.quantity = rangeData.quantity;\n    });\n\n    // Refresh the table to show the updated rows\n    frm.refresh_field('custom_quantity_in_ranges');\n    \n    // Save the document to persist changes (if needed)\n    // frm.save(); // Uncomment if you want to automatically save after updating\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Application",
  "enabled": 1,
  "modified": "2025-01-03 09:14:40.494350",
  "module": null,
  "name": "Hide Leave Allocation Table",
  "script": "frappe.ui.form.on('Leave Application', {\n    refresh: async function(frm) {\n        \n        if( frm.doc.docstatus === 1 )\n        {\n            frm.add_custom_button(\n            __(\"Employee Rejoining\"),\n            function() {\n                // Define the action for the Sales Inquiry button\n                createemployeerejoining(frm.doc);\n            },\n            __(\"Create\")\n     \n        );}\n        \n        \n        \n        \n        if (frm.doc.name.includes('new-leave-application')) {\n            $('.form-dashboard').css('display', 'none');\n        } else {\n            $('.form-dashboard').css('display', 'block');\n        }\n\n        let emp_list = await frappe.db.get_list('Employee', {\n            filters: {\n                user_id: frappe.session.user\n            },\n            fields: ['name']\n        });\n\n        if (emp_list.length > 0) {\n            let emp_doc = await frappe.db.get_doc('Employee', emp_list[0].name);\n            if (emp_doc.create_user_permission != 1) {\n                $('.form-dashboard').css('display', 'block');\n            }\n        } else {\n            $('.form-dashboard').css('display', 'block');\n        }\n    },\n    \n  \n});\n\nfunction createemployeerejoining(leave) {\n    \n\n    frappe.model.with_doctype('Leave Application', function() {\n        var emprejoin = frappe.model.get_new_doc('Employee Rejoining Form');\n        // Set fields in the Quotation document\n        emprejoin.employee = leave.employee;\n        emprejoin.leave_type = leave.leave_type;\n        emprejoin.from = leave.from_date;\n        emprejoin.to = leave.to_date;\n        emprejoin.leave_application = leave.name;\n        emprejoin.approved_days = leave.total_leave_days;\n        \n\n        frappe.set_route('Form', 'Employee Rejoining Form', emprejoin.name);\n    });\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-05-26 16:29:05.803978",
  "module": null,
  "name": "Quotation to Sales Order",
  "script": "frappe.ui.form.on(\"Quotation\", {\n    refresh: function(frm) {\n        // Add custom button to create Sales Order\n        if (frm.doc.docstatus === 1) {\n            frm.add_custom_button(\n                __(\"Sales Order\"),\n                function() {\n                    // Define the action for the Create Sales Order button\n                    createSalesOrder(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n    }\n});\n\n\n\nfunction createSalesOrder(quotation) {\n    // console.log(\"Creating Sales Order from Quotation:\", quotation);\n\n    frappe.model.with_doctype('Sales Order', function() {\n        var sales_order = frappe.model.get_new_doc('Sales Order');\n\n        // Set fields in the Sales Order document\n        sales_order.customer = quotation.party_name;\n        sales_order.company = quotation.company;\n        sales_order.custom_ref_quotation = quotation.name;\n\n        // Copy items from Quotation to Sales Order\n        quotation.items.map(function(item) {\n            var row = frappe.model.add_child(sales_order, \"Sales Order Item\", \"items\");\n            row.item_code = item.item_code;\n            row.custom_parent_item_1 = item.custom_parent_item_1 ;\n            row.qty = item.qty;\n            row.uom = item.uom;\n            row.item_name = item.item_name;\n            row.brand = item.brand;\n            row.item_group = item.item_group;\n            row.rate = item.rate;\n            row.amount = item.amount;\n            row.custom_s1 = item.custom_s1;\n            row.custom_s2 = item.custom_s2;\n            row.custom_s3 = item.custom_s3;\n            row.custom_s4 = item.custom_s4;\n            row.custom_lengthangle = item.custom_lengthangle;\n            row.custom_gaugethickess = item.custom_gaugethickess;\n            row.custom_fixing_1st_side = item.custom_fixing_1st_side;\n            row.custom_stiffener_total_qty = item.custom_stiffener_total_qty;\n            row.custom_fixing_2nd_side = item.custom_fixing_2nd_side;\n            row.custom_vanes_nos = item.custom_vanes_nos;\n            row.custom_stiffener = item.custom_stiffener;\n            row.custom_joint = item.custom_joint;\n            \n        });\n\n        sales_order.custom_parent_item = quotation.custom_parent_item ;\n  \n\n        // Open the Sales Order in a new tab without saving\n        frappe.set_route('Form', 'Sales Order', sales_order.name);\n    });\n    \n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2024-10-02 10:57:23.945764",
  "module": null,
  "name": "JOB Offer Letter Naming series",
  "script": "frappe.ui.form.on('Job Offer', {\n    custom_job_offer_type: function(frm) {\n        if (frm.doc.custom_job_offer_type === \"Staff\") {\n            frm.set_value('naming_series', \"HR-OFF-Staff-.YYYY.-.#####\");\n        } else if (frm.doc.custom_job_offer_type === \"Labour\") {\n            frm.set_value('naming_series', \"HR-OFF-Labour-.YYYY.-.#####\");\n        } else {\n            frm.set_value('naming_series', '');  // Clear the naming series if type does not match\n        }\n        frm.refresh_field('naming_series'); // Refresh the field to reflect changes\n    },\n    \n    \n    custom_salary_stracture: function(frm) {\n    console.log(\"Function invoked\");\n    \n    if (frm.doc.custom_salary_stracture) {\n        // Fetch the Salary Structure document\n        console.log(\"Inside the Condition\");\n        frappe.db.get_doc(\"Salary Structure\", frm.doc.custom_salary_stracture)\n            .then(salary_structure_doc => {\n                console.log(salary_structure_doc);\n\n                // Clear the custom salary details table\n                frm.clear_table('custom_salary_details');\n\n                // Populate the custom salary details table with salary components\n                salary_structure_doc.earnings.forEach((item) => {\n                    let row = frm.add_child('custom_salary_details');\n                    row.salary_component = item.salary_component; // Assuming 'salary_component' is the field name\n                });\n                \n                // Refresh the custom salary details table\n                frm.refresh_field('custom_salary_details');\n            })\n            .catch(error => {\n                console.error(\"Error fetching Salary Structure:\", error);\n                frappe.msgprint(__('Could not fetch Salary Structure. Please try again.'));\n            });\n    }\n}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication List",
  "enabled": 0,
  "modified": "2025-02-06 13:09:55.643586",
  "module": null,
  "name": "Fabrication Ranges",
  "script": "frappe.ui.form.on('Fabrication List', {\n    // Trigger this function when the form is loaded or refreshed\n    calculate: function(frm) {\n        if (frm.doc.ranges === 1 && frm.doc.quantity == 0) {\n            distributeValuesAcrossRanges(frm);\n        }\n\n        if (frm.doc.quantity == 1 && frm.doc.ranges === 0) {\n            distributeQuantitiesIntoRanges(frm);\n        }\n    },\n    \n    item_group: function(frm) {\n       updateItemGroupInFabricationTable(frm);\n    }\n    \n    \n    \n});\n\nfunction distributeValuesAcrossRanges(frm) {\n    let ranges = frm.doc.fabrication_ranges || [];\n    let highestValues = [];\n\n    // Collect highest values from each item\n    frm.doc.fabrication_table.forEach(function(item) {\n        let values = [item.custom_s1 || 0, item.custom_s2 || 0, item.custom_s3 || 0, item.custom_s4 || 0];\n        let itemHighestValue = Math.max(...values);\n        if (itemHighestValue > 0) {\n            highestValues.push({\n                item: item.item_name,  // Use 'item' to store item name\n                highestValue: itemHighestValue\n            });\n        }\n    });\n\n    console.log('Highest values:', highestValues);\n\n    // Initialize range limits with empty lists for matching values and a sum for each range\n    let rangeLimits = ranges.map(r => ({\n        from: parseFloat(r.from_range) || 0,\n        to: parseFloat(r.to_range) || 0,\n        values: [],\n        sum: 0,\n        item: r.item || ''  // Include 'item' in the range limits\n    }));\n\n    // Distribute values across ranges\n    highestValues.forEach(item => {\n        let { highestValue, item: itemName } = item;\n        let placed = false;\n        rangeLimits.forEach(r => {\n            if (r.from <= highestValue && highestValue <= r.to) {\n                r.values.push(highestValue);\n                r.sum += highestValue;  // Add the value to the sum for this range\n                placed = true;\n                return;  // Exit the loop once the value is placed\n            }\n        });\n        if (!placed) {\n            console.log(`Highest value ${highestValue} for item ${itemName} does not fit into any defined range.`);\n        }\n    });\n\n    // Update the `quantity_in_ranges` table with the results\n    updateRangeTable(frm, rangeLimits, ranges);\n}\n\nfunction updateRangeTable(frm, rangeLimits, allRanges) {\n    // Create a map to keep track of existing ranges and their sums\n    let existingRanges = new Map();\n\n    // Initialize the map with all defined ranges\n    allRanges.forEach(r => {\n        existingRanges.set(`${r.from_range}-${r.to_range}`, {\n            from_range: r.from_range,\n            to_range: r.to_range,\n            quantity: 0,\n            item: r.item || ''  // Add 'item' to the map\n        });\n    });\n\n    // Update the map with computed sums from rangeLimits\n    rangeLimits.forEach(r => {\n        let key = `${r.from}-${r.to}`;\n        if (existingRanges.has(key)) {\n            let rangeData = existingRanges.get(key);\n            rangeData.quantity = r.sum;\n            rangeData.item = r.item;  // Ensure 'item' is updated\n        }\n    });\n\n    // Clear existing rows in the table\n    frm.clear_table('quantity_in_ranges');\n\n    // Add new rows to the table based on the updated ranges\n    existingRanges.forEach(rangeData => {\n        let newRow = frm.add_child('quantity_in_ranges');\n        newRow.from_range = rangeData.from_range;\n        newRow.to_range = rangeData.to_range;\n        newRow.quantity = rangeData.quantity;\n        newRow.item = rangeData.item;  // Set 'item' in the new row\n    });\n\n    // Refresh the table to show the updated rows\n    frm.refresh_field('quantity_in_ranges');\n    \n    // Save the document to persist changes (if needed)\n    // frm.save(); // Uncomment if you want to automatically save after updating\n}\n\nfunction distributeQuantitiesIntoRanges(frm) {\n    let ranges = frm.doc.fabrication_ranges || [];\n    let allItems = [];\n\n    // Collect quantities and highest values from each item\n    frm.doc.fabrication_table.forEach(function(item) {\n        let values = [item.custom_s1 || 0, item.custom_s2 || 0, item.custom_s3 || 0, item.custom_s4 || 0];\n        let itemHighestValue = Math.max(...values);\n        let quantity = item.qty || 0;  // Assuming 'qty' is the field name for quantity\n        if (quantity > 0 && itemHighestValue > 0) {\n            allItems.push({\n                quantity,\n                highestValue: itemHighestValue,\n                item: item.item_name  // Add item name to the item data\n            });\n        }\n    });\n\n    console.log('Items with quantities and highest values:', allItems);\n\n    // Initialize range limits with empty lists for matching quantities and a sum for each range\n    let rangeLimits = ranges.map(r => ({\n        from: parseFloat(r.from_range) || 0,\n        to: parseFloat(r.to_range) || 0,\n        quantities: [],\n        sum: 0,\n        item: r.item || ''  // Include 'item' in the range limits\n    }));\n\n    // Distribute quantities across ranges based on their highest values\n    allItems.forEach(item => {\n        let { quantity, highestValue, item: itemName } = item;\n        let placed = false;\n        rangeLimits.forEach(r => {\n            if (r.from <= highestValue && highestValue <= r.to) {\n                r.quantities.push(quantity);\n                r.sum += quantity;  // Add the quantity to the sum for this range\n                placed = true;\n                return;  // Exit the loop once the quantity is placed\n            }\n        });\n        if (!placed) {\n            console.log(`Quantity ${quantity} with highest value ${highestValue} for item ${itemName} does not fit into any defined range.`);\n        }\n    });\n\n    // Update the `quantity_in_ranges` table with the results\n    refreshRangeTable(frm, rangeLimits, ranges);\n}\n\nfunction refreshRangeTable(frm, rangeLimits, allRanges) {\n    // Create a map to keep track of existing ranges and their sums\n    let existingRanges = new Map();\n\n    // Initialize the map with all defined ranges\n    allRanges.forEach(r => {\n        existingRanges.set(`${r.from_range}-${r.to_range}`, {\n            from_range: r.from_range,\n            to_range: r.to_range,\n            quantity: 0,\n            item: r.item || ''  // Add 'item' to the map\n        });\n    });\n\n    // Update the map with computed sums from rangeLimits\n    rangeLimits.forEach(r => {\n        let key = `${r.from}-${r.to}`;\n        if (existingRanges.has(key)) {\n            let rangeData = existingRanges.get(key);\n            rangeData.quantity = r.sum;\n            rangeData.item = r.item;  // Ensure 'item' is updated\n        }\n    });\n\n    // Clear existing rows in the table\n    frm.clear_table('quantity_in_ranges');\n\n    // Add new rows to the table based on the updated ranges\n    existingRanges.forEach(rangeData => {\n        let newRow = frm.add_child('quantity_in_ranges');\n        newRow.from_range = rangeData.from_range;\n        newRow.to_range = rangeData.to_range;\n        newRow.quantity = rangeData.quantity;\n        newRow.item = rangeData.item;  // Set 'item' in the new row\n    });\n\n    // Refresh the table to show the updated rows\n    frm.refresh_field('quantity_in_ranges');\n    \n    // Save the document to persist changes (if needed)\n    // frm.save(); // Uncomment if you want to automatically save after updating\n}\n\n\n\nfunction updateItemGroupInFabricationTable(frm) {\n    // Get the item_group value from the form\n    let itemGroup = frm.doc.item_group;\n\n    // Iterate through the fabrication_table and set item_group for each row\n    frm.doc.fabrication_table.forEach(function(row) {\n        row.item_group = itemGroup;\n    });\n\n    // Refresh the field to show the updated rows\n    frm.refresh_field('fabrication_table');\n}\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication List",
  "enabled": 0,
  "modified": "2025-02-06 13:08:43.740052",
  "module": null,
  "name": "Fabrication Template",
  "script": "frappe.ui.form.on('Fabrication List', {\n    fabrication_template: function(frm) {\n        var template_name = frm.doc.fabrication_template;\n        if (template_name) {\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Fabrication Template',\n                    name: template_name\n                },\n                callback: function(response) {\n                    if (!response.exc) {\n                        var template_doc = response.message;\n                        if (template_doc && template_doc.fabrication_template_ranges) {\n                            frm.clear_table('table'); // 'table' is the name of the table field in Fabrication List\n                            template_doc.fabrication_template_ranges.forEach(function(row_data) {\n                                var row = frm.add_child('table'); // Add a new row to the table\n                                row.item = row_data.item;\n                                row.quantity = row_data.quantity;\n                                row.from_range = row_data.from_range;\n                                row.to_range = row_data.to_range;\n                                row.uom = row_data.uom;\n                                row.thickness = row_data.thickness;\n                                row.item_name = row_data.item_name;\n                                row.fixing_1st_side = row_data.fixing_1st_side;\n                                row.fixing_2nd_side = row_data.fixing_2nd_side;\n                                row.vanes_nos = row_data.vanes_nos;\n                                row.stiffener_total_qty = row_data.stiffener_total_qty;\n                                // Set other fields as needed\n                            });\n                            frm.refresh_field('table'); // Refresh the field to display the updated rows\n                        } else {\n                            console.log('Fabrication Template document or its fabrication_template_table not found.');\n                        }\n                    } else {\n                        console.error('Error fetching Fabrication Template document:', response.exc);\n                    }\n                }\n            });\n        }\n        else {\n            frm.clear_table('table');\n            frm.refresh_field('table');\n        }\n    },\n    \n    \n    onload: function (frm) {\n\n        frm.set_query('fabrication_template', function () {\n            return {\n                filters: {\n                    docstatus: 1 \n                }\n            };\n        });\n    }\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication List",
  "enabled": 0,
  "modified": "2025-02-06 13:03:54.600967",
  "module": null,
  "name": "Quantities Update in Fabrication Template Table",
  "script": "frappe.ui.form.on('Fabrication List', {\n    refresh: function(frm) {\n        if(frm.doc.docstatus != 1 ) \n        {\n            frm.add_custom_button(__('Update Quantities, Area, and KG'), function() {\n                if(frm.doc.check != 1 )\n                {\n                    sufyan_function(frm) ;        \n                }\n                else\n                {\n                    updateQuantitiesAreaAndKgfortable1(frm);\n                }\n            });\n        }\n    }\n});\n\n\n\n\n\nfunction updateQuantitiesAreaAndKgfortable1(frm) {\n    let fabricationTable = frm.doc.fabrication_table || [];\n    let table1 = frm.doc.table1 || [];\n\n    // Create maps to track quantities, areas, kg, and lm for each thickness\n    let thicknessQuantityMap = new Map();\n    let thicknessAreaMap = new Map();\n    let thicknessKgMap = new Map();\n    let thicknessLmMap = new Map();  // New map for linear meters\n\n    // Step 1: Iterate over 'fabrication_table' to process each entry\n    fabricationTable.forEach(fabricationEntry => {\n        let thickness = fabricationEntry.custom_gaugethickess;\n        \n        if (thickness) {\n            // Initialize map entries for this thickness if not already present\n            if (!thicknessQuantityMap.has(thickness)) {\n                thicknessQuantityMap.set(thickness, 0);\n                thicknessAreaMap.set(thickness, 0);\n                thicknessKgMap.set(thickness, 0);\n                thicknessLmMap.set(thickness, 0);  // Initialize lm map\n            }\n\n            // Update quantity, area, kg, and lm in maps\n            thicknessQuantityMap.set(thickness, thicknessQuantityMap.get(thickness) + (fabricationEntry.qty || 0));\n            thicknessAreaMap.set(thickness, thicknessAreaMap.get(thickness) + (fabricationEntry.customer_sqm || 0)); // Update area\n            thicknessKgMap.set(thickness, thicknessKgMap.get(thickness) + (fabricationEntry.customer_kg || 0)); // Update kg\n            thicknessLmMap.set(thickness, thicknessLmMap.get(thickness) + (fabricationEntry.customer_lm || 0)); // Update lm\n        }\n    });\n\n    // Debugging: Print maps to the console\n    // console.log('Thickness Quantity Map:', thicknessQuantityMap);\n    // console.log('Thickness Area Map:', thicknessAreaMap);\n    // console.log('Thickness KG Map:', thicknessKgMap);\n    // console.log('Thickness LM Map:', thicknessLmMap);\n\n    // Clear existing rows in 'table1'\n    frm.clear_table('table1');\n    \n    // Add updated quantities, areas, kg, and lm to 'table1'\n    thicknessQuantityMap.forEach((quantity, thickness) => {\n        let newRow = frm.add_child('table1');\n        newRow.thickness = thickness;\n        newRow.quantity = quantity;\n        newRow.area_in_sqm = thicknessAreaMap.get(thickness) || 0; // Set the area_in_sqm field\n        newRow.kg = thicknessKgMap.get(thickness) || 0; // Set the kg field\n        newRow.lm = thicknessLmMap.get(thickness) || 0; // Set the lm field\n    });\n\n    // Refresh the 'table1' to show updated rows\n    frm.refresh_field('table1');\n}\n\n\n\nfunction sufyan_function(frm) {\n  \n\n    frm.doc.table.forEach(function(row) {\n\n        frappe.model.set_value(row.doctype, row.name, 'quantity', 0);\n        frappe.model.set_value(row.doctype, row.name, 'area_in_sqm', 0);\n        frappe.model.set_value(row.doctype, row.name, 'lm', 0);\n        frappe.model.set_value(row.doctype, row.name, 'kg', 0);\n    });\n\n    frm.refresh_field('table');\n    \n    \n    \n    frm.doc.fabrication_table.forEach(function(row) {\n        \n        let customS1 = row.custom_s1 || 0;  \n        let customS2 = row.custom_s2 || 0;  \n        let customS3 = row.custom_s3 || 0;  \n        let customS4 = row.custom_s4 || 0;  \n\n        \n        let maxValue = Math.max(customS1, customS2, customS3, customS4);\n        \n        if(maxValue == 0)\n        {\n            frm.doc.table.forEach(function(tbl_row) {\n                if (tbl_row.item === row.item_name) {\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'quantity', (tbl_row.quantity + row.qty) );\n                    \n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'area_in_sqm', (tbl_row.area_in_sqm + row.customer_sqm) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'lm', (tbl_row.lm + row.customer_lm) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'kg', (tbl_row.kg + row.customer_kg) );\n                    \n                    \n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'fixing_1st_side', (parseFloat(tbl_row.fixing_1st_side) + parseFloat(row.custom_fixing_1st_side)) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'fixing_2nd_side', ( parseFloat(tbl_row.fixing_2nd_side) + parseFloat(row.custom_fixing_2nd_side) ) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'vanes_nos', ( parseFloat(tbl_row.vanes_nos) + parseFloat(row.custom_vanes_nos) ) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'stiffener_total_qty', ( parseFloat(tbl_row.stiffener_total_qty) + parseFloat(row.custom_stiffener_total_qty) ) );\n       \n                    \n                    \n                    \n                    \n                }\n            });\n        }\n        else if(maxValue > 0)\n        {\n            \n             frm.doc.table.forEach(function(tbl_row) {\n               \n                if ( parseFloat(tbl_row.from_range) <= parseFloat(maxValue) && parseFloat(maxValue) <= parseFloat(tbl_row.to_range) && tbl_row.thickness == row.custom_gaugethickess ) {\n                    \n                    \n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'quantity', (tbl_row.quantity + row.qty) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'area_in_sqm', (tbl_row.area_in_sqm + row.customer_sqm) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'lm', (tbl_row.lm + row.customer_lm) );\n                    frappe.model.set_value(tbl_row.doctype, tbl_row.name, 'kg', (tbl_row.kg + row.customer_kg) );\n       \n       \n                 \n                    \n                    \n                    \n                }\n            });\n            \n        }\n\n        \n        \n    });\n\n    frm.refresh_field('table');\n    frm.refresh_field('fabrication_table');\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Loan Application",
  "enabled": 1,
  "modified": "2024-09-04 10:34:05.295200",
  "module": null,
  "name": "Empployee Loan Eligiblity",
  "script": "frappe.ui.form.on('Loan Application', {\n    applicant: function(frm) {\n    // Check if applicant field is set\n    if (frm.doc.applicant) {\n        // Fetch the Employee document\n        frappe.call({\n            method: 'frappe.client.get',\n            args: {\n                doctype: 'Employee',\n                name: frm.doc.applicant  // Ensure this is the ID of the employee\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var employee_doc = response.message;\n                    var loan_product = employee_doc.custom_loan_product;\n                    frm.set_value('loan_product', loan_product);\n\n                    // Debugging: Log the entire employee document\n                    console.log(\"Employee Document:\", employee_doc);\n\n                    // Ensure necessary fields are available\n                    var date_of_joining = employee_doc.date_of_joining;\n                    var salary = employee_doc.custom_total_salary; // Make sure this field name matches\n                    var loan_policy = employee_doc.custom_loan_policy;\n\n                    console.log(\"Date of Joining:\", date_of_joining);\n                    console.log(\"Salary:\", salary); // Check if this is undefined\n                    console.log(\"Loan Policy:\", loan_policy);\n\n                    if (date_of_joining && salary && loan_policy) {\n                        var joining_date = new Date(date_of_joining);\n                        var current_date = new Date();\n                        \n                        // Calculate the difference in years\n                        var diffYears = (current_date - joining_date) / (1000 * 60 * 60 * 24 * 365.25); // Consider leap years\n                        console.log(\"Difference in years:\", diffYears);\n\n                        // Check if experience is less than 1 year\n                        if (diffYears < 1) {\n                            frappe.msgprint(\"Experience is less than 1 year\");\n                            return; // Exit if not eligible\n                        }\n\n                        // Fetch the Loan Policy document\n                        frappe.call({\n                            method: 'frappe.client.get',\n                            args: {\n                                doctype: 'Loan Policy',\n                                name: loan_policy\n                            },\n                            callback: function(policy_response) {\n                                if (policy_response.message) {\n                                    var policy_doc = policy_response.message;\n                                    var policy_items = policy_doc.policy_details || [];\n                                    \n                                    // Store policy details in an array\n                                    var policy_details_array = policy_items.map(item => ({\n                                        number_of_years: parseFloat(item.number_of_years) || 0, // Convert to number\n                                        salary_portion: parseFloat(item.salary_portion) || 0, // Convert to number\n                                        deduction_year: parseFloat(item.deduction_duration) || 0 // Assuming deduction_duration is renamed to deduction_year\n                                    }));\n\n                                    console.log(\"Policy Details Array:\", policy_details_array);\n\n                                    // Determine the applicable salary portion\n                                    var selected_policy_salary = 0;\n                                    var repayment_amount = 0;\n                                    var found = false;\n\n                                    console.log(\"Processing policy details\");\n\n                                    for (var i = 0; i < policy_details_array.length; i++) {\n                                        var item = policy_details_array[i];\n                                        var number_of_years = item.number_of_years;\n                                        var next_number_of_years = (i + 1 < policy_details_array.length) ? policy_details_array[i + 1].number_of_years : Infinity;\n                                        var policy_salary = item.salary_portion;\n                                        var deduction_year = item.deduction_year;\n\n                                        console.log(`Checking: ${number_of_years} <= ${diffYears} < ${next_number_of_years}`);\n\n                                        // Check if the diffYears falls in the range or exactly matches the last row\n                                        if (diffYears >= number_of_years && diffYears < next_number_of_years) {\n                                            // Calculate the loan amount and repayment amount\n                                            selected_policy_salary = policy_salary * salary;\n                                            repayment_amount = deduction_year;\n\n                                            found = true;\n                                            console.log(\"Selected Policy Salary:\", selected_policy_salary);\n                                            console.log(\"Repayment Amount:\", repayment_amount);\n                                            break;\n                                        }\n                                    }\n                                    \n                                    // Set the loan amount and repayment amount\n                                    if (found) {\n                                        frm.set_value('loan_amount', selected_policy_salary);\n                                        frm.set_value('repayment_amount', repayment_amount);\n                                    } else {\n                                        frm.set_value('loan_amount', 0);\n                                        frm.set_value('repayment_amount', 0); // No matching policy found\n                                    }\n                                } else {\n                                    console.error(\"Error: Loan Policy not found.\");\n                                }\n                            },\n                            error: function(err) {\n                                console.error(\"Error fetching loan policy:\", err);\n                            }\n                        });\n                    } else {\n                        console.error(\"Error: Missing required fields in Employee document.\");\n                    }\n                } else {\n                    console.error(\"Error: Employee document not found.\");\n                }\n            },\n            error: function(err) {\n                console.error(\"Error fetching employee document:\", err);\n            }\n        });\n    }\n},\n  before_save: function(frm) {\n        // Check if applicant field is set\n        if (frm.doc.applicant) {\n            // Fetch the Employee document using frappe.call\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Employee',\n                    name: frm.doc.applicant  // Ensure this is the ID of the employee\n                },\n                async: false,  // Make the call synchronous\n                callback: function(response) {\n                    if (response.message) {\n                        var employee_doc = response.message;\n\n                        // Ensure date_of_joining is available\n                        if (employee_doc.date_of_joining) {\n                            // Get the joining date from the employee document\n                            var joining_date = new Date(employee_doc.date_of_joining);\n                            var current_date = new Date();\n                            \n                            // Calculate the difference in years\n                            var diffYears = (current_date - joining_date) / (1000 * 60 * 60 * 24 * 365.25); // Consider leap years\n                            console.log(diffYears);\n                            // Check if joining date is less than 1 year before\n                            if (parseInt(diffYears) < 1) {\n                                frappe.throw(\"Not Eligible\");\n                            }\n                        } else {\n                            frappe.throw(\"Employee document is missing the date_of_joining.\");\n                        }\n                    } else {\n                        frappe.throw(\"Employee document not found.\");\n                    }\n                },\n                error: function(err) {\n                    frappe.msgprint(__('Error fetching employee document: ' + err.message));\n                }\n            });\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Additional Salary",
  "enabled": 1,
  "modified": "2025-03-06 10:42:28.272683",
  "module": null,
  "name": "calculate overtime amount",
  "script": "frappe.ui.form.on('Additional Salary', {\r\n    // Trigger the update function when any of these fields change\r\n    custom_total_monthly_days: function(frm) {\r\n        update_overtime_amount(frm);\r\n    },\r\n    custom_basic: function(frm) {\r\n        update_overtime_amount(frm);\r\n    },\r\n    custom_per_day_working_hours: function(frm) {\r\n        update_overtime_amount(frm);\r\n    },\r\n    custom_overtime_hours: function(frm) {\r\n        update_overtime_amount(frm);\r\n    }\r\n});\r\n\r\nfunction update_overtime_amount(frm) {\r\n    // Check if custom_overtime_calculation is enabled\r\n    if (frm.doc.custom_overtime_calculation == 1) {\r\n        // Log all relevant field values for debugging\r\n        // console.log('custom_basic:', frm.doc.custom_basic);\r\n        // console.log('custom_total_monthly_days:', frm.doc.custom_total_monthly_days);\r\n        // console.log('custom_per_day_working_hours:', frm.doc.custom_per_day_working_hours);\r\n        // console.log('custom_overtime_hours:', frm.doc.custom_overtime_hours);\r\n\r\n        // Make sure all required fields are present and valid\r\n        if (frm.doc.custom_basic && frm.doc.custom_total_monthly_days &&\r\n            frm.doc.custom_per_day_working_hours && frm.doc.custom_overtime_hours) {\r\n\r\n            // Calculate the overtime amount\r\n            var overtime_amount = (frm.doc.custom_basic / frm.doc.custom_total_monthly_days / \r\n                                   frm.doc.custom_per_day_working_hours) * frm.doc.custom_overtime_hours;\r\n\r\n            // Log the calculated overtime amount for debugging\r\n            console.log('custom_overtime_amount:', overtime_amount);\r\n\r\n            // Set the value in the custom_overtime_amount field\r\n            frm.set_value(\"custom_overtime_amount\", overtime_amount);\r\n\r\n            // Set the value of the amount field to the overtime_amount\r\n            frm.set_value(\"amount\", overtime_amount);\r\n\r\n            // Optionally, refresh the fields to update the form\r\n            frm.refresh_field(\"custom_overtime_amount\");\r\n            frm.refresh_field(\"amount\");\r\n\r\n        } else {\r\n            // Handle cases where one or more fields are missing or invalid\r\n            frappe.msgprint(__('Please ensure that all required fields are filled out.'));\r\n        }\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event",
  "enabled": 0,
  "modified": "2024-08-22 13:25:32.691920",
  "module": null,
  "name": "Event Status",
  "script": "frappe.ui.form.on('Event', {\n    refresh: function(frm) {\n        \n        \n        // // Additional condition to clear status if neither `custom_start_on` nor `ends_on` are set\n        // else if (!frm.doc.custom_start_on && !frm.doc.ends_on) {\n        //     console.log(\"Meeting not started or not ended\");\n        //     frm.set_value(\"custom_event_status\", \"\");\n        //     frm.refresh_field('custom_event_status'); // Clear the custom field\n        // }\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Inquiry",
  "enabled": 1,
  "modified": "2025-11-11 14:12:34.606123",
  "module": null,
  "name": "Sales Inquiry Scripts",
  "script": "frappe.ui.form.on('Sales Inquiry', {\n    refresh: function(frm) {\n        // Add custom buttons based on workflow state\n        if (frm.doc.workflow_state == \"Started\") {\n            frm.add_custom_button(\n                __(\"Pricing Sheet\"),\n                function() {\n                    createCostingSheet(frm.doc);\n                },\n                __(\"Create\")\n            );\n            \n            frm.add_custom_button(\n                __(\"Estimation Request\"),\n                function() {\n                    createEstimationRequest(frm);\n                },\n                __(\"Create\")\n            );\n            \n            \n            frm.add_custom_button(\n                __(\"Fabrication\"),\n                function() {\n                    createFabrication(frm.doc);\n                },\n                __(\"Create\")\n            );\n            \n            \n            \n        }\n        \n        if (frm.doc.workflow_state == \"Approved for Quotation\" || frm.doc.workflow_state == \"QTN Pending\") {\n            frm.add_custom_button(\n                __(\"Sales Quotation\"),\n                function() {\n                    createQuotation(frm.doc);\n                },\n                __(\"Create\")\n            );\n            \n            frm.add_custom_button(\n                __(\"Estimation Request\"),\n                function() {\n                    createEstimationRequest(frm);\n                },\n                __(\"Create\")\n                );\n        }\n        toggle_child_tables(frm);\n    },\n    \n    items_remove: function(frm, cdt, cdn) {\n        updateTotalValues(frm);\n    },\n\n    product_type_table_add(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    },\n\n    product_type_table_remove(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    }\n});\n\nfrappe.ui.form.on('Product Type', {\n    product_types: function(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    }\n});\nfunction toggle_child_tables(frm) {\n    // collect all product_types from grid\n    let product_types = (frm.doc.product_type_table || []).map(row => row.product_types);\n\n    // mapping of product type to child table fieldname\n    const mapping = {\n        \"Adhesives & Sealant\": \"adhesives_and_sealant_specification_table\",\n        \"Dampers\": \"damper_specification_table\",\n        \"Duct\": \"duct_specifications_table\",\n        \"Duct Accessories\": \"duct_accessories_table\",\n        \"Fastners\": \"fastners_specification_table\",\n        \"Gasket & Masking Tape\": \"gasket_and_masking_tape_specification_table\",\n        \"Grill\": \"grilles_table\",\n        \"Diffuser\": \"diffuser_specification\",\n        \"Louver\": \"louver_specification_table\",\n        \"Raw Material\": \"raw_materal_specification_table\",\n        \"Sound Attenuator\": \"sound_attenuator__specification_table\",\n        \"Plenum\": \"plenum_specification_table\"\n    };\n\n    // loop through mapping and show/hide child tables\n    for (let [ptype, fieldname] of Object.entries(mapping)) {\n        \n        if (product_types.includes(ptype)) {\n            console.log(`Toggling ${fieldname} for product type ${ptype}`);\n            frm.toggle_display(fieldname, true);\n        } else {\n            frm.toggle_display(fieldname, false);\n        }\n    }\n}\n\n\nfrappe.ui.form.on('Opportunity Item', {\n    rate: function(frm, cdt, cdn) {\n        updateItemTotals(frm, cdt, cdn);\n    },\n    qty: function(frm, cdt, cdn) {\n        updateItemTotals(frm, cdt, cdn);\n    }\n});\n\nfunction updateItemTotals(frm, cdt, cdn) {\n    var total = 0;\n    var item = locals[cdt][cdn];\n    total = item.qty * item.rate;\n    frappe.model.set_value(item.doctype, item.name, 'amount', total);\n    frappe.model.set_value(item.doctype, item.name, 'base_rate', item.rate);\n    frappe.model.set_value(item.doctype, item.name, 'base_amount', total);\n    updateTotalValues(frm);\n}\n\nfunction updateTotalValues(frm) {\n    var total_qty = 0;\n    var total_amount = 0;\n    var items = frm.doc.items || [];\n\n    // Calculate total quantity and total amount for all items\n    for (var i = 0; i < items.length; i++) {\n        var item = items[i];\n        total_qty += flt(item.qty);\n        total_amount += flt(item.amount);\n    }\n\n    // Set total quantity and total amount in the Opportunity form\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_quantity', total_qty);\n    frappe.model.set_value(frm.doctype, frm.docname, 'total_amount', total_amount);\n}\n\nfunction createCostingSheet(salesInquiryDoc) {\n    frappe.model.with_doctype('Pricing Sheet', function() {\n        var costingSheet = frappe.model.get_new_doc('Pricing Sheet');\n        costingSheet.sales_inquiry = salesInquiryDoc.name;\n        costingSheet.project = salesInquiryDoc.project;\n        frappe.set_route('Form', 'Pricing Sheet', costingSheet.name);\n    });\n}\n\nfunction createFabrication(salesInquiryDoc) {\n    frappe.model.with_doctype('Fabrication List', function() {\n        var fabrication = frappe.model.get_new_doc('Fabrication List');\n        fabrication.oppurtunity = salesInquiryDoc.opportunity;\n        fabrication.lead = salesInquiryDoc.lead;\n        fabrication.opportunity_owner = salesInquiryDoc.opportunity_owner;\n        fabrication.project_ref = salesInquiryDoc.project;\n        fabrication.priority = salesInquiryDoc.name;\n        frappe.set_route('Form', 'Fabrication List', fabrication.name);\n    });\n}\n\n// function createEstimationRequest(frm) \n// {\n//             frappe.call({\n//                 method: 'frappe.client.insert',\n//                 args: {\n//                     doc: {\n//                         doctype: 'Estimation Request',\n//                         // creation_date: frm.doc.creation_date,\n//                         sales_inquiry: frm.doc.name,\n//                         inquiry_type: frm.doc.inquiry_type ,\n//                         client_reference: frm.doc.client_reference ,\n//                         drawing_link: frm.doc.drawing_link,\n//                         special_instruction: frm.doc.special_instruction,\n//                         customer_name: frm.doc.customer_name,\n//                         customer_location: frm.doc.customer_location,\n//                         customer_name: frm.doc.customer_name,\n//                         quotation_address_to: frm.doc.quotation_address_to,\n//                         email_id: frm.doc.email_id,\n//                         mobile_no: frm.doc.mobile_no,\n//                         technical_contact: frm.doc.technical_contact,\n//                         contact_number: frm.doc.contact_number,\n//                         submittal_link: frm.doc.submittal_link,\n//                         company: frm.doc.company,\n//                         opportunity: frm.doc.opportunity,\n//                         sales_inquiry_status: frm.doc.sales_inquiry_status,\n//                         products: frm.doc.products,\n                        \n                        \n                        \n                        \n//                         attachment_1: frm.doc.attachment_1,\n//                         attachment_2: frm.doc.attachment_2,\n//                         attachment_3: frm.doc.attachment_3,\n//                         items: frm.doc.items,\n//                         total_quantity: frm.doc.total_quantity,\n//                         total_amount: frm.doc.total_amount,\n                        \n                        \n//                     }\n//                 },\n//                 callback: function(r) {\n//                     if (!r.exc) {\n//                         frappe.msgprint(`Estimation Request ${r.message.name} saved successfully!`);\n//                         frappe.model.set_value(\"Estimation Request\" , frm.doc.name, 'estimation_request_created', 1) ;\n                        \n                        // frappe.flags.hide_save_message = true;\n\n//                         if (frm.doc.docstatus == 1)\n//                         {\n//                             frm.save('Update') ;\n//                         }\n//                         else if (frm.doc.docstatus == 0)\n//                         {\n//                             frm.save() ;\n//                         }\n//                     } else {\n//                         frappe.msgprint(`Error: ${r.exc}`);\n//                     }\n//                 }\n//             });\n// }\n\nfunction createEstimationRequest(frm) {\n\n    // Function to copy any child table rows\n    function copy_child_table(rows, child_doctype) {\n        return rows.map(r => {\n            let row = { doctype: child_doctype };\n            for (let key in r) {\n                if (![\"name\", \"parent\", \"parenttype\", \"parentfield\", \"idx\"].includes(key)) {\n                    row[key] = r[key];\n                }\n            }\n            return row;\n        });\n    }\n\n    // Your mapping\n    const mapping = {\n        \"Adhesives & Sealant\": \"adhesives_and_sealant_specification_table\",\n        \"Dampers\": \"damper_specification_table\",\n        \"Duct\": \"duct_specifications_table\",\n        \"Duct Accessories\": \"duct_accessories_table\",\n        \"Fastners\": \"fastners_specification_table\",\n        \"Gasket & Masking Tape\": \"gasket_and_masking_tape_specification_table\",\n        \"Grill\": \"grilles_table\",\n        \"Diffuser\": \"diffuser_specification\",\n        \"Louver\": \"louver_specification_table\",\n        \"Raw Material\": \"raw_materal_specification_table\",\n        \"Sound Attenuator\": \"sound_attenuator__specification_table\",\n        \"Plenum\": \"plenum_specification_table\"\n    };\n\n    // Prepare child tables\n    let child_tables = {};\n\n    // Loop through mapped tables dynamically\n    for (let key in mapping) {\n        let fieldname = mapping[key];\n        let rows = frm.doc[fieldname];\n\n        if (rows && rows.length > 0) {\n            child_tables[fieldname] = copy_child_table(rows, rows[0].doctype);\n        }\n    }\n\n    // Prepare main doc payload\n    let new_doc = {\n        doctype: 'Estimation Request',\n        product_type_table: frm.doc.product_type_table,\n        sales_inquiry: frm.doc.name,\n        inquiry_type: frm.doc.inquiry_type,\n        client_reference: frm.doc.client_reference,\n        drawing_link: frm.doc.drawing_link,\n        special_instruction: frm.doc.special_instruction,\n        customer_name: frm.doc.customer_name,\n        customer_location: frm.doc.customer_location,\n        quotation_address_to: frm.doc.quotation_address_to,\n        email_id: frm.doc.email_id,\n        mobile_no: frm.doc.mobile_no,\n        technical_contact: frm.doc.technical_contact,\n        contact_number: frm.doc.contact_number,\n        submittal_link: frm.doc.submittal_link,\n        company: frm.doc.company,\n        opportunity: frm.doc.opportunity,\n        sales_inquiry_status: frm.doc.sales_inquiry_status,\n        total_quantity: frm.doc.total_quantity,\n        total_amount: frm.doc.total_amount,\n\n\n        // items: copy_child_table(frm.doc.items || [], frm.doc.items?.[0]?.doctype),\n    };\n\n    // Merge dynamic child tables\n    Object.assign(new_doc, child_tables);\n\n    // Insert document\nfrappe.call({\n    method: 'frappe.client.insert',\n    args: { doc: new_doc },\n    callback: function (r) {\n        if (!r.exc) {\n\n            // Update flag\n            // frappe.model.set_value(\"Sales Inquiry\", frm.doc.name, \"estimation_request_created\", 1);\n\n            // // Suppress automatic save popup BEFORE saving\n            // frappe.flags.hide_save_message = true;\n\n            // if (frm.doc.docstatus == 1) {\n            //     frm.save('Update');\n            // } else if (frm.doc.docstatus == 0) {\n            //     frm.save();\n            // }\n            // frm.set_value(\"estimation_request_created\", 1);\n            // frm.save('Update');\n            // Show success FIRST\n            frappe.msgprint(`Estimation Request ${r.message.name} saved successfully!`);\n        } else {\n            frappe.msgprint(`Error: ${r.exc}`);\n        }\n    }\n});\n\n}\n\n\nfunction createQuotation(salesInquiry) {\n    frappe.model.with_doctype('Quotation', function() {\n        var quotation = frappe.model.get_new_doc('Quotation');\n\n        // Set fields in the Quotation document\n        quotation.custom_refrence = salesInquiry.name;\n        quotation.party_name = salesInquiry.customer;\n        quotation.opportunity = salesInquiry.opportunity;\n\n        // Copy items from Sales Inquiry to Quotation\n        salesInquiry.items.forEach(function(item) {\n            var row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n            row.item_code = item.item_code;\n            row.qty = item.qty;\n            row.uom = item.uom;\n            row.item_name = item.item_name;\n            row.brand = item.brand;\n            row.item_group = item.item_group;\n            row.rate = item.rate;\n            row.amount = item.amount;\n            row.description = item.description;\n        });\n\n        // Calculate total amount\n        quotation.total_amount = quotation.items.reduce(function(acc, item) {\n            return acc + item.amount;\n        }, 0);\n\n        // Open the Quotation in a new tab without saving\n        frappe.set_route('Form', 'Quotation', quotation.name);\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication Filter",
  "enabled": 0,
  "modified": "2024-12-19 13:21:36.976567",
  "module": null,
  "name": "multi fabrication travel",
  "script": "frappe.ui.form.on('Fabrication Filter', {\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 0) {\n            frm.add_custom_button(\n                __(\"Sales Quotation\"),\n                function() {\n                    createQuotation(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n    }\n});\n\n\n\nasync function createQuotation(fabricationFilter) {\n    try {\n        // Ensure Quotation doctype is loaded\n        await frappe.model.with_doctype('Quotation');\n\n        // Create a new Quotation document\n        let quotation = frappe.model.get_new_doc('Quotation');\n        \n        if (!quotation) {\n            console.error('Failed to create new Quotation document');\n            return;\n        }\n\n        // Initialize the new Quotation\n        quotation.quotation_to = \"Customer\";\n        quotation.party_name = fabricationFilter.customer;\n        quotation.project = fabricationFilter.project;\n\n        // Aggregate Fabrication List references from filtered_fabrication_list\n        let fabricationPromises = fabricationFilter.filtered_fabrication_list.map(async (item) => {\n            try {\n                return await frappe.db.get_doc('Fabrication List', item.fabrication);\n            } catch (error) {\n                console.error(`Error fetching Fabrication List ${item.fabrication}:`, error);\n            }\n        });\n\n        // Fetch all Fabrication List documents\n        let fabrications = await Promise.all(fabricationPromises);\n        fabrications = fabrications.filter(fab => fab); // Remove any undefined entries\n\n        // Aggregate items by item_code and item_name\n        let itemAggregates = {};\n        let fabricationRefs = []; // Array to store fabrication references\n\n        fabrications.forEach(fab => {\n            // Add to the fabricationRefs array\n            fabricationRefs.push(fab.name);\n\n            fab.fabrication_table.forEach(tableItem => {\n                let key = tableItem.item_code;\n                if (!itemAggregates[key]) {\n                    itemAggregates[key] = {\n                        item_code: tableItem.item,\n                        item_name: tableItem.item_names, // Use item_names from fabrication_table\n                        uom: tableItem.uom, // Use uom from fabrication_table\n                        custom_s1: tableItem.custom_s1,\n                        custom_s2: tableItem.custom_s2,\n                        custom_s3: tableItem.custom_s3,\n                        custom_s4: tableItem.custom_s4,\n                        custom_lengthangle: tableItem.custom_lengthangle,\n                        custom_gaugethickess: tableItem.custom_gaugethickess,\n                        qty: 0, // Aggregate quantity\n                        lm: 0, // Aggregate linear meters\n                        kg: 0, // Aggregate kilograms\n                        area_in_sqm: 0, // Aggregate area in sqm\n                        custom_fixing_1st_side: tableItem.custom_fixing_1st_side,\n                        custom_stiffener_total_qty: tableItem.custom_stiffener_total_qty,\n                        custom_fixing_2nd_side: tableItem.custom_fixing_2nd_side,\n                        custom_vanes_nos: tableItem.custom_vanes_nos,\n                        custom_stiffener: tableItem.custom_stiffener,\n                        custom_joint: tableItem.custom_joint,\n                        custom_lm: tableItem.lm,\n                        custom_kg: tableItem.kg,\n                        custom_area_in_sqm: tableItem.area_in_sqm\n                    };\n                }\n                itemAggregates[key].qty += tableItem.qty; // Aggregate quantity\n                itemAggregates[key].lm += tableItem.lm; // Aggregate linear meters\n                itemAggregates[key].kg += tableItem.kg; // Aggregate kilograms\n                itemAggregates[key].area_in_sqm += tableItem.area_in_sqm; // Aggregate area in sqm\n            });\n        });\n\n        // Populate Quotation Items with aggregated data\n        let itemPromises = Object.values(itemAggregates).map(async (aggregate) => {\n            let row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n\n            // Map fields from aggregated data to Quotation Item\n            row.item_code = aggregate.item_code;\n            row.item_name = aggregate.item_name; // Set item_name from aggregated data\n            row.uom = aggregate.uom; // Set uom from aggregated data\n            row.custom_s1 = aggregate.custom_s1;\n            row.custom_s2 = aggregate.custom_s2;\n            row.custom_s3 = aggregate.custom_s3;\n            row.custom_s4 = aggregate.custom_s4;\n            row.custom_lengthangle = aggregate.custom_lengthangle;\n            row.custom_gaugethickess = aggregate.custom_gaugethickess;\n            row.qty = aggregate.qty;\n            row.custom_lm = aggregate.lm; // Add linear meters\n            row.custom_kg = aggregate.kg; // Add kilograms\n            row.custom_area_in_sqm = aggregate.area_in_sqm; // Add area in sqm\n            row.custom_fixing_1st_side = aggregate.custom_fixing_1st_side;\n            row.custom_stiffener_total_qty = aggregate.custom_stiffener_total_qty;\n            row.custom_fixing_2nd_side = aggregate.custom_fixing_2nd_side;\n            row.custom_vanes_nos = aggregate.custom_vanes_nos;\n            row.custom_stiffener = aggregate.custom_stiffener;\n            row.custom_joint = aggregate.custom_joint;\n\n            // Fetch item price\n            try {\n                let priceResponse = await frappe.db.get_list('Item Price', {\n                    filters: {\n                        item_code: row.item_code,\n                        selling: 1\n                    },\n                    fields: ['price_list_rate'],\n                    order_by: 'valid_from desc',\n                    limit_page_length: 1\n                });\n\n                if (priceResponse.length > 0) {\n                    row.rate = priceResponse[0].price_list_rate;\n                } else {\n                    console.error('No selling price found for item:', aggregate.item_code);\n                }\n            } catch (error) {\n                console.error('Error fetching item price:', error);\n            }\n        });\n\n        // Wait for all promises to resolve\n        await Promise.all(itemPromises);\n\n        // Populate the custom_multi_fabrication_to_quotation table with fabrication references\n        quotation.custom_multi_fabrication_to_quotation = fabricationRefs.map(ref => {\n            return {\n                fabrication: ref\n            };\n        });\n\n        // Redirect to the new Quotation form\n        frappe.set_route('Form', 'Quotation', quotation.name);\n\n    } catch (error) {\n        console.error('Error creating Quotation:', error);\n    }\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// frappe.ui.form.on('Fabrication Filter', {\n//     refresh: function(frm) {\n//         if (frm.doc.docstatus === 0) {\n//             frm.add_custom_button(\n//                 __(\"Sales Quotation\"),\n//                 function() {\n//                     createQuotation(frm.doc);\n//                 },\n//                 __(\"Create\")\n//             );\n//         }\n//     }\n// });\n\n\n\n// async function createQuotation(fabricationFilter) {\n//     try {\n//         // Ensure Quotation doctype is loaded\n//         await frappe.model.with_doctype('Quotation');\n//         // Create a new Quotation document\n//         let quotation = frappe.model.get_new_doc('Quotation');\n        \n//         if (!quotation) {\n//             console.error('Failed to create new Quotation document');\n//             return;\n//         }\n\n//         // Initialize the new Quotation\n//         quotation.quotation_to = \"Customer\";\n//         quotation.party_name = fabricationFilter.client_ref;\n\n//         // Aggregate Fabrication List references from filtered_fabrication_list\n//         let fabricationPromises = fabricationFilter.filtered_fabrication_list.map(async (item) => {\n//             try {\n//                 return await frappe.db.get_doc('Fabrication List', item.fabrication);\n//             } catch (error) {\n//                 console.error(`Error fetching Fabrication List ${item.fabrication}:`, error);\n//             }\n//         });\n\n//         // Fetch all Fabrication List documents\n//         let fabrications = await Promise.all(fabricationPromises);\n//         fabrications = fabrications.filter(fab => fab); // Remove any undefined entries\n\n//         // Aggregate items by item_code and item_name\n//         let itemAggregates = {};\n//         fabrications.forEach(fab => {\n//             fab.fabrication_table.forEach(tableItem => {\n//                 let key = tableItem.item_code;\n//                 if (!itemAggregates[key]) {\n//                     itemAggregates[key] = {\n//                         item_code: tableItem.item_code,\n//                         custom_s1: tableItem.custom_s1,\n//                         custom_s2: tableItem.custom_s2,\n//                         custom_s3: tableItem.custom_s3,\n//                         custom_s4: tableItem.custom_s4,\n//                         custom_lengthangle: tableItem.custom_lengthangle,\n//                         custom_gaugethickess: tableItem.custom_gaugethickess,\n//                         qty: 0, // Aggregate quantity\n//                         lm: 0, // Aggregate linear meters\n//                         kg: 0, // Aggregate kilograms\n//                         area_in_sqm: 0, // Aggregate area in sqm\n//                         custom_fixing_1st_side: tableItem.custom_fixing_1st_side,\n//                         custom_stiffener_total_qty: tableItem.custom_stiffener_total_qty,\n//                         custom_fixing_2nd_side: tableItem.custom_fixing_2nd_side,\n//                         custom_vanes_nos: tableItem.custom_vanes_nos,\n//                         custom_stiffener: tableItem.custom_stiffener,\n//                         custom_joint: tableItem.custom_joint,\n//                         custom_lm: tableItem.lm,\n//                         custom_kg: tableItem.kg,\n//                         custom_area_in_sqm: tableItem.area_in_sqm\n//                     };\n//                 }\n//                 itemAggregates[key].qty += tableItem.qty; // Aggregate quantity\n//                 itemAggregates[key].lm += tableItem.lm; // Aggregate linear meters\n//                 itemAggregates[key].kg += tableItem.kg; // Aggregate kilograms\n//                 itemAggregates[key].area_in_sqm += tableItem.area_in_sqm; // Aggregate area in sqm\n//             });\n//         });\n\n//         // Populate Quotation Items with aggregated data\n//         let itemPromises = Object.values(itemAggregates).map(async (aggregate) => {\n//             let row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n\n//             // Map fields from aggregated data to Quotation Item\n//             row.item_code = aggregate.item_code;\n//             row.custom_s1 = aggregate.custom_s1;\n//             row.custom_s2 = aggregate.custom_s2;\n//             row.custom_s3 = aggregate.custom_s3;\n//             row.custom_s4 = aggregate.custom_s4;\n//             row.custom_lengthangle = aggregate.custom_lengthangle;\n//             row.custom_gaugethickess = aggregate.custom_gaugethickess;\n//             row.qty = aggregate.qty;\n//             row.custom_lm = aggregate.lm; // Add linear meters\n//             row.custom_kg = aggregate.kg; // Add kilograms\n//             row.custom_area_in_sqm = aggregate.area_in_sqm; // Add area in sqm\n//             row.custom_fixing_1st_side = aggregate.custom_fixing_1st_side;\n//             row.custom_stiffener_total_qty = aggregate.custom_stiffener_total_qty;\n//             row.custom_fixing_2nd_side = aggregate.custom_fixing_2nd_side;\n//             row.custom_vanes_nos = aggregate.custom_vanes_nos;\n//             row.custom_stiffener = aggregate.custom_stiffener;\n//             row.custom_joint = aggregate.custom_joint;\n\n//             // Fetch item details and price\n//             try {\n//                 let [itemResponse, priceResponse] = await Promise.all([\n//                     frappe.db.get_value('Item', aggregate.item_code, ['item_name', 'stock_uom', 'description']),\n//                     frappe.db.get_list('Item Price', {\n//                         filters: {\n//                             item_code: aggregate.item_code,\n//                             selling: 1\n//                         },\n//                         fields: ['price_list_rate'],\n//                         order_by: 'valid_from desc',\n//                         limit_page_length: 1\n//                     })\n//                 ]);\n\n//                 if (itemResponse.message) {\n//                     row.item_name = itemResponse.message.item_name;\n//                     row.uom = itemResponse.message.stock_uom;\n//                     row.description = itemResponse.message.description;\n\n//                     if (priceResponse.length > 0) {\n//                         row.rate = priceResponse[0].price_list_rate;\n//                     } else {\n//                         console.error('No selling price found for item:', aggregate.item_code);\n//                     }\n//                 } else {\n//                     console.error('No item details found for item:', aggregate.item_code);\n//                 }\n//             } catch (error) {\n//                 console.error('Error fetching item details or price:', error);\n//             }\n//         });\n\n//         // Wait for all promises to resolve\n//         await Promise.all(itemPromises);\n\n//         // Redirect to the new Quotation form\n//         frappe.set_route('Form', 'Quotation', quotation.name);\n\n//     } catch (error) {\n//         console.error('Error creating Quotation:', error);\n//     }\n// }\n\n\n\n\n// frappe.ui.form.on('Fabrication Filter', {\n//     refresh: function(frm) {\n//         if (frm.doc.docstatus === 0) {\n//             frm.add_custom_button(\n//                 __(\"Sales Quotation\"),\n//                 function() {\n//                     createQuotation(frm.doc);\n//                 },\n//                 __(\"Create\")\n//             );\n//         }\n//     }\n// });\n\n// async function createQuotation(fabricationFilter) {\n//     try {\n//         // Ensure Quotation doctype is loaded\n//         await frappe.model.with_doctype('Quotation');\n//         // Create a new Quotation document\n//         let quotation = frappe.model.get_new_doc('Quotation');\n        \n//         if (!quotation) {\n//             console.error('Failed to create new Quotation document');\n//             return;\n//         }\n\n//         // Initialize the new Quotation\n//         quotation.quotation_to = \"Customer\";\n//         quotation.party_name = fabricationFilter.client_ref;\n\n//         // Aggregate Fabrication List references from filtered_fabrication_list\n//         let fabricationPromises = fabricationFilter.filtered_fabrication_list.map(async (item) => {\n//             try {\n//                 return await frappe.db.get_doc('Fabrication List', item.fabrication);\n//             } catch (error) {\n//                 console.error(`Error fetching Fabrication List ${item.fabrication}:`, error);\n//             }\n//         });\n\n//         // Fetch all Fabrication List documents\n//         let fabrications = await Promise.all(fabricationPromises);\n//         fabrications = fabrications.filter(fab => fab); // Remove any undefined entries\n\n//         // Aggregate items by item_code and item_name\n//         let itemAggregates = {};\n//         fabrications.forEach(fab => {\n//             fab.fabrication_table.forEach(tableItem => {\n//                 let key = tableItem.item_code;\n//                 if (!itemAggregates[key]) {\n//                     itemAggregates[key] = {\n//                         item_code: tableItem.item_code,\n//                         custom_s1: tableItem.custom_s1,\n//                         custom_s2: tableItem.custom_s2,\n//                         custom_s3: tableItem.custom_s3,\n//                         custom_s4: tableItem.custom_s4,\n//                         custom_lengthangle: tableItem.custom_lengthangle,\n//                         custom_gaugethickess: tableItem.custom_gaugethickess,\n//                         qty: 0, // Aggregate quantity\n//                         lm: 0, // Aggregate linear meters\n//                         kg: 0, // Aggregate kilograms\n//                         area_in_sqm: 0, // Aggregate area in sqm\n//                         custom_fixing_1st_side: tableItem.custom_fixing_1st_side,\n//                         custom_stiffener_total_qty: tableItem.custom_stiffener_total_qty,\n//                         custom_fixing_2nd_side: tableItem.custom_fixing_2nd_side,\n//                         custom_vanes_nos: tableItem.custom_vanes_nos,\n//                         custom_stiffener: tableItem.custom_stiffener,\n//                         custom_joint: tableItem.custom_joint,\n//                         custom_lm: tableItem.lm,\n//                         custom_kg: tableItem.kg,\n//                         custom_area_in_sqm: tableItem.area_in_sqm\n//                     };\n//                 }\n//                 itemAggregates[key].qty += tableItem.qty; // Aggregate quantity\n//                 itemAggregates[key].lm += tableItem.lm; // Aggregate linear meters\n//                 itemAggregates[key].kg += tableItem.kg; // Aggregate kilograms\n//                 itemAggregates[key].area_in_sqm += tableItem.area_in_sqm; // Aggregate area in sqm\n//             });\n//         });\n\n//         // Populate Quotation Items with aggregated data\n//         let itemPromises = Object.values(itemAggregates).map(async (aggregate) => {\n//             let row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n\n//             // Map fields from aggregated data to Quotation Item\n//             row.item_code = aggregate.item_code;\n//             row.custom_s1 = aggregate.custom_s1;\n//             row.custom_s2 = aggregate.custom_s2;\n//             row.custom_s3 = aggregate.custom_s3;\n//             row.custom_s4 = aggregate.custom_s4;\n//             row.custom_lengthangle = aggregate.custom_lengthangle;\n//             row.custom_gaugethickess = aggregate.custom_gaugethickess;\n//             row.qty = aggregate.qty;\n//             row.custom_lm = aggregate.lm; // Add linear meters\n//             row.custom_kg = aggregate.kg; // Add kilograms\n//             row.custom_area_in_sqm = aggregate.area_in_sqm; // Add area in sqm\n//             row.custom_fixing_1st_side = aggregate.custom_fixing_1st_side;\n//             row.custom_stiffener_total_qty = aggregate.custom_stiffener_total_qty;\n//             row.custom_fixing_2nd_side = aggregate.custom_fixing_2nd_side;\n//             row.custom_vanes_nos = aggregate.custom_vanes_nos;\n//             row.custom_stiffener = aggregate.custom_stiffener;\n//             row.custom_joint = aggregate.custom_joint;\n\n//             // Fetch item details and price\n//             try {\n//                 let [itemResponse, priceResponse] = await Promise.all([\n//                     frappe.db.get_value('Item', aggregate.item_code, ['item_name', 'stock_uom', 'description']),\n//                     frappe.db.get_list('Item Price', {\n//                         filters: {\n//                             item_code: aggregate.item_code,\n//                             selling: 1\n//                         },\n//                         fields: ['price_list_rate'],\n//                         order_by: 'valid_from desc',\n//                         limit_page_length: 1\n//                     })\n//                 ]);\n\n//                 if (itemResponse.message) {\n//                     row.item_name = itemResponse.message.item_name;\n//                     row.uom = itemResponse.message.stock_uom;\n//                     row.description = itemResponse.message.description;\n\n//                     if (priceResponse.length > 0) {\n//                         row.rate = priceResponse[0].price_list_rate;\n//                     } else {\n//                         console.error('No selling price found for item:', aggregate.item_code);\n//                     }\n//                 } else {\n//                     console.error('No item details found for item:', aggregate.item_code);\n//                 }\n//             } catch (error) {\n//                 console.error('Error fetching item details or price:', error);\n//             }\n//         });\n\n//         // Populate Fabrication Template Table\n//         let templatePromises = fabrications.flatMap(fab => {\n//             return fab.table.map(async (templateItem) => {\n//                 let row = frappe.model.add_child(quotation, \"Fabrication Template Table\", \"custom_fabrication_template\");\n\n//                 // Map fields from Fabrication Template Item to Fabrication Template Table\n//                 row.item = templateItem.item;\n//                 row.item_name = templateItem.item_name;\n//                 row.from_range = templateItem.from_range;\n//                 row.to_range = templateItem.to_range;\n//                 row.uom = templateItem.uom;\n//                 row.thickness = templateItem.thickness;\n//                 row.quantity = templateItem.quantity;\n//                 row.area_in_sqm = templateItem.area_in_sqm;\n//                 row.lm = templateItem.lm;\n//                 row.kg = templateItem.kg;\n//             });\n//         });\n\n//         // Wait for all promises to resolve\n//         await Promise.all([...itemPromises, ...templatePromises]);\n\n//         // Redirect to the new Quotation form\n//         frappe.set_route('Form', 'Quotation', quotation.name);\n\n//     } catch (error) {\n//         console.error('Error creating Quotation:', error);\n//     }\n// }\n\n\n\n// frappe.ui.form.on('Fabrication Filter', {\n//     refresh: function(frm) {\n//         if (frm.doc.docstatus === 0) {\n//             frm.add_custom_button(\n//                 __(\"Sales Quotation\"),\n//                 function() {\n//                     createQuotation(frm.doc);\n//                 },\n//                 __(\"Create\")\n//             );\n//         }\n//     }\n// });\n\n// async function createQuotation(fabricationFilter) {\n//     try {\n//         // Ensure Quotation doctype is loaded\n//         await frappe.model.with_doctype('Quotation');\n//         // Create a new Quotation document\n//         let quotation = frappe.model.get_new_doc('Quotation');\n        \n//         if (!quotation) {\n//             console.error('Failed to create new Quotation document');\n//             return;\n//         }\n\n//         // Initialize the new Quotation\n//         quotation.quotation_to = \"Customer\";\n//         quotation.party_name = fabricationFilter.client_ref;\n\n//         // Aggregate Fabrication List references from filtered_fabrication_list\n//         let fabricationPromises = fabricationFilter.filtered_fabrication_list.map(async (item) => {\n//             try {\n//                 return await frappe.db.get_doc('Fabrication List', item.fabrication);\n//             } catch (error) {\n//                 console.error(`Error fetching Fabrication List ${item.fabrication}:`, error);\n//             }\n//         });\n\n//         // Fetch all Fabrication List documents\n//         let fabrications = await Promise.all(fabricationPromises);\n//         fabrications = fabrications.filter(fab => fab); // Remove any undefined entries\n\n//         // Aggregate items by item_code and item_name\n//         let itemAggregates = {};\n//         fabrications.forEach(fab => {\n//             fab.fabrication_table.forEach(tableItem => {\n//                 let key = tableItem.item_code;\n//                 if (!itemAggregates[key]) {\n//                     itemAggregates[key] = {\n//                         item_code: tableItem.item_code,\n//                         custom_s1: tableItem.custom_s1,\n//                         custom_s2: tableItem.custom_s2,\n//                         custom_s3: tableItem.custom_s3,\n//                         custom_s4: tableItem.custom_s4,\n//                         custom_lengthangle: tableItem.custom_lengthangle,\n//                         custom_gaugethickess: tableItem.custom_gaugethickess,\n//                         qty: 0, // Aggregate quantity\n//                         custom_fixing_1st_side: tableItem.custom_fixing_1st_side,\n//                         custom_stiffener_total_qty: tableItem.custom_stiffener_total_qty,\n//                         custom_fixing_2nd_side: tableItem.custom_fixing_2nd_side,\n//                         custom_vanes_nos: tableItem.custom_vanes_nos,\n//                         custom_stiffener: tableItem.custom_stiffener,\n//                         custom_joint: tableItem.custom_joint,\n//                         custom_lm: tableItem.lm,\n//                         custom_kg: tableItem.kg,\n//                         custom_area_in_sqm: tableItem.area_in_sqm\n//                     };\n//                 }\n//                 itemAggregates[key].qty += tableItem.qty; // Aggregate quantity\n//             });\n//         });\n\n//         // Populate Quotation Items with aggregated data\n//         let itemPromises = Object.values(itemAggregates).map(async (aggregate) => {\n//             let row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n\n//             // Map fields from aggregated data to Quotation Item\n//             row.item_code = aggregate.item_code;\n//             row.custom_s1 = aggregate.custom_s1;\n//             row.custom_s2 = aggregate.custom_s2;\n//             row.custom_s3 = aggregate.custom_s3;\n//             row.custom_s4 = aggregate.custom_s4;\n//             row.custom_lengthangle = aggregate.custom_lengthangle;\n//             row.custom_gaugethickess = aggregate.custom_gaugethickess;\n//             row.qty = aggregate.qty;\n//             row.custom_fixing_1st_side = aggregate.custom_fixing_1st_side;\n//             row.custom_stiffener_total_qty = aggregate.custom_stiffener_total_qty;\n//             row.custom_fixing_2nd_side = aggregate.custom_fixing_2nd_side;\n//             row.custom_vanes_nos = aggregate.custom_vanes_nos;\n//             row.custom_stiffener = aggregate.custom_stiffener;\n//             row.custom_joint = aggregate.custom_joint;\n\n//             // Fetch item details and price\n//             try {\n//                 let [itemResponse, priceResponse] = await Promise.all([\n//                     frappe.db.get_value('Item', aggregate.item_code, ['item_name', 'stock_uom', 'description']),\n//                     frappe.db.get_list('Item Price', {\n//                         filters: {\n//                             item_code: aggregate.item_code,\n//                             selling: 1\n//                         },\n//                         fields: ['price_list_rate'],\n//                         order_by: 'valid_from desc',\n//                         limit_page_length: 1\n//                     })\n//                 ]);\n\n//                 if (itemResponse.message) {\n//                     row.item_name = itemResponse.message.item_name;\n//                     row.uom = itemResponse.message.stock_uom;\n//                     row.description = itemResponse.message.description;\n\n//                     if (priceResponse.length > 0) {\n//                         row.rate = priceResponse[0].price_list_rate;\n//                     } else {\n//                         console.error('No selling price found for item:', aggregate.item_code);\n//                     }\n//                 } else {\n//                     console.error('No item details found for item:', aggregate.item_code);\n//                 }\n//             } catch (error) {\n//                 console.error('Error fetching item details or price:', error);\n//             }\n//         });\n\n//         // Populate Fabrication Template Table\n//         let templatePromises = fabrications.flatMap(fab => {\n//             return fab.table.map(async (templateItem) => {\n//                 let row = frappe.model.add_child(quotation, \"Fabrication Template Table\", \"custom_fabrication_template\");\n\n//                 // Map fields from Fabrication Template Item to Fabrication Template Table\n//                 row.item = templateItem.item;\n//                 row.item_name = templateItem.item_name;\n//                 row.from_range = templateItem.from_range;\n//                 row.to_range = templateItem.to_range;\n//                 row.uom = templateItem.uom;\n//                 row.thickness = templateItem.thickness;\n//                 row.quantity = templateItem.quantity;\n//                 row.area_in_sqm = templateItem.area_in_sqm;\n//                 row.lm = templateItem.lm;\n//                 row.kg = templateItem.kg;\n//             });\n//         });\n\n//         // Wait for all promises to resolve\n//         await Promise.all([...itemPromises, ...templatePromises]);\n\n//         frappe.set_route('Form', 'Quotation', quotation.name);\n\n//     } catch (error) {\n//         console.error('Error creating Quotation:', error);\n//     }\n// }\n\n// // frappe.ui.form.on('Fabrication Filter', {\n// //     refresh: function(frm) {\n// //         if (frm.doc.docstatus === 0) {\n// //             frm.add_custom_button(\n// //                 __(\"Sales Quotation\"),\n// //                 function() {\n// //                     createQuotation(frm.doc);\n// //                 },\n// //                 __(\"Create\")\n// //             );\n// //         }\n// //     }\n// // });\n\n// // async function createQuotation(fabricationFilter) {\n// //     try {\n// //         // Ensure Quotation doctype is loaded\n// //         await frappe.model.with_doctype('Quotation');\n// //         // Create a new Quotation document\n// //         let quotation = frappe.model.get_new_doc('Quotation');\n        \n// //         if (!quotation) {\n// //             console.error('Failed to create new Quotation document');\n// //             return;\n// //         }\n\n// //         // Initialize the new Quotation\n// //         quotation.quotation_to = \"Customer\";\n// //         quotation.party_name = fabricationFilter.client_ref;\n\n// //         // Collect Fabrication List references from filtered_fabrication_list\n// //         let fabricationPromises = fabricationFilter.filtered_fabrication_list.map(async (item) => {\n// //             try {\n// //                 return await frappe.db.get_doc('Fabrication List', item.fabrication);\n// //             } catch (error) {\n// //                 console.error(`Error fetching Fabrication List ${item.fabrication}:`, error);\n// //             }\n// //         });\n\n// //         // Fetch all Fabrication List documents\n// //         let fabrications = await Promise.all(fabricationPromises);\n// //         fabrications = fabrications.filter(fab => fab); // Remove any undefined entries\n\n// //         // Populate Quotation Items\n// //         let itemPromises = fabrications.flatMap(fab => {\n// //             return fab.fabrication_table.map(async (tableItem) => {\n// //                 let row = frappe.model.add_child(quotation, \"Quotation Item\", \"items\");\n\n// //                 // Map fields from Fabrication Item to Quotation Item\n// //                 row.item_code = tableItem.item_code;\n// //                 row.custom_s1 = tableItem.custom_s1;\n// //                 row.custom_s2 = tableItem.custom_s2;\n// //                 row.custom_s3 = tableItem.custom_s3;\n// //                 row.custom_s4 = tableItem.custom_s4;\n// //                 row.custom_lengthangle = tableItem.custom_lengthangle;\n// //                 row.custom_gaugethickess = tableItem.custom_gaugethickess;\n// //                 row.qty = tableItem.qty;\n// //                 row.custom_fixing_1st_side = tableItem.custom_fixing_1st_side;\n// //                 row.custom_stiffener_total_qty = tableItem.custom_stiffener_total_qty;\n// //                 row.custom_fixing_2nd_side = tableItem.custom_fixing_2nd_side;\n// //                 row.custom_vanes_nos = tableItem.custom_vanes_nos;\n// //                 row.custom_stiffener = tableItem.custom_stiffener;\n// //                 row.custom_joint = tableItem.custom_joint;\n\n// //                 // Fetch item details and price\n// //                 try {\n// //                     let [itemResponse, priceResponse] = await Promise.all([\n// //                         frappe.db.get_value('Item', tableItem.item_code, ['item_name', 'stock_uom', 'description']),\n// //                         frappe.db.get_list('Item Price', {\n// //                             filters: {\n// //                                 item_code: tableItem.item_code,\n// //                                 selling: 1\n// //                             },\n// //                             fields: ['price_list_rate'],\n// //                             order_by: 'valid_from desc',\n// //                             limit_page_length: 1\n// //                         })\n// //                     ]);\n\n// //                     if (itemResponse.message) {\n// //                         row.item_name = itemResponse.message.item_name;\n// //                         row.uom = itemResponse.message.stock_uom;\n// //                         row.description = itemResponse.message.description;\n\n// //                         if (priceResponse.length > 0) {\n// //                             row.rate = priceResponse[0].price_list_rate;\n// //                         } else {\n// //                             console.error('No selling price found for item:', tableItem.item_code);\n// //                         }\n// //                     } else {\n// //                         console.error('No item details found for item:', tableItem.item_code);\n// //                     }\n// //                 } catch (error) {\n// //                     console.error('Error fetching item details or price:', error);\n// //                 }\n// //             });\n// //         });\n\n// //         // Populate Fabrication Template Table\n// //         let templatePromises = fabrications.flatMap(fab => {\n// //             return fab.table.map(async (templateItem) => {\n// //                 let row = frappe.model.add_child(quotation, \"Fabrication Template Table\", \"custom_fabrication_template\");\n\n// //                 // Map fields from Fabrication Template Item to Fabrication Template Table\n// //                 row.item = templateItem.item;\n// //                 row.item_name = templateItem.item_name;\n// //                 row.from_range = templateItem.from_range;\n// //                 row.to_range = templateItem.to_range;\n// //                 row.uom = templateItem.uom;\n// //                 row.thickness = templateItem.thickness;\n// //                 row.quantity = templateItem.quantity;\n// //                 row.area_in_sqm = templateItem.area_in_sqm;\n// //                 row.lm = templateItem.lm;\n// //                 row.kg = templateItem.kg;\n// //             });\n// //         });\n\n// //         // Wait for all promises to resolve\n// //         await Promise.all([...itemPromises, ...templatePromises]);\n\n// //         frappe.set_route('Form', 'Quotation', quotation.name);\n\n// //     } catch (error) {\n// //         console.error('Error creating Quotation:', error);\n// //     }\n// // }\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication Filter",
  "enabled": 0,
  "modified": "2024-12-19 13:21:27.641608",
  "module": null,
  "name": "fabrication Filter",
  "script": "frappe.ui.form.on('Fabrication Filter', {\n    refresh: function(frm) {\n        // Add the button to the form\n        frm.set_query('sales_inquiry', function() {\n            return {\n                filters: {\n                    'docstatus': 1 // Filter to include only records with docstatus 1\n                }\n            };\n        });\n        frm.add_custom_button(__('Create Filtered Fabrication List'), function() {\n            // Fetch Fabrication List records based on the current form's filters\n            let selected_sales_inquiries = frm.doc.sales_inquiry \n                ? frm.doc.sales_inquiry.map(item => item.sales_inquiry) \n                : [];\n            console.log(selected_sales_inquiries);\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Fabrication List',\n                    filters: [\n                        \n                        ['normal', 'between', [frm.doc.from_date, frm.doc.to_date]],\n                        ['client_ref', '=', frm.doc.customer],\n                        ['project_ref', '=', frm.doc.project],\n                        ['priority', 'IN', selected_sales_inquiries],\n                        ['docstatus', '=', 1]\n                        \n                    ],\n                    fields: ['name', 'client_ref', 'normal', 'project_ref', 'lead', 'priority', 'oppurtunity', 'fabrication_template'],\n                    limit_page_length: 1000 // Specify the maximum limit here\n                },\n                callback: function(response) {\n                    if (response && response.message) {\n                        let fabrication_list = response.message;\n                        \n                        // Clear existing rows in the filtered_fabrication_list table\n                        frm.clear_table('filtered_fabrication_list');\n                        \n                        // Prepare data for appending to the table\n                        fabrication_list.forEach(f => {\n                            let row = frm.add_child('filtered_fabrication_list');\n                            row.fabrication = f.name;\n                            row.customer = f.client_ref;\n                            row.date = f.normal;\n                            row.project = f.project_ref;\n                            row.lead = f.lead;\n                            row.sales_inquiry = f.priority;\n                            row.oppurtunity = f.oppurtunity;\n                            row.fabrication_template = f.fabrication_template;\n                        });\n                        \n                        // Refresh the table to show new data\n                        frm.refresh_field('filtered_fabrication_list');\n                        \n                        frappe.msgprint(__('Filtered Fabrication List updated successfully.'));\n                    } else {\n                        frappe.msgprint(__('No Fabrication List records found.'));\n                    }\n                },\n                error: function(error) {\n                    frappe.msgprint(__('An error occurred while fetching Fabrication List records.'));\n                }\n            });\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 0,
  "modified": "2025-09-26 16:02:07.712753",
  "module": null,
  "name": "Insert Child Table",
  "script": "frappe.ui.form.on('Quotation', {\n\tcustom_quotation_template(frm) {\n\t    if (frm.doc.custom_quotation_template) {\n\t\t    frappe.call({\n                method: \"frappe.client.get\",\n                args: {\n                    doctype: \"Quotation Template\",\n                    name: frm.doc.custom_quotation_template,\n                },\n                callback(r) {\n                    if(r.message) {\n                        var ftr = r.message.quotation_items;\n                        frm.set_value(\"items\", []);\n                        for (var i = 0; i < ftr.length; i++) {\n                            var ele = ftr[i];\n                            var row = frappe.model.add_child(\n                              frm.doc,\n                              \"Quotation Item\",\n                              \"items\"\n                            );\n                            row.item_code = ele.item;\n                            row.item_name = ele.item_name;\n                            row.description = ele.item_name;\n                            row.uom = ele.uom;\n                            row.qty = ele.quantity;\n                            row.custom_stiffener_total_qty = ele.stiffener_total_qty;\n                            row.custom_fixing_1st_side = ele.fixing_1st_side;\n                            row.custom_fixing_2nd_side = ele.fixing_2nd_side;\n                            row.custom_vanes_nos = ele.vanes_nos;\n                            row.custom_stiffener_total_qty = ele.stiffener_total_qty;\n                            row.custom_kg = ele.kg;\n                            row.custom_area_in_sqm = ele.area_in_sqm;\n                            row.custom_lm = ele.lm;\n                            \n                        }\n                        refresh_field(\"items\");\n                    }\n                }\n            });\n\t    }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2024-09-24 14:07:18.731045",
  "module": null,
  "name": "Customer-Form",
  "script": "frappe.ui.form.on('Customer', {\n\tonload(frm) {\n\t    if(frm.doc.custom_gps_location){\n    \t\tfrm.set_df_property('custom_gps_location_map','options','<div class=\"mapouter\"><div class=\"gmap_canvas\"><iframe width=100% height=\"300\" id=\"gmap_canvas\" src=\"https://maps.google.com/maps?q='+frm.doc.custom_gps_location+'&t=&z=17&ie=UTF8&iwloc=&output=embed\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\"></iframe><a href=\"https://yt2.org/youtube-to-mp3-ALeKk00qEW0sxByTDSpzaRvl8WxdMAeMytQ1611842368056QMMlSYKLwAsWUsAfLipqwCA2ahUKEwiikKDe5L7uAhVFCuwKHUuFBoYQ8tMDegUAQCSAQCYAQCqAQdnd3Mtd2l6\"></a><br><style>.mapouter{position:relative;text-align:right;height:300px;width:100%;}</style><style>.gmap_canvas {overflow:hidden;background:none!important;height:300px;width:100%;}</style></div></div>');\n            frm.refresh_field('custom_gps_location_map');\n\t    }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2024-09-24 14:50:27.084160",
  "module": null,
  "name": "Project-Form-GPS",
  "script": "frappe.ui.form.on('Project', {\n\tonload(frm) {\n\t    if(frm.doc.custom_gps_location){\n    \t\tfrm.set_df_property('custom_gps_location_map','options','<div class=\"mapouter\"><div class=\"gmap_canvas\"><iframe width=100% height=\"300\" id=\"gmap_canvas\" src=\"https://maps.google.com/maps?q='+frm.doc.custom_gps_location+'&t=&z=17&ie=UTF8&iwloc=&output=embed\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\"></iframe><a href=\"https://yt2.org/youtube-to-mp3-ALeKk00qEW0sxByTDSpzaRvl8WxdMAeMytQ1611842368056QMMlSYKLwAsWUsAfLipqwCA2ahUKEwiikKDe5L7uAhVFCuwKHUuFBoYQ8tMDegUAQCSAQCYAQCqAQdnd3Mtd2l6\"></a><br><style>.mapouter{position:relative;text-align:right;height:300px;width:100%;}</style><style>.gmap_canvas {overflow:hidden;background:none!important;height:300px;width:100%;}</style></div></div>');\n            frm.refresh_field('custom_gps_location_map');\n\t    }\n\t}\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Trip",
  "enabled": 1,
  "modified": "2024-09-30 15:41:29.393125",
  "module": null,
  "name": "Calculate Total Distance Covered",
  "script": "frappe.ui.form.on('Delivery Trip', {\n\tcustom_start_trip_value(frm) {\n\t\tif (frm.doc.custom_start_trip_value && frm.doc.custom_end_trip_value) {\n\t        var total = frm.doc.custom_end_trip_value - frm.doc.custom_start_trip_value;\n\t\t    frm.set_value(\"custom_total_distance_covered\", total);\n\t\t}\n\t},\n\tcustom_end_trip_value(frm) {\n\t\tif (frm.doc.custom_start_trip_value && frm.doc.custom_end_trip_value) {\n\t        var total = frm.doc.custom_end_trip_value - frm.doc.custom_start_trip_value;\n\t\t    frm.set_value(\"custom_total_distance_covered\", total);\n\t\t}\n\t},\n\n});\n\n\n\nfrappe.ui.form.on('Delivery Stop', {\n\n    custom_fuel_value(frm,cdt,cdn)\n    {\n        var row = locals[cdt][cdn] ;\n        if(row.distance)\n        {\n            frappe.model.set_value('Delivery Stop',  row.name ,'custom_fuel_consumption',row.custom_fuel_value * row.distance)\n        }\n        \n    },\n    \n    distance(frm,cdt,cdn)\n    {\n        var row = locals[cdt][cdn] ;\n        if(row.custom_fuel_value)\n        {\n            frappe.model.set_value('Delivery Stop',  row.name ,'custom_fuel_consumption',row.custom_fuel_value * row.distance)\n        }\n        \n    }\n    \n    \n\n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Costing Sheet",
  "enabled": 1,
  "modified": "2025-04-29 10:55:37.496457",
  "module": null,
  "name": "Get Rate from Item  Price List",
  "script": "frappe.ui.form.on('Costing Sheet', {\r\n    \r\n    \r\n    \r\n    onload: async function(frm) {\r\n        \r\n        var itm_grp = frm.doc.item_group ;\r\n        var company = frm.doc.company ;\r\n        \r\n        \r\n        if (itm_grp || company) \r\n        {\r\n            \r\n            \r\n            \r\n            let itm_grp_list = await frappe.db.get_list('Item Group', {\r\n                                    filters : {\r\n                                        'parent_item_group' : frm.doc.item_group ,\r\n                                    }\r\n                                }        \r\n            );\r\n            let itm_grp_names = itm_grp_list.map(item => item.name);\r\n            itm_grp_names.push(itm_grp);\r\n            \r\n            if (itm_grp && !company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n          \r\n            }\r\n            else if(!itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n            \r\n            else if(itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n           \r\n        }\r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    company : async function(frm) {\r\n       \r\n       \r\n        var itm_grp = frm.doc.item_group ;\r\n        var company = frm.doc.company ;\r\n        \r\n        if (itm_grp || company) \r\n        {\r\n            let itm_grp_list = await frappe.db.get_list('Item Group', {\r\n                                    filters : {\r\n                                        'parent_item_group' : frm.doc.item_group ,\r\n                                    }\r\n                                }        \r\n            );\r\n            let itm_grp_names = itm_grp_list.map(item => item.name);\r\n            itm_grp_names.push(itm_grp);\r\n            \r\n            if (itm_grp && !company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n          \r\n            }\r\n            else if(!itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n            \r\n            else if(itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n           \r\n        }\r\n        \r\n          \r\n    },\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    refresh: function(frm) {\r\n      // Hide the button with the specified HTML structure\r\n       \r\n       \r\n        if (frm.doc.table_htbf.length < 1)\r\n        {\r\n            let itm_array = [ 'Waste' , 'Overheads' , 'Contigency'] ;\r\n            itm_array.forEach(function(itm) {\r\n               var row = frm.add_child('table_htbf')  ;\r\n               row.factors = itm ;\r\n            });\r\n            frm.refresh_field('table_htbf') ;\r\n        }\r\n        \r\n        if (frm.doc.others.length < 1) {\r\n            \r\n            let itm_array = [ 'Welding', 'Fabrication', 'Assembly', 'Painting', 'Loading', 'Insulation'] ;\r\n            itm_array.forEach(function(itm) {\r\n                var row = frm.add_child('others');\r\n                row.item_code = itm ;\r\n            });\r\n            frm.refresh_field('others');\r\n            \r\n        }\r\n        \r\n        \r\n        \r\n        \r\n        // if (frm.doc.delivery_charges.length < 1)\r\n        // {\r\n        //     let itm_array2 = ['Waste %','Over Head %','Margin %','Delivery Charge - AHU - 3Ton - PickUP','Delivery Charge - DBX - 3Ton PickUP','Delivery Charge - AHU - Trailer','Delivery Charge - DBX - Trailer'] ;\r\n        //     itm_array2.forEach(function(itm2) {\r\n        //         var row = frm.add_child('delivery_charges');\r\n        //         row.item_code = itm2 ;\r\n        //     });\r\n        //     frm.refresh_field('delivery_charges');\r\n        // }\r\n        \r\n        \r\n        \r\n        \r\n        // $('button.btn.btn-xs.btn-secondary.grid-add-row').eq(2).hide();\r\n        // $('button.btn.btn-xs.btn-secondary.grid-add-row').eq(4).hide();\r\n        \r\n    },\r\n    \r\n    price_list: function(frm) {\r\n        if(frm.doc.price_list)\r\n        {\r\n            const costing_sheet_items = frm.doc.costing_sheet_item || [];\r\n    \r\n            costing_sheet_items.forEach(function(item) {\r\n                const item_code = item.item_code;\r\n                const item_name = item.item_name;\r\n                \r\n                if (item_code) {\r\n                    update_rate(frm,item, item_code, item_name, frm.doc.price_list);  \r\n                }\r\n            });\r\n        }\r\n        else {\r\n            const costing_sheet_items = frm.doc.costing_sheet_item || [];\r\n    \r\n            costing_sheet_items.forEach(function(item) {\r\n                const item_code = item.item_code;\r\n                const item_name = item.item_name;\r\n                \r\n                if (item_code) {\r\n                        item.uom = '';\r\n                        item.rate = 0 ;\r\n                        item.amount = item.rate * item.quantity ;\r\n                        item.saving = item.selling_amount - item.amount ;\r\n                }\r\n                frm.refresh_field('costing_sheet_item');\r\n            });\r\n        }\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    margin_percentage: function(frm) {\r\n        \r\n        // frappe.db.set_value('Costing Sheet', frm.doc.name, 'margin_amount' , ( frm.doc.total_amount + frm.doc.total_accessory_amount + frm.doc.total_other_item_amount + frm.doc.total_delivery_charges_amount + frm.doc.others_subtotal ) * (frm.doc.margin_percentage/100) ) ;     \r\n        frm.set_value('margin_amount' , ( frm.doc.total_amount + frm.doc.total_accessory_amount + frm.doc.total_other_item_amount + frm.doc.total_delivery_charges_amount + frm.doc.others_subtotal ) * (frm.doc.margin_percentage/100) ) ;     \r\n        frm.refresh();\r\n        // frm.refresh_field('margin_amount');\r\n        \r\n    },\r\n    \r\n\r\n\r\n    \r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Costing Sheet Item', {\r\n   \r\n    \r\n    item_code: async function(frm,cdt,cdn) {\r\n        \r\n        var row = locals[cdt][cdn] ;\r\n        row.rate = 0 ;\r\n        row.uom = '' ;\r\n        row.amount = row.rate * row.quantity ;\r\n        frm.refresh_field('costing_sheet_item');        \r\n                \r\n        if (frm.doc.price_list) \r\n        {\r\n            if (row.item_code) \r\n            {\r\n                update_rate(frm, row, row.item_code, row.item_name, frm.doc.price_list); \r\n            }\r\n            else \r\n            {\r\n                row.rate = 0 ;\r\n                row.uom = '' ;\r\n                row.amount = row.rate * row.quantity ;\r\n                row.saving = row.selling_amount * row.amount ;\r\n            }\r\n            frm.refresh_field('costing_sheet_item');\r\n            calculate_total_amount(frm);   \r\n        }\r\n        \r\n        \r\n        var itm_grp = frm.doc.item_group ;\r\n        var company = frm.doc.company ;\r\n        \r\n        \r\n        if (itm_grp || company) \r\n        {\r\n            \r\n            \r\n            \r\n            let itm_grp_list = await frappe.db.get_list('Item Group', {\r\n                                    filters : {\r\n                                        'parent_item_group' : frm.doc.item_group ,\r\n                                    }\r\n                                }        \r\n            );\r\n            let itm_grp_names = itm_grp_list.map(item => item.name);\r\n            itm_grp_names.push(itm_grp);\r\n            \r\n            if (itm_grp && !company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n          \r\n            }\r\n            else if(!itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n            \r\n            else if(itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n           \r\n        }\r\n        \r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        \r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'amount' , row.quantity * row.rate ) ;\r\n        row.amount = row.quantity * row.rate ;\r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        frm.refresh_field('costing_sheet_item');\r\n        calculate_total_amount(frm);\r\n\r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'amount' , row.quantity * row.rate ) ;\r\n        row.amount = row.quantity * row.rate ;\r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        frm.refresh_field('costing_sheet_item');\r\n        calculate_total_amount(frm);\r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    costing_sheet_item_remove: function(frm,cdt,cdn)\r\n    {\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    \r\n    ordered_quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Costing Sheet Item', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount = row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    selling_rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Costing Sheet Item', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount = row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value(\"Costing Sheet Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n\r\n});\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Accessory Item', {\r\n   \r\n    \r\n    item_code: async function(frm,cdt,cdn) {\r\n        \r\n        var row = locals[cdt][cdn] ;\r\n        row.rate = 0 ;\r\n        row.uom = '' ;\r\n        row.amount = row.rate * row.quantity ;\r\n        row.saving = row.selling_amount - row.amount ;\r\n        frm.refresh_field('accessory_item');        \r\n                \r\n        if (frm.doc.price_list) \r\n        {\r\n            if (row.item_code) \r\n            {\r\n                update_rate(frm, row, row.item_code, row.item_name, frm.doc.price_list); \r\n            }\r\n            else \r\n            {\r\n                row.rate = 0 ;\r\n                row.uom = '' ;\r\n                row.amount = row.rate * row.quantity ;\r\n                row.saving = row.selling_amount - row.amount ;\r\n            }\r\n            frm.refresh_field('accessory_item');\r\n            calculate_total_amount(frm);   \r\n        }\r\n        \r\n        var itm_grp = frm.doc.item_group ;\r\n        var company = frm.doc.company ;\r\n        \r\n        \r\n        if (itm_grp || company) \r\n        {\r\n            \r\n            \r\n            \r\n            let itm_grp_list = await frappe.db.get_list('Item Group', {\r\n                                    filters : {\r\n                                        'parent_item_group' : frm.doc.item_group ,\r\n                                    }\r\n                                }        \r\n            );\r\n            let itm_grp_names = itm_grp_list.map(item => item.name);\r\n            itm_grp_names.push(itm_grp);\r\n            \r\n            if (itm_grp && !company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                            },\r\n                        };\r\n                    };\r\n          \r\n            }\r\n            else if(!itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n            \r\n            else if(itm_grp && company)\r\n            {\r\n                    frm.fields_dict.costing_sheet_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n                    frm.fields_dict.accessory_item.grid.get_field(\"item_code\").get_query = function (frm, cdt, cdn) {\r\n                        return {\r\n                            filters: {\r\n                                item_group : ['in', itm_grp_names] ,\r\n                                custom_company : company ,\r\n                            },\r\n                        };\r\n                    };\r\n            }\r\n           \r\n        }\r\n        \r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        \r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'amount' , row.quantity * row.rate ) ;\r\n        row.amount = row.quantity * row.rate ;\r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        frm.refresh_field('accessory_item');\r\n        calculate_total_amount(frm);\r\n\r\n        \r\n        \r\n    },\r\n    \r\n    \r\n    rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'amount' , row.quantity * row.rate ) ;\r\n        row.amount = row.quantity * row.rate ;\r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        frm.refresh_field('accessory_item');\r\n        calculate_total_amount(frm);\r\n        \r\n    },\r\n    \r\n    \r\n    \r\n    accessory_item_remove: function(frm,cdt,cdn)\r\n    {\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n\r\n    ordered_quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Accessory Item', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    selling_rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Accessory Item', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value(\"Accessory Item\", row.name, 'saving' , row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n\r\n\r\n\r\n});\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Other Items In Costing Sheet', {\r\n   \r\n   \r\n    rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'amount', row.rate*row.quantity ) ;\r\n        row.amount = row.rate * row.quantity ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm); \r\n    },\r\n\r\n\r\n    quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'amount', row.rate*row.quantity ) ;\r\n        row.amount = row.rate * row.quantity ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm); \r\n    },\r\n\r\n    ordered_quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    selling_rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value('Other Items In Costing Sheet', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n\r\n\r\n\r\n\r\n});\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Delivery Charge', {\r\n   \r\n   \r\n    rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'amount', row.rate*row.quantity ) ;\r\n        row.amount = row.rate * row.quantity ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm); \r\n    },\r\n\r\n\r\n    quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'amount', row.rate*row.quantity ) ;\r\n        row.amount = row.rate * row.quantity ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm); \r\n    },\r\n    \r\n    \r\n    ordered_quantity: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n    \r\n    selling_rate: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'selling_amount', row.ordered_quantity * row.selling_rate) ;\r\n        row.selling_amount =  row.ordered_quantity * row.selling_rate ;\r\n        frappe.model.set_value('Delivery Charge', row.name, 'saving', row.selling_amount - row.amount ) ;\r\n        calculate_total_amount(frm);\r\n    },\r\n\r\n    \r\n    \r\n\r\n});\r\n\r\n\r\n\r\n\r\n\r\nfrappe.ui.form.on('Others Table in Costing Sheet', {\r\n   \r\n   \r\n    percentage: function(frm,cdt,cdn)\r\n    {\r\n        var row = locals[cdt][cdn] ;\r\n        if (row.factors == 'Waste') \r\n        {\r\n            frappe.model.set_value('Others Table in Costing Sheet', row.name, 'amount', (frm.doc.total_amount + frm.doc.total_accessory_amount)*(row.percentage/100) ) ;\r\n        }\r\n        if (row.factors == 'Overheads') \r\n        {\r\n            frappe.model.set_value('Others Table in Costing Sheet', row.name, 'amount', (frm.doc.total_amount + frm.doc.total_accessory_amount + frm.doc.total_other_item_amount + frm.doc.total_delivery_charges_amount)*(row.percentage/100) ) ;\r\n        }\r\n        if (row.factors == 'Contigency') \r\n        {\r\n            frappe.model.set_value('Others Table in Costing Sheet', row.name, 'amount', (frm.doc.total_amount + frm.doc.total_accessory_amount)*(row.percentage/100) ) ;\r\n        }\r\n        calculate_total_amount(frm); \r\n    },\r\n\r\n\r\n   \r\n\r\n    \r\n    \r\n\r\n});\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfunction calculate_total_amount(frm) {\r\n    let total_amount = 0 ;\r\n    let total_quantity = 0 ;\r\n    let total_sell_amount = 0 ;\r\n    let total_saving = 0 ;\r\n    const costing_sheet_items = frm.doc.costing_sheet_item || [];\r\n    \r\n    costing_sheet_items.forEach(function(item) {\r\n        total_amount = total_amount + item.amount;\r\n        total_quantity = total_quantity + item.quantity;\r\n        total_sell_amount = total_sell_amount + item.selling_amount ;\r\n        total_saving = total_saving + item.saving ;\r\n    });\r\n    \r\n    frm.set_value('total_amount', total_amount) ;\r\n    frm.refresh_field('frm.doc.total_amount');\r\n    \r\n    frm.set_value('total_quantity', total_quantity) ;\r\n    frm.refresh_field('frm.doc.total_quantity');\r\n\r\n    frm.set_value('total_selling_amount', total_sell_amount) ;\r\n    frm.refresh_field('frm.doc.total_selling_amount');\r\n    \r\n    frm.set_value('total_saving', total_saving) ;\r\n    frm.refresh_field('frm.doc.total_saving');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    let total_acc_amount = 0 ;\r\n    let total_acc_quantity = 0 ;\r\n    let total_acc_sell_amount = 0 ;\r\n    let total_acc_saving = 0 ;\r\n    const acc_items = frm.doc.accessory_item || [] ;\r\n    \r\n    acc_items.forEach(function(item) {\r\n        total_acc_amount = total_acc_amount + item.amount ;\r\n        total_acc_quantity = total_acc_quantity + item.quantity ;\r\n        total_acc_sell_amount = total_acc_sell_amount + item.selling_amount ;\r\n        total_acc_saving = total_acc_saving + item.saving ;\r\n    });\r\n    \r\n    frm.set_value('total_accessory_amount', total_acc_amount) ;\r\n    frm.refresh_field('frm.doc.total_accessory_amount');\r\n    \r\n    \r\n    frm.set_value('total_accessory_quantity', total_acc_quantity) ;\r\n    frm.refresh_field('frm.doc.total_accessory_quantity');\r\n    \r\n    \r\n    frm.set_value('total_accessory_selling_amount', total_acc_sell_amount) ;\r\n    frm.refresh_field('frm.doc.total_accessory_selling_amount');\r\n    \r\n    frm.set_value('total_accessory_saving', total_acc_saving) ;\r\n    frm.refresh_field('frm.doc.total_accessory_saving');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n      \r\n    let total_oth_amount = 0 ;\r\n    let total_oth_quantity = 0 ;\r\n    let total_oth_sell_amount = 0 ;\r\n    let total_oth_saving = 0 ;\r\n    const oth_items = frm.doc.others || [] ;\r\n    \r\n    oth_items.forEach(function(item) {\r\n        total_oth_amount = total_oth_amount + item.amount ;\r\n        total_oth_quantity = total_oth_quantity + item.quantity ;\r\n        total_oth_sell_amount = total_oth_sell_amount + item.selling_amount ;\r\n        total_oth_saving = total_oth_saving + item.saving ;\r\n    });\r\n    \r\n    frm.set_value('total_other_item_amount', total_oth_amount) ;\r\n    frm.refresh_field('frm.doc.total_other_item_amount');\r\n    \r\n    \r\n    frm.set_value('total_other_items_quantity', total_oth_quantity) ;\r\n    frm.refresh_field('frm.doc.total_other_items_quantity');\r\n    \r\n    \r\n    frm.set_value('total_other_items_selling_amount', total_oth_sell_amount) ;\r\n    frm.refresh_field('frm.doc.total_other_items_selling_amount');\r\n    \r\n    frm.set_value('total_other_items_saving', total_oth_saving) ;\r\n    frm.refresh_field('frm.doc.total_other_items_saving');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    let total_dc_amount = 0 ;\r\n    let total_dc_quantity = 0 ;\r\n    let total_dc_sell_amount = 0 ;\r\n    let total_dc_saving = 0 ;\r\n    const dc_items = frm.doc.delivery_charges || [] ;\r\n    \r\n    dc_items.forEach(function(item) {\r\n        total_dc_amount = total_dc_amount + item.amount ;\r\n        total_dc_quantity = total_dc_quantity + item.quantity ;\r\n        total_dc_sell_amount = total_dc_sell_amount + item.selling_amount ;\r\n        total_dc_saving = total_dc_saving + item.saving ;\r\n    });\r\n    \r\n    frm.set_value('total_delivery_charges_amount', total_dc_amount ) ;\r\n    frm.refresh_field('frm.doc.total_delivery_charges_amount');\r\n    \r\n    \r\n    frm.set_value('total_delivery_charges_quantity', total_dc_quantity) ;\r\n    frm.refresh_field('frm.doc.total_delivery_charges_quantity');\r\n    \r\n    frm.set_value('total_delivery_charges_selling_amount', total_dc_sell_amount) ;\r\n    frm.refresh_field('frm.doc.total_delivery_charges_selling_amount');\r\n    \r\n    \r\n    frm.set_value('total_delivery_charges_saving', total_dc_saving) ;\r\n    frm.refresh_field('frm.doc.total_delivery_charges_saving');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    let total_others_amount = 0 ;\r\n    const others_items = frm.doc.table_htbf || [] ;\r\n    \r\n    others_items.forEach(function(item) {\r\n        total_others_amount = total_others_amount + item.amount ;\r\n        \r\n    });\r\n    \r\n    frm.set_value('others_subtotal', total_others_amount ) ;\r\n    frm.refresh_field('frm.doc.others_subtotal');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    let grand_cost = frm.doc.total_amount + frm.doc.total_accessory_amount + frm.doc.total_other_item_amount + frm.doc.total_delivery_charges_amount + frm.doc.others_subtotal ;\r\n    let sell_amount = frm.doc.total_selling_amount + frm.doc.total_accessory_selling_amount + frm.doc.total_other_items_selling_amount + frm.doc.total_delivery_charges_selling_amount ;\r\n    let p_l = frm.doc.total_saving + frm.doc.total_accessory_saving + frm.doc.total_other_items_saving + frm.doc.total_delivery_charges_saving ;\r\n    \r\n    \r\n    frm.set_value('grand_cost', grand_cost) ;\r\n    frm.refresh_field('frm.doc.grand_cost');\r\n    \r\n    \r\n    frm.set_value('grand_selling_amount', sell_amount) ;\r\n    frm.refresh_field('frm.doc.grand_selling_amount');\r\n    \r\n    // frm.set_value('profit__loss', p_l) ;\r\n    // frm.refresh_field('frm.doc.profit__loss');\r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n    \r\n}\r\n\r\nfunction update_rate(frm,item, item_code, item_name, price_list) {\r\n    frappe.db.get_list('Item Price', {\r\n    fields: ['item_code', 'price_list', 'uom', 'price_list_rate','name'],\r\n    filters: {\r\n        'item_code'    :   item_code,\r\n        'price_list'   :   price_list\r\n        \r\n    }\r\n}).then(records => {\r\n    if (records.length > 0){\r\n    \r\n        ip_uom = records[0].uom;\r\n        ip_rate = records[0].price_list_rate;\r\n            item.item_code = item_code;\r\n            item.item_name = item_name;\r\n            item.uom = ip_uom;\r\n            item.rate = ip_rate;\r\n            item.amount = item.quantity * item.rate;\r\n            item.saving = item.selling_amount - item.amount ;\r\n    }\r\n    else\r\n    {\r\n        item.uom = '';\r\n        item.rate = 0 ;\r\n        item.amount = item.quantity * item.rate;\r\n        item.saving = item.selling_amount - item.amount ;\r\n        \r\n    }\r\n    frm.refresh_field('costing_sheet_item');\r\n    frm.refresh_field('accessory_item');\r\n    calculate_total_amount(frm);\r\n    \r\n});\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Logistics Buses",
  "enabled": 0,
  "modified": "2024-09-30 15:30:01.612367",
  "module": null,
  "name": "Calculate the Fuel Consumption",
  "script": "frappe.ui.form.on('Logistics Buses', {\r\n    refresh(frm) {\r\n        // Any refresh logic can go here\r\n    }\r\n});\r\n\r\n// Child table: Logistics Table\r\nfrappe.ui.form.on('Logistics Table', {\r\n    distance_covered: function(frm, cdt, cdn) {\r\n        calculate_fuel_consumption(frm, cdt, cdn);\r\n    },\r\n    float_value: function(frm, cdt, cdn) {\r\n        calculate_fuel_consumption(frm, cdt, cdn);\r\n    }\r\n});\r\n\r\nfunction calculate_fuel_consumption(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n    if (row.distance_covered && row.float_value) {\r\n        // Calculate fuel consumption\r\n        row.fuel_consumption = row.distance_covered * row.float_value;\r\n    } else {\r\n        // Reset fuel consumption if any field is missing\r\n        row.fuel_consumption = 0;\r\n    }\r\n    // Refresh the specific field in the child table\r\n    frm.refresh_field(\"fuel_consumption\"); // Refresh the specific row in the child table\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Logistic Car",
  "enabled": 0,
  "modified": "2024-09-30 15:41:37.831677",
  "module": null,
  "name": "Calculate the fuel consumption 2",
  "script": "frappe.ui.form.on('Logistic car', {\r\n    refresh(frm) {\r\n        // Any refresh logic can go here\r\n    }\r\n});\r\n\r\n// Child table: Logistics Table\r\nfrappe.ui.form.on('Logistics Table', {\r\n    distance_covered: function(frm, cdt, cdn) {\r\n        calculate_fuel_consumption(frm, cdt, cdn);\r\n    },\r\n    float_value: function(frm, cdt, cdn) {\r\n        calculate_fuel_consumption(frm, cdt, cdn);\r\n    }\r\n});\r\n\r\nfunction calculate_fuel_consumption(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n    if (row.distance_covered && row.float_value) {\r\n        // Calculate fuel consumption\r\n        row.fuel_consumption = row.distance_covered * row.float_value;\r\n    } else {\r\n        // Reset fuel consumption if any field is missing\r\n        row.fuel_consumption = 0;\r\n    }\r\n    // Refresh the child table to reflect changes\r\n    frm.refresh_field(\"fuel_consumption\"); // Change \"logistics_table\" to the actual fieldname of the child table\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Costing Sheet",
  "enabled": 1,
  "modified": "2024-10-02 12:12:50.596761",
  "module": null,
  "name": "Filter price list in costing sheet to only buying check = 1",
  "script": "frappe.ui.form.on('Costing Sheet', {\r\n    refresh: function(frm) {\r\n        // Trigger filtering on form load\r\n        filter_price_list(frm);\r\n    },\r\n    onload: function(frm) {\r\n        // Trigger filtering when the form is loaded\r\n        filter_price_list(frm);\r\n    },\r\n    price_list: function(frm) {\r\n        // Optionally refresh if the price_list is changed\r\n        filter_price_list(frm);\r\n    }\r\n});\r\n\r\nfunction filter_price_list(frm) {\r\n    // Set the query for the price_list field\r\n    frm.set_query('price_list', function() {\r\n        return {\r\n            filters: {\r\n                'buying': 1 // Adjust to match the field name in Price List doctype\r\n            }\r\n        };\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Job Offer",
  "enabled": 1,
  "modified": "2024-10-17 09:48:24.015563",
  "module": null,
  "name": "Calculating the notice period days",
  "script": "frappe.ui.form.on('Job Offer', {\r\n    custom_notice_period_for_staff: function(frm) {\r\n        // Get the value of custom_notice_period_for_staff\r\n        const noticePeriod = frm.doc.custom_notice_period_for_staff;\r\n\r\n        // Initialize custom notice period days\r\n        let customNoticePeriodDays = 0; // Default value\r\n\r\n        // Check if notice period is selected\r\n        if (noticePeriod) {\r\n            // Set days based on the selected period\r\n            if (noticePeriod === \"1 Month\") {\r\n                customNoticePeriodDays = 30;\r\n            } else if (noticePeriod === \"2 Months\") {\r\n                customNoticePeriodDays = 60;\r\n            } else if (noticePeriod === \"3 Months\") {\r\n                customNoticePeriodDays = 90;\r\n            }\r\n        }\r\n\r\n        // Set the custom_notice_period_days field\r\n        frm.set_value('custom_notice_period_days', customNoticePeriodDays);\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2024-10-17 12:02:04.675203",
  "module": null,
  "name": "test2",
  "script": "frappe.ui.form.on('Material Request', {\n\trefresh(frm) {\n\t\tconsole.log(frm.timeline.doc_info.workflow_logs)\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2024-10-17 14:24:48.023969",
  "module": null,
  "name": "test3",
  "script": "frappe.ui.form.on('Material Request', {\r\n\r\n   on_load: function(frm) {\r\n        update_user(frm);\r\n    },\r\n    after_workflow_action: function(frm) {\r\n        update_user(frm);\r\n    },\r\n\r\n});\r\n\r\nfunction update_user(frm) {\r\n    // Get the current user\r\n    const current_user = frappe.session.user;\r\n\r\n    // Set the custom_user field to the current user\r\n    frm.set_value('custom_user', current_user);\r\n\r\n    // Refresh the field to ensure it's updated\r\n    frm.refresh_field('custom_user');\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Training Event",
  "enabled": 0,
  "modified": "2024-10-23 10:44:49.212330",
  "module": null,
  "name": "Send Email to employees",
  "script": "frappe.ui.form.on('Training Event', {\n    refresh(frm) {\n        \n            let all_emails = [];\n\n            // Loop through employees child table and collect their email addresses\n            frm.doc.employees.forEach(employee => {\n                console.log(employee); // Debugging line to check employee data\n                if (employee.custom_email) {\n                    all_emails.push(employee.custom_email);\n                }\n            });\n\n            if (all_emails.length > 0) {\n                console.log(all_emails); // Check the list of emails in the console\n                \n                // Wrap sendmail in a try-catch block to handle any errors\n                try {\n                    frappe.sendmail({\n                        recipients: all_emails,\n                        subject: `${frm.doc.training_program} - Training Event Notification`,\n                        message: `\n                            <p>Dear Employee,</p>\n                            <p>This is to notify you about the upcoming training event titled \"${frm.doc.training_program}\".</p>\n                            <p>Event Details:</p>\n                            <p>Start Time: ${frm.doc.start_time}</p>\n                            <p>End Time: ${frm.doc.end_time}</p>\n                            <p>Location: ${frm.doc.location}</p>\n                            <p>Please make sure to attend.</p>\n                            <p>For any further details, feel free to contact the HR Department.</p>\n                        `,\n                        reference_doctype: frm.doctype,\n                        reference_name: frm.docname\n                    });\n                    frappe.msgprint(__('Emails have been sent successfully.'));\n                } catch (error) {\n                    // Log the error in the console for debugging\n                    console.error('Error sending emails:', error);\n                    \n                    // Show an error message to the user\n                    frappe.msgprint({\n                        title: __('Error'),\n                        indicator: 'red',\n                        message: __('There was an issue sending the emails. Please try again later.')\n                    });\n                }\n            } else {\n                frappe.msgprint(__('No employee email addresses found.'));\n            }\n        \n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2024-10-28 11:01:54.372162",
  "module": null,
  "name": "Setting Price List Rate on Item",
  "script": "frappe.ui.form.on('Purchase Order', {\n    // Triggered when the form is loaded or any other field event if needed\n});\n\nfrappe.ui.form.on('Purchase Order Item', {\n    rate: function(frm, cdt, cdn) {\n        // Get the specific child table row\n        let row = locals[cdt][cdn];\n\n        // Set the price_list_rate field to be the same as the rate field in the child table row\n        frappe.model.set_value(cdt, cdn, 'price_list_rate', row.rate);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-02-11 10:16:30.631429",
  "module": null,
  "name": "hiding item table buttons",
  "script": "frappe.ui.form.on('Sales Order', {\n    \n    \n    refresh: function(frm) {\n          frm.get_field(\"items\").grid.cannot_add_rows = true;\n          frm.fields_dict[\"items\"].$wrapper.find('.btn.btn-xs.btn-secondary.grid-upload').addClass(\"hidden\");\n    \n    \n        \n\n    },\n    \n    \n});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Manufacture Order",
  "enabled": 1,
  "modified": "2025-04-21 10:11:00.929844",
  "module": null,
  "name": "Customization on Manufacture Order For Stock Entry",
  "script": "frappe.ui.form.on('Manufacture Order', {\n    \n    async refresh(frm) {\n     \n        \n        // frm.set_query('item_code', 'item_table', () => {\n        //     return {\n        //         filters: [\n        //             [\"Item\",\"disabled\",\"=\",0],\n        //             [\"Item\",\"item_group\",\"descendants of (inclusive)\",\"Finished Goods\"] ,\n        //         ]\n        //     };\n        // });\n    \n        \n        if (frm.doc.docstatus == 1 && !frm.doc.start_time) {\n            \n            frm.add_custom_button('START', () => {\n\n                    frm.set_value('start_time', frappe.datetime.now_datetime());\n                \n        \n                    frm.refresh_field('start_time');\n                    // frm.save();\n                    frm.save('Update');\n            });\n        }\n\n        \n        if (frm.doc.docstatus == 1 && frm.doc.start_time ) { \n            \n        \n            frm.add_custom_button('Finished Goods Creation', async () => {\n\n                const table_rpga_data = [...frm.doc.table_rpga] || [];\n                \n                var acc_doc = await frappe.db.get_doc('Manufacturing Order Settings') ;\n                var acc = null ;\n                \n                \n                for (let x of acc_doc.tolerance) {\n                    if (frm.doc.company == x.company)\n                    {\n                        acc = x.over_head_cost_valuation_account ;\n                        break ;\n                    }\n                }\n                // console.log(acc);\n\n                \n                const tableFields = [\n                    {\n                        fieldtype: 'Link',\n                        options: 'Item' ,\n                        fieldname: 'item_code',\n                        label: 'FG Item Code',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'item_name',\n                        label: 'FG Item Name',\n                        in_list_view: 0,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Link',\n                        options: 'UOM' , \n                        fieldname: 'uom',\n                        label: 'UOM',\n                        in_list_view: 0,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'qty',\n                        label: 'Quantity',\n                        in_list_view: 1,\n                        read_only: 0 ,\n                        columns: 1 ,\n                    },\n                    { fieldtype: 'Currency', fieldname: 'per_unit_cost', label: 'Per Unit Cost', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    { fieldtype: 'Link', options: 'Brand' , fieldname: 'brand', label: 'Brand', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'item_gauge', label: 'Item Gauge', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_area_sqm', label: 'SPL Area SQM', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_weight_kg', label: 'SPL Weight KG', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_vanes_splitter_qty_1', label: 'CAM Item Vanes Splitter Qty 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_duct_seam_1', label: 'CAM Item Duct Seam 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_range', label: 'Duct Range', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                    { fieldtype: 'Data', fieldname: 'duct_connector_1', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_connector_2', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'pl_item_length__angle', label: 'PL Item Length / Angle', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                    { fieldtype: 'Link', options: 'Item' , fieldname: 'parent_finished_goods_item', label: 'Parent Finished Good', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                ];\n\n\n                let dialog = new frappe.ui.Dialog({\n                    title: 'Finished Goods Creation',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: '',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This Table lists out only Child Finished Goods Items which are passed on Quality towards Finished Goods Store.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Select\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        for (let item of selected_items) {\n                            if (item.qty <= 0) {\n                                frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n                                return;\n                            }\n                        }\n                        \n                        var total_spl_area_sqm = 0;\n                        var per_unit_spl_area_sqm_cost = 0;\n                        \n                        frm.doc.item_table.forEach(r => {\n                            total_spl_area_sqm = total_spl_area_sqm + (r.spl_area_sqm || 0 );\n                        });\n                        \n                        per_unit_spl_area_sqm_cost = frm.doc.grand_total / total_spl_area_sqm ;\n                        // console.log(total_spl_area_sqm);\n                        // console.log(per_unit_spl_area_sqm_cost);\n                      \n                        \n                        if (selected_items.length > 0) \n                        {\n\n                            frappe.new_doc(\"Stock Entry\", {\"stock_entry_type\": \"Manufacture\"}, doc => {\n                                \n                                doc.company = frm.doc.company ;\n                                doc.posting_date = frappe.datetime.get_today() ;\n                                doc.custom_manufacture_order = frm.doc.name ;\n                                doc.custom_manufacture_order_purpose = \"Finished Goods Creation\" ;\n                                doc.items = [];\n                        \n                                // let ad_row = frappe.model.add_child(doc, \"additional_costs\");\n                                // frappe.model.set_value(ad_row.doctype, ad_row.name, 'expense_account', acc);\n                                // frappe.model.set_value(ad_row.doctype, ad_row.name, 'description', \"Finished Goods Item\");\n                                // frappe.model.set_value(ad_row.doctype, ad_row.name, 'amount', 10);\n                                // refresh_field(\"additional_costs\");\n                        \n                                selected_items.forEach(item => {\n                                    \n                                    frappe.db.set_value('Item', item.item_code, 'valuation_rate', item.per_unit_cost) ;\n                                    \n                                    \n                                    let row = frappe.model.add_child(doc, \"items\");\n                                    frappe.model.set_value(row.doctype, row.name, 'item_code', item.item_code);\n                                    frappe.model.set_value(row.doctype, row.name, 'item_name', item.item_name);\n                                    frappe.model.set_value(row.doctype, row.name, 'qty', item.qty);\n                                    frappe.model.set_value(row.doctype, row.name, 'uom', item.uom);\n                                    frappe.model.set_value(row.doctype, row.name, 'basic_rate', item.per_unit_cost);\n                                    frappe.model.set_value(row.doctype, row.name, 'valuation_rate', item.per_unit_cost);\n                                    frappe.model.set_value(row.doctype, row.name, 'manufacture_order', frm.doc.name);\n                                    \n                                    // frappe.model.set_value(row.doctype, row.name, 'custom_finished_goods_item', item.fg_item_code);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_parent_finished_goods_item', item.parent_finished_goods_item);\n                                    \n    \t\t                        \n    \t\t                        \n    \t\t                        if(row.item_code)\n                                    {\n                                        \n                                        var ars = {\n                            \t\t\t\titem_code: row.item_code,\n                            \t\t\t\titem_name: row.item_name,\n                            \t\t\t\twarehouse: cstr(row.s_warehouse) || cstr(row.t_warehouse),\n                            \t\t\t\ttransfer_qty: row.transfer_qty,\n                            \t\t\t\tserial_no: row.serial_no,\n                            \t\t\t\tbatch_no: row.batch_no,\n                            \t\t\t\tbom_no: row.bom_no,\n                            \t\t\t\texpense_account: row.expense_account,\n                            \t\t\t\tcost_center: row.cost_center,\n                            \t\t\t\tcompany: doc.company,\n                            \t\t\t\tqty: item.qty,\n                            \t\t\t\tvoucher_type: doc.doctype,\n                            \t\t\t\tvoucher_no: row.name,\n                            \t\t\t\tvaluation_rate: row.valuation_rate,\n                            \t\t\t\tbasic_rate: row.valuation_rate,\n                            \t\t\t\tallow_zero_valuation: 0,\n                            \t\t\t};\n                            \n                            \t\t\tfrappe.call({\n                            \t\t\t\tdoc: doc,\n                            \t\t\t\tmethod: \"get_item_details\",\n                            \t\t\t\targs: ars,\n                            \t\t\t\tcallback: function (r) {\n                            \t\t\t\t\tif (r.message) {\n                            \t\t\t\t\t\tvar d = locals[cdt][cdn];\n                            \t\t\t\t\t\t$.each(r.message, function (k, v) {\n                            \t\t\t\t\t\t\tif (v) {\n                            \t\t\t\t\t\t\t\t// set_value trigger barcode function and barcode set qty to 1 in stock_controller.js, to avoid this set value manually instead of set value.\n                            \t\t\t\t\t\t\t\tif (k != \"barcode\") {\n                            \t\t\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, k, v); // qty and it's subsequent fields weren't triggered\n                            \t\t\t\t\t\t\t\t} else {\n                            \t\t\t\t\t\t\t\t\td.barcode = v;\n                            \t\t\t\t\t\t\t\t}\n                            \t\t\t\t\t\t\t}\n                            \t\t\t\t\t\t});\n                            \t\t\t\t\t\trefresh_field(\"items\");\n                            \n                            \t\t\t\t\t\tlet no_batch_serial_number_value = false;\n                            \t\t\t\t\t\tif (d.has_serial_no || d.has_batch_no) {\n                            \t\t\t\t\t\t\tno_batch_serial_number_value = true;\n                            \t\t\t\t\t\t}\n                            \n                            \t\t\t\t\t\tif (\n                            \t\t\t\t\t\t\tno_batch_serial_number_value &&\n                            \t\t\t\t\t\t\t!frappe.flags.hide_serial_batch_dialog &&\n                            \t\t\t\t\t\t\t!frappe.flags.dialog_set\n                            \t\t\t\t\t\t) {\n                            \t\t\t\t\t\t\tfrappe.flags.dialog_set = true;\n                            \t\t\t\t\t\t\terpnext.stock.select_batch_and_serial_no(frm, d);\n                            \t\t\t\t\t\t} else {\n                            \t\t\t\t\t\t\tfrappe.flags.dialog_set = false;\n                            \t\t\t\t\t\t}\n                            \t\t\t\t\t}\n                            \t\t\t\t},\n                            \t\t\t});\n                            \t\t\t\n                                    \n                                    \n                                    }\n    \t\t                        \n                          \n                                });\n                                \n                                                            \n                            });\n                            \n                        }\n                        else {\n                            frappe.msgprint(\"Please select at least one item.\");\n                        }\n\n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n\n\n                let dummyData = [];\n               \n\n\n                (frm.doc.item_table || []).forEach(row => {\n                    if(row.pass_count > 0)\n                    {\n                        dummyData.push({\n                            item_code : row.item_code ,\n                            item_name : row.item_name ,\n                            qty : row.quantity ,\n                            uom : row.uom ,\n                            per_unit_cost : row.per_unit_cost ,\n                            \n                            brand : row.item_brand ,\n                            item_gauge : row.item_guage ,\n                            spl_area_sqm : row.spl_area_sqm ,\n                            spl_weight_kg : row.spl_weight_kg ,\n                            cam_item_vanes_splitter_qty_1 : row.cam_item_vanes_splitter_qty_1 ,\n                            cam_item_duct_seam_1 : row.cam_item_duct_seam_1 ,\n                            duct_range : row.duct_range ,\n                            \n                            duct_connector_1 : row.duct_connector_1 ,\n                            duct_connector_2 : row.duct_connector_2 ,\n                            pl_item_length__angle : row.pl_item_length__angle , \n                            \n                            parent_finished_goods_item : row.parent_finished_goods_item ,\n                            \n                        });\n                    }\n                });\n\n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n\n                dialog.show();\n\n                            \n            });\n         \n                \n            frm.add_custom_button('Material Consumption', () => {\n\n                const table_rpga_data = [...frm.doc.table_rpga] || [];\n                \n\n                const tableFields = [\n                    {\n                        fieldtype: 'Link',\n                        options: 'Item' ,\n                        fieldname: 'item_code',\n                        label: 'Item Code',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                        columns: 2 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'item_name',\n                        label: 'Item Name',\n                        in_list_view: 0,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'qty',\n                        label: 'Quantity',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'used_qty',\n                        label: 'Used Qty',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'rem_qty',\n                        label: 'Remaining Qty',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'selected_qty',\n                        label: 'Select Qty',\n                        in_list_view: 1,\n                        read_only: 0 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Currency',\n                        fieldname: 'rate',\n                        label: 'Rate',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Link',\n                        options: 'UOM' , \n                        fieldname: 'uom',\n                        label: 'UOM',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Link',\n                        options: 'Item' ,\n                        fieldname: 'fg_item_code',\n                        label: 'Child FG Item',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Link',\n                        options: 'Item' ,\n                        fieldname: 'parent_fg_item_code',\n                        label: 'Parent FG Item',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    \n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'rm_check',\n                        label: 'Raw Material',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'ass_check',\n                        label: 'Accessory Item',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'cons_check',\n                        label: 'Consumable Item',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                    },\n\n                ];\n\n\n                let dialog = new frappe.ui.Dialog({\n                    title: 'Material Consumption',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: '',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This Table contains Coils Item Details List + Accessory Items list + Consumable items for Cost Consumption Recording only.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Select\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        for (let item of selected_items) {\n                            if (item.selected_qty > item.rem_qty ) {\n                                frappe.msgprint(`Error: Selected quantity (${item.selected_qty}) cannot be greater than remaining quantity (${item.rem_qty}) for item ${item.item_code}`);\n                                return;\n                            }\n                            if (item.selected_qty <= 0) {\n                                frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n                                return;\n                            }\n                        }\n                      \n                        \n                        if (selected_items.length > 0) \n                        {\n\n                            frappe.new_doc(\"Stock Entry\", {\"stock_entry_type\": \"Material Consumption for Manufacture\"}, doc => {\n                                \n                                doc.company = frm.doc.company ;\n                                doc.posting_date = frappe.datetime.get_today() ;\n                                doc.custom_manufacture_order = frm.doc.name ;\n                                doc.custom_manufacture_order_purpose = \"Material Consumption\" ;\n                                // doc.from_warehouse = \"Consumables WH - M\" ;\n                                doc.items = [];\n                        \n                                selected_items.forEach(item => {\n                                    \n                                    frappe.db.set_value('Item', item.item_code, 'valuation_rate', item.rate) ;\n                                    \n                                    let row = frappe.model.add_child(doc, \"items\");\n                                    frappe.model.set_value(row.doctype, row.name, 'item_code', item.item_code);\n                                    frappe.model.set_value(row.doctype, row.name, 'item_name', item.item_code);\n                                    frappe.model.set_value(row.doctype, row.name, 'qty', item.selected_qty);\n                                    frappe.model.set_value(row.doctype, row.name, 'uom', item.uom);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_finished_goods_item', item.fg_item_code);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_parent_finished_goods_item', item.parent_fg_item_code);\n                                    \n                                    frappe.model.set_value(row.doctype, row.name, 'basic_rate', item.rate);\n                                    frappe.model.set_value(row.doctype, row.name, 'valuation_rate', item.rate);\n                                    \n                                    \n                                    frappe.model.set_value(row.doctype, row.name, 'custom_manufacture_order_rate', item.rate);\n                                    \n                                    \n                                    \n                                    frappe.model.set_value(row.doctype, row.name, 'custom_raw_material', item.rm_check);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_accessory_item', item.ass_check);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_consumable_item', item.cons_check);\n                                    \n                                    frappe.model.set_value(row.doctype, row.name, 'manufacture_order', frm.doc.name);\n                                    \n    \t\t                        \n    \t\t                        \n    \t\t                        if(row.item_code)\n                                    {\n                                        \n                                        var ars = {\n                            \t\t\t\titem_code: row.item_code,\n                            \t\t\t\titem_name: row.item_name,\n                            \t\t\t\twarehouse: cstr(row.s_warehouse) || cstr(row.t_warehouse),\n                            \t\t\t\ttransfer_qty: row.transfer_qty,\n                            \t\t\t\tserial_no: row.serial_no,\n                            \t\t\t\tbatch_no: row.batch_no,\n                            \t\t\t\tbom_no: row.bom_no,\n                            \t\t\t\texpense_account: row.expense_account,\n                            \t\t\t\tcost_center: row.cost_center,\n                            \t\t\t\tcompany: doc.company,\n                            \t\t\t\tqty: item.qty,\n                            \t\t\t\tvoucher_type: doc.doctype,\n                            \t\t\t\tvoucher_no: row.name,\n                            \t\t\t\tallow_zero_valuation: 1,\n                            \t\t\t};\n                            \n                            \t\t\tfrappe.call({\n                            \t\t\t\tdoc: doc,\n                            \t\t\t\tmethod: \"get_item_details\",\n                            \t\t\t\targs: ars,\n                            \t\t\t\tcallback: function (r) {\n                            \t\t\t\t\tif (r.message) {\n                            \t\t\t\t\t\tvar d = locals[cdt][cdn];\n                            \t\t\t\t\t\t$.each(r.message, function (k, v) {\n                            \t\t\t\t\t\t\tif (v) {\n                            \t\t\t\t\t\t\t\t// set_value trigger barcode function and barcode set qty to 1 in stock_controller.js, to avoid this set value manually instead of set value.\n                            \t\t\t\t\t\t\t\tif (k != \"barcode\") {\n                            \t\t\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, k, v); // qty and it's subsequent fields weren't triggered\n                            \t\t\t\t\t\t\t\t} else {\n                            \t\t\t\t\t\t\t\t\td.barcode = v;\n                            \t\t\t\t\t\t\t\t}\n                            \t\t\t\t\t\t\t}\n                            \t\t\t\t\t\t});\n                            \t\t\t\t\t\trefresh_field(\"items\");\n                            \n                            \t\t\t\t\t\tlet no_batch_serial_number_value = false;\n                            \t\t\t\t\t\tif (d.has_serial_no || d.has_batch_no) {\n                            \t\t\t\t\t\t\tno_batch_serial_number_value = true;\n                            \t\t\t\t\t\t}\n                            \n                            \t\t\t\t\t\tif (\n                            \t\t\t\t\t\t\tno_batch_serial_number_value &&\n                            \t\t\t\t\t\t\t!frappe.flags.hide_serial_batch_dialog &&\n                            \t\t\t\t\t\t\t!frappe.flags.dialog_set\n                            \t\t\t\t\t\t) {\n                            \t\t\t\t\t\t\tfrappe.flags.dialog_set = true;\n                            \t\t\t\t\t\t\terpnext.stock.select_batch_and_serial_no(frm, d);\n                            \t\t\t\t\t\t} else {\n                            \t\t\t\t\t\t\tfrappe.flags.dialog_set = false;\n                            \t\t\t\t\t\t}\n                            \t\t\t\t\t}\n                            \t\t\t\t},\n                            \t\t\t});\n                            \t\t\t\n                                    \n                                    \n                                    }\n    \t\t                        \n                                    \n    \t\t                        \n    \t\t                        \n    \t\t                        \n    \t\t                        \n    \t\t                        \n    \t\t                        \n                                    let rm_row = frappe.model.add_child(doc, \"custom_raw_material\");\n                                    frappe.model.set_value(\"Raw Material Item In Stock Entry\", rm_row.name, 'raw_material_item', item.item_code);\n                                    frappe.model.set_value(\"Raw Material Item In Stock Entry\", rm_row.name, 'finished_goods_item', item.fg_item_code);\n                                    frappe.model.set_value(\"Raw Material Item In Stock Entry\", rm_row.name, 'incoming_quantity', item.selected_qty);\n                                    \n                                    refresh_field(\"custom_raw_material\");\n                                    \n                                    // rm_row.raw_material_item = item.item_code ;\n                                    // rm_row.finished_goods_item = item.fg_item_code ;\n                                    // rm_row.incoming_quantity = item.selected_qty ; \n                                    \n                          \n                                });\n                                                            \n                            });\n                            \n                        }\n                        else {\n                            frappe.msgprint(\"Please select at least one item.\");\n                        }\n\n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n\n\n                let dummyData = [];\n\n\n                (frm.doc.raw_material_item || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.coil_item_code_rm,\n                        item_name: row.coil_item_code_rm,\n                        qty: row.coil_item_qty,\n                        used_qty: row.coil_item_used_qty,\n                        rem_qty: row.coil_item_remaining_qty,\n                        selected_qty: row.coil_item_remaining_qty,\n                        rate: row.costing_rate ,\n                        uom: row.coil_item_uom,\n                        fg_item_code: row.fl_item,\n                        parent_fg_item_code: row.spl_item_fg_code ,\n                        rm_check: 1,\n                        ass_check: 0,\n                        cons_check: 0,\n                    });\n                });\n                \n                (frm.doc.accessory_summary || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item_code_linked,\n                        item_name: row.item_name,\n                        qty: row.qty,\n                        used_qty: row.se_used_qty,\n                        rem_qty: row.se_remaining_qty,\n                        selected_qty: row.se_remaining_qty,\n                        uom: row.uom,\n                        rate: row.rate ,\n                        fg_item_code: null,\n                        parent_fg_item_code: null ,\n                        rm_check: 0,\n                        ass_check: 1,\n                        cons_check: 0,\n                    });\n                });\n                \n                (frm.doc.consumable_cost || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item,\n                        item_name: row.item_name,\n                        qty: row.quantity,\n                        uom: row.uom,\n                        used_qty: row.se_used_quantity,\n                        rem_qty: row.se_remaining_quantity,\n                        selected_qty: row.se_remaining_quantity,\n                        rate: row.rate ,\n                        fg_item_code: null,\n                        parent_fg_item_code: null ,\n                        rm_check: 0,\n                        ass_check: 0,\n                        cons_check: 1,\n                    });\n                });\n\n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n\n                dialog.show();\n\n                                \n            });\n        \n            \n            frm.add_custom_button('Material Request', () => {\n\n                const table_rpga_data = [...frm.doc.table_rpga] || [];\n                \n\n                const tableFields = [\n                    {\n                        fieldtype: 'Link',\n                        options: 'Item' ,\n                        fieldname: 'item_code',\n                        label: 'Item Code',\n                        in_list_view: 0 ,\n                        read_only: 1 ,\n                        columns: 2 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'item_name',\n                        label: 'Item Name',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'qty',\n                        label: 'Quantity',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'max_qty',\n                        label: 'Allowed Qty',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'used_qty',\n                        label: 'Used Qty',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'rem_qty',\n                        label: 'Remaining Qty',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                        columns: 1 ,\n                    },\n                    {\n                        fieldtype: 'Float',\n                        fieldname: 'selected_qty',\n                        label: 'Select Qty',\n                        in_list_view: 1,\n                        read_only: 0 ,\n                        columns: 1 ,\n                    },\n                    \n                    \n                    { fieldtype: 'Float', fieldname: 'fl_item_gauge', label: 'FL Item Gauge', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'sum_of_duct_weight', label: 'Sum of Duct Weight', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'fl_item_specification', label: 'CAM Specification', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'sum_of_duct_area_with_seam', label: 'Sum of Duct Area with seam', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    \n                    {\n                        fieldtype: 'Link',\n                        fieldname: 'uom',\n                        label: 'UOM',\n                        options: 'UOM' , \n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    \n                    \n                    \n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'rm_check',\n                        label: 'Raw Material',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    \n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'acc_check',\n                        label: 'Accessory Item',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    \n                    {\n                        fieldtype: 'Check',\n                        fieldname: 'cons_check',\n                        label: 'Consumable Item',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    \n                ];\n\n\n                let dialog = new frappe.ui.Dialog({\n                    title: 'Material Request',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: '',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This table contains Coil items Summary + Accessory items list + consumable items list for purchase / transfer request.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Select\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        for (let item of selected_items) {\n                            if (item.selected_qty > item.rem_qty ) {\n                                frappe.msgprint(`Error: Selected quantity (${item.selected_qty}) cannot be greater than remaining quantity (${item.rem_qty}) for item ${item.item_code}`);\n                                return;\n                            }\n                            if (item.selected_qty <= 0) {\n                                frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n                                return;\n                            }\n                        }\n                        \n                        \n                        \n                        let matched_items = [];\n\n                        \n                        if (selected_items.length > 0) \n                        {\n\n                            frappe.new_doc(\"Material Request\", {\"material_request_type\": \"Material Transfer\"}, doc => {\n                                \n                                doc.company = frm.doc.company ;\n                                doc.transaction_date = frappe.datetime.get_today() ;\n                                doc.custom_manufacture_order = frm.doc.name ;\n                                doc.items = [];\n                        \n                                selected_items.forEach(item => {\n                                    let row = frappe.model.add_child(doc, \"items\");\n                                    frappe.model.set_value(row.doctype, row.name, 'item_code', item.item_code);\n                                    \n                                    frappe.model.set_value(row.doctype, row.name, 'custom_raw_material', item.rm_check);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_accessory_item', item.acc_check);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_consumable_item', item.cons_check);\n                                    \n                                    \n                                    \n                                    row.rate = 0;\n    \t\t                        row.uom = \"\";\n                                    \n                                    if(row.item_code)\n                                    {\n                                        frappe.call({\n                                \t\t\tmethod: \"erpnext.stock.get_item_details.get_item_details\",\n                                \t\t\targs: {\n                                \t\t\t\targs: {\n                                \t\t\t\t\titem_code: row.item_code,\n                                \t\t\t\t\tfrom_warehouse: row.from_warehouse,\n                                \t\t\t\t\twarehouse: row.warehouse,\n                                \t\t\t\t\tdoctype: 'Material Request',\n                                \t\t\t\t\tbuying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                                \t\t\t\t\tcurrency: frappe.defaults.get_default(\"Currency\"),\n                                \t\t\t\t\tname: doc.name,\n                                \t\t\t\t\tqty: item.selected_qty,\n                                \t\t\t\t\tstock_qty: row.stock_qty,\n                                \t\t\t\t\tcompany: frm.doc.company,\n                                \t\t\t\t\tconversion_rate: 1,\n                                \t\t\t\t\tmaterial_request_type: 'Material Transfer',\n                                \t\t\t\t\tplc_conversion_rate: 1,\n                                \t\t\t\t\trate: row.rate,\n                                \t\t\t\t\tuom: row.uom,\n                                \t\t\t\t\tconversion_factor: row.conversion_factor,\n                                \t\t\t\t\tproject: row.project,\n                                \t\t\t\t},\n                                \t\t\toverwrite_warehouse: true,\n                                \t\t\t},\n                                \t\t\tcallback: function (r) {\n                                \t\t\t\tconst d = row;\n                                \t\t\t\tconst allow_to_change_fields = [\n                                \t\t\t\t\t\"actual_qty\",\n                                \t\t\t\t\t\"projected_qty\",\n                                \t\t\t\t\t\"min_order_qty\",\n                                \t\t\t\t\t\"item_name\",\n                                \t\t\t\t\t\"description\",\n                                \t\t\t\t\t\"stock_uom\",\n                                \t\t\t\t\t\"uom\",\n                                \t\t\t\t\t\"conversion_factor\",\n                                \t\t\t\t\t\"stock_qty\",\n                                \t\t\t\t];\n                                \n                                \t\t\t\tif (!r.exc) {\n                                \t\t\t\t\t$.each(r.message, function (key, value) {\n                                \t\t\t\t\t\tif (!d[key] || allow_to_change_fields.includes(key)) {\n                                \t\t\t\t\t\t\td[key] = value;\n                                \t\t\t\t\t\t}\n                                \t\t\t\t\t});\n                                \n                                \t\t\t\t\tif (d.price_list_rate != r.message.price_list_rate) {\n                                \t\t\t\t\t\td.rate = 0.0;\n                                \t\t\t\t\t\td.price_list_rate = r.message.price_list_rate;\n                                \t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                                \t\t\t\t\t}\n                                                    // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                                \t\t\t\t\trefresh_field(\"items\");\n                                \t\t\t\t}\n                                \t\t\t},\n                                \t\t});\n                                    }\n                                    \n                                    let fg_row = frappe.model.add_child(doc, \"custom_finished_goods\");\n                                    frappe.model.set_value(fg_row.doctype, fg_row.name, 'finished_goods_item', item.item_code);\n                                    frappe.model.set_value(fg_row.doctype, fg_row.name, 'incoming_quantity', item.selected_qty);\n    \n                          \n                                });\n                                                            \n                            });\n                        \n                            \n                        }\n                        else {\n                            frappe.msgprint(\"Please select at least one <b>Finished Good</b> item that has <b>Raw Materials</b> assigned to it.\");\n                        }\n\n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n\n\n                let dummyData = [];\n\n                \n                \n                (frm.doc.raw_material_summary || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.material_item_code,\n                        item_name: row.material_item_code,\n                        qty: row.material_item_qty,\n                        max_qty: row.material_item_max_qty ,\n                        used_qty: row.material_item_used_qty,\n                        rem_qty: row.material_item_remaining_qty,\n                        selected_qty: row.material_item_remaining_qty,\n                        fl_item_gauge: row.fl_item_gauge,\n                        sum_of_duct_weight: row.sum_of_duct_weight,\n                        sum_of_duct_area_with_seam: row.sum_of_duct_area_with_seam,\n                        fl_item_specification: row.fl_item_specification ,\n                        uom: row.material_item_uom,\n                        rm_check: 1,\n                        acc_check: 0,\n                        cons_check: 0\n                    });\n                });\n                \n                (frm.doc.accessory_summary || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item_code_linked,\n                        item_name: row.item_name,\n                        qty: row.qty,\n                        max_qty: row.max_qty ,\n                        used_qty: row.used_qty,\n                        rem_qty: row.remaining_qty,\n                        selected_qty: row.remaining_qty,\n                        uom: row.uom,\n                        rm_check: 0,\n                        acc_check: 1,\n                        cons_check: 0\n                    });\n                });\n                \n                (frm.doc.consumable_cost || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item,\n                        item_name: row.item_name,\n                        qty: row.quantity,\n                        max_qty: row.max_quantity ,\n                        used_qty: row.used_quantity,\n                        rem_qty: row.remaining_quantity,\n                        selected_qty: row.remaining_quantity,\n                        uom: row.uom,\n                        rm_check: 0,\n                        acc_check: 0,\n                        cons_check: 1\n                    });\n                });\n                \n\n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n\n                dialog.show();\n\n                                \n            });\n            \n    \n        }\n          \n                                            \n                                            \n    } ,\n    \n    \n    // on_submit : function(frm)\n    // {\n    //     frm.get_field(\"job_card\").grid.cannot_add_rows = true;\n    //     frm.fields_dict[\"job_card\"].$wrapper.find('.btn.btn-xs.btn-secondary.grid-upload').addClass(\"hidden\");\n    // }\n\n\n\n    order_type : async function (frm)\n    {\n        \n        \n        if (frm.doc.order_type == 'Sales Order') {\n            \n            frm.set_value(\"document_id\", \"\");\n            frm.set_query(\"document_id\", function () {\n                  return {\n                        filters: [\n                            [\"Sales Order\", \"docstatus\", \"=\", 1]\n                        ],\n                  };\n            });\n            \n        }\n        \n        \n    } ,\n    \n    fg_based_operating_cost : async function (frm) \n    {\n        frm.set_value('total_over_head_cost_' , 0) ;\n        frm.set_value('total_over_head_cost' , 0) ;\n        \n    } ,\n\n\n    fabrication_list : async function (frm) \n    {\n        \n        frm.set_value('item_table',[]) ;\n        frm.set_value('raw_material_item',[]) ;\n        frm.set_value('raw_material_summary',[]);\n        frm.set_value('accessory_summary',[]) ;\n        frm.set_value('duct_and_acc_item',[]) ;\n        frm.set_value('auto_fold_summary',[]) ;\n        \n        frm.set_value('total_fl_item_qty',0) ;\n        frm.set_value('total_coil_item_qty',0) ;\n        \n        \n        \n        \n        \n        if (frm.doc.fabrication_list)\n        {\n            var fabrication = await frappe.db.get_doc('Fabrication List', frm.doc.fabrication_list) ;\n            // console.log(fabrication.fabrication_table) ;\n            \n            \n            frm.set_value('duct_and_acc_item' , fabrication.duct_and_acc_item) ;\n            \n            frm.set_value('auto_fold_summary' , fabrication.auto_fold_summary) ;\n            frm.set_value('total_fl_item_qty' , fabrication.total_fl_item_qty) ;\n            frm.set_value('total_coil_item_qty' , fabrication.total_coil_item_qty) ;\n            \n            \n            fabrication.fabrication_table.forEach(item => {\n                \n                var row = frappe.model.add_child(frm.doc, \"Costing Sheet Item\", \"item_table\");\n                \n                row.item_code = item.fg_batch_sr ;\n                row.item_name = item.fl_item_name ;\n                row.parent_finished_goods_item = item.spl_item_fg_code ;\n                row.quantity = item.fl_item_qty ;\n                row.uom = item.fl_item_uom ;\n                row.item_guage = item.fl_item_gauge ;\n                row.spl_area_sqm = item.spl_area_sqm ;\n                row.spl_weight_kg = item.spl_weight_kg ;\n                row.cam_item_vanes_splitter_qty_1 = item.cam_item_vanes_splitter_qty_1 ;\n                row.cam_item_duct_seam_1 = item.cam_item_duct_seam_1 ;\n                row.duct_range = item.duct_range ;\n                row.duct_connector_1 = item.duct_connector_1 ;\n                row.duct_connector_2 = item.duct_connector_2 ;\n                row.pl_item_length__angle = item.pl_item_length__angle ;\n                row.fabrication_cost = item.operation_cost ;\n                \n            });\n            \n            \n            fabrication.material_list1.forEach(item => {\n                \n                var row = frappe.model.add_child(frm.doc, \"Manufacture Order Material List\", \"raw_material_item\");\n                \n                row.fl_item = item.fl_item ;\n                row.fl_item_gauge = item.fl_item_gauge ;\n                row.sum_of_fl_item_qty = item.sum_of_fl_item_qty ;\n                \n                \n                row.spl_item_fg_code = item.spl_item_fg_code ;\n                row.spl_item_fg_name = item.spl_item_fg_name ;\n                \n                \n                row.coil_item_code_rm = item.coil_item_code_rm ;\n                row.coil_item_uom = item.coil_item_uom ;\n                row.coil_item_brand = item.coil_item_brand ;\n                row.coil_item_specification = item.coil_item_specification ;\n                row.item_group = item.coil_item_group ;\n                row.coil_item_qty = item.coil_item_qty ;\n                row.coil_item_remaining_qty = item.coil_item_qty ;\n                \n                row.sum_of_duct_weight = item.sum_of_duct_weight ;\n                row.sum_of_duct_area_with_seam = item.sum_of_duct_area_with_seam ;\n                row.fg_batch_sr = item.fg_batch_sr ;\n                \n            });\n            \n            \n            fabrication.material_summary.forEach(item => {\n                var row = frappe.model.add_child(frm.doc, \"Manufacture Order Material Summary\", \"raw_material_summary\");\n                \n                row.parent_finished_good = item.parent_finished_good ;\n                row.material_item_code = item.material_item_code ;\n                row.material_item_brand = item.material_item_brand ;\n                row.material_item_uom = item.material_item_uom ;\n                row.material_item_qty = item.material_item_qty ;\n                row.material_item_max_qty = 0 ;\n                row.material_item_used_qty = 0 ;\n                row.material_item_remaining_qty = 0 ;\n                row.sum_of_fl_item_qty = item.sum_of_fl_item_qty ;\n                row.fl_item_gauge = item.fl_item_gauge ;\n                \n                \n                row.sum_of_duct_weight = item.sum_of_duct_weight ;\n                row.sum_of_duct_area_with_seam = item.sum_of_duct_area_with_seam ;\n                row.fl_item_specification = item.fl_item_specification ;\n                \n            })\n            \n    \n            fabrication.acc_item.forEach(item => {\n                var row = frappe.model.add_child(frm.doc, \"Accessory Item Summary\", \"accessory_summary\");\n                \n                row.item_code = item.item_code ;\n                row.item_code_linked = item.item_code ;\n                row.item_name = item.item_name ;\n                row.uom = item.uom ;\n                row.qty = item.qty ;\n            });\n          \n            \n            \n            frm.refresh_field('item_table');\n            frm.refresh_field('raw_material_item');\n            frm.refresh_field('raw_material_summary');\n            frm.refresh_field('accessory_summary');\n            frm.refresh_field('duct_and_acc_item');\n            frm.refresh_field('auto_fold_summary');\n            frm.refresh_field('total_fl_item_qty');\n            frm.refresh_field('total_coil_item_qty');\n\n                \n        }\n    } ,\n    \n    \n    job_operations_complete: async function (frm) {\n        if (!frm.doc.job_card || frm.doc.job_card.length === 0) {\n            frappe.throw(\"Job Card table is empty.\");\n        }\n    \n        for (let row of frm.doc.job_card) {\n            if (row.end !== 1) {\n                frappe.throw(`Row ${row.idx} is not marked as completed.`);\n            }\n        }\n        \n        frm.set_value('job_operations_completed', 1) ;\n        if (frm.doc.docstatus == 1)\n        {\n            frm.save('Update') ;\n        }\n        else if (frm.doc.docstatus == 0)\n        {\n            frm.save() ;\n        }\n    },\n    \n    \n    \n    \n    \n    \n    \n     \n    before_submit: async function(frm) {\n\n        let mo_settings_doc = await frappe.db.get_doc('Manufacturing Order Settings');\n    \n        let account_entries = [] ;\n        \n        let mat_acc = null ;\n        let ass_acc = null ;\n        let cons_acc = null ;\n        let del_acc = null ;\n        let ad_ov_acc = null ;\n        let fab_acc = null ;\n        \n        let credit_acc = null ;\n    \n        if (mo_settings_doc.table_icuu && mo_settings_doc.table_icuu.length > 0) \n        {\n            for (let row of mo_settings_doc.table_icuu)\n            {\n                if (row.company === frm.doc.company) {\n                    if (row.cost_type === 'Material Cost') {\n                        mat_acc = row.expense_gl_account;\n                        if (frm.doc.total_raw_material_cost > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_raw_material_cost, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Accessory Cost') {\n                        ass_acc = row.expense_gl_account;\n                        if (frm.doc.total_accessory_item_amount_ > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_accessory_item_amount_, 'debit': 0 }) ;\n                        }\n                            \n                    }\n                    if (row.cost_type === 'Consumable Cost') {\n                        cons_acc = row.expense_gl_account;\n                        if (frm.doc.total_consumable_cost_1 > 0)\n                        {    \n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_consumable_cost_1, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Delivery Cost') {\n                        del_acc = row.expense_gl_account;\n                        if (frm.doc.total_delivery_cost1 > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_delivery_cost1, 'debit': 0 }) ;\n                        }        \n                    }\n                    if (row.cost_type === 'Additional OH Cost') {\n                        ad_ov_acc = row.expense_gl_account;\n                        if (frm.doc.total_over_head_cost > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_over_head_cost, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Fabrication Cost') {\n                        fab_acc = row.expense_gl_account;\n                        if (frm.doc.total_operation_cost_ > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_operation_cost_, 'debit': 0 }) ;\n                        }\n                    }\n                }\n            }\n        }\n        \n        if (mo_settings_doc.table_juan && mo_settings_doc.table_juan.length > 0) \n        {\n            for (let row of mo_settings_doc.table_juan)\n            {\n                if (row.company === frm.doc.company) {\n                    if (row.cost_type === 'Material Cost') {\n                        mat_acc = row.expense_gl_account;\n                        if (frm.doc.total_raw_material_cost > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_raw_material_cost, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Accessory Cost') {\n                        ass_acc = row.expense_gl_account;\n                        if (frm.doc.total_accessory_item_amount_ > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_accessory_item_amount_, 'debit': 0 }) ;\n                        }\n                            \n                    }\n                    if (row.cost_type === 'Consumable Cost') {\n                        cons_acc = row.expense_gl_account;\n                        if (frm.doc.total_consumable_cost_1 > 0)\n                        {    \n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_consumable_cost_1, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Delivery Cost') {\n                        del_acc = row.expense_gl_account;\n                        if (frm.doc.total_delivery_cost1 > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_delivery_cost1, 'debit': 0 }) ;\n                        }        \n                    }\n                    if (row.cost_type === 'Additional OH Cost') {\n                        ad_ov_acc = row.expense_gl_account;\n                        if (frm.doc.total_over_head_cost > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_over_head_cost, 'debit': 0 }) ;\n                        }\n                    }\n                    if (row.cost_type === 'Fabrication Cost') {\n                        fab_acc = row.expense_gl_account;\n                        if (frm.doc.total_operation_cost_ > 0)\n                        {\n                            account_entries.push({'account': row.expense_gl_account, 'credit': frm.doc.total_operation_cost_, 'debit': 0 }) ;\n                        }\n                    }\n                }\n            }\n        }\n        \n        \n        if ( mo_settings_doc.sasco_company == frm.doc.company )\n        {\n            credit_acc = mo_settings_doc.standard_cost_parking_gl_account ;\n            account_entries.push({'account': mo_settings_doc.standard_cost_parking_gl_account, 'credit': 0, 'debit': frm.doc.grand_total }) ;\n        }\n        else if ( mo_settings_doc.mabani_company == frm.doc.company )\n        {\n            credit_acc = mo_settings_doc.standard_cost_parking_gl_accounts ;\n            account_entries.push({'account': mo_settings_doc.standard_cost_parking_gl_accounts, 'credit': 0, 'debit': frm.doc.grand_total }) ;\n        }\n        \n        \n        \n        \n    \n        // console.log(mat_acc);\n        // console.log(ass_acc);\n        // console.log(cons_acc);\n        // console.log(del_acc);\n        // console.log(ad_ov_acc);\n        // console.log(fab_acc);\n        // console.log(credit_acc);\n        \n        \n        console.log(account_entries) ;\n        \n        \n        \n        \n        \n        \n        \n        \n        if ( mat_acc && ass_acc && cons_acc && del_acc && ad_ov_acc && fab_acc && credit_acc )\n        {\n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Journal Entry',\n                        voucher_type: 'Journal Entry',\n                        custom_manufacture_order: frm.doc.name,\n                        company: frm.doc.company ,\n                        posting_date: frappe.datetime.get_today() ,\n                        docstatus: 1,\n                        \n                        accounts: account_entries.map(acc => ({\n                            account: acc.account,\n                            debit_in_account_currency: acc.debit,\n                            credit_in_account_currency: acc.credit,\n                            manufacture_order: frm.doc.name ,\n                        }))\n                    }\n                },\n                callback: function(r) {\n                    if (!r.exc) {\n                        frappe.msgprint(`Journal Entry ${r.message.name} saved successfully!`);\n                        \n                        // frm.refresh_field('job_card');\n                        // frm.refresh();\n                        \n                        frm.set_value('jv_created', 1) ;\n                        \n                        if (frm.doc.docstatus == 1)\n                        {\n                            frm.save('Update') ;\n                        }\n                        else if (frm.doc.docstatus == 0)\n                        {\n                            frm.save() ;\n                        }\n                    } else {\n                        frappe.msgprint(`Error: ${r.exc}`);\n                    }\n                }\n            });\n    \n        }\n        else\n        {\n            frappe.throw(\"Define all types of cost accounts in Manufacture Order Settings.\") ;\n        }\n\n                    \n                    \n        \n                    \n                    \n        \n    \n    \n        \n        \n    \n        \n        \n       \n    },\n    \n    \n    \n    \n    \n    \n    \n\n\n    \n});\n\n\n\nfrappe.ui.form.on('Manufacture Order Job Card', {\n    \n    start: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let cur_date_time = frappe.datetime.now_datetime(); // Corrected method\n\n        frappe.model.set_value(cdt, cdn, 'start_time', cur_date_time);\n        frappe.model.set_value(cdt, cdn, 'status', 'Start');\n\n        frm.refresh_field('items'); \n    },\n    \n    end: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        let cur_date_time = frappe.datetime.now_datetime(); // Corrected method\n\n        frappe.model.set_value(cdt, cdn, 'end_time', cur_date_time);\n        frappe.model.set_value(cdt, cdn, 'status', 'Close');\n        \n        frm.refresh_field('items');\n\n        // let duration = frappe.datetime.get_hour_diff(cur_date_time, row.start_time);\n        // frappe.model.set_value(cdt, cdn, 'time_spent', duration);\n        \n        \n        let time_diff_in_seconds = moment(cur_date_time).diff(row.start_time, 'seconds', true);\n        frappe.model.set_value(cdt, cdn, 'time_spent', time_diff_in_seconds);\n\n        frm.refresh_field('items'); \n    },\n    \n    \n    operation_transfer: async function(frm, cdt, cdn)\n    {\n        var sel_row = locals[cdt][cdn] ;\n        var res = await frappe.db.get_value( \"Operation\", sel_row.operation, 'is_corrective_operation') ;\n        var q_st_check = res.message.is_corrective_operation ;\n        \n        if (sel_row.start == true && sel_row.end != true)\n        {\n            console.log(q_st_check);\n            \n            if ( q_st_check == 1 )\n            {\n                \n                const table_rpga_data = [...frm.doc.table_rpga] || [];\n                        \n                \n                const tableFields = [\n                    { fieldtype: 'Link', options: 'Item' , fieldname: 'item_code', label: 'FG Item Code', in_list_view: 1 , read_only: 1 , columns: 2 ,},\n                    { fieldtype: 'Data', fieldname: 'item_name', label: 'FG Item Name', in_list_view: 0, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Link', options: 'UOM' , fieldname: 'uom', label: 'UOM', in_list_view: 0, read_only: 1 , columns: 1 , },\n                    \n                    { fieldtype: 'Select', fieldname: 'quality_status', label: 'Quality Status', options: 'Pass\\nFails', in_list_view: 1 , read_only: 0 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'item_gauge', label: 'Item Gauge', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'qty', label: 'Quantity', in_list_view: 1, read_only: 0 , columns: 1 , },\n                    \n                    { fieldtype: 'Link', options: 'Brand', fieldname: 'brand', label: 'Brand', in_list_view: 0 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_area_sqm', label: 'SPL Area SQM', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_weight_kg', label: 'SPL Weight KG', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_vanes_splitter_qty_1', label: 'CAM Item Vanes Splitter Qty 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_duct_seam_1', label: 'CAM Item Duct Seam 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_range', label: 'Duct Range', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                    { fieldtype: 'Data', fieldname: 'duct_connector_1', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_connector_2', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'pl_item_length__angle', label: 'PL Item Length / Angle', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                ];\n        \n        \n                let dialog = new frappe.ui.Dialog({\n                    title: 'Finished Goods Item',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: 'Items',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This is a table with finished goods data.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Create Operations Transfer\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        for (let item of selected_items) {\n                            if (item.qty <= 0) {\n                                frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n                                return;\n                            }\n                        }\n                      \n                        \n                        if (selected_items.length > 0) \n                        {\n        \n                            frappe.call({\n                                method: 'frappe.client.insert',\n                                args: {\n                                    doc: {\n                                        doctype: 'Operations Transfers',\n                                        manufacture_order: frm.doc.name,\n                                        fabrication_list: frm.doc.fabrication_list,\n                                        project: frm.doc.project ,\n                                        company: frm.doc.company ,\n                                        operation: sel_row.operation,\n                                        operation_name: sel_row.operation_name,\n                                        machine_name: sel_row.machine_name,\n                                        status: sel_row.status,\n                                        start_time: sel_row.start_time,\n                                        end_time: sel_row.end_time,\n                                        time_spent: sel_row.time_spent,\n                                        docstatus: 1,\n                                        job_operation_row_name: sel_row.name,\n                                        quality_operation: 1,\n                                        item: selected_items.map(item => ({\n                                            item_code: item.item_code,\n                                            item_name: item.item_name,\n                                            quantity: item.qty,\n                                            uom: item.uom,\n                                            quality_status: item.quality_status,\n                                            brand: item.brand,\n                                            item_gauge: item.item_gauge,\n                                            spl_area_sqm: item.spl_area_sqm,\n                                            spl_weight_kg: item.spl_weight_kg,\n                                            cam_item_vanes_splitter_qty_1: item.cam_item_vanes_splitter_qty_1,\n                                            cam_item_duct_seam_1: item.cam_item_duct_seam_1,\n                                            duct_range: item.duct_range,\n                                            duct_connector_1: item.duct_connector_1,\n                                            duct_connector_2: item.duct_connector_2,\n                                            pl_item_length__angle: item.pl_item_length__angle,\n                                        }))\n                                    }\n                                },\n                                callback: function(r) {\n                                    if (!r.exc) {\n                                        frappe.msgprint(`Operations Transfer ${r.message.name} saved successfully!`);\n                                        frappe.model.set_value(sel_row.doctype , sel_row.name, 'operations_transfers_created', sel_row.operations_transfers_created + 1) ;\n                                        // frm.refresh_field('job_card');\n                                        // frm.refresh();\n                                        \n                                        \n                                        \n                                        for (let item of selected_items) {\n                                            \n                                            (frm.doc.item_table || []).forEach(x => {\n                                \n                                                if ( x.item_code == item.item_code && item.quality_status == 'Pass' )\n                                                {\n                                                    frappe.model.set_value(x.doctype , x.name, 'pass_count', x.pass_count + 1) ;\n                                                    // break ;\n                                                }\n                                                \n                                                \n                                            });\n                                        }\n                      \n                                        \n                                        \n                                        \n                                        \n                                        \n                                        \n                                        if (frm.doc.docstatus == 1)\n                                        {\n                                            frm.save('Update') ;\n                                        }\n                                        else if (frm.doc.docstatus == 0)\n                                        {\n                                            frm.save() ;\n                                        }\n                                    } else {\n                                        frappe.msgprint(`Error: ${r.exc}`);\n                                    }\n                                }\n                            });\n        \n                        }\n                        else \n                        {\n                            frappe.msgprint(\"Please select at least one item.\");\n                        }\n        \n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n        \n        \n                let dummyData = [];\n        \n        \n                (frm.doc.item_table || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item_code,\n                        item_name: row.item_name,\n                        qty: row.quantity,\n                        uom: row.uom,\n                        quality_status: \"Pass\",\n                        brand: row.brand,\n                        item_gauge: row.item_guage ,\n                        spl_area_sqm: row.spl_area_sqm,\n                        spl_weight_kg: row.spl_weight_kg,\n                        cam_item_vanes_splitter_qty_1: row.cam_item_vanes_splitter_qty_1,\n                        cam_item_duct_seam_1: row.cam_item_duct_seam_1,\n                        duct_range: row.duct_range,\n                        duct_connector_1: row.duct_connector_1,\n                        duct_connector_2: row.duct_connector_2 ,\n                        pl_item_length__angle: row.pl_item_length__angle ,\n                    });\n                });\n        \n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n        \n                dialog.show();\n            }\n        \n            else \n            {\n            \n                const table_rpga_data = [...frm.doc.table_rpga] || [];\n                const tableFields = [\n                    \n                    { fieldtype: 'Link', options: 'Item' , fieldname: 'item_code', label: 'FG Item Code', in_list_view: 1 , read_only: 1 , columns: 2 ,},\n                    \n                    \n                    { fieldtype: 'Data', fieldname: 'item_name', label: 'FG Item Name', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Link', options: 'UOM' , fieldname: 'uom', label: 'UOM', in_list_view: 1, read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'qty', label: 'Quantity', in_list_view: 1, read_only: 0 , columns: 1 , },\n                    \n                    \n                    \n                    \n                    { fieldtype: 'Float', fieldname: 'item_gauge', label: 'Item Gauge', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Link', options: 'Brand', fieldname: 'brand', label: 'Brand', in_list_view: 0 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_area_sqm', label: 'SPL Area SQM', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'spl_weight_kg', label: 'SPL Weight KG', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_vanes_splitter_qty_1', label: 'CAM Item Vanes Splitter Qty 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'cam_item_duct_seam_1', label: 'CAM Item Duct Seam 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_range', label: 'Duct Range', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_connector_1', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Data', fieldname: 'duct_connector_2', label: 'Duct Connector 1', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    { fieldtype: 'Float', fieldname: 'pl_item_length__angle', label: 'PL Item Length / Angle', in_list_view: 1 , read_only: 1 , columns: 1 , },\n                    \n                    \n                    \n                    \n                ];\n                let dialog = new frappe.ui.Dialog({\n                    title: 'Finished Goods Item',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: 'Items',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This is a table with finished goods data.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Create Operations Transfer\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        for (let item of selected_items) {\n                            if (item.qty <= 0) {\n                                frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n                                return;\n                            }\n                        }\n                      \n                        \n                        if (selected_items.length > 0) \n                        {\n        \n                            \n                            frappe.call({\n                                method: 'frappe.client.insert',\n                                args: {\n                                    doc: {\n                                        doctype: 'Operations Transfers',\n                                        manufacture_order: frm.doc.name,\n                                        fabrication_list: frm.doc.fabrication_list,\n                                        project: frm.doc.project ,\n                                        company: frm.doc.company ,\n                                        operation: sel_row.operation,\n                                        operation_name: sel_row.operation_name,\n                                        machine_name: sel_row.machine_name,\n                                        status: sel_row.status,\n                                        start_time: sel_row.start_time,\n                                        end_time: sel_row.end_time,\n                                        time_spent: sel_row.time_spent,\n                                        docstatus: 1,\n                                        job_operation_row_name: sel_row.name,\n                                        item: selected_items.map(item => ({\n                                            item_code: item.item_code,\n                                            item_name: item.item_name,\n                                            quantity: item.qty,\n                                            uom: item.uom,\n                                            brand: item.brand,\n                                            item_gauge: item.item_gauge,\n                                            spl_area_sqm: item.spl_area_sqm,\n                                            spl_weight_kg: item.spl_weight_kg,\n                                            cam_item_vanes_splitter_qty_1: item.cam_item_vanes_splitter_qty_1,\n                                            cam_item_duct_seam_1: item.cam_item_duct_seam_1,\n                                            duct_range: item.duct_range,\n                                            duct_connector_1: item.duct_connector_1,\n                                            duct_connector_2: item.duct_connector_2,\n                                            pl_item_length__angle: item.pl_item_length__angle,\n                                        }))\n                                    }\n                                },\n                                callback: function(r) {\n                                    if (!r.exc) \n                                    {\n                                        frappe.msgprint(`Operations Transfer ${r.message.name} saved successfully!`);\n                                        frappe.model.set_value(sel_row.doctype , sel_row.name, 'operations_transfers_created', sel_row.operations_transfers_created + 1) ;\n                                        \n                                        for (let item of selected_items) {\n                                            \n                                            (frm.doc.item_table || []).forEach(x => {\n                                \n                                                if ( x.item_code == item.item_code && item.quality_status == 'Pass' )\n                                                {\n                                                    frappe.model.set_value(x.doctype , x.name, 'pass_count', x.pass_count + 1) ;\n                                                }\n                                                \n                                                \n                                            });\n                                        }\n                      \n                                        \n                                        if (frm.doc.docstatus == 1)\n                                        {\n                                            frm.save('Update') ;\n                                        }\n                                        else if (frm.doc.docstatus == 0)\n                                        {\n                                            frm.save() ;\n                                        }\n                                    } \n                                    else \n                                    {\n                                        frappe.msgprint(`Error: ${r.exc}`);\n                                    }\n                                }\n                            });\n        \n                            \n                            \n                            \n                        }\n                        else \n                        {\n                            frappe.msgprint(\"Please select at least one item.\");\n                        }\n        \n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n                let dummyData = [];\n                (frm.doc.item_table || []).forEach(row => {\n                    dummyData.push({\n                        item_code: row.item_code,\n                        item_name: row.item_name,\n                        qty: row.quantity,\n                        uom: row.uom,\n                        \n                        \n                        \n                        brand: row.brand,\n                        item_gauge: row.item_guage ,\n                        spl_area_sqm: row.spl_area_sqm,\n                        spl_weight_kg: row.spl_weight_kg,\n                        cam_item_vanes_splitter_qty_1: row.cam_item_vanes_splitter_qty_1,\n                        cam_item_duct_seam_1: row.cam_item_duct_seam_1,\n                        duct_range: row.duct_range,\n                        duct_connector_1: row.duct_connector_1,\n                        duct_connector_2: row.duct_connector_2 ,\n                        pl_item_length__angle: row.pl_item_length__angle ,\n                    });\n                });\n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n                dialog.show();\n                \n                \n            }\n            \n        }\n       \n    },\n    \n    \n    \n    before_job_card_remove: function(frm, cdt, cdn)\n    {\n        row = locals[cdt][cdn] ;\n        if ( row.operations_transfers_created >= 1 )\n        {\n            frappe.throw(`Cannot delete row ${row.idx} because you have created ${row.operations_transfers_created} Operation Transfers for this job.`)\n        }\n    },\n    \n    \n});\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-02-06 15:20:54.907156",
  "module": null,
  "name": "Filter project location to restrict is group to no",
  "script": "frappe.ui.form.on('Project', {\r\n    \r\n    onload: function(frm) {\r\n        set_custom_territory_query(frm);\r\n    },\r\n    custom_project_territory: function(frm) {\r\n        set_custom_territory_query(frm);\r\n    }\r\n});\r\n\r\n\r\nfunction set_custom_territory_query(frm) {\r\n    frm.fields_dict['custom_project_territory'].get_query = function(doc) {\r\n        return {\r\n            filters: {\r\n                'is_group': 0\r\n            }\r\n        };\r\n    };\r\n    frm.refresh_field('custom_project_territory');\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Rejoining Form",
  "enabled": 1,
  "modified": "2024-12-03 16:34:26.873872",
  "module": null,
  "name": "filer only submitted records on employee rejoining",
  "script": "frappe.ui.form.on('Employee Rejoining Form', {\r\n    refresh(frm) {\r\n        // Apply filter to the 'leave_application' field\r\n        frm.fields_dict['leave_application'].get_query = function(doc) {\r\n            return {\r\n                filters: {\r\n                    docstatus: 1,  // Filter to only show 'Submitted' records\r\n                }\r\n            };\r\n        };\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Rejoining Form",
  "enabled": 1,
  "modified": "2024-12-04 11:06:48.344483",
  "module": null,
  "name": "move from employee rejoining to leave salary",
  "script": "frappe.ui.form.on('Employee Rejoining Form', {\r\n    refresh: async function(frm) {\r\n        frm.add_custom_button(\r\n            __(\"Leave Salary\"),\r\n            function() {\r\n                // Define the action for the Employee Rejoining button\r\n                createemployeerejoining(frm.doc);\r\n            },\r\n            __(\"Create\")\r\n        );\r\n    }\r\n});\r\n\r\nfunction createemployeerejoining(leave) {\r\n    frappe.model.with_doctype('Employee Rejoining Form', function() {\r\n        var leavesalary = frappe.model.get_new_doc('Leave Salary');\r\n        // Set fields in the Leave Salary document\r\n        leavesalary.employee = leave.employee;\r\n        leavesalary.from_date = leave.from;\r\n        leavesalary.to_date = leave.from_date;\r\n        leavesalary.total_days = leave.total_days;\r\n        leavesalary.from = leave.from;\r\n        leavesalary.to = leave.to;\r\n        leavesalary.total_day = leave.total_days;\r\n\r\n        // Assuming 'emprejoin' is the document you want to set the route to\r\n        frappe.set_route('Form', 'Leave Salary', leavesalary.name); // Fixed: 'leave.name' instead of 'emprejoin.name'\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Event",
  "enabled": 1,
  "modified": "2024-12-18 11:29:49.340486",
  "module": null,
  "name": "Sales plan current time restriction",
  "script": "frappe.ui.form.on('Event', {\n    starts_on: function(frm) {\n        console.log(frm.doc)\n        // Get current datetime\n        let currentDateTime = frappe.datetime.now_datetime();\n        \n        // Get selected datetime\n        let selectedDateTime = frm.doc.starts_on;\n        \n       \n     \n        \n        // Compare dates\n        if (selectedDateTime < currentDateTime) {\n            // Clear the field\n            \n            \n          \n            frappe.throw({\n                title: __('Invalid Date'),\n                indicator: 'red',\n                message: __('Schedule Time cannot be in the past. Please select a current or future date/time.')\n            });\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication Filter",
  "enabled": 0,
  "modified": "2025-06-24 12:41:08.553738",
  "module": null,
  "name": "Create Quotation",
  "script": "\nfrappe.ui.form.on('Fabrication Filter', {\n    \n    refresh: function(frm) {\n        if (frm.doc.docstatus === 1) {\n            frm.add_custom_button(\n                __(\"Sales Quotation\"),\n                function() {\n                    createQuotation(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n    } ,\n    \n    \n    customer: async function(frm)\n    {\n        frm.set_value('filtered_fabrication_list', [])\n        if(frm.doc.customer)\n        {\n            var fab_list = await frappe.db.get_list('Fabrication List', {\n                                fields : ['name' , 'client_ref' , 'normal' , 'project_ref' ,'lead' ,'oppurtunity' ,'fabrication_template'] ,\n                                filters : { client_ref : frm.doc.customer , docstatus : 1 },\n                            }) ;\n            if (fab_list)\n            {\n                \n                fab_list.forEach(row => {\n                    frm.add_child('filtered_fabrication_list', {\n                        fabrication : row.name ,\n                        customer : row.client_ref ,\n                        date : row.normal ,\n                        project : row.project_ref ,\n                        lead : row.lead ,\n                        oppurtunity : row.oppurtunity ,\n                        fabrication_template : row.fabrication_template ,\n                    });\n                });\n                frm.refresh_field('filtered_fabrication_list') ;\n                \n            }\n        }\n    }\n    \n});\n\n\n\n\n\n\nasync function createQuotation(fabrication_filter) {\n    frappe.new_doc(\"Quotation\", { \"quotation_to\": \"Customer\" }, async (doc) => {\n        doc.company = fabrication_filter.company;\n        doc.transaction_date = frappe.datetime.get_today();\n        doc.custom_quotation_status = 'Under Negotiation';\n        doc.custom_refrence = fabrication_filter.sales_inquiry;\n        doc.party_name = fabrication_filter.customer;\n        doc.project = fabrication_filter.project;\n        doc.custom_multi_fabrication = 1 ;\n        doc.custom_fabrication_filter = fabrication_filter.name ;\n        doc.custom_parent_item = fabrication_filter.parent_item ;\n        doc.items = [];\n\n            \n        fabrication_filter.fabrication_filter_items.forEach(item => {\n                                    let row = frappe.model.add_child(doc, \"items\");\n                                    frappe.model.set_value(row.doctype, row.name, 'item_code', item.item);\n                                    frappe.model.set_value(row.doctype, row.name, 'custom_parent_item_1', item.parent_item);\n                                    \n                                    row.rate = 0;\n    \t\t                        row.uom = \"\";\n                                    \n                                    if(row.item_code)\n                                    {\n                                        frappe.call({\n                                \t\t\tmethod: \"erpnext.stock.get_item_details.get_item_details\",\n                                \t\t\targs: {\n                                \t\t\t\targs: {\n                                \t\t\t\t\titem_code: row.item_code,\n                                \t\t\t\t\tfrom_warehouse: row.from_warehouse,\n                                \t\t\t\t\twarehouse: row.warehouse,\n                                \t\t\t\t\tdoctype: 'Quotation',\n                                \t\t\t\t\tbuying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                                \t\t\t\t\tcurrency: frappe.defaults.get_default(\"Currency\"),\n                                \t\t\t\t\tname: doc.name,\n                                \t\t\t\t\tqty: item.quantity,\n                                \t\t\t\t\tstock_qty: row.stock_qty,\n                                \t\t\t\t\tcompany: doc.company,\n                                \t\t\t\t\tconversion_rate: 1,\n                                \t\t\t\t// \tmaterial_request_type: 'Purchase',\n                                \t\t\t\t\tplc_conversion_rate: 1,\n                                \t\t\t\t\trate: row.rate,\n                                \t\t\t\t\tuom: item.uom,\n                                \t\t\t\t\tconversion_factor: row.conversion_factor,\n                                \t\t\t\t\tproject: row.project,\n                                \t\t\t\t},\n                                \t\t\toverwrite_warehouse: true,\n                                \t\t\t},\n                                \t\t\tcallback: function (r) {\n                                \t\t\t\tconst d = row;\n                                \t\t\t\tconst allow_to_change_fields = [\n                                \t\t\t\t\t\"actual_qty\",\n                                \t\t\t\t\t\"projected_qty\",\n                                \t\t\t\t\t\"min_order_qty\",\n                                \t\t\t\t\t\"item_name\",\n                                \t\t\t\t\t\"description\",\n                                \t\t\t\t\t\"stock_uom\",\n                                \t\t\t\t\t\"uom\",\n                                \t\t\t\t\t\"conversion_factor\",\n                                \t\t\t\t\t\"stock_qty\",\n                                \t\t\t\t];\n                                \n                                \t\t\t\tif (!r.exc) {\n                                \t\t\t\t\t$.each(r.message, function (key, value) {\n                                \t\t\t\t\t\tif (!d[key] || allow_to_change_fields.includes(key)) {\n                                \t\t\t\t\t\t\td[key] = value;\n                                \t\t\t\t\t\t}\n                                \t\t\t\t\t});\n                                \n                                \t\t\t\t\tif (d.price_list_rate != r.message.price_list_rate) {\n                                \t\t\t\t\t\td.rate = 0.0;\n                                \t\t\t\t\t\td.price_list_rate = r.message.price_list_rate;\n                                \t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                                \t\t\t\t\t}\n                                                    // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                                \t\t\t\t\trefresh_field(\"items\");\n                                \t\t\t\t}\n                                \t\t\t},\n                                \t\t});\n                                    }\n                          \n                                });\n\n    });\n    \n    \n}\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication List",
  "enabled": 1,
  "modified": "2025-09-15 16:06:44.003773",
  "module": null,
  "name": "Create Quotation Through Fabrication List",
  "script": "frappe.ui.form.on('Fabrication List', {\n    refresh: function (frm) {\n        if (frm.doc.docstatus === 1) {\nfrm.add_custom_button(\n    __(\"Sales Quotation\"),\n    function () {\n        frappe.prompt(\n            [\n                {\n                    fieldname: \"uom\",\n                    label: \"Unit of Measurement\",\n                    fieldtype: \"Select\",\n                    options: [\"SQM\", \"KG\"],\n                    reqd: 1,\n                    default: \"SQM\"\n                }\n            ],\n            function (values) {\n                frappe.call({\n                    method: \"sasco.sasco.utils.fabrication_utils.create_quotation_from_fabrication\",\n                    args: {\n                        fabrication_name: frm.doc.name,\n                        uom: values.uom\n                    },\n                    callback: function (r) {\n                        if (!r.exc) {\n                            frappe.set_route(\"Form\", \"Quotation\", r.message);\n                        }\n                    }\n                });\n            },\n            __(\"Select UOM\"),\n            __(\"Create\")\n        );\n    },\n    __(\"Create\")\n);            \n            // frm.add_custom_button(\n            //     __(\"Sales Quotation\"),\n            //     function () {\n            //         //sufyancreateQuotationChildItems(frm.doc);\n            //         frappe.call({\n            //             method: \"sasco.sasco.utils.fabrication_utils.create_quotation_from_fabrication\",\n            //             args: { fabrication_name: cur_frm.doc.name },\n            //             callback: function (r) {\n            //                 if (!r.exc) {\n            //                     frappe.set_route(\"Form\", \"Quotation\", r.message);\n            //                 }\n            //             }\n            //         });\n            //     },\n            //     __(\"Create\")\n            // );\n            frm.add_custom_button(\n                __(\"Manufacture Order\"),\n                function () {\n                sufyancreateManufactureOrder(frm.doc);\n                // frappe.call({\n                //     method: \"sasco.sasco.utils.fabrication_utils.create_manufacture_order\",\n                //     args: { fabrication_name: frm.doc.name },\n                //     callback: function(r) {\n                //         if (r.message) {\n                //             frappe.set_route(\"Form\", \"Manufacture Order\", r.message);\n                //         }\n                //     }\n                // });  \n                },\n                __(\"Create\")\n            );\n            frm.add_custom_button(\n                __(\"Costing Sheet\"),\n                function () {\n                    sufyancreateCostingSheet(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n    },\n\n\n    fabrication_type: function (frm) {\n        if (frm.doc.fabrication_type == 'Sales Inquiry') {\n            frm.set_value('sales_order', null);\n        }\n        else if (frm.doc.fabrication_type == 'Sales Order') {\n            frm.set_value('priority', null);\n        }\n        else {\n            frm.set_value('sales_order', null);\n            frm.set_value('priority', null);\n        }\n    },\n\n\n    sales_order: async function (frm) {\n        if (frm.doc.sales_order) {\n            if (frm.doc.fabrication_type == 'Sales Order') {\n                so_doc = await frappe.db.get_doc('Sales Order', frm.doc.sales_order);\n                frm.set_value('client_ref', so_doc.customer);\n                frm.set_value('project_ref', so_doc.project);\n                frm.set_value('company', so_doc.company);\n            }\n        }\n\n    },\n\n\n\n\n});\n\n\nasync function sufyancreateQuotation(fabrication) {\n\n\n    frappe.new_doc(\"Quotation\", { \"quotation_to\": \"Customer\" }, doc => {\n\n        doc.company = fabrication.company;\n        doc.transaction_date = frappe.datetime.get_today();\n        doc.custom_quotation_status = 'Under Negotiation';\n        doc.custom_refrence = fabrication.priority;\n        doc.party_name = fabrication.client_ref;\n        doc.project = fabrication.project_ref;\n        doc.custom_fabrication_list = fabrication.name;\n        doc.custom_job_number = fabrication.job_number;\n        doc.items = [];\n\n\n        let unique_codes = {};\n\n        if (fabrication.fabrication_table) {\n            fabrication.fabrication_table.forEach(row => {\n                let key = row.spl_item_fg_code;\n\n                if (!unique_codes[key]) {\n                    unique_codes[key] = {\n                        spl_item_fg_code: row.spl_item_fg_code,\n                        spl_qty_in_pcs: parseFloat(row.spl_qty_in_pcs) || 0,\n                        spl_area_sqm: parseFloat(row.spl_area_sqm) || 0,\n                        spl_weight_kg: parseFloat(row.spl_weight_kg) || 0\n                    };\n                } else {\n                    unique_codes[key].spl_qty_in_pcs += parseFloat(row.spl_qty_in_pcs) || 0;\n                    unique_codes[key].spl_area_sqm += parseFloat(row.spl_area_sqm) || 0;\n                    unique_codes[key].spl_weight_kg += parseFloat(row.spl_weight_kg) || 0;\n                }\n            });\n        }\n\n        // console.log(unique_codes);\n\n\n        Object.values(unique_codes).forEach(item => {\n\n\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.spl_item_fg_code);\n\n            frappe.model.set_value(row.doctype, row.name, 'custom_spl_area_sqm', item.spl_area_sqm);\n            frappe.model.set_value(row.doctype, row.name, 'custom_spl_weight_kg', item.spl_weight_kg);\n\n\n            row.rate = 0;\n            row.uom = \"\";\n\n            if (row.item_code) {\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.spl_qty_in_pcs,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            // \tmaterial_request_type: 'Purchase',\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: row.uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project,\n                        },\n                        overwrite_warehouse: true,\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\",\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n\n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n                            // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                            refresh_field(\"items\");\n                        }\n                    },\n                });\n            }\n\n\n\n        });\n\n\n        let acc_unique_codes = {};\n\n        if (fabrication.accessory) {\n            fabrication.accessory.forEach(row => {\n                let key = `${row.child_finished_good_item}-${row.child_finished_good_uom}`; // Composite Key\n\n                if (!acc_unique_codes[key]) {\n                    acc_unique_codes[key] = {\n                        child_finished_good_item: row.child_finished_good_item,\n                        child_finished_good_uom: row.child_finished_good_uom,\n                        child_finished_good_qty: parseFloat(row.child_finished_good_qty) || 0,\n                    };\n                } else {\n                    acc_unique_codes[key].child_finished_good_qty += parseFloat(row.child_finished_good_qty) || 0;\n                }\n            });\n        }\n\n        // console.log(acc_unique_codes);\n\n\n\n        Object.values(acc_unique_codes).forEach(item => {\n\n\n            // console.log(item.child_finished_good_item);\n\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.child_finished_good_item);\n\n\n\n            row.rate = 0;\n            row.uom = \"\";\n\n            if (row.item_code) {\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.child_finished_good_qty,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            // \tmaterial_request_type: 'Purchase',\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: item.child_finished_good_uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project,\n                        },\n                        overwrite_warehouse: true,\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\",\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n\n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n                            // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                            refresh_field(\"items\");\n                        }\n                    },\n                });\n            }\n\n\n\n        });\n\n\n\n\n\n\n\n\n\n    });\n}\n\n\n\n\n\nasync function sufyancreateManufactureOrder(fabrication) {\n    frappe.new_doc(\"Manufacture Order\", { company: fabrication.company }, doc => {\n        // Basic fields\n        Object.assign(doc, {\n            company: fabrication.company,\n            date: fabrication.normal,\n            fabrication_list: fabrication.name,\n            total_fl_item_qty: fabrication.total_fl_item_qty,\n            total_coil_item_qty: fabrication.total_coil_item_qty\n        });\n\n        // 1. Costing Sheet Items\n        fabrication.fabrication_table.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Costing Sheet Item\", \"item_table\");\n            Object.assign(row, {\n                item_code: item.fg_batch_sr,\n                item_name: item.fl_item_name,\n                parent_finished_goods_item: item.spl_item_fg_code,\n                quantity: item.fl_item_qty,\n                uom: item.fl_item_uom,\n                item_guage: item.fl_item_gauge,\n                spl_area_sqm: item.spl_area_sqm,\n                spl_weight_kg: item.spl_weight_kg,\n                cam_item_vanes_splitter_qty_1: item.cam_item_vanes_splitter_qty_1,\n                cam_item_duct_seam_1: item.cam_item_duct_seam_1,\n                duct_range: item.duct_range,\n                duct_connector_1: item.duct_connector_1,\n                duct_connector_2: item.duct_connector_2,\n                pl_item_length__angle: item.pl_item_length__angle,\n                fabrication_cost: item.operation_cost\n            });\n        });\n\n        // 2. Material List\n        fabrication.material_list1.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Manufacture Order Material List\", \"raw_material_item\");\n            Object.assign(row, {\n                fl_item: item.fl_item,\n                fl_item_gauge: item.fl_item_gauge,\n                sum_of_fl_item_qty: item.sum_of_fl_item_qty,\n                spl_item_fg_code: item.spl_item_fg_code,\n                spl_item_fg_name: item.spl_item_fg_name,\n                coil_item_code_rm: item.coil_item_code_rm,\n                coil_item_uom: item.coil_item_uom,\n                coil_item_brand: item.coil_item_brand,\n                coil_item_specification: item.coil_item_specification,\n                item_group: item.coil_item_group,\n                coil_item_qty: item.coil_item_qty,\n                coil_item_remaining_qty: item.coil_item_qty,\n                sum_of_duct_weight: item.sum_of_duct_weight,\n                sum_of_duct_area_with_seam: item.sum_of_duct_area_with_seam,\n                fg_batch_sr: item.fg_batch_sr\n            });\n        });\n\n        // 3. Material Summary\n        fabrication.material_summary.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Manufacture Order Material Summary\", \"raw_material_summary\");\n            Object.assign(row, {\n                parent_finished_good: item.parent_finished_good,\n                material_item_code: item.material_item_code,\n                material_item_brand: item.material_item_brand,\n                material_item_uom: item.material_item_uom,\n                material_item_qty: item.material_item_qty,\n                material_item_max_qty: 0,\n                material_item_used_qty: 0,\n                material_item_remaining_qty: 0,\n                sum_of_fl_item_qty: item.sum_of_fl_item_qty,\n                fl_item_gauge: item.fl_item_gauge,\n                sum_of_duct_weight: item.sum_of_duct_weight,\n                sum_of_duct_area_with_seam: item.sum_of_duct_area_with_seam,\n                fl_item_specification: item.fl_item_specification\n            });\n        });\n\n        // 4. Accessory Summary\n        fabrication.acc_item.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Accessory Item Summary\", \"accessory_summary\");\n            Object.assign(row, {\n                item_code: item.item_code,\n                item_code_linked: item.item_code,\n                item_name: item.item_name,\n                uom: item.uom,\n                qty: item.qty\n            });\n        });\n\n        // 5. Auto Fold Summary (fixed)\n        fabrication.auto_fold_summary.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Auto Fold Summary\", \"auto_fold_summary\");\n            Object.assign(row, {\n                item_code: item.item_code,\n                item_name: item.item_name,\n                uom: item.uom,\n                qty: item.qty\n            });\n        });\n\n        // 6. Fabrication Item Summary\n        fabrication.duct_and_acc_item.forEach(item => {\n            let row = frappe.model.add_child(doc, \"Fabrication Item Summary\", \"duct_and_acc_item\");\n            Object.assign(row, {\n                item_code: item.item_code,\n                item_name: item.item_name,\n                uom: item.uom,\n                qty: item.qty,\n                spl_area_sqm: item.spl_area_sqm,\n                spl_weight_kg: item.spl_weight_kg,\n                duct_range: item.duct_range\n            });\n        });\n\n        // Navigate to the new Manufacture Order form\n        frappe.set_route(\"Form\", \"Manufacture Order\", doc.name);\n    });\n}\n\n\n\n\n\nasync function sufyancreateCostingSheet(fabrication) {\n\n\n    frappe.new_doc(\"Costing Sheet\", { \"fabrication_list\": fabrication.name }, doc => {\n        doc.company = fabrication.company;\n        doc.date = fabrication.normal;\n        doc.customer = fabrication.client_ref;\n        doc.project = fabrication.project_ref;\n        doc.item_group = fabrication.item_group;\n\n        // doc.table_rpga = [];\n\n\n    });\n}\n\n\n\nasync function sufyancreateQuotationChildItems(fabrication) {\n\n    frappe.new_doc(\"Quotation\", { \"quotation_to\": \"Customer\" }, doc => {\n\n        doc.company = fabrication.company;\n        doc.transaction_date = frappe.datetime.get_today();\n        doc.custom_quotation_status = 'Under Negotiation';\n        doc.custom_refrence = fabrication.priority;\n        doc.party_name = fabrication.client_ref;\n        doc.project = fabrication.project_ref;\n        doc.custom_fabrication_list = fabrication.name;\n        doc.custom_job_number = fabrication.job_number;\n        doc.items = [];\n\n\n        let unique_codes = {};\n        let defaultBuyingPriceList = frappe.defaults.get_default(\"buying_price_list\");\n        let defaultSellingPriceList = frappe.defaults.get_default(\"selling_price_list\");\n\n        if (fabrication.fabrication_table) {\n            fabrication.fabrication_table.forEach(row => {\n                let key = row.fg_batch_sr;\n\n                if (!unique_codes[key]) {\n                    unique_codes[key] = {\n                        parent_item: row.spl_item_fg_code,\n                        fg_batch_sr: row.fg_batch_sr,\n                        fl_item_qty: parseFloat(row.fl_item_qty) || 0\n                    };\n                } else {\n                    unique_codes[key].fl_item_qty += parseFloat(row.fl_item_qty) || 0;\n                    unique_codes[key].parent_item += row.spl_item_fg_code;\n\n                }\n            });\n        }\n\n        Object.values(unique_codes).forEach(item => {\n\n\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.fg_batch_sr);\n\n            frappe.model.set_value(row.doctype, row.name, 'custom_parent_item_1', item.parent_item);\n            // row.custome_parent_item = item.parent_item ;\n\n\n            row.rate = 0;\n            row.uom = \"\";\n\n            if (row.item_code) {\n                // Print args values for testing\n\n\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: defaultBuyingPriceList,\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.fl_item_qty,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            // \tmaterial_request_type: 'Purchase',\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: row.uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project,\n                        },\n                        overwrite_warehouse: true,\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\",\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n                            \n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n                            // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                            refresh_field(\"items\");\n                        }\n                    },\n                });\n            }\n\n\n            // frappe.model.set_value(row.doctype, row.name, 'custome_parent_item', item.parent_item);\n            // refresh_field(\"items\");\n\n\n        });\n\n\n\n\n        let acc_unique_codes = {};\n\n        if (fabrication.accessory) {\n            fabrication.accessory.forEach(row => {\n                let key = `${row.child_finished_good_item}-${row.child_finished_good_uom}`; // Composite Key\n\n                if (!acc_unique_codes[key]) {\n                    acc_unique_codes[key] = {\n                        parent_item: row.parent_finished_good_item,\n                        child_finished_good_item: row.child_finished_good_item,\n                        child_finished_good_uom: row.child_finished_good_uom,\n                        child_finished_good_qty: parseFloat(row.child_finished_good_qty) || 0,\n                    };\n                } else {\n                    acc_unique_codes[key].child_finished_good_qty += parseFloat(row.child_finished_good_qty) || 0;\n                }\n            });\n        }\n\n        Object.values(acc_unique_codes).forEach(item => {\n\n\n\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.child_finished_good_item);\n            frappe.model.set_value(row.doctype, row.name, 'custom_parent_item_1', item.parent_item);\n\n\n            row.rate = 0;\n            row.uom = \"\";\n            if(item.child_finished_good_item==\"HDFSRI0000001 - M\")\n            {\n                console.log(\"item\", item);\n                console.log(\"row on top\", row);\n            }\n            if (row.item_code) {\n                //                 console.log(\"frappe.call args:\", {\n                //     item_code: row.item_code,\n                //     from_warehouse: row.from_warehouse,\n                //     warehouse: row.warehouse,\n                //     doctype: 'Quotation',\n                //     buying_price_list: defaultBuyingPriceList,\n                //     currency: frappe.defaults.get_default(\"Currency\"),\n                //     name: doc.name,\n                //     qty: item.fl_item_qty,\n                //     stock_qty: row.stock_qty,\n                //     company: doc.company,\n                //     conversion_rate: 1,\n                //     plc_conversion_rate: 1,\n                //     rate: row.rate,\n                //     uom: row.uom,\n                //     conversion_factor: row.conversion_factor,\n                //     project: row.project,\n                // });\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: defaultBuyingPriceList,\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.child_finished_good_qty,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            // \tmaterial_request_type: 'Purchase',\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: item.child_finished_good_uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project,\n                        },\n                        overwrite_warehouse: true,\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\",\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n            if(item.child_finished_good_item==\"HDFSRI0000001 - M\")\n            {\n                console.log(\"result\",r.message);\n                            console.log(\"row\",d);\n            }                            \n                            \n                            // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                           // console.log(\"pricelistrate\", d.item_code, d.price_list_rate)\n                            refresh_field(\"items\");\n                        }\n                    },\n                });\n            }\n\n\n\n        });\n\n\n\n        let parent_unique_codes = {};\n\n        if (fabrication.fabrication_table) {\n            fabrication.fabrication_table.forEach(row => {\n                let key = row.spl_item_fg_code;\n\n                if (!parent_unique_codes[key]) {\n                    parent_unique_codes[key] = {\n                        spl_item_fg_code: row.spl_item_fg_code,\n                        spl_qty_in_pcs: parseFloat(row.spl_qty_in_pcs) || 0,\n                        spl_area_sqm: parseFloat(row.spl_area_sqm) || 0,\n                        spl_item_fg_uom: row.spl_item_fg_uom,\n                        spl_weight_kg: row.spl_weight_kg\n                    };\n                } else {\n                    parent_unique_codes[key].spl_qty_in_pcs += parseFloat(row.spl_qty_in_pcs) || 0;\n                    parent_unique_codes[key].spl_area_sqm += parseFloat(row.spl_area_sqm) || 0;\n                    parent_unique_codes[key].spl_weight_kg += parseFloat(row.spl_weight_kg) || 0;\n                }\n            });\n        }\n\n        Object.values(parent_unique_codes).forEach(item => {\n\n\n            let row = frappe.model.add_child(doc, \"custom_parent_item\");\n            frappe.model.set_value(row.doctype, row.name, 'parent_item', item.spl_item_fg_code);\n\n            frappe.model.set_value(row.doctype, row.name, 'spl_area_sqm', item.spl_area_sqm);\n            frappe.model.set_value(row.doctype, row.name, 'cam_item_qty', item.spl_qty_in_pcs);\n            frappe.model.set_value(row.doctype, row.name, 'total_kg', item.spl_weight_kg);\n            frappe.model.set_value(row.doctype, row.name, 'fg_item_uom', item.spl_item_fg_uom);\n\n            frappe.model.set_value(row.doctype, row.name, 'price_list', defaultSellingPriceList);\n            refresh_field(\"custom_parent_item\");\n\n\n        });\n\n        //again to add accessory items to parent items\n\n        Object.values(acc_unique_codes).forEach(item => {\n\n\n            let row = frappe.model.add_child(doc, \"custom_parent_item\");\n            frappe.model.set_value(row.doctype, row.name, 'parent_item', item.child_finished_good_item);\n            // frappe.model.set_value(row.doctype, row.name, 'total_kg', item.child_finished_good_qty);\n\n            frappe.model.set_value(row.doctype, row.name, 'spl_area_sqm', item.child_finished_good_qty);\n            frappe.model.set_value(row.doctype, row.name, 'cam_item_qty', item.child_finished_good_qty);\n            frappe.model.set_value(row.doctype, row.name, 'total_kg', 0);\n            frappe.model.set_value(row.doctype, row.name, 'fg_item_uom', item.child_finished_good_uom);\n            frappe.model.set_value(row.doctype, row.name, 'price_list', defaultSellingPriceList);\n            refresh_field(\"custom_parent_item\");\n\n        });\n\n\n\n    });\n\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Checkin",
  "enabled": 1,
  "modified": "2025-01-22 14:05:57.481616",
  "module": null,
  "name": "Employee Checkin-Form",
  "script": "frappe.ui.form.on('Employee Checkin', {\n\tonload(frm) {\n\t    if(frm.doc.marked_gps){\n    \t\tfrm.set_df_property('map','options','<div class=\"mapouter\"><div class=\"gmap_canvas\"><iframe width=100% height=\"300\" id=\"gmap_canvas\" src=\"https://maps.google.com/maps?q='+frm.doc.marked_gps+'&t=&z=17&ie=UTF8&iwloc=&output=embed\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\"></iframe><a href=\"https://yt2.org/youtube-to-mp3-ALeKk00qEW0sxByTDSpzaRvl8WxdMAeMytQ1611842368056QMMlSYKLwAsWUsAfLipqwCA2ahUKEwiikKDe5L7uAhVFCuwKHUuFBoYQ8tMDegUAQCSAQCYAQCqAQdnd3Mtd2l6\"></a><br><style>.mapouter{position:relative;text-align:right;height:300px;width:100%;}</style><style>.gmap_canvas {overflow:hidden;background:none!important;height:300px;width:100%;}</style></div></div>');\n            frm.refresh_field('map');\n\t    }\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Leave Salary",
  "enabled": 1,
  "modified": "2025-01-27 18:39:34.502385",
  "module": null,
  "name": "Employee Basic Fetch",
  "script": "frappe.ui.form.on('Leave Salary', {\r\n \r\n    employee:function(frm) {\r\n        if (frm.doc.employee) {\r\n            // Fetch custom_basic_salary when employee is selected\r\n            frappe.call({\r\n                method: \"frappe.client.get_value\",\r\n                args: {\r\n                    doctype: \"Employee\",\r\n                    filters: { name: frm.doc.employee },\r\n                    fieldname: \"custom_basic_salary\"\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message) {\r\n                        frm.set_value('basic', response.message.custom_basic_salary);\r\n                    }\r\n                }\r\n            });\r\n        } else {\r\n            // Clear the basic field when employee is removed\r\n            frm.set_value('basic', 0);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Full and Final Statement",
  "enabled": 1,
  "modified": "2025-02-20 17:14:14.644396",
  "module": null,
  "name": "Fetching price on Gratuity selection",
  "script": "frappe.ui.form.on('Full and Final Outstanding Statement', {\n    reference_document: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        \n        if (row.reference_document_type == \"UAE Gratuity\") {\n            frappe.db.get_doc('UAE Gratuity', row.reference_document)\n                .then(gratuity_doc => {\n                    let rounded_amount = Math.round(gratuity_doc.amount);\n                    frappe.model.set_value(cdt, cdn, 'amount', rounded_amount);\n\n                    if (gratuity_doc.payable_account) {\n                        frappe.model.set_value(cdt, cdn, 'account', gratuity_doc.payable_account);\n                    }\n                    \n                    frm.refresh_field('payables');\n                })\n                .catch(err => {\n                    frappe.throw(__('Error fetching UAE Gratuity document: ') + err.message);\n                });\n        } \n        \n        else if (row.reference_document_type == \"Leave Salary\") {\n            frappe.db.get_doc('Leave Salary', row.reference_document)\n                .then(leave_salary_doc => {\n                    frappe.model.set_value(cdt, cdn, 'amount', leave_salary_doc.encashment_amount);\n                    \n                    frm.refresh_field('payables');\n                })\n                .catch(err => {\n                    frappe.throw(__('Error fetching Leave Salary document: ') + err.message);\n                });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Project",
  "enabled": 1,
  "modified": "2025-02-06 18:03:37.697642",
  "module": null,
  "name": "Create Project Tendering Request",
  "script": "frappe.ui.form.on('Project', {\n\t\n\tasync refresh(frm) {\n\t\t\n\t\tif (frm.doc.workflow_state == 'Approved by Sales Manager')\n\t\t{\n\t\t\n\t\t    frm.add_custom_button('Request Project Tendering', async () => {\n\t\t  \n\t\t     \n                const tableFields = [\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'product',\n                        label: 'Product',\n                        in_list_view: 1 ,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'pre_qualification_submittal',\n                        label: 'Pre Qualification Submittal',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'material_submittal_status',\n                        label: 'Material Submittal Status',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Data',\n                        fieldname: 'sample_status',\n                        label: 'Sample Status',\n                        in_list_view: 1,\n                        read_only: 1 ,\n                    },\n                    {\n                        fieldtype: 'Small Text',\n                        fieldname: 'last_update',\n                        label: 'Last Update',\n                        in_list_view: 0,\n                        read_only: 1 ,\n                    },\n                    \n                    \n                ];\n\n                let dialog = new frappe.ui.Dialog({\n                    title: 'Product Approval',\n                    fields: [\n                        {\n                            fieldtype: 'Table',\n                            fieldname: 'item_table',\n                            label: 'Product Approval',\n                            cannot_add_rows: 1,\n                            cannot_delete_rows: 1,\n                            description: 'This is a table with product approval data.',\n                            fields: tableFields,\n                            data: [],\n                            get_data: () => {\n                                return dummyData;\n                            }\n                        }\n                    ],\n                    size : 'extra-large' ,\n                    primary_action_label: \"Select\",\n                    primary_action(values) {\n                     \n                        let selected_items = values.item_table.filter(row => row.__checked === 1);\n                        \n                        if (selected_items.length > 0) \n                        {\n\n                            selected_items.forEach(item => {\n\n                                frappe.call({\n                                    method: \"frappe.client.insert\",\n                                    args: {\n                                        doc: {\n                                            doctype: \"Project Tendering Request\",\n                                            project: frm.doc.name,\n                                            product: item.product ,\n                                            pre_qualification_submittal: item.pre_qualification_submittal,\n                                            material_submittal_status: item.material_submittal_status,\n                                            sample_status: item.sample_status,\n                                            last_update: item.last_update,\n                                            status: \"Draft\"\n                                        }\n                                    },\n                                    callback: function(r) {\n                                        if (r.message) {\n                                            \n                                            frappe.msgprint('Request created successfully.');\n                                        \n                                            \n                                        } \n                                        // console.log(r.message);\n                                        else {\n                                            frappe.msgprint('Failed to create the request.');\n                                        }\n                                    }\n                                });\n                                \n                                \n\n                                \n                                \n                                                            \n                            });\n                            \n                        }\n                        else {\n                            frappe.msgprint(\"Please select at least one item.\");\n                        }\n\n                        dialog.hide();\n                        \n                    },\n                    \n                    \n                });\n\n                let dummyData = [];\n\n\n                (frm.doc.custom_product_approval || []).forEach(row => {\n                    dummyData.push({\n                        product: row.product ,\n                        pre_qualification_submittal: row.pre_qualification_submittal,\n                        material_submittal_status: row.material_submittal_status,\n                        sample_status: row.sample_status,\n                        last_update: row.last_update,\n                    });\n                });\n\n                dialog.fields_dict.item_table.df.data = dummyData;\n                dialog.fields_dict.item_table.refresh();\n                dialog.show();\n\n\t\t    \n\t\t});\n\t\t\n\t\t}\n\t\t\n\t\n\t    \n\t}\n\t\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-05-28 14:04:57.429656",
  "module": null,
  "name": "Create Fabrication From Sales Order",
  "script": "\n\nfrappe.ui.form.on('Sales Order', {\n    \n    refresh: function(frm) {\n\n          if (frm.doc.docstatus === 1) {\n            // frm.add_custom_button(\n            //     __(\"Generate Fabrication\"),\n            //     function() {\n            //         sufyancreateFabrication(frm.doc); \n            //     },\n            // );\n            \n            frm.add_custom_button(\n                __(\"Estimation Request\"),\n                async function() {\n                    var quot_doc = await frappe.db.get_doc('Quotation', frm.doc.custom_ref_quotation) ;\n                    var sal_inq_doc = await frappe.db.get_doc('Sales Inquiry', quot_doc.custom_refrence) ;\n                    createEstimationRequest(sal_inq_doc, frm) ;\n                },\n                __(\"Create\")\n            );\n            \n            \n            frm.add_custom_button(\n                __(\"Delivery Note\"),\n                async function() {\n                    createDeliveryNote(frm) ;\n                },\n                __(\"Create\")\n            );\n            \n            \n            \n          }\n    },\n    \n    \n});\n\n\n\n\n\n\n\n\n\n\n\n\n// async function createDeliveryNote1(frm)\n// {\n    \n    \n//     const tableFields = [\n//         {\n//             fieldtype: 'Link',\n//             options: 'Item' ,\n//             fieldname: 'item_code',\n//             label: 'Item Code',\n//             in_list_view: 1 ,\n//             read_only: 1 ,\n//             columns: 2 ,\n//         },\n//         {\n//             fieldtype: 'Data',\n//             fieldname: 'item_name',\n//             label: 'FG Item Name',\n//             in_list_view: 1,\n//             read_only: 1 ,\n//             columns: 2 ,\n//         },\n//         {\n//             fieldtype: 'Link',\n//             options: 'UOM' , \n//             fieldname: 'uom' ,\n//             label: 'UOM' ,\n//             in_list_view: 1 ,\n//             read_only: 1 ,\n//             columns: 2 ,\n//         },\n//         {\n//             fieldtype: 'Float',\n//             fieldname: 'qty',\n//             label: 'Quantity',\n//             in_list_view: 1,\n//             read_only: 0 ,\n//             columns: 2 ,\n//         },\n       \n        \n//     ];\n\n//     let dialog = new frappe.ui.Dialog({\n//         title: 'Finished Goods Creation',\n//         fields: [\n//             {\n//                 fieldtype: 'Table',\n//                 fieldname: 'item_table',\n//                 label: '',\n//                 cannot_add_rows: 1,\n//                 cannot_delete_rows: 0,\n//                 description: 'This Table lists out only Child Finished Goods Items which are passed on Quality towards Finished Goods Store.',\n//                 fields: tableFields,\n//                 data: [],\n//                 get_data: () => {\n//                     return dummyData;\n//                 }\n//             }\n//         ],\n//         size : 'extra-large' ,\n//         primary_action_label: \"Select\",\n//         primary_action(values) {\n         \n//             let selected_items = values.item_table.filter(row => row.__checked === 1);\n            \n//             // for (let item of selected_items) {\n//             //     if (item.qty <= 0) {\n//             //         frappe.msgprint(`Error: Selected quantity for item ${item.item_code} must be at least 1.`);\n//             //         return;\n//             //     }\n//             // }\n            \n            \n//             // let parentQtyMap = {};\n            \n//             if (selected_items.length > 0) {\n            \n\n//                 // selected_items.forEach(item => {\n//                 //     const code = item.parent_item_code;\n//                 //     const qty = item.qty;\n            \n//                 //     if (parentQtyMap[code]) {\n//                 //         parentQtyMap[code].selected_qty += qty;\n//                 //     } else {\n//                 //         parentQtyMap[code] = { selected_qty: qty, packed_qty: 0, percentage: 0 };\n//                 //     }\n//                 // });\n            \n//                 // frm.doc.packed_items.forEach(item => {\n//                 //     const code = item.parent_item;\n                \n//                 //     if (!parentQtyMap[code]) {\n//                 //         return;\n//                 //     }\n                \n//                 //     const qty = item.qty;\n                \n//                 //     parentQtyMap[code].packed_qty += qty;\n                \n//                 //     if (parentQtyMap[code].selected_qty > 0) {\n//                 //         parentQtyMap[code].percentage = (parentQtyMap[code].selected_qty / parentQtyMap[code].packed_qty) * 100 ;\n//                 //     } else {\n//                 //         parentQtyMap[code].percentage = 0;\n//                 //     }\n//                 // });\n            \n//                 // console.log(parentQtyMap);\n                \n                \n//                 frappe.call({\n//                     method: 'erpnext.selling.doctype.sales_order.sales_order.make_delivery_note',\n//                     args: {\n//                         source_name: frm.doc.name\n//                     },\n//                     callback: function(r) {\n//                         if (!r.exc) {\n\n//                             let delivery_note = r.message;\n                            \n//                             // delivery_note.items = delivery_note.items\n//                             //     .filter(item => {\n//                             //         return parentQtyMap[item.item_code];\n//                             //     })\n//                             //     .map(item => {\n//                             //         let percentage = parentQtyMap[item.item_code].percentage || 0;\n//                             //         item.qty = (item.qty * (percentage / 100)).toFixed(2);\n//                             //         item.qty = parseFloat(item.qty); \n//                             //         return item;\n//                             //     });\n                                \n//                             // const selectedItemCodes = new Set(selected_items.map(i => i.item_code));\n\n//                             // delivery_note.packed_items = delivery_note.packed_items.filter(item =>\n//                             //     selectedItemCodes.has(item.item_code)\n//                             // );\n                            \n                            \n//                             delivery_note.items = delivery_note.items.filter(item => {\n//                                 let match = selected_items.find(si => si.item_code === item.item_code);\n//                                 if (match) {\n//                                     item.qty = match.qty;\n//                                     return true;\n//                                 }\n//                                 return false;\n//                             });\n                \n\n//                             frappe.model.with_doctype('Delivery Note', function() {\n//                                 let doc = frappe.model.sync(delivery_note)[0];\n//                                 frappe.set_route('Form', 'Delivery Note', doc.name);\n//                             });\n//                         }\n//                     }\n//                 });\n\n                \n                \n                \n\n                \n                \n                \n                \n\n//             }\n//             else {\n//                 frappe.msgprint(\"Please select at least one item.\");\n//             }\n\n//             dialog.hide();\n            \n//         },\n        \n        \n//     });\n\n//     let dummyData = [];\n   \n//     (frm.doc.items || []).forEach(row => {\n       \n//         dummyData.push({\n            \n//             // parent_item_code : row.parent_item ,\n//             item_code : row.item_code ,\n//             item_name : row.item_name ,\n//             qty : row.qty ,\n//             uom : row.uom ,\n\n//         });\n    \n//     });\n\n//     dialog.fields_dict.item_table.df.data = dummyData;\n//     dialog.fields_dict.item_table.refresh();\n\n//     dialog.show();\n// }\n\n\n\n\n\n\nasync function createDeliveryNote(frm)\n{\n    \n\n                frappe.call({\n                    method: 'erpnext.selling.doctype.sales_order.sales_order.make_delivery_note',\n                    args: {\n                        source_name: frm.doc.name\n                    },\n                    callback: function(r) {\n                        if (!r.exc) {\n\n                            let delivery_note = r.message;\n                            delivery_note.custom_sales_order = frm.doc.name ;\n                            delivery_note.items = delivery_note.items.filter(item => {\n                                let match = frm.doc.items.find(so => so.item_code === item.item_code);\n                                if (match) {\n                                    item.custom_parent_item_1 = match.custom_parent_item_1 ;\n                                    return true;\n                                }\n                                return false;\n                            });\n                \n\n                            frappe.model.with_doctype('Delivery Note', function() {\n                                let doc = frappe.model.sync(delivery_note)[0];\n                                frappe.set_route('Form', 'Delivery Note', doc.name);\n                            });\n                        }\n                    }\n                });\n\n\n\n\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nasync function sufyancreateFabrication(so_doc)\n{\n    \n    frappe.call({\n        method: \"frappe.client.insert\",\n        args: {\n            doc: {\n                doctype : \"Fabrication List\",\n                normal : frappe.datetime.nowdate() ,\n                fabrication_type : \"Sales Order\",\n                sales_order : so_doc.name ,\n                company : so_doc.company ,\n                client_ref : so_doc.customer ,\n                project_ref : so_doc.project ,\n                // item_group : 'Coils' ,\n            }\n        },\n        callback: function(response) {\n            if (response.message) {\n                frappe.msgprint(\"Document inserted successfully: \" + response.message.name);\n            } else {\n                frappe.msgprint(\"Failed to insert document\");\n            }\n        }\n    });\n\n    \n}\n\n\n\n\n\n\nfunction createEstimationRequest(sal_inq_doc, frm) \n{\n    \n    \n    \n            frappe.call({\n                method: 'frappe.client.insert',\n                args: {\n                    doc: {\n                        doctype: 'Estimation Request',\n                        creation_date: sal_inq_doc.creation_date,\n                        sales_inquiry: sal_inq_doc.name,\n                        inquiry_type: sal_inq_doc.inquiry_type ,\n                        client_reference: sal_inq_doc.client_reference ,\n                        \n                        \n                        estimation_request_type: 'Direct' ,\n                        sales_order_number : frm.doc.name ,\n                        \n                        \n                        drawing_link: sal_inq_doc.drawing_link,\n                        special_instruction: sal_inq_doc.special_instruction,\n                        \n                        \n                        \n                        customer_name: sal_inq_doc.customer,\n                        customer_location: sal_inq_doc.customer_location,\n                        customer_name: sal_inq_doc.customer_name,\n                        quotation_address_to: sal_inq_doc.quotation_address_to,\n                        email_id: sal_inq_doc.email_id,\n                        mobile_no: sal_inq_doc.mobile_no,\n                        technical_contact: sal_inq_doc.technical_contact,\n                        contact_number: sal_inq_doc.contact_number,\n                        submittal_link: sal_inq_doc.submittal_link,\n                        company: sal_inq_doc.company,\n                        opportunity: sal_inq_doc.opportunity,\n                        sales_inquiry_status: sal_inq_doc.sales_inquiry_status,\n                        products: sal_inq_doc.products,\n                        \n                        \n                        \n                        \n                        attachment_1: sal_inq_doc.attachment_1,\n                        attachment_2: sal_inq_doc.attachment_2,\n                        attachment_3: sal_inq_doc.attachment_3,\n                        \n                        items: sal_inq_doc.items,\n                        total_quantity: sal_inq_doc.total_quantity,\n                        total_amount: sal_inq_doc.total_amount,\n                        \n                        \n                    }\n                },\n                callback: function(r) {\n                    if (!r.exc) {\n                        frappe.msgprint(`Estimation Request ${r.message.name} saved successfully!`);\n                        frappe.model.set_value(\"Estimation Request\" , frm.doc.name, 'estimation_request_created', 1) ;\n                        \n                        \n                        if (frm.doc.docstatus == 1)\n                        {\n                            frm.save('Update') ;\n                        }\n                        else if (frm.doc.docstatus == 0)\n                        {\n                            frm.save() ;\n                        }\n                    } else {\n                        frappe.msgprint(`Error: ${r.exc}`);\n                    }\n                }\n            });\n\n    \n    \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Costing Sheet",
  "enabled": 1,
  "modified": "2025-02-20 10:45:24.264403",
  "module": null,
  "name": "Fetch Tables from Fabrication",
  "script": "frappe.ui.form.on('Costing Sheet', {\n    fabrication_list: function(frm) {\n        \n        frm.set_value('accessory_item', []);\n        frm.set_value('material_summary', []);\n        frm.set_value('costing_sheet_item', []);\n        \n        \n        if (frm.doc.fabrication_list) {\n            \n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Fabrication List',\n                    name: frm.doc.fabrication_list\n                },\n                callback: function(response) {\n                    if (response.message) {\n                        let fl_doc = response.message;\n\n                        if (fl_doc.acc_item && fl_doc.material_summary) {\n                            fl_doc.material_summary.forEach(row1 => {\n                                let materialEntry = {\n                                    parent_finished_good: row1.parent_finished_good,\n                                    material_item_code: row1.material_item_code,\n                                    material_item_brand: row1.material_item_brand,\n                                    material_item_uom: row1.material_item_uom,\n                                    material_item_qty: row1.material_item_qty,\n                                    sum_of_fl_item_qty: row1.sum_of_fl_item_qty,\n                                    fl_item_gauge: row1.fl_item_gauge,\n                                    sum_of_duct_weight: row1.sum_of_duct_weight,\n                                    sum_of_duct_area_with_seam: row1.sum_of_duct_area_with_seam\n                                };\n                                frm.add_child('material_summary', materialEntry);\n\n                                let costingEntry = {\n                                    item_code: row1.material_item_code,\n                                    item_name: row1.material_item_code,\n                                    parent_finished_goods_item: row1.parent_finished_good,\n                                    finished_goods_item: null,\n                                    uom: row1.material_item_uom,\n                                    quantity: row1.material_item_qty,\n                                    item_brand: row1.material_item_brand,\n                                    item_guage: row1.fl_item_gauge\n                                };\n                                frm.add_child('costing_sheet_item', costingEntry);\n                            });\n\n                            fl_doc.acc_item.forEach(row => {\n                                let accessoryEntry = {\n                                    item_code: row.item_code,\n                                    item_name: row.item_name,\n                                    uom: row.uom,\n                                    quantity: row.qty\n                                };\n                                frm.add_child('accessory_item', accessoryEntry);\n                            });\n\n                            frm.refresh_field('material_summary');\n                            frm.refresh_field('costing_sheet_item');\n                            frm.refresh_field('accessory_item');\n                        }\n                    }\n                }\n                \n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-04-10 15:46:20.568344",
  "module": null,
  "name": "Setting Barcode",
  "script": "frappe.ui.form.on('Item', {\n    \n   \n    setup: function(frm)\n    {\n        frm.set_value('custom_barcode', frm.doc.item_code) ;\n        // frm.set_value('custom_barcode_image_format', frm.doc.custom_barcode) ;\n        frm.save();\n        // frm.refresh();\n    },\n\n\n    before_save: function(frm)\n    {\n        frm.set_value('custom_barcode', frm.doc.item_code) ;\n        // frm.set_value('custom_barcode_image_format', frm.doc.custom_barcode) ;\n        frm.refresh();\n    },\n    \n    \n    // before_save: function(frm)\n    // {\n    //     frappe.db.get_list('Item', {\n    //         filters: { \n    //             custom_update_barcode : ['!=',1] ,\n    //             item_code : '17'\n    //         }\n    //     }).then(r => {\n            \n    //         // console.log(r[0].name);\n    //         frappe.db.get_doc('Item', r[0].name)\n    //          .then(doc => {\n    //              console.log(doc);\n    //             frappe.db.set_value('Item', r[0].name, {\n    //                 //  custom_update_barcode: 'Working',\n    //                  custom_barcode: r[0].name\n    //                 }).then(r => {\n    //                  let doc = r.message;\n    //                  console.log(doc);\n    //                 });\n    //          });\n        \n            \n    //     });\n    // },\n\n    \n\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Factory Approval",
  "enabled": 1,
  "modified": "2025-04-09 14:58:23.277007",
  "module": null,
  "name": "Set status",
  "script": "// frappe.ui.form.on('Factory Approval', {\n// \trefresh(frm) {\n// \t\t// your code here\n// \t}\n// })\n\nfrappe.ui.form.on('Company Registration Details', {\n    expiry_date(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n\n        if (!row.expiry_date) return;\n\n        const today = frappe.datetime.now_date();\n        const status = row.expiry_date < today ? \"Expired\" : \"Active\";\n        frappe.model.set_value(cdt, cdn, 'status', status);\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Estimation Request",
  "enabled": 1,
  "modified": "2025-11-11 14:11:45.746226",
  "module": null,
  "name": "Create Fabrciation From Estimation Request",
  "script": "frappe.ui.form.on('Estimation Request', {\n\trefresh(frm) {\n\t    \n\t\t\n\t\tif (frm.doc.workflow_state == 'Started') \n\t\t{\n\t\t    frm.add_custom_button(\n                __(\"Fabrication\"),\n                function() {\n                    createFabrication(frm.doc);\n                },\n                __(\"Create\")\n            );\n\t\t}\n\t\t\n\t\ttoggle_child_tables(frm);\n\t},\n\t\n    product_type_table_add(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    },\n\n    product_type_table_remove(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    },\t\n\t\n\tasync previous_estimation_request(frm)\n\t{\n\t    if(frm.doc.previous_estimation_request)\n\t    {\n\t        est_req_doc = await frappe.db.get_doc(\"Estimation Request\", frm.doc.previous_estimation_request) ;\n\t       // console.log(est_req_doc) ;\n\t        \n\t        frm.set_value('inquiry_type',est_req_doc.inquiry_type) ;\n\t        frm.set_value('drawing_link',est_req_doc.drawing_link) ;\n\t        frm.set_value('customer_location',est_req_doc.customer_location) ;\n\t        frm.set_value('customer_name',est_req_doc.customer_name) ;\n\t        frm.set_value('quotation_address_to',est_req_doc.quotation_address_to) ;\n\t        frm.set_value('email_id',est_req_doc.email_id) ;\n\t        frm.set_value('mobile_no',est_req_doc.mobile_no) ;\n\t        frm.set_value('technical_contact',est_req_doc.technical_contact) ;\n\t        frm.set_value('contact_number',est_req_doc.contact_number) ;\n\t        frm.set_value('submittal_link',est_req_doc.submittal_link) ;\n\t        frm.set_value('project',est_req_doc.project) ;\n\t        frm.set_value('location',est_req_doc.location) ;\n\t        frm.set_value('project_stage',est_req_doc.project_stage) ;\n\t        frm.set_value('project_name',est_req_doc.project_name) ;\n\t        frm.set_value('client',est_req_doc.client) ;\n\t        frm.set_value('special_instruction',est_req_doc.special_instruction) ;\n\t        frm.set_value('opportunity_owner',est_req_doc.opportunity_owner) ;\n\t        frm.set_value('sales_person',est_req_doc.sales_person) ;\n\t        frm.set_value('sales_inquiry_status',est_req_doc.sales_inquiry_status) ;\n\t        frm.set_value('opportunity',est_req_doc.opportunity) ;\n\t        frm.set_value('lead',est_req_doc.lead) ;\n\t        frm.set_value('floor',est_req_doc.floor) ;\n\t        frm.set_value('client_reference',est_req_doc.client_reference) ;\n\t        frm.set_value('unit_rate',est_req_doc.unit_rate) ;\n\t        frm.set_value('boq',est_req_doc.boq) ;\n\t        frm.set_value('estimation',est_req_doc.estimation) ;\n\t        frm.set_value('submittal_status',est_req_doc.submittal_status) ;\n\t        frm.set_value('pre_qualification_status',est_req_doc.pre_qualification_status) ;\n\t        frm.set_value('sample_status',est_req_doc.sample_status) ;\n\t        frm.set_value('products',est_req_doc.products) ;\n\t        frm.set_value('attachment_1',est_req_doc.attachment_1) ;\n\t        frm.set_value('attachment_2',est_req_doc.attachment_2) ;\n\t        frm.set_value('attachment_3',est_req_doc.attachment_3) ;\n\t        frm.set_value('items',est_req_doc.items) ;\n\t        frm.set_value('total_quantity',est_req_doc.total_quantity) ;\n\t        frm.set_value('total_amount',est_req_doc.total_amount) ;\n\t        \n\t    }\n\t    \n\t    else\n\t    {\n\t       // est_req_doc = await frappe.db.get_doc(\"Estimation Request\", frm.doc.previous_estimation_request) ;\n\t       // console.log(est_req_doc) ;\n\t        \n\t        frm.set_value('inquiry_type',null) ;\n\t        frm.set_value('drawing_link',null) ;\n\t        frm.set_value('customer_location',null) ;\n\t        frm.set_value('customer_name',null) ;\n\t        frm.set_value('quotation_address_to',null) ;\n\t        frm.set_value('email_id',null) ;\n\t        frm.set_value('mobile_no',null) ;\n\t        frm.set_value('technical_contact',null) ;\n\t        frm.set_value('contact_number',null) ;\n\t        frm.set_value('submittal_link',null) ;\n\t        frm.set_value('project',null) ;\n\t        frm.set_value('location',null) ;\n\t        frm.set_value('project_stage',null) ;\n\t        frm.set_value('project_name',null) ;\n\t        frm.set_value('client',null) ;\n\t        frm.set_value('special_instruction',null) ;\n\t        frm.set_value('opportunity_owner',null) ;\n\t        frm.set_value('sales_person',null) ;\n\t        frm.set_value('sales_inquiry_status',null) ;\n\t        frm.set_value('opportunity',null) ;\n\t        frm.set_value('lead',null) ;\n\t        frm.set_value('floor',null) ;\n\t        frm.set_value('client_reference',null) ;\n\t        frm.set_value('unit_rate',null) ;\n\t        frm.set_value('boq',null) ;\n\t        frm.set_value('estimation',null) ;\n\t        frm.set_value('submittal_status',null) ;\n\t        frm.set_value('pre_qualification_status',null) ;\n\t        frm.set_value('sample_status',null) ;\n\t        frm.set_value('products',null) ;\n\t        frm.set_value('attachment_1',null) ;\n\t        frm.set_value('attachment_2',null) ;\n\t        frm.set_value('attachment_3',null) ;\n\t        frm.set_value('items',null) ;\n\t        frm.set_value('total_quantity',null) ;\n\t        frm.set_value('total_amount',null) ;\n\t        \n\t    }\n\t}\n\t\n\t\n\t\n});\n\nfrappe.ui.form.on('Product Type', {\n    product_types: function(frm, cdt, cdn) {\n        toggle_child_tables(frm);\n    }\n});\nfunction toggle_child_tables(frm) {\n    // collect all product_types from grid\n    let product_types = (frm.doc.product_type_table || []).map(row => row.product_types);\n\n    // mapping of product type to child table fieldname\n    const mapping = {\n        \"Adhesives & Sealant\": \"adhesives_and_sealant_specification_table\",\n        \"Dampers\": \"damper_specification_table\",\n        \"Duct\": \"duct_specifications_table\",\n        \"Duct Accessories\": \"duct_accessories_table\",\n        \"Fastners\": \"fastners_specification_table\",\n        \"Gasket & Masking Tape\": \"gasket_and_masking_tape_specification_table\",\n        \"Grill\": \"grilles_table\",\n        \"Diffuser\": \"diffuser_specification\",\n        \"Louver\": \"louver_specification_table\",\n        \"Raw Material\": \"raw_materal_specification_table\",\n        \"Sound Attenuator\": \"sound_attenuator__specification_table\",\n        \"Plenum\": \"plenum_specification_table\"\n    };\n\n    // loop through mapping and show/hide child tables\n    for (let [ptype, fieldname] of Object.entries(mapping)) {\n        \n        if (product_types.includes(ptype)) {\n            console.log(`Toggling ${fieldname} for product type ${ptype}`);\n            frm.toggle_display(fieldname, true);\n        } else {\n            frm.toggle_display(fieldname, false);\n        }\n    }\n}\n\n\n\nfunction createFabrication(estimationRequest) {\n    frappe.model.with_doctype('Fabrication List', function() {\n        var fabrication = frappe.model.get_new_doc('Fabrication List');\n        fabrication.oppurtunity = estimationRequest.opportunity;\n        fabrication.fabrication_type = \"Estimation Request\" ;\n        fabrication.lead = estimationRequest.lead;\n        fabrication.opportunity_owner = estimationRequest.opportunity_owner;\n        fabrication.project_ref = estimationRequest.project;\n        fabrication.estimation_request = estimationRequest.name;\n        frappe.set_route('Form', 'Fabrication List', fabrication.name);\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Promotion",
  "enabled": 1,
  "modified": "2025-07-01 14:37:23.740089",
  "module": null,
  "name": "Set auto ctc",
  "script": "frappe.ui.form.on('Employee Promotion', {\n    refresh(frm) {\n        frm.set_df_property('current_ctc', 'read_only', 1);\n        frm.set_df_property('revised_ctc', 'read_only', 1);\n    },\n\n    custom_incremented_amount(frm) {\n        const increment_amt = parseFloat(frm.doc.custom_incremented_amount) || 0;\n        const ccc = parseFloat(frm.doc.current_ctc) || 0;\n        frm.set_value('revised_ctc');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 0,
  "modified": "2025-05-15 18:50:09.816597",
  "module": null,
  "name": "test1011",
  "script": "frappe.ui.form.on('Sales Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n});\n\n\n\n\n\nfrappe.ui.form.on('Sales Taxes and Charges', {\n// \trefresh(frm) {\n// \t\t// your code here\n// \t}\n\n    \n    charge_type: function(frm,cdt,cdn)\n    {\n      console.log(\"Print\") ; \n    },\n\n});\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-06-19 13:18:00.973725",
  "module": null,
  "name": "Hiding Zatca button",
  "script": "frappe.ui.form.on('Sales Invoice', {\n    refresh: function(frm) {\n        // Hide Zatca Phase-2 button if company is SASCO Industries\n        if (frm.doc.company === 'SASCO Industries') {\n            // Hide the Zatca Phase-2 button from the toolbar\n            frm.page.remove_inner_button('Zatca Phase-2');\n            \n            // Alternative method - hide using CSS if button exists\n            setTimeout(function() {\n                $('button:contains(\"Zatca Phase-2\")').hide();\n                $('.btn:contains(\"Zatca Phase-2\")').hide();\n            }, 100);\n        }\n    },\n    \n    company: function(frm) {\n        // Also check when company field is changed\n        if (frm.doc.company === 'SASCO Industries') {\n            frm.page.remove_inner_button('Zatca Phase-2');\n            \n            setTimeout(function() {\n                $('button:contains(\"Zatca Phase-2\")').hide();\n                $('.btn:contains(\"Zatca Phase-2\")').hide();\n            }, 100);\n        } else {\n            // Show the button again if company is changed to something else\n            setTimeout(function() {\n                $('button:contains(\"Zatca Phase-2\")').show();\n                $('.btn:contains(\"Zatca Phase-2\")').show();\n            }, 100);\n        }\n    }\n});\n\n// Alternative approach using onload_post_render for more reliable hiding\nfrappe.ui.form.on('Sales Invoice', {\n    onload_post_render: function(frm) {\n        if (frm.doc.company === 'SASCO Industries') {\n            // Use a more aggressive approach to hide the button\n            var checkAndHideButton = function() {\n                var zatcaButtons = $('button:contains(\"Zatca Phase-2\"), .btn:contains(\"Zatca Phase-2\")');\n                if (zatcaButtons.length > 0) {\n                    zatcaButtons.hide();\n                } else {\n                    // Keep checking for the button if it hasn't loaded yet\n                    setTimeout(checkAndHideButton, 200);\n                }\n            };\n            \n            setTimeout(checkAndHideButton, 100);\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Fabrication Filter",
  "enabled": 1,
  "modified": "2025-09-19 14:52:01.327150",
  "module": null,
  "name": "Create Proforma Invoice",
  "script": "\n\nfrappe.ui.form.on('Fabrication Filter', {\n\n    refresh: function (frm) {\n        if (frm.doc.docstatus === 1) {\n            frm.add_custom_button(\n                __(\"Sales Quotation\"),\n                function () {\n                    // collect only selected fabrication names\n                    let fabrication_names = (frm.fields_dict.filtered_fabrication_list.grid.get_selected_children() || [])\n                        .map(row => row.fabrication);\n\n                    if (!fabrication_names.length) {\n                        frappe.msgprint(\"Please select at least one Fabrication List.\");\n                        return;\n                    }\n\n                    frappe.prompt(\n                        [\n                            {\n                                fieldname: \"uom\",\n                                label: \"Unit of Measurement\",\n                                fieldtype: \"Select\",\n                                options: [\"SQM\", \"KG\"],\n                                reqd: 1,\n                                default: \"SQM\"\n                            }\n                        ],\n                        function (values) {\n                            frappe.call({\n                                method: \"sasco.sasco.utils.fabrication_utils.create_quotation_from_fabrication_filter_aggr\",\n                                args: {\n                                    fabrication_names: fabrication_names,  // only selected names\n                                    uom: values.uom\n                                },\n                                callback: function (r) {\n                                    if (!r.exc) {\n                                        frappe.set_route(\"Form\", \"Quotation\", r.message);\n                                    }\n                                }\n                            });\n                        },\n                        __(\"Select UOM\"),\n                        __(\"Create\")\n                    );\n                },\n                __(\"Create\")\n            );\n\n\n            frm.add_custom_button(\n                __(\"Proforma Invoice\"),\n                function () {\n                    createProformaInvoice(frm.doc);\n                },\n                __(\"Create\")\n            );\n        }\n        frm.set_query(\"sales_inquiry\", function () {\n            return {\n                filters: {\n                    customer_name: frm.doc.customer || \"\"   // only Sales Inquiry for selected customer\n                }\n            };\n        });\n\n    },\n\n\n    customer: function (frm) {\n       \n        load_fabrication_list(frm);\n    },\n    sales_inquiry: function (frm) {\n        load_fabrication_list(frm);\n    }\n\n});\n\n\n//  shared function\nasync function load_fabrication_list(frm) {\n    frm.set_value('filtered_fabrication_list', []);\n\n    if (!frm.doc.customer) return;\n\n    // base filters\n    let filters = { client_ref: frm.doc.customer, docstatus: 1 };\n\n    // optional filter on sales_inquiry (if field exists + value provided)\n    if ( frm.doc.sales_inquiry) {\n        filters.priority = frm.doc.sales_inquiry;\n    }\n\n    console.log(\"Applying filters:\", filters);\n    // fetch Fabrication List records\n    let fab_list = await frappe.db.get_list('Fabrication List', {\n        fields: [\n            'name',\n            'client_ref',\n            'normal',\n            'project_ref',\n            'lead',\n            'oppurtunity',\n            'fabrication_template'\n        ],\n        filters: filters\n    });\n    // var fab_list = await frappe.db.get_list('Fabrication List', {\n    //     fields: ['name', 'client_ref', 'normal', 'project_ref', 'lead', 'oppurtunity', 'fabrication_template'],\n    //     filters: { client_ref: frm.doc.customer, docstatus: 1 },\n    // });\n    console.log(`Found ${fab_list.length} Fabrication List records`, fab_list);\n\n    if (fab_list && fab_list.length) {\n        fab_list.forEach(row => {\n            frm.add_child('filtered_fabrication_list', {\n                fabrication: row.name,\n                customer: row.client_ref,\n                date: row.normal,\n                project: row.project_ref,\n                lead: row.lead,\n                oppurtunity: row.oppurtunity,\n                fabrication_template: row.fabrication_template\n            });\n        });\n        frm.refresh_field('filtered_fabrication_list');\n    }\n}\n\n\n\nasync function createQuotation(fabrication_filter) {\n    frappe.new_doc(\"Quotation\", { \"quotation_to\": \"Customer\" }, async (doc) => {\n        doc.company = fabrication_filter.company;\n        doc.transaction_date = frappe.datetime.get_today();\n        doc.custom_quotation_status = 'Under Negotiation';\n        doc.custom_refrence = fabrication_filter.sales_inquiry;\n        doc.party_name = fabrication_filter.customer;\n        doc.project = fabrication_filter.project;\n        doc.custom_multi_fabrication = 1;\n        doc.custom_fabrication_filter = fabrication_filter.name;\n        doc.custom_parent_item = fabrication_filter.parent_item;\n        doc.items = [];\n\n\n        fabrication_filter.fabrication_filter_items.forEach(item => {\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.item);\n            frappe.model.set_value(row.doctype, row.name, 'custom_parent_item_1', item.parent_item);\n\n            row.rate = 0;\n            row.uom = \"\";\n\n            if (row.item_code) {\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.quantity,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            // \tmaterial_request_type: 'Purchase',\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: item.uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project,\n                        },\n                        overwrite_warehouse: true,\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\",\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n\n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n                            // frappe.model.set_value(d.doctype, d.name, \"qty\", item.qty);\n                            refresh_field(\"items\");\n                        }\n                    },\n                });\n            }\n\n        });\n\n    });\n\n\n}\n\n\n\n\n\nasync function createProformaInvoice(fabrication_filter) {\n    frappe.new_doc(\"Proforma Invoice\", {}, async (doc) => {\n        doc.company = fabrication_filter.company;\n        doc.customer = fabrication_filter.customer;\n        doc.custom_fabrication_filter = fabrication_filter.name;\n        doc.custom_multi_fabrication = 1;\n        doc.custom_parent_item = fabrication_filter.parent_item;\n        doc.transaction_date = frappe.datetime.get_today();\n\n        doc.items = [];\n\n        fabrication_filter.fabrication_filter_items.forEach(item => {\n            let row = frappe.model.add_child(doc, \"items\");\n            frappe.model.set_value(row.doctype, row.name, 'item_code', item.item);\n            frappe.model.set_value(row.doctype, row.name, 'custom_parent_item_1', item.parent_item);\n\n            row.rate = 0;\n            row.uom = \"\";\n\n            if (row.item_code) {\n                frappe.call({\n                    method: \"erpnext.stock.get_item_details.get_item_details\",\n                    args: {\n                        args: {\n                            item_code: row.item_code,\n                            from_warehouse: row.from_warehouse,\n                            warehouse: row.warehouse,\n                            doctype: 'Quotation',\n                            buying_price_list: frappe.defaults.get_default(\"buying_price_list\"),\n                            currency: frappe.defaults.get_default(\"Currency\"),\n                            name: doc.name,\n                            qty: item.quantity,\n                            stock_qty: row.stock_qty,\n                            company: doc.company,\n                            conversion_rate: 1,\n                            plc_conversion_rate: 1,\n                            rate: row.rate,\n                            uom: item.uom,\n                            conversion_factor: row.conversion_factor,\n                            project: row.project\n                        },\n                        overwrite_warehouse: true\n                    },\n                    callback: function (r) {\n                        const d = row;\n                        const allow_to_change_fields = [\n                            \"actual_qty\",\n                            \"projected_qty\",\n                            \"min_order_qty\",\n                            \"item_name\",\n                            \"description\",\n                            \"stock_uom\",\n                            \"uom\",\n                            \"conversion_factor\",\n                            \"stock_qty\"\n                        ];\n\n                        if (!r.exc) {\n                            $.each(r.message, function (key, value) {\n                                if (!d[key] || allow_to_change_fields.includes(key)) {\n                                    d[key] = value;\n                                }\n                            });\n\n                            if (d.price_list_rate != r.message.price_list_rate) {\n                                d.rate = 0.0;\n                                d.price_list_rate = r.message.price_list_rate;\n                                frappe.model.set_value(d.doctype, d.name, \"rate\", d.price_list_rate);\n                            }\n\n                            refresh_field(\"items\");\n                        }\n                    }\n                });\n            }\n        });\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 0,
  "modified": "2025-11-11 12:29:17.265400",
  "module": null,
  "name": "Customer in Quotation",
  "script": "frappe.ui.form.on('Quotation', {\r\n    before_save: function(frm) {\r\n        // Check if 'customer_name' field has a value but 'customer' (Link field) is empty\r\n        if (frm.doc.customer_name && !frm.doc.quotation) {\r\n            frappe.db.get_value('Quotation', { 'customer_name': frm.doc.customer_name }, 'party_name')\r\n                .then(r => {\r\n                    if (r && r.message && r.message.name) {\r\n                        frm.set_value('customer', r.message.name);\r\n                    } else {\r\n                        frappe.msgprint(__('No matching Customer found for {0}', [frm.doc.customer_name]));\r\n                    }\r\n                });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Expense",
  "enabled": 1,
  "modified": "2024-03-29 23:26:18.904399",
  "module": "Erpnext Expenses",
  "name": "Bulk Expense Report",
  "script": "frappe.listview_settings['Expense'] = {\n    onload(listview) {\n        listview.page.add_action_item('My custom Action', () => my_action_handler());\n        listview.page.set_secondary_action('Create Report', function(){\n            \n            let checkedItems = frappe.get_list_view('Expense').get_checked_items();\n            \n            if(checkedItems.length != 0){\n                frappe.show_progress('Processing entries...', 70, 100, 'Please wait.');\n            \n                frappe.call({\n                    args: {\n                        'selected': checkedItems\n                    },\n                    method: 'erpnext_expenses.erpnext_expenses.doctype.expense.expense.create_bulk_expense_report',\n                    callback: function(r) {\n                        frappe.show_progress('Processing entries...', 100, 100);\n                        frappe.set_route(\"Form\", \"Expense Report\", r.message.expense);\n                    }\n                });\n            }else{\n                frappe.throw('Please select at least one expense from the list.');\n            }\n            \n        } );\n  }\n};\n",
  "view": "List"
 }
]