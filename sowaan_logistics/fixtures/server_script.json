[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-05-15 15:50:38.777729",
  "module": null,
  "name": "Lead in Quotation Doctype",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "\nif doc.quotation_to == 'Lead' :\n    if doc.custom_refrence :\n        s_inq_doc = frappe.get_doc(\"Sales Inquiry\",doc.custom_refrence)\n        doc.party_name = s_inq_doc.lead",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-05-21 15:40:39.450997",
  "module": null,
  "name": "Document Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Plan",
  "script": "\nsignal = 0\n\nfor row in doc.daily_work_details :\n    if row.status == 'Open' :\n        doc.document_status = 'Incomplete'\n        signal = 1\n        break\n\n\nif signal == 0 :\n    doc.document_status = 'Complete'\n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-11 11:59:00.888665",
  "module": null,
  "name": "Costing Calculation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Pricing Sheet",
  "script": "# this part is for standanrd \ni=0\ncoil=0 \nwaste= 0 \nfab = 0 \noh = 0 \nmargin = 0 \nstandard_thickness = []\nitemsss = []\n\nA_thickness= []\nB_thickness = []\nstandard_rate = []\nA_rate = []\nB_rate= []\nsum_price_per_kg = 0\ncount = 0\n\n\nfor row in doc.factor:\n    if row.factors == \"Coil Price\":\n        coil= row.standard\n    elif row.factors == \"Waste\":\n        waste= row.standard\n    elif row.factors == \"Fabrication Cost\":\n        fab= row.standard\n    elif row.factors == \"Over Head\":\n        oh= row.standard\n    elif row.factors == \"Margin\":\n        margin= row.standard\n    elif row.factors == \"Finance\":\n        finance= row.standard\n    \n    \nfor wow in doc.pricing:\n    wow.standard_cost__sqm = (wow.thickness * coil * 7860)/1000000\n    standard_thickness.append(wow.thickness)\n    itemsss.append(wow.item)\n    result =(((fab + (wow.standard_cost__sqm * (1 + (waste / 100)))) * (1 + (oh / 100)) * (1 + (margin / 100)) * (1 + (finance / 100))) / 0.25) * 0.25 \n    if result % 0.25 != 0:\n        result = ((result // 0.25) + 1) * 0.25\n    wow.standard_rate__sqm = result\n    standard_rate.append(result)\n\n# this part is for A\n\nacoil=0 \nawaste= 0 \nafab = 0 \naoh = 0 \namargin = 0 \n\nfor row in doc.factor:\n    if row.factors == \"Coil Price\":\n        acoil= row.a\n    elif row.factors == \"Waste\":\n        awaste= row.a\n    elif row.factors == \"Fabrication Cost\":\n        afab= row.a\n    elif row.factors == \"Over Head\":\n        aoh= row.a\n    elif row.factors == \"Margin\":\n        amargin= row.a\n    elif row.factors == \"Finance\":\n        afinance= row.a\n    \n    \nfor wow in doc.pricing:\n    wow.a_cost__sqm = (wow.thickness * acoil * 7860)/1000000\n    A_thickness.append(wow.thickness)\n    \n    \n    result1 =(((afab + (wow.a_cost__sqm * (1 + (awaste / 100)))) * (1 + (aoh / 100)) * (1 + (amargin / 100)) * (1 + (afinance / 100))) / 0.25) * 0.25 \n    # result1 = (((wow.a_cost__sqm * (1 + awaste / 100) * (1 + aoh / 100) * (1 + amargin / 100) * (1 + afinance / 100)) + afab)/ 0.25)* 0.25\n\n    if result1 % 0.25 != 0:\n        result1 = ((result1 // 0.25) + 1) * 0.25\n    wow.a_rate__sqm = result1\n    A_rate.append(result1)\n\n\n# This is for B\n\nbcoil=0 \nbwaste= 0 \nbfab = 0 \nboh = 0 \nbmargin = 0 \n\n\n\n\nfor row in doc.factor:\n    if row.factors == \"Coil Price\":\n        bcoil= row.b\n    elif row.factors == \"Waste\":\n        bwaste= row.b\n    elif row.factors == \"Fabrication Cost\":\n        bfab= row.b\n    elif row.factors == \"Over Head\":\n        boh= row.b\n    elif row.factors == \"Margin\":\n        bmargin= row.b\n    elif row.factors == \"Finance\":\n        bfinance= row.b\n    \n    \nfor wow in doc.pricing:\n    wow.b_cost__sqm = (wow.thickness * bcoil * 7860)/1000000\n    B_thickness.append(wow.thickness)\n    \n    # result2 =(((bfab + (wow.b_cost__sqm * (1 + (bwaste / 100)))) * (1 + (boh / 100)) * (1 + (bmargin / 100)) * (1 + (bfinance / 100))) / 0.25) * 0.25 \n    result2 = (((wow.b_cost__sqm * (1 + bwaste / 100) * (1 + boh / 100) * (1 + bmargin / 100) * (1 + bfinance / 100)) + bfab)/ 0.25)* 0.25\n    if result2 % 0.25 != 0:\n        result2 = ((result2 // 0.25) + 1) * 0.25\n    wow.b_rate__sqm = result2\n    B_rate.append(result2)\n    \n    \n    \n    \n    \n\n# This is for C\n\nccoil=0 \ncwaste= 0 \ncfab = 0 \ncoh = 0 \ncmargin = 0 \nC_thickness = []\nC_rate = []\n\n\n\n\nfor row in doc.factor:\n    if row.factors == \"Coil Price\":\n        ccoil= row.c\n    elif row.factors == \"Waste\":\n        cwaste= row.c\n    elif row.factors == \"Fabrication Cost\":\n        cfab= row.c\n    elif row.factors == \"Over Head\":\n        coh= row.c\n    elif row.factors == \"Margin\":\n        cmargin= row.c\n    elif row.factors == \"Finance\":\n        cfinance= row.c\n    \n    \nfor wow in doc.pricing:\n    wow.c_cost__sqm = (wow.thickness * ccoil * 7860)/1000000\n    C_thickness.append(wow.thickness)\n    \n    # result2 =(((bfab + (wow.b_cost__sqm * (1 + (bwaste / 100)))) * (1 + (boh / 100)) * (1 + (bmargin / 100)) * (1 + (bfinance / 100))) / 0.25) * 0.25 \n    result3 = (((wow.c_cost__sqm * (1 + cwaste / 100) * (1 + coh / 100) * (1 + cmargin / 100) * (1 + cfinance / 100)) + cfab)/ 0.25)* 0.25\n    if result3 % 0.25 != 0:\n        result3 = ((result3 // 0.25) + 1) * 0.25\n    wow.c_rate__sqm = result3\n    C_rate.append(result3)\n    \n    \n    \nra = 0\nfor vov in doc.additional_factors:\n    ra = vov.target_rate\n\n    \n    \n    \n\nn=len(standard_thickness)\ndoc.additional_factors=[]\nfor i in range(n):\n   \n    if doc.category == \"Standard\":\n           \n            rows = {'sheet_thickness_mm': standard_thickness[i] , 'duct_unit_ratesqm': standard_rate[i] , 'item':itemsss[i]}\n            doc.append('additional_factors', rows)\n           \n            # doc.additional_factors[i].standard_thickness = standard_thickness[i]\n            # doc.additional_factors[i].duct_unit_ratesqm = standard_rate[i]\n            # doc.additional_factors[i].item = itemsss[i]\n    \n    elif doc.category == \"A\":\n           \n            rows = {'sheet_thickness_mm': A_thickness[i] , 'duct_unit_ratesqm': A_rate[i] , 'item':itemsss[i] }\n            doc.append('additional_factors', rows)\n      \n    \n    elif doc.category == \"B\":\n        \n            rows = {'sheet_thickness_mm': B_thickness[i] , 'duct_unit_ratesqm':B_rate[i] , 'item':itemsss[i]}\n            doc.append('additional_factors', rows)\n    \n    elif doc.category == \"C\":\n        \n            rows = {'sheet_thickness_mm': C_thickness[i] , 'duct_unit_ratesqm':C_rate[i] , 'item':itemsss[i]}\n            doc.append('additional_factors', rows)\n       \n\nfor vov in doc.additional_factors:\n    vov.dilevery__ratesqm = doc.delivery_ratesqm + vov.duct_unit_ratesqm\n    vov.kg = 7850 * 1 * ( vov.sheet_thickness_mm / 1000)\n    vov.price_per_kg = vov.dilevery__ratesqm / vov.kg\n    sum_price_per_kg = sum_price_per_kg + vov.price_per_kg\n    vov.target_rate = ra\n    count = count + 1\n    \n\nfor vov in doc.additional_factors:\n\n    vov.average_standard = sum_price_per_kg / count\n    \n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-05-24 14:33:01.735147",
  "module": null,
  "name": "Amount Calculation Script",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Inquiry",
  "script": "totalquantity = 0\ntotalamount = 0\n\nfor row in doc.items:\n    if row.amount is None:\n        amount = row.rate * row.qty\n        row.amount = amount\n    else:\n        amount = row.amount\n        \n    totalquantity = totalquantity + row.qty\n    totalamount = totalamount + amount\n\ndoc.total_quantity=totalquantity\ndoc.total_amount = totalamount\n\n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-11 11:13:46.564966",
  "module": null,
  "name": "Accessories Calculation In Costing Sheet",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Pricing Sheet",
  "script": "# # this part is for standanrd \n# i=0\n# coil=0 \n# waste= 0 \n# fab = 0 \n# fc = 0\n# oh = 0 \n# margin = 0 \n# standard_thickness = []\n# itemsss = []\n\n# A_thickness= []\n# B_thickness = []\nstandard_rate = []\nA_rate = []\nB_rate= []\n# sum_price_per_kg = 0\n# count = 0\n\n\n# for row in doc.accessories_factors:\n#     if row.factors == \"Coil Price\":\n#         coil= row.standard\n#     elif row.factors == \"Waste\":\n#         waste= row.standard\n#     elif row.factors == \"Fabrication Cost\":\n#         fab= row.standard\n#     elif row.factors == \"Fixing Cost\":\n#         fc= row.standard\n#     elif row.factors == \"Over Head\":\n#         oh= row.standard\n#     elif row.factors == \"Margin\":\n#         margin= row.standard\n   \n    \n    \n# for wow in doc.accessories_pricing:\n#     wow.standard_cost__sqm = coil / (1000 / ((wow.thickness / 1000) * 7860))\n\n#     standard_thickness.append(wow.thickness)\n#     itemsss.append(wow.item)\n#     result = ((fab + fc + (wow.standard_cost__sqm * (1 + waste / 100))) * (1 + oh / 100)) * (1 + margin / 100)\n   \n#     if result % 0.25 != 0:\n#         # Round up to the nearest multiple of 0.25\n#         result = ((result // 0.25) + 1) * 0.25\n#     wow.standard_rate__sqm = result\n#     standard_rate.append(result)\n\n# # this part is for A\n\n# acoil=0 \n# awaste= 0 \n# afab = 0 \n# aoh = 0 \n# amargin = 0\n# afc = 0\n\n# for row in doc.accessories_factors:\n#     if row.factors == \"Coil Price\":\n#         acoil= row.a\n#     elif row.factors == \"Waste\":\n#         awaste= row.a\n#     elif row.factors == \"Fabrication Cost\":\n#         afab= row.a\n#     elif row.factors == \"Over Head\":\n#         aoh= row.a\n#     elif row.factors == \"Margin\":\n#         amargin= row.a\n#     elif row.factors == \"Fixing Cost\":\n#         afc= row.a\n    \n    \n# for wow in doc.accessories_pricing:\n#     wow.a_cost__sqm = acoil / (1000 / ((wow.thickness / 1000) * 7860))\n#     A_thickness.append(wow.thickness)\n    \n    \n#     result1 = ((afab + afc + (wow.standard_cost__sqm * (1 + awaste / 100))) * (1 + aoh / 100)) * (1 + amargin / 100)\n\n#     if result1 % 0.25 != 0:\n#         result1 = ((result1 // 0.25) + 1) * 0.25\n#     wow.a_rate__sqm = result1\n#     A_rate.append(result1)\n\n\n# # This is for B\n\n# bcoil=0 \n# bwaste= 0 \n# bfab = 0 \n# boh = 0 \n# bmargin = 0 \n# bfc = 0\n\n\n\n\n# for row in doc.accessories_factors:\n#     if row.factors == \"Coil Price\":\n#         bcoil= row.b\n#     elif row.factors == \"Waste\":\n#         bwaste= row.b\n#     elif row.factors == \"Fabrication Cost\":\n#         bfab= row.b\n#     elif row.factors == \"Over Head\":\n#         boh= row.b\n#     elif row.factors == \"Margin\":\n#         bmargin= row.b\n#     elif row.factors == \"Fixing Cost\":\n#         bfc= row.b\n    \n    \n# for wow in doc.accessories_pricing:\n#     wow.b_cost__sqm = bcoil / (1000 / ((wow.thickness / 1000) * 7860))\n#     B_thickness.append(wow.thickness)\n    \n#     result2 = ((wow.standard_cost__sqm *(1 + bwaste / 100)*(1 + boh / 100)*(1 + bmargin / 100)) + bfab + bfc )\n#     if result2 % 0.25 != 0:\n#         result2 = ((result2 // 0.25) + 1) * 0.25\n#     wow.b_rate__sqm = result2\n#     B_rate.append(result2)\n    \n    \n    \n    \n    \n\n# # This is for C\n\n# ccoil=0 \n# cwaste= 0 \n# cfab = 0 \n# coh = 0 \n# cmargin = 0 \n# cfc=0\n# C_thickness = []\nC_rate = []\n\n\n\n\n# for row in doc.accessories_factors:\n#     if row.factors == \"Coil Price\":\n#         ccoil= row.c\n#     elif row.factors == \"Waste\":\n#         cwaste= row.c\n#     elif row.factors == \"Fabrication Cost\":\n#         cfab= row.c\n#     elif row.factors == \"Over Head\":\n#         coh= row.c\n#     elif row.factors == \"Margin\":\n#         cmargin= row.c\n#     elif row.factors == \"Fixing Price\":\n#         cfinance= row.c\n    \n    \n# for wow in doc.accessories_pricing:\n#     wow.c_cost__sqm = ccoil / (1000 / ((wow.thickness / 1000) * 7860))\n#     C_thickness.append(wow.thickness)\n    \n    \n#     result3 = ((wow.standard_cost__sqm *(1 + cwaste / 100)*(1 + coh / 100)*(1 + cmargin / 100)) + cfab + cfc )\n#     if result3 % 0.25 != 0:\n#         result3 = ((result3 // 0.25) + 1) * 0.25\n#     wow.c_rate__sqm = result3\n#     C_rate.append(result3)\n    \n    \n    \n    \nthicknesses = []\nstandard_rates = []\na_rates = []\nb_rates = []\nc_rates = []\ntarget_thickness = 0\n\n# Populate the lists\nfor wow in doc.accessories_pricing:\n    thicknesses.append(wow.thickness)\n    standard_rates.append(wow.standard_rate__sqm)\n    a_rates.append(wow.a_rate__sqm)\n    b_rates.append(wow.b_rate__sqm)\n    c_rates.append(wow.c_rate__sqm)\n\n# Transpose the lists manually\nall_rates_transposed = []\nfor i in range(len(thicknesses)):\n    row = [thicknesses[i], standard_rates[i], a_rates[i], b_rates[i], c_rates[i]]\n    all_rates_transposed.append(row)\n    \n    \n    \n# Iterate through the fixing table and retrieve rates for each thickness\nfor row in doc.accessory_fixing:\n    target_thickness = row.thickness  # Get the thickness from the fixing table\n    # frappe.msgprint(str(target_thickness))\n    # Initialize flag to check if target thickness is found\n    found = False\n\n    # Iterate through all_rates_transposed to find the target thickness\n    for sublist in all_rates_transposed:\n        # Check if the thickness in the sublist matches the target thickness\n        if sublist[0] == target_thickness:\n            # If found, extract the rates\n            standard_rate = sublist[1]\n            A_rate = sublist[2]\n            B_rate = sublist[3]\n            C_rate = sublist[4]\n            \n            found = True\n            break  # Exit the loop since we found the matching sublist\n\n    # If target thickness is not found, print a message\n    if not found:\n        frappe.msgprint(f\"No rates found for thickness {target_thickness}\")\n\n    standard = standard_rate * row.area\n    a = A_rate * row.area\n    b = B_rate * row.area\n    c = C_rate * row.area\n\n    # Round up each calculated value to the nearest multiple of 0.25 manually\n    row.category = ((standard + 0.24) // 0.25) * 0.25\n    row.a = ((a + 0.24) // 0.25) * 0.25\n    row.b = ((b + 0.24) // 0.25) * 0.25\n    row.c = ((c + 0.24) // 0.25) * 0.25\n\n           \n        \n\n\n\n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-11 10:15:46.583640",
  "module": null,
  "name": "Accessory Calculation In Accessory Doctype",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Accessories",
  "script": "i=0\ncoil=0 \nwaste= 0 \nfab = 0 \nfc = 0\noh = 0 \nmargin = 0 \nstandard_thickness = []\nitemsss = []\n\nA_thickness= []\nB_thickness = []\nstandard_rate = []\nA_rate = []\nB_rate= []\nsum_price_per_kg = 0\ncount = 0\n\n\nfor row in doc.factors:\n    if row.factors == \"Coil Price\":\n        coil= row.standard\n    elif row.factors == \"Waste\":\n        waste= row.standard\n    elif row.factors == \"Fabrication Cost\":\n        fab= row.standard\n    elif row.factors == \"Fixing Cost\":\n        fc= row.standard\n    elif row.factors == \"Over Head\":\n        oh= row.standard\n    elif row.factors == \"Margin\":\n        margin= row.standard\n   \n    \n    \nfor wow in doc.accessories_pricing:\n    wow.standard_cost__sqm = coil / (1000 / ((wow.thickness / 1000) * 7860))\n\n    standard_thickness.append(wow.thickness)\n    itemsss.append(wow.item)\n    result = ((fab + fc + (wow.standard_cost__sqm * (1 + waste / 100))) * (1 + oh / 100)) * (1 + margin / 100)\n   \n    if result % 0.25 != 0:\n        # Round up to the nearest multiple of 0.25\n        result = ((result // 0.25) + 1) * 0.25\n    wow.standard_rate__sqm = result\n    standard_rate.append(result)\n\n# this part is for A\n\nacoil=0 \nawaste= 0 \nafab = 0 \naoh = 0 \namargin = 0\nafc = 0\n\nfor row in doc.factors:\n    if row.factors == \"Coil Price\":\n        acoil= row.a\n    elif row.factors == \"Waste\":\n        awaste= row.a\n    elif row.factors == \"Fabrication Cost\":\n        afab= row.a\n    elif row.factors == \"Over Head\":\n        aoh= row.a\n    elif row.factors == \"Margin\":\n        amargin= row.a\n    elif row.factors == \"Fixing Cost\":\n        afc= row.a\n    \n    \nfor wow in doc.accessories_pricing:\n    wow.a_cost__sqm = acoil / (1000 / ((wow.thickness / 1000) * 7860))\n    A_thickness.append(wow.thickness)\n    \n    \n    result1 = ((afab + afc + (wow.standard_cost__sqm * (1 + awaste / 100))) * (1 + aoh / 100)) * (1 + amargin / 100)\n\n    if result1 % 0.25 != 0:\n        result1 = ((result1 // 0.25) + 1) * 0.25\n    wow.a_rate__sqm = result1\n    A_rate.append(result1)\n\n\n# This is for B\n\nbcoil=0 \nbwaste= 0 \nbfab = 0 \nboh = 0 \nbmargin = 0 \nbfc = 0\n\n\n\n\nfor row in doc.factors:\n    if row.factors == \"Coil Price\":\n        bcoil= row.b\n    elif row.factors == \"Waste\":\n        bwaste= row.b\n    elif row.factors == \"Fabrication Cost\":\n        bfab= row.b\n    elif row.factors == \"Over Head\":\n        boh= row.b\n    elif row.factors == \"Margin\":\n        bmargin= row.b\n    elif row.factors == \"Fixing Cost\":\n        bfc= row.b\n    \n    \nfor wow in doc.accessories_pricing:\n    wow.b_cost__sqm = bcoil / (1000 / ((wow.thickness / 1000) * 7860))\n    B_thickness.append(wow.thickness)\n    \n    result2 = ((wow.standard_cost__sqm *(1 + bwaste / 100)*(1 + boh / 100)*(1 + bmargin / 100)) + bfab + bfc )\n    if result2 % 0.25 != 0:\n        result2 = ((result2 // 0.25) + 1) * 0.25\n    wow.b_rate__sqm = result2\n    B_rate.append(result2)\n    \n    \n    \n    \n    \n\n# This is for C\n\nccoil=0 \ncwaste= 0 \ncfab = 0 \ncoh = 0 \ncmargin = 0 \ncfc=0\nC_thickness = []\nC_rate = []\n\n\n\n\nfor row in doc.factors:\n    if row.factors == \"Coil Price\":\n        ccoil= row.c\n    elif row.factors == \"Waste\":\n        cwaste= row.c\n    elif row.factors == \"Fabrication Cost\":\n        cfab= row.c\n    elif row.factors == \"Over Head\":\n        coh= row.c\n    elif row.factors == \"Margin\":\n        cmargin= row.c\n    elif row.factors == \"Fixing Price\":\n        cfinance= row.c\n    \n    \nfor wow in doc.accessories_pricing:\n    wow.c_cost__sqm = ccoil / (1000 / ((wow.thickness / 1000) * 7860))\n    C_thickness.append(wow.thickness)\n    \n    \n    result3 = ((wow.standard_cost__sqm *(1 + cwaste / 100)*(1 + coh / 100)*(1 + cmargin / 100)) + cfab + cfc )\n    if result3 % 0.25 != 0:\n        result3 = ((result3 // 0.25) + 1) * 0.25\n    wow.c_rate__sqm = result3\n    C_rate.append(result3)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-18 09:01:20.698510",
  "module": null,
  "name": "Leave Days",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "month_days = frappe.utils.add_days(doc.from_date, -1)\r\n\r\n\r\n\r\n\r\nemp_leaves = frappe.get_list(\"Leave Application\",\r\n    filters={\r\n        'employee': doc.employee,\r\n        'docstatus': 1,\r\n        'leave_type': 'Sick Leave',\r\n        'from_date': ['>=', '2024-01-01'],\r\n        'to_date': ['<', month_days],\r\n    },\r\n    fields=[\"total_leave_days\"]\r\n)\r\n\r\n# salary slip ki dates laani hain by doc.start_date doc.end_date \r\n\r\ntotal_leave_days = sum(leave.total_leave_days for leave in emp_leaves)\r\n\r\nactual_payment_days = 30\r\n\r\nif total_leave_days > 15:\r\n\r\n    half_days = total_leave_days - 15\r\n    actual_payment_days = actual_payment_days-half_days * 0.5  \r\n    \r\nif total_leave_days > 45:\r\n   \r\n    unpaid_leaves = total_leave_days - 45\r\n    actual_payment_days = actual_payment_days-unpaid_leaves \r\n\r\n\r\ndoc.custom_leave_days = actual_payment_days\r\n\r\n\r\n# frappe.msgprint(f\"Total Leave Days: {total_leave_days}, Actual Payment Days: {actual_payment_days}\")\r\nfrappe.msgprint(doc.start_date, doc.end_date)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-02-11 20:36:38.758226",
  "module": null,
  "name": "test",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "\n\n\n    ##################### Employee Sick Leaves ######################\n\ndoc.custom_leave_days = doc.payment_days\n# doc.custom_previous_leaves = 0\n# doc.custom_current_leaves = 0\n# doc.custom_absent_with_permission = 0\n\n\nday_before_month = frappe.utils.add_days(doc.start_date, -1)\n\n\nlp_list = frappe.get_list('Leave Period',\n                filters = {\n                    \"company\" : doc.company ,\n                    \"is_active\" : 1 ,\n                }, order_by = 'from_date desc' )\n\n\nif lp_list :\n    lp_doc = frappe.get_doc(\"Leave Period\", lp_list[0].name)\n    \n\n\nprev_sick_leaves = 0\ncur_sick_leaves = 0\n\nvalues = {\n    'employee': doc.employee,\n    's_date': lp_doc.from_date,\n    'e_date': day_before_month,\n}\n\nprev_sick_leaves_list = frappe.db.sql(\"\"\"\n\n    SELECT\n        lp.name ,\n        lp.total_leave_days ,\n        lp.from_date ,\n        lp.to_date\n    FROM\n        `tabLeave Application` lp\n    WHERE\n        lp.employee = %(employee)s\n        AND lp.docstatus = 1\n        AND (lp.leave_type = 'Sick Leave SASCO' OR lp.leave_type = 'Sick Leave Al Mabani')\n        AND (\n            lp.from_date BETWEEN %(s_date)s AND %(e_date)s \n            OR lp.to_date BETWEEN %(s_date)s AND %(e_date)s\n        )      \n\n\"\"\", values=values , as_dict=1)\n\n\nif prev_sick_leaves_list :\n    for prev_sk in prev_sick_leaves_list :\n        \n        if str(prev_sk.from_date) < str(lp_doc.from_date) :\n            dt_diff_s = frappe.utils.date_diff(lp_doc.from_date , str(prev_sk.from_date))\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days - dt_diff_s\n             \n        elif str(day_before_month) < str(prev_sk.to_date) :\n            dt_diff_e = frappe.utils.date_diff(str(prev_sk.to_date) , day_before_month )\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days - dt_diff_e        \n        \n        else :\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days\n\n\nvalues = {\n    'employee': doc.employee,\n    's_date': doc.start_date,\n    'e_date': doc.end_date,\n}\n\ncur_sick_leaves_list = frappe.db.sql(\"\"\"\n    SELECT\n        lp.name ,\n        lp.total_leave_days ,\n        lp.from_date ,\n        lp.to_date\n    FROM\n        `tabLeave Application` lp\n    WHERE\n        lp.employee = %(employee)s\n        AND lp.docstatus = 1\n        AND (lp.leave_type = 'Sick Leave SASCO' OR lp.leave_type = 'Sick Leave Al Mabani')\n        AND (\n            lp.from_date BETWEEN %(s_date)s AND %(e_date)s \n            OR lp.to_date BETWEEN %(s_date)s AND %(e_date)s\n        )  \n       \n\"\"\", values=values, as_dict=True)\n\n\n \nif cur_sick_leaves_list :\n    for cur_sk in cur_sick_leaves_list :\n        \n        if str(cur_sk.from_date) < str(doc.start_date) :\n            dt_diff_s = frappe.utils.date_diff(doc.start_date , str(cur_sk.from_date))\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days - dt_diff_s\n             \n            \n        elif str(doc.end_date) < str(cur_sk.to_date) :\n            dt_diff_e = frappe.utils.date_diff(str(cur_sk.to_date) , doc.end_date)\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days - dt_diff_e        \n            \n        else :\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days \n\n\n\ndoc.custom_previous_leaves = prev_sick_leaves\ndoc.custom_current_leaves = cur_sick_leaves\n\n\n\n\nhalf_cur_sick_leaves = 0\nabsent_cur_sick_leaves = 0\n\nif doc.company == \"SASCO Industries\":\n    if cur_sick_leaves > 0 :\n    \n        if (prev_sick_leaves + cur_sick_leaves) <= 45 :\n            \n            if (prev_sick_leaves + cur_sick_leaves) > 15 :\n                \n                if prev_sick_leaves < 15 :\n                    prev_diff = 15 - prev_sick_leaves\n                    half_cur_sick_leaves = float( ( cur_sick_leaves - prev_diff ) / 2 )\n                    \n                elif prev_sick_leaves >= 15 :\n                    half_cur_sick_leaves = float( cur_sick_leaves / 2 )\n                    \n                doc.custom_leave_days = doc.payment_days - half_cur_sick_leaves\n                doc.custom_absent_with_permission = half_cur_sick_leaves\n                \n                \n            \n        elif (prev_sick_leaves + cur_sick_leaves) > 45 :\n            \n            if prev_sick_leaves < 45 :\n                prev_diff = 45 - prev_sick_leaves\n                \n                half_cur_sick_leaves = float( prev_diff / 2 )\n                absent_cur_sick_leaves = ( cur_sick_leaves - prev_diff )\n                \n            elif prev_sick_leaves >= 45 :\n                absent_cur_sick_leaves = cur_sick_leaves\n        \n            doc.custom_leave_days = doc.payment_days - (absent_cur_sick_leaves + half_cur_sick_leaves)\n            doc.custom_absent_with_permission = half_cur_sick_leaves + absent_cur_sick_leaves\n\n\n\n\n\nif doc.company == \"Al Mabani\":\n    \n    \n    half_cur_sick_leaves = 0\n    absent_cur_sick_leaves = 0\n    \n    if cur_sick_leaves > 0 :\n    \n        if (prev_sick_leaves + cur_sick_leaves) <= 90 :\n            \n            if (prev_sick_leaves + cur_sick_leaves) > 30 :\n                \n                if prev_sick_leaves < 30 :\n                    prev_diff = 30 - prev_sick_leaves\n                    half_cur_sick_leaves = float( ( cur_sick_leaves - prev_diff ) / 4 )\n                    \n                elif prev_sick_leaves >= 30 :\n                    half_cur_sick_leaves = float( cur_sick_leaves / 4 )\n                    \n                doc.custom_leave_days = doc.payment_days - half_cur_sick_leaves\n                doc.custom_absent_with_permission = half_cur_sick_leaves\n                \n                \n            \n        elif (prev_sick_leaves + cur_sick_leaves) > 90 :\n            \n            if prev_sick_leaves < 90 :\n                prev_diff = 90 - prev_sick_leaves\n                \n                half_cur_sick_leaves = float( prev_diff / 4 )\n                absent_cur_sick_leaves = ( cur_sick_leaves - prev_diff )\n                \n            elif prev_sick_leaves >= 90 :\n                absent_cur_sick_leaves = cur_sick_leaves\n        \n            doc.custom_leave_days = doc.payment_days - (absent_cur_sick_leaves + half_cur_sick_leaves)\n            doc.custom_absent_with_permission = half_cur_sick_leaves + absent_cur_sick_leaves\n\n\n\n\n\n        ########################## OverTime Calculation ###########################\n                \nemp_doc = frappe.get_doc(\"Employee\", doc.employee)\n\nif emp_doc.custom_employee_group :\n    emp_grp_doc = frappe.get_doc('Employee Group',emp_doc.custom_employee_group)\n    \n    if emp_grp_doc.custom_overtime_allowed == 1 :\n    \n        ov_hrs = 0\n        ov_amount = 0\n        \n        \n        \n        values = {\n            'employee' : doc.employee ,\n            'start_date' : doc.start_date ,\n            'end_date' : doc.end_date ,\n        }                    \n    \n        att_list = frappe.db.sql(\"\"\"\n        \n                        SELECT\n                            shift,\n                            working_hours\n                        FROM\n                            `tabAttendance`\n                        WHERE\n                            employee = %(employee)s\n                            AND attendance_date BETWEEN %(start_date)s AND %(end_date)s\n                            AND shift != ''\n                            AND working_hours > 0\n                            AND status != 'Absent'\n        \n                  \"\"\", values=values, as_dict=1)\n        \n                   \n        if att_list :\n            \n            for att in att_list :\n                shift_doc = frappe.get_doc('Shift Type',att.shift)\n                \n                if shift_doc.required_hours and att.working_hours > shift_doc.required_hours :\n                    ov_hrs = ov_hrs + ( att.working_hours - shift_doc.required_hours )\n                    \n        \n        if doc.earnings :\n            for comp in doc.earnings :\n                if comp.salary_component == 'Basic' :\n                    ov_amount = ( (comp.amount/emp_grp_doc.custom_payroll_days_for_overtime) / emp_grp_doc.custom_required_hours_per_day ) * ov_hrs\n                    break\n        \n        \n        if ov_hrs % 1 >= 0.5 :\n            ov_hrs = frappe.utils.ceil(ov_hrs)\n        else :\n            ov_hrs = frappe.utils.floor(ov_hrs)\n        \n        doc.custom_overtime_hours = ov_hrs\n        doc.custom_overtime_amount = ov_amount\n                    \n   \n   \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n                    \n                    \n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-22 09:57:07.544509",
  "module": null,
  "name": "test leave",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "\n# month_days = frappe.utils.add_days(doc.start_date, -1)\n\n\n# lp_list = frappe.get_list('Leave Period',\n#     filters={\n#         \"company\": doc.company,\n#         \"is_active\": 1,\n#     },\n#     order_by='from_date desc',\n#     limit=1  \n# )\n\n# if lp_list:\n#     lp_doc = frappe.get_doc(\"Leave Period\", lp_list[0].name)\n\n#     # previous sick leaves\n#     prev_sick_leaves_list = frappe.get_list(\"Leave Application\",\n#         filters={\n#             'employee': doc.employee,\n#             'docstatus': 1,\n#             'leave_type': 'Sick Leave',\n#             'from_date': ['>=', lp_doc.from_date],\n#             'to_date': ['<', month_days],\n#         },\n#         fields=[\"total_leave_days\"]\n#     )\n\n#     prev_sick_leaves = sum([sl.total_leave_days for sl in prev_sick_leaves_list])\n\n#     #current sick leaves\n#     cur_sick_leaves_list = frappe.db.sql(\"\"\"\n#         SELECT\n#             SUM(total_leave_days) AS total\n#         FROM\n#             `tabLeave Application`\n#         WHERE\n#             employee = %(employee)s\n#             AND docstatus = 1\n#             AND leave_type = 'Sick Leave'\n#             AND (\n#                 from_date BETWEEN %(s_date)s AND %(e_date)s\n#                 OR to_date BETWEEN %(s_date)s AND %(e_date)s\n#             )  \n#     \"\"\", values={\n#         'employee': doc.employee,\n#         's_date': doc.start_date,\n#         'e_date': doc.end_date,\n#     }, as_dict=True)\n\n#     cur_sick_leaves = cur_sick_leaves_list[0].total if cur_sick_leaves_list else 0\n\n    \n#     doc.custom_previous_leaves = prev_sick_leaves\n#     doc.custom_current_leaves = cur_sick_leaves\n\n\nmonth_days = frappe.utils.add_days(doc.start_date, -1)\n\nlp_list = frappe.get_list('Leave Period',\n    filters={\n        \"company\": doc.company,\n        \"is_active\": 1,\n    },\n    order_by='from_date desc',\n    limit=1  \n)\n\nif lp_list:\n    lp_doc = frappe.get_doc(\"Leave Period\", lp_list[0].name)\n\n    # Previous sick leaves\n    prev_sick_leaves_list = frappe.get_list(\"Leave Application\",\n        filters={\n            'employee': doc.employee,\n            'docstatus': 1,\n            'leave_type': 'Sick Leave',\n            'from_date': ['>=', lp_doc.from_date],\n            'to_date': ['<', month_days],\n        },\n        fields=[\"total_leave_days\"]\n    )\n\n    prev_sick_leaves = sum([sl.total_leave_days for sl in prev_sick_leaves_list])\n\n    # Current sick leaves\n    cur_sick_leaves_list = frappe.db.sql(\"\"\"\n        SELECT\n            SUM(total_leave_days) AS total\n        FROM\n            `tabLeave Application`\n        WHERE\n            employee = %(employee)s\n            AND docstatus = 1\n            AND leave_type = 'Sick Leave'\n            AND (\n                from_date BETWEEN %(s_date)s AND %(e_date)s\n                OR to_date BETWEEN %(s_date)s AND %(e_date)s\n            )  \n    \"\"\", values={\n        'employee': doc.employee,\n        's_date': doc.start_date,\n        'e_date': doc.end_date,\n    }, as_dict=True)\n\n    cur_sick_leaves = cur_sick_leaves_list[0].total if cur_sick_leaves_list else 0\n\n    # Calculate total sick leaves\n    total_sick_leaves = prev_sick_leaves + cur_sick_leaves\n\n    # Determine custom_half_days and leave_without_pay\n    if total_sick_leaves > 45:\n        doc.leave_without_pay = total_sick_leaves - 45\n        doc.custom_half_days = 45 - 15  # Assuming 15 to 45 days are counted as half days\n    elif total_sick_leaves > 15:\n        doc.custom_half_days = total_sick_leaves - 15\n        doc.leave_without_pay = 0\n    else:\n        doc.custom_half_days = 0\n        doc.leave_without_pay = 0\n\n    doc.custom_previous_leaves = prev_sick_leaves\n    doc.custom_current_leaves = cur_sick_leaves",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-03 16:23:27.345615",
  "module": null,
  "name": "fetch project customer",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Event",
  "script": "table = doc.event_participants\n\nfor item in table:\n    if item.reference_doctype == \"Opportunity\":\n        \n        project=frappe.get_doc(\"Opportunity\", item.reference_docname)\n        if project.source == \"Existing Customer\":\n            doc.custom_project= project.custom_project\n            doc.custom_customer = project.custom_customer\n        else:\n            doc.custom_project = None\n            doc.custom_customer = None\n       \n        break\n    \n    if item.reference_doctype == \"Lead\":\n        \n        project=frappe.get_doc(\"Lead\", item.reference_docname)\n        if project.source == \"Existing Customer\":\n            doc.custom_project= project.custom_project\n            doc.custom_customer = project.customer\n        else:\n            doc.custom_project = None\n            doc.custom_customer = None\n       \n        break\n    \n    \nif doc.custom_meeting_topic not in doc.subject:\n    subject = f'''{doc.custom_meeting_topic}\\n{doc.subject}\\n{doc.custom_project if doc.custom_project else ''}'''   \n    doc.subject = subject\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-28 11:12:49.281982",
  "module": null,
  "name": "items of material",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "if doc.material_request:\r\n    print_table_entries = []\r\n\r\n    # Set to keep track of unique supplier quotations\r\n    unique_supplier_quotations = set()\r\n\r\n    for x in doc.material_request:\r\n        mt_req_doc = frappe.get_doc(\"Material Request\", x.material_request)\r\n        \r\n        # Only consider submitted Material Requests\r\n        if mt_req_doc.docstatus == 1:\r\n            # Query Request for Quotation linked to the current material_request\r\n            rfq_list = frappe.get_list(\"Request for Quotation\", filters={\"custom_material_request\": x.material_request})\r\n            \r\n            if rfq_list:\r\n                for rfq in rfq_list:\r\n                    rfq_doc = frappe.get_doc(\"Request for Quotation\", rfq.name)\r\n                    \r\n                    # Query Supplier Quotations linked to the RFQ\r\n                    rfq_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_request_for_quotation\": rfq_doc.name})\r\n                    \r\n                    for req in rfq_supplier_quotations:\r\n                        supplier_quotation_id = req.name\r\n                        \r\n                        # Check if this supplier_quotation has already been added\r\n                        if supplier_quotation_id not in unique_supplier_quotations:\r\n                            unique_supplier_quotations.add(supplier_quotation_id)\r\n                            \r\n                            supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", supplier_quotation_id)\r\n                            \r\n                            # Only consider submitted Supplier Quotations\r\n                            if supplier_quotation_doc.docstatus == 1:\r\n                                # Append a new entry to print_table\r\n                                new_entry = {\r\n                                    'material_request': mt_req_doc.name,\r\n                                    'supplier_quotation': supplier_quotation_id,\r\n                                    'supplier': supplier_quotation_doc.supplier,\r\n                                    'supplier_name': supplier_quotation_doc.supplier_name\r\n                                }\r\n\r\n                                # Append to print_table_entries\r\n                                print_table_entries.append(new_entry)\r\n\r\n            else:\r\n                # If no Request for Quotation found, include Supplier Quotations directly linked to material_request\r\n                direct_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_material_request_ref\": x.material_request})\r\n                \r\n                for req in direct_supplier_quotations:\r\n                    supplier_quotation_id = req.name\r\n                    \r\n                    # Check if this supplier_quotation has already been added\r\n                    if supplier_quotation_id not in unique_supplier_quotations:\r\n                        unique_supplier_quotations.add(supplier_quotation_id)\r\n                        \r\n                        supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", supplier_quotation_id)\r\n                        \r\n                        # Only consider submitted Supplier Quotations\r\n                        if supplier_quotation_doc.docstatus == 1:\r\n                            # Append a new entry to print_table\r\n                            new_entry = {\r\n                                'material_request': mt_req_doc.name,\r\n                                'supplier_quotation': supplier_quotation_id,\r\n                                'supplier': supplier_quotation_doc.supplier,\r\n                                'supplier_name': supplier_quotation_doc.supplier_name\r\n                            }\r\n\r\n                            # Append to print_table_entries\r\n                            print_table_entries.append(new_entry)\r\n\r\n    # Set print_table_entries to doc's print_table field\r\n    doc.set('print_table', print_table_entries)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-28 11:11:20.829703",
  "module": null,
  "name": "fetch supplier quotation and material request to supplier quotation comparison",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "if doc.material_request:\r\n    table_netp_entries = []\r\n\r\n    for x in doc.material_request:\r\n        mt_req_doc = frappe.get_doc(\"Material Request\", x.material_request)\r\n        \r\n        # Only consider submitted Material Requests\r\n        if mt_req_doc.docstatus == 1:\r\n            # Append a new entry to table_netp\r\n            new_child = doc.append('table_netp', {\r\n                'material_request': mt_req_doc.name\r\n            })\r\n            \r\n            # Query Request for Quotation linked to the current material_request\r\n            rfq_list = frappe.get_list(\"Request for Quotation\", filters={\"custom_material_request\": x.material_request})\r\n            \r\n            if rfq_list:\r\n                for rfq in rfq_list:\r\n                    rfq_doc = frappe.get_doc(\"Request for Quotation\", rfq.name)\r\n                    \r\n                    # Query Supplier Quotations linked to the RFQ\r\n                    rfq_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_request_for_quotation\": rfq_doc.name})\r\n                    \r\n                    for req in rfq_supplier_quotations:\r\n                        supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", req.name)\r\n                        \r\n                        # Only consider submitted Supplier Quotations\r\n                        if supplier_quotation_doc.docstatus == 1:\r\n                            # Fetch items from the Supplier Quotation Item table\r\n                            for item in supplier_quotation_doc.items:\r\n                                # Fetch first warehouse_reorder_level from Item Master's reorder_levels\r\n                                item_master_doc = frappe.get_doc(\"Item\", item.item_code)\r\n                                reorder_level = None\r\n                                if item_master_doc.reorder_levels:\r\n                                    reorder_level = item_master_doc.reorder_levels[0].warehouse_reorder_level\r\n\r\n                                # Fetch last_purchase_rate from Item Master\r\n                                last_purchase_rate = item_master_doc.last_purchase_rate\r\n\r\n                                # Append each item with additional fields\r\n                                table_netp_entries.append({\r\n                                    'parent': new_child.name,\r\n                                    'material_request': x.material_request,\r\n                                    'supplier_quotation': req.name,\r\n                                    'item_code': item.item_code,\r\n                                    'uom': item.uom,\r\n                                    'qty': item.qty,\r\n                                    'rate': item.rate,\r\n                                    'amount': item.amount,\r\n                                    'brand': item.custom_brands,\r\n                                    'delivery_date': item.custom_delivery_date,\r\n                                    'request_for_quotation': rfq_doc.name,\r\n                                    'quality_of_products': supplier_quotation_doc.custom_quality_of_products,\r\n                                    'previous_experience': supplier_quotation_doc.custom_previous_experience,\r\n                                    're_order_level': reorder_level,\r\n                                    'last_purchase_rate': last_purchase_rate,\r\n                                    'supplier': supplier_quotation_doc.supplier,\r\n                                    'supplier_name': supplier_quotation_doc.supplier_name\r\n                                })\r\n\r\n            else:\r\n                # If no Request for Quotation found, include Supplier Quotations directly linked to material_request\r\n                direct_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_material_request_ref\": x.material_request})\r\n                \r\n                for req in direct_supplier_quotations:\r\n                    supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", req.name)\r\n                    \r\n                    # Only consider submitted Supplier Quotations\r\n                    if supplier_quotation_doc.docstatus == 1:\r\n                        # Fetch items from the Supplier Quotation Item table\r\n                        for item in supplier_quotation_doc.items:\r\n                            # Fetch first warehouse_reorder_level from Item Master's reorder_levels\r\n                            item_master_doc = frappe.get_doc(\"Item\", item.item_code)\r\n                            reorder_level = None\r\n                            if item_master_doc.reorder_levels:\r\n                                reorder_level = item_master_doc.reorder_levels[0].warehouse_reorder_level\r\n\r\n                            # Fetch last_purchase_rate from Item Master\r\n                            last_purchase_rate = item_master_doc.last_purchase_rate\r\n\r\n                            # Append each item with additional fields\r\n                            table_netp_entries.append({\r\n                                'parent': new_child.name,\r\n                                'material_request': x.material_request,\r\n                                'supplier_quotation': req.name,\r\n                                'item_code': item.item_code,\r\n                                'uom': item.uom,\r\n                                'qty': item.qty,\r\n                                'rate': item.rate,\r\n                                'amount': item.amount,\r\n                                'brand': item.custom_brands,\r\n                                'delivery_date': item.custom_delivery_date,\r\n                                'request_for_quotation': None,\r\n                                'quality_of_products': supplier_quotation_doc.custom_quality_of_products,\r\n                                'previous_experience': supplier_quotation_doc.custom_previous_experience,\r\n                                're_order_level': reorder_level,\r\n                                'last_purchase_rate': last_purchase_rate,\r\n                                'supplier': supplier_quotation_doc.supplier,\r\n                                'supplier_name': supplier_quotation_doc.supplier_name\r\n                            })\r\n\r\n    doc.set('table_netp', table_netp_entries)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-29 13:34:21.077914",
  "module": null,
  "name": "fetch material request and supplier quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "if doc.table_hrwu:\n    table_hrwu_entries = []\n    processed_material_requests = set()\n\n    for x in doc.table_hrwu:\n        mt_req_doc = frappe.get_doc(\"Material Request\", x.material_request)\n        \n        # Only consider submitted Material Requests\n        if mt_req_doc.docstatus == 1:\n            # Fetch all Supplier Quotations linked to the Material Request\n            direct_supplier_quotations = frappe.get_list(\n                \"Supplier Quotation\",\n                filters={\"custom_material_request_ref\": x.material_request}\n            )\n            \n            if not direct_supplier_quotations:\n                # If no quotations, still add the Material Request with a special flag or empty value\n                if x.material_request not in processed_material_requests:\n                    table_hrwu_entries.append({\n                        'supplier_quotation':\"\",\n                        'material_request': x.material_request  # Ensure this field is present in table_hrwu\n                    })\n                    processed_material_requests.add(x.material_request)\n            else:\n                for req in direct_supplier_quotations:\n                    supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", req.name)\n                    \n                    if supplier_quotation_doc.docstatus == 1:\n                        # Add entry only if it hasn't been processed already\n                        if (x.material_request, req.name) not in processed_material_requests:\n                            table_hrwu_entries.append({\n                                'supplier_quotation': req.name,\n                                'material_request': x.material_request  # Ensure this field is present in table_hrwu\n                            })\n                            processed_material_requests.add((x.material_request, req.name))\n\n    # Debugging: Print or log the entries being set\n    print(\"Table HRWU Entries:\", table_hrwu_entries)\n\n    # Clear the existing entries if needed, or append new ones\n    doc.set('table_hrwu', [])  # Clear existing entries\n    for entry in table_hrwu_entries:\n        doc.append('table_hrwu', entry)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-31 10:50:36.367170",
  "module": null,
  "name": "test1",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "\n\n\n    ##################### Employee Sick Leaves ######################\n\ndoc.custom_leave_days = doc.payment_days\ndoc.custom_previous_leaves = 0\ndoc.custom_current_leaves = 0\ndoc.custom_absent_with_permission = 0\nfrappe.msgprint(doc.company)\n\nday_before_month = frappe.utils.add_days(doc.start_date, -1)\n\n\nlp_list = frappe.get_list('Leave Period',\n                filters = {\n                    \"company\" : doc.company ,\n                    \"is_active\" : 1 ,\n                }, order_by = 'from_date desc' )\n\n\nif lp_list :\n    lp_doc = frappe.get_doc(\"Leave Period\", lp_list[0].name)\n    \n\n\nprev_sick_leaves = 0\ncur_sick_leaves = 0\n\nvalues = {\n    'employee': doc.employee,\n    's_date': lp_doc.from_date,\n    'e_date': day_before_month,\n}\n\nprev_sick_leaves_list = frappe.db.sql(\"\"\"\n\n    SELECT\n        lp.name ,\n        lp.total_leave_days ,\n        lp.from_date ,\n        lp.to_date\n    FROM\n        `tabLeave Application` lp\n    WHERE\n        lp.employee = %(employee)s\n        AND lp.docstatus = 1\n        AND lp.leave_type = 'Sick Leave'\n        AND (\n            lp.from_date BETWEEN %(s_date)s AND %(e_date)s \n            OR lp.to_date BETWEEN %(s_date)s AND %(e_date)s\n        )      \n\n\"\"\", values=values , as_dict=1)\n\n\nif prev_sick_leaves_list :\n    for prev_sk in prev_sick_leaves_list :\n        \n        if str(prev_sk.from_date) < str(lp_doc.from_date) :\n            dt_diff_s = frappe.utils.date_diff(lp_doc.from_date , str(prev_sk.from_date))\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days - dt_diff_s\n             \n        elif day_before_month < str(prev_sk.to_date) :\n            dt_diff_e = frappe.utils.date_diff(str(prev_sk.to_date) , day_before_month )\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days - dt_diff_e        \n        \n        else :\n            prev_sick_leaves = prev_sick_leaves + prev_sk.total_leave_days\n\n\nvalues = {\n    'employee': doc.employee,\n    's_date': doc.start_date,\n    'e_date': doc.end_date,\n}\n\ncur_sick_leaves_list = frappe.db.sql(\"\"\"\n    SELECT\n        lp.name ,\n        lp.total_leave_days ,\n        lp.from_date ,\n        lp.to_date\n    FROM\n        `tabLeave Application` lp\n    WHERE\n        lp.employee = %(employee)s\n        AND lp.docstatus = 1\n        AND lp.leave_type = 'Sick Leave'\n        AND (\n            lp.from_date BETWEEN %(s_date)s AND %(e_date)s \n            OR lp.to_date BETWEEN %(s_date)s AND %(e_date)s\n        )  \n       \n\"\"\", values=values, as_dict=True)\n\n \nif cur_sick_leaves_list :\n    for cur_sk in cur_sick_leaves_list :\n        \n        if str(cur_sk.from_date) < doc.start_date :\n            dt_diff_s = frappe.utils.date_diff(doc.start_date , str(cur_sk.from_date))\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days - dt_diff_s\n             \n            \n        elif doc.end_date < str(cur_sk.to_date) :\n            dt_diff_e = frappe.utils.date_diff(str(cur_sk.to_date) , doc.end_date)\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days - dt_diff_e        \n            \n        else :\n            cur_sick_leaves = cur_sick_leaves + cur_sk.total_leave_days \n\n\ndoc.custom_previous_leaves = prev_sick_leaves\ndoc.custom_current_leaves = cur_sick_leaves\n\nif doc.company == \"Al Mabani\":\n    half_cur_sick_leaves = 0\n    absent_cur_sick_leaves = 0\n    \n    if cur_sick_leaves > 0 :\n    \n        if (prev_sick_leaves + cur_sick_leaves) <= 90 :\n            \n            if (prev_sick_leaves + cur_sick_leaves) > 30 :\n                \n                if prev_sick_leaves < 30 :\n                    prev_diff = 30 - prev_sick_leaves\n                    half_cur_sick_leaves = float( ( cur_sick_leaves - prev_diff ) / 4 )\n                    \n                elif prev_sick_leaves >= 30 :\n                    half_cur_sick_leaves = float( cur_sick_leaves / 4 )\n                    \n                doc.custom_leave_days = doc.payment_days - half_cur_sick_leaves\n                doc.custom_absent_with_permission = half_cur_sick_leaves\n                \n                \n            \n        elif (prev_sick_leaves + cur_sick_leaves) > 90 :\n            \n            if prev_sick_leaves < 90 :\n                prev_diff = 90 - prev_sick_leaves\n                \n                half_cur_sick_leaves = float( prev_diff / 4 )\n                absent_cur_sick_leaves = ( cur_sick_leaves - prev_diff )\n                \n            elif prev_sick_leaves >= 90 :\n                absent_cur_sick_leaves = cur_sick_leaves\n        \n            doc.custom_leave_days = doc.payment_days - (absent_cur_sick_leaves + half_cur_sick_leaves)\n            doc.custom_absent_with_permission = half_cur_sick_leaves + absent_cur_sick_leaves\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-07-31 17:58:08.936221",
  "module": null,
  "name": "restrict comment field when workstale is pending by hod",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Checkin Request",
  "script": "if doc.workflow_state == \"Pending By HR User\" and  doc.custom_comment == None:\n  frappe.throw(\"you cannot proceed until you fill comment\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-21 11:06:55.153732",
  "module": null,
  "name": "Creating Item Master From Fabrication",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication List",
  "script": "\n\n\n\n    \n############ SUFYAN SCRIPT ##############\n\n\ndata_dict = {}\n\nfor row in doc.fabrication_table :\n    \n    \n                            #### Child Item Link Records ####\n    \n    \n    if not frappe.db.exists('Item Group', {'item_group_name': row.fl_item_group}) :\n        frappe.get_doc({\n            'doctype': 'Item Group' ,\n            'item_group_name': row.fl_item_group ,\n            'custom_abbreviation' : row.fl_item_group ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('Brand', {'brand': row.fl_item_brand}) :\n        frappe.get_doc({\n            'doctype': 'Brand' ,\n            'brand': row.fl_item_brand ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('UOM', {'uom_name': row.fl_item_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.fl_item_uom ,\n        }).insert(ignore_permissions=True)\n    \n    if not frappe.db.exists('UOM', {'uom_name': row.spl_item_fg_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.spl_item_fg_uom ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('Item', {'item_code': row.fg_batch_sr}) :\n        frappe.get_doc({\n            'doctype': 'Item',\n            'uom' : row.spl_item_fg_uom,\n            'item_code' : row.fg_batch_sr,\n            'item_name' : row.fl_item_name ,\n            # 'description': row.fl_item_description,\n            'item_group': row.fl_item_group,\n            'stock_uom': row.fl_item_uom ,\n            'brand' : row.fl_item_brand ,\n            'custom_specifications' : row.spl_item_fg_specification ,\n            'custom_company' : doc.company ,\n        }).insert(ignore_permissions=True)\n        \n        \n                            #### Parent Item Link Records ####\n    \n    \n    if not frappe.db.exists('Brand', {'brand': row.spl_item_fg_brand}) :\n        frappe.get_doc({\n            'doctype': 'Brand' ,\n            'brand': row.spl_item_fg_brand ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('UOM', {'uom_name': row.spl_item_fg_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.spl_item_fg_uom ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('Item', {'item_code': row.spl_item_fg_code}) :\n        frappe.get_doc({\n            'doctype': 'Item',\n            'uom' : row.spl_item_fg_uom ,\n            'item_code' : row.spl_item_fg_code ,\n            'item_name' : row.spl_item_fg_name ,\n            # 'description': row.spl_item_fg_description,\n            'item_group': row.fl_item_group,\n            'stock_uom': row.spl_item_fg_uom ,\n            'is_stock_item' : 0 ,\n            'brand' : row.spl_item_fg_brand ,\n            'custom_specifications' : row.fl_item_specification ,\n            'custom_company' : doc.company\n        }).insert(ignore_permissions=True)\n        \n    \n    \n    key = (row.spl_item_fg_code)\n            \n    if key not in data_dict:\n        data_dict[key] = {\n            \"new_item_code\": row.spl_item_fg_code,\n            \"items\": []\n        }\n    \n    data_dict[key][\"items\"].append({\n        \"item_code\": row.fg_batch_sr ,\n        \"qty\": row.fl_item_qty ,\n        \"description\": row.fl_item_description ,\n        \"uom\" : row.fl_item_uom ,\n    })\n\n\n\n# for row in doc.accessory :\n    \n#     key = (row.parent_item)\n            \n#     if key not in data_dict:\n#         data_dict[key] = {\n#             \"new_item_code\": row.parent_item,\n#             \"items\": []\n#         }\n    \n#     data_dict[key][\"items\"].append({\n#         \"item_code\": row.item_code ,\n#         \"qty\": row.quantity ,\n#         \"description\": row.description ,\n#         \"uom\" : row.uom ,\n#     })\n    \n    \nfor row in doc.accessory :\n    \n    \n                            #### Child Item Link Records ####\n    \n    \n    if not frappe.db.exists('Item Group', {'item_group_name': row.finished_good_item_group}) :\n        frappe.get_doc({\n            'doctype': 'Item Group' ,\n            'item_group_name': row.finished_good_item_group ,\n            'custom_abbreviation' : row.finished_good_item_group ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('Brand', {'brand': row.child_finished_good_brand}) :\n        frappe.get_doc({\n            'doctype': 'Brand' ,\n            'brand': row.child_finished_good_brand ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('UOM', {'uom_name': row.child_finished_good_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.child_finished_good_uom ,\n        }).insert(ignore_permissions=True)\n    \n    \n    if not frappe.db.exists('Item', {'item_code': row.child_finished_good_item}) :\n        frappe.get_doc({\n            'doctype': 'Item',\n            'uom' : row.child_finished_good_uom,\n            'item_code' : row.child_finished_good_item,\n            'item_name' : row.child_finished_good_item_name ,\n            # 'description': row.child_finished_good_description,\n            'item_group': row.finished_good_item_group,\n            'stock_uom': row.child_finished_good_uom ,\n            'brand' : row.child_finished_good_brand ,\n            'custom_specifications' : row.child_finished_good_specification ,\n            'custom_company' : doc.company ,\n        }).insert(ignore_permissions=True)\n        \n        \n                            #### Parent Item Link Records ####\n    \n    \n    # if not frappe.db.exists('Brand', {'brand': row.parent_finished_good_brand}) :\n    #     frappe.get_doc({\n    #         'doctype': 'Brand' ,\n    #         'brand': row.parent_finished_good_brand ,\n    #     }).insert(ignore_permissions=True)\n    \n    \n    # if not frappe.db.exists('UOM', {'uom_name': row.parent_finished_good_uom}) :\n    #     frappe.get_doc({\n    #         'doctype': 'UOM' ,\n    #         'uom_name': row.parent_finished_good_uom ,\n    #     }).insert(ignore_permissions=True)\n    \n    \n    # if not frappe.db.exists('Item', {'item_code': row.parent_finished_good_item}) :\n    #     frappe.get_doc({\n    #         'doctype': 'Item',\n    #         'uom' : row.parent_finished_good_uom ,\n    #         'item_code' : row.parent_finished_good_item ,\n    #         'item_name' : row.parent_finished_good_item_name ,\n    #         'description': row.parent_finished_good_description,\n    #         'item_group': row.finished_good_item_group,\n    #         'stock_uom': row.parent_finished_good_uom ,\n    #         'is_stock_item' : 0 ,\n    #         'brand' : row.parent_finished_good_brand ,\n    #         'custom_specifications' : row.parent_finished_good_specification\n    #     }).insert(ignore_permissions=True)\n    \n    \n    key = (row.parent_finished_good_item)\n    \n    if key not in data_dict:\n        data_dict[key] = {\n            \"new_item_code\": row.parent_finished_good_item,\n            \"items\": []\n        }\n        \n    data_dict[key][\"items\"].append({\n        \"item_code\": row.child_finished_good_item ,\n        \"qty\": row.child_finished_good_qty ,\n        \"description\": row.child_finished_good_description ,\n        \"uom\" : row.child_finished_good_uom ,\n    })\n    \n    \n\nformatted_data = list(data_dict.values())\n\n\nfor rec in formatted_data :\n    sql_qty = 1\n    if doc.duct_and_acc_item :\n        for x in doc.duct_and_acc_item :\n            if x.item_code == rec['new_item_code'] :\n                sql_qty = (x.qty or 1)\n                break\n    \n    if not frappe.db.exists('Product Bundle', {'new_item_code': rec['new_item_code']}) :\n\n        pro_bndl_doc = frappe.new_doc('Product Bundle')\n        pro_bndl_doc.new_item_code = rec['new_item_code']\n        \n        \n    \n    \n        for item in rec['items']:\n\n            pro_bndl_doc.append('items', {\n                'item_code': item['item_code'],\n                'qty': item['qty'] / sql_qty ,\n                'description': item['description'],\n                'uom': item['uom']\n            })\n    \n        pro_bndl_doc.insert()\n    \n    else :\n        pro_bndl_doc = frappe.get_doc('Product Bundle' , rec['new_item_code'] )\n        pro_bndl_doc.items = []\n        \n        for item in rec['items']:\n            pro_bndl_doc.append('items', {\n                'item_code': item['item_code'],\n                'qty': item['qty'] / sql_qty ,\n                'description': item['description'],\n                'uom': item['uom']\n            })\n        pro_bndl_doc.save()\n    \n\n\n\n\n\n\n\n\n\n\n\n\n\n############# Creating Item From Material List Table #############\nfor row in doc.material_list :\n    \n    \n    ###########################################  Creating RAW Material  #############################################################################\n    if not frappe.db.exists('Item Group', {'item_group_name': row.coil_item_group}) :\n        frappe.get_doc({\n            'doctype': 'Item Group' ,\n            'item_group_name': row.coil_item_group ,\n            'custom_abbreviation' : row.coil_item_group ,\n        }).insert(ignore_permissions=True)\n    row.coil_item_group_link = row.coil_item_group\n    \n    if not frappe.db.exists('Brand', {'brand': row.coil_item_brand}) :\n        frappe.get_doc({\n            'doctype': 'Brand' ,\n            'brand': row.coil_item_brand ,\n        }).insert(ignore_permissions=True)\n    row.coil_item_brand_link = row.coil_item_brand\n    \n    if not frappe.db.exists('UOM', {'uom_name': row.coil_item_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.coil_item_uom ,\n        }).insert(ignore_permissions=True)\n    row.coil_item_uom_link = row.coil_item_uom\n    \n    if not frappe.db.exists('Item', {'item_code': row.coil_item_code_rm}) :\n        frappe.get_doc({\n            'doctype': 'Item',\n            'uom' : row.coil_item_uom ,\n            'item_code' : row.coil_item_code_rm ,\n            'item_group': row.coil_item_group,\n            'stock_uom': row.coil_item_uom ,\n            'is_stock_item' : 1 ,\n            'brand' : row.coil_item_brand ,\n            'custom_specifications' : row.coil_item_specification ,\n            'custom_company' : doc.company ,\n        }).insert(ignore_permissions=True)\n    row.coil_item_code_rm_link = row.coil_item_code_rm\n        \n\n\n\n\n    ##########################################  Creating Parent Finsih Good  ########################################################################     \n    # if not frappe.db.exists('Item Group', {'item_group_name': row.spl_item_fg_item_group}) :\n    #     frappe.get_doc({\n    #         'doctype': 'Item Group' ,\n    #         'item_group_name': row.spl_item_fg_item_group ,\n    #         'custom_abbreviation' : row.spl_item_fg_item_group ,\n    #     }).insert(ignore_permissions=True)\n    # row.spl_item_fg_item_group_link = row.spl_item_fg_item_group\n    \n    # if not frappe.db.exists('Brand', {'brand': row.spl_item_fg_brand}) :\n    #     frappe.get_doc({\n    #         'doctype': 'Brand' ,\n    #         'brand': row.spl_item_fg_brand ,\n    #     }).insert(ignore_permissions=True)\n    # row.spl_item_fg_brand_link = row.spl_item_fg_brand\n    \n    \n    # if not frappe.db.exists('UOM', {'uom_name': row.spl_item_fg_uom}) :\n    #     frappe.get_doc({\n    #         'doctype': 'UOM' ,\n    #         'uom_name': row.spl_item_fg_uom ,\n    #     }).insert(ignore_permissions=True)\n    # row.spl_item_fg_uom_link = row.spl_item_fg_uom\n    \n    \n    # if not frappe.db.exists('Item', {'item_code': row.spl_item_fg_code}) :\n    #     frappe.get_doc({\n    #         'doctype': 'Item',\n    #         'uom' : row.spl_item_fg_uom ,\n    #         'item_code' : row.spl_item_fg_code ,\n    #         'item_name' : row.spl_item_fg_name ,\n    #         'item_group': row.spl_item_fg_item_group,\n    #         'stock_uom': row.spl_item_fg_uom ,\n    #         'is_stock_item' : 0 ,\n    #         'brand' : row.spl_item_fg_brand ,\n    #         'custom_specifications' : row.spl_item_fg_specification\n    #     }).insert(ignore_permissions=True)\n    # row.spl_item_fg_code_link = row.spl_item_fg_code\n\n\n\n    \n    ##########################################  Creating Child Finsih Good  ########################################################################\n    if not frappe.db.exists('Item Group', {'item_group_name': row.fl_item_group}) :\n        frappe.get_doc({\n            'doctype': 'Item Group' ,\n            'item_group_name': row.fl_item_group ,\n            'custom_abbreviation' : row.fl_item_group ,\n        }).insert(ignore_permissions=True)\n    row.fl_item_group_link = row.fl_item_group\n    \n    \n    if not frappe.db.exists('Brand', {'brand': row.fl_item_brand}) :\n        frappe.get_doc({\n            'doctype': 'Brand' ,\n            'brand': row.fl_item_brand ,\n        }).insert(ignore_permissions=True)\n    row.fl_item_brand_link = row.fl_item_brand\n    \n    \n    if not frappe.db.exists('UOM', {'uom_name': row.fl_item_uom}) :\n        frappe.get_doc({\n            'doctype': 'UOM' ,\n            'uom_name': row.fl_item_uom ,\n        }).insert(ignore_permissions=True)\n    row.fl_item_uom_link = row.fl_item_uom\n    \n    \n    if not frappe.db.exists('Item', {'item_code': row.fg_batch_sr}) :\n        frappe.get_doc({\n            'doctype': 'Item',\n            'uom' : row.fl_item_uom ,\n            'item_code' : row.fg_batch_sr ,\n            'item_group': row.fl_item_group,\n            'stock_uom': row.fl_item_uom ,\n            'is_stock_item' : 1 ,\n            'brand' : row.fl_item_brand ,\n            'custom_specifications' : row.fl_item_specification ,\n            'custom_company' : doc.company\n        }).insert(ignore_permissions=True)\n    row.fl_item_link = row.fg_batch_sr\n    \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n############# FARIZ SCRIPT ##############\n\n\n# for item in doc.fabrication_table:\n    \n#     if not frappe.db.exists('Item', {'item_code': item.item_name}):\n        \n    \n#         if item.item_group and not frappe.db.exists('Item Group', {'item_group_name': item.item_group}):\n#             frappe.get_doc({\n#                 'doctype': 'Item Group',\n#                 'item_group_name': item.item_group,\n#             }).insert(ignore_permissions=True)\n        \n    \n#         if item.uom and not frappe.db.exists('UOM', {'uom_name': item.uom}):\n#             frappe.get_doc({\n#                 'doctype': 'UOM',\n#                 'uom_name': item.uom,\n#             }).insert(ignore_permissions=True)\n        \n    \n#         item_name_parts = [item.item_group, item.item_name]\n        \n#         if item.custom_gaugethickess or item.custom_s1 or item.custom_s2 or item.custom_s3 or item.custom_s4:\n    \n#             dimensions = []\n#             if item.custom_gaugethickess:\n#                 dimensions.append(f\"{item.custom_gaugethickess} mm\")\n#             if item.custom_s1:\n#                 dimensions.append(f\"X{item.custom_s1:.2f}\")\n#             if item.custom_s2:\n#                 dimensions.append(f\"X{item.custom_s2:.2f}\")\n#             if item.custom_s3:\n#                 dimensions.append(f\"X{item.custom_s3:.2f}\")\n#             if item.custom_s4:\n#                 dimensions.append(f\"X{item.custom_s4:.2f}\")\n            \n#             item_name_parts.append(\" \".join(dimensions))\n        \n#         item_name = \" \".join(item_name_parts)\n\n#         new_item = frappe.get_doc({\n#             'doctype': 'Item',\n#             'uom' : item.uom,\n#             'item_code': item.item_name,\n#             'description': item.description,\n#             'item_group': item.item_group,\n#             'stock_uom': item.uom\n#         })\n#         if item.custom_s1 == 0 and item.custom_s2 == 0 and item.custom_s3 == 0 and item.custom_s4 == 0 :\n#             new_item.item_name = item.item_name\n#         else:\n#             new_item.item_name = item_name\n#             new_item.custom_s1 = item.custom_s1\n#             new_item.custom_s2 = item.custom_s2\n#             new_item.custom_s3 = item.custom_s3 \n#             new_item.custom_s4 = item.custom_s4 \n#         new_item.insert(ignore_permissions=True)\n#         item.item = new_item.name\n#         item.item_names =  new_item.item_name\n#         new_item.save()\n    \n#     else:\n#         frappe.log_error(f\"Item with code {item.item_name} already exists\", 'Item Exists')\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:45:53.337613",
  "module": null,
  "name": "Restrict hod to proceed until he fill comment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Confirmation Order",
  "script": "if doc.workflow_state == \"Pending By HR User\" and  doc.comment_by_hod == None:\n  frappe.throw(\"you cannot proceed until you fill comment\")\n  \n  \n\n  \nstate = doc.workflow_state\n# frappe.msgprint(str(state))\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \n    elif state == 'Pending By CEO':\n        doc.cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    elif state == 'Approved':\n        doc.director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.cao == None:\n#     doc.cao = 'Mahmoud Elseyoufi'\n# if doc.director == None:\n#     doc.director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-24 12:49:29.520048",
  "module": null,
  "name": "Filtered Fabrication",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication Filter",
  "script": "if not doc.name:\n    # Step 1: Retrieve Fabrication List records with specified fields\n    fabrication_list = frappe.get_all('Fabrication List',\n        filters={\n            'normal': doc.date,\n            'client_ref': doc.customer,\n            'project_ref': doc.project,\n        },\n        fields=['name', 'client_ref', 'normal', 'project_ref', 'lead', 'priority', 'oppurtunity', 'fabrication_template']\n    )\n    \n    # Debugging: Print the retrieved records\n    # frappe.msgprint(f\"Retrieved Fabrication List Records: {fabrication_list}\")\n    \n    # Step 2: Prepare data for appending to the table\n    for f in fabrication_list:\n        # Prepare a dictionary with the field names and values\n        row_data = {\n            'fabrication': f.name,\n            'customer': f.client_ref,\n            'date': f.normal,\n            'project': f.project_ref,\n            'lead': f.lead,\n            'sales_inquiry': f.priority,\n            'oppurtunity': f.oppurtunity,\n            'fabrication_template': f.fabrication_template\n        }\n    \n        # Append the row data to the table field\n        doc.append('filtered_fabrication_list', row_data)\n    \n    # # Debugging: Print the updated table field data\n    # frappe.msgprint(f\"Updated filtered_fabrication_list: {doc.filtered_fabrication_list}\")\n    \n    # # Optionally, save the document if needed\n    # try:\n    #     # doc.save()\n    #     # frappe.msgprint(\"Document saved successfully with appended rows.\")\n    # except Exception as e:\n    #     frappe.msgprint(f\"Error saving document: {e}\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-25 18:54:05.575387",
  "module": null,
  "name": "Event Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Event",
  "script": "if (doc.custom_event_status != \"Scheduled\" and doc.status == \"Open\"):\n    doc.custom_event_status = \"Scheduled\"\nif (doc.custom_start_on and not doc.ends_on):\n    doc.custom_event_status = \"Started\"\nelif (doc.ends_on and doc.custom_start_on):\n    doc.custom_event_status = \"Completed\"\n    \nif (doc.workflow_state == \"Pending for Approval\"):\n    doc.custom_event_status = \"Submitted\"",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-24 11:21:33.448108",
  "module": null,
  "name": "Multi Fabrication Travel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication Filter",
  "script": "fabs = []\n\n# Collect the fabrication references\nfor fab in doc.filtered_fabrication_list:\n    f = fab.fabrication\n    fabs.append(f)\n\n# Display collected fabrication references\nfrappe.msgprint(str(fabs))\n\n# Process each fabrication reference\nfor foc in fabs:\n    # Fetch the Fabrication List document\n    fabfromarray = frappe.get_doc(\"Fabrication List\", foc)\n    frappe.msgprint(str(fabfromarray))\n    \n    # Create a new Quotation document\n    quotation = frappe.new_doc(\"Quotation\")\n    quotation.quotation_to = \"Customer\"\n    quotation.party_name = fabfromarray.client_ref\n    quotation.custom_fabrication = fabfromarray.name\n    quotation.transaction_date = fabfromarray.normal\n    quotation.custom_quotation_status = \"Under Negotiation\"\n    quotation.tc_name = \"Default Terms for All QTNS\"\n    \n    # Iterate through the fabrication_table and add items to the Quotation's item table\n    for tablesource in fabfromarray.fabrication_table:\n        # Append new rows to the Quotation's item table\n        quotation.append(\"items\", {\n            \"item_code\": tablesource.item_code,\n            \"custom_s1\": tablesource.custom_s1,\n            \"custom_s2\": tablesource.custom_s2,\n            \"custom_s3\": tablesource.custom_s3,\n            \"custom_s4\": tablesource.custom_s4,\n            \"custom_lengthangle\": tablesource.custom_lengthangle,\n            \"custom_gaugethickess\": tablesource.custom_gaugethickess,\n            \"qty\": tablesource.qty,\n            \"custom_fixing_1st_side\": tablesource.custom_fixing_1st_side,\n            \"custom_stiffener_total_qty\": tablesource.custom_stiffener_total_qty,\n            \"custom_fixing_2nd_side\": tablesource.custom_fixing_2nd_side,\n            \"custom_vanes_nos\": tablesource.custom_vanes_nos,\n            \"custom_stiffener\": tablesource.custom_stiffener,\n            \"custom_joint\": tablesource.custom_joint\n        })\n    quotation.insert()\n    quotation.save()\n    \n    # Optionally, you can save the quotation here or perform additional operations\n    # quotation.save()  # Uncomment this line if you want to save the Quotation document\n    # frappe.msgprint(f\"Quotation {quotation.name} created.\")\n\n# Optionally, you can display a message or perform additional actions\nfrappe.msgprint(\"Quotations created from fabrication data.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-27 17:24:10.167011",
  "module": null,
  "name": "Setting Asset Table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Onboarding",
  "script": "\n\n\n# job_offer_list = frappe.get_list(\"Job Offer\",\n#                     filters={\n#                       'job_applicant' : doc.job_applicant ,\n#                       'docstatus' : 1 ,\n#                     })\n                    \n                    \n# if job_offer_list :\n\njob_offer_doc = frappe.get_doc(\"Job Offer\",doc.job_offer)\n\nfor asset in job_offer_doc.custom_asset_table:\n\n    new_row = doc.append(\"custom_asset\", {})\n\n    new_row.asset_name = asset.asset_name\n    new_row.user = asset.user\n    new_row.description = asset.description\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-27 18:07:48.394924",
  "module": null,
  "name": "Set Asset on Separation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Separation",
  "script": "\n\nemp_onb_doc = frappe.get_doc(\"Employee Onboarding\", doc.custom_employee_onboarding)\n\nfor asset in emp_onb_doc.custom_asset :\n\n    new_row = doc.append(\"custom_asset\", {})\n\n    new_row.asset_name = asset.asset_name\n    new_row.user = asset.user\n    new_row.description = asset.description\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-02 15:17:52.079179",
  "module": null,
  "name": "Quoting Fabrications",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "\nfor fab in doc.custom_multi_fabrication_to_quotation:\n    doc1 = frappe.get_doc(\"Fabrication List\" , fab.fabrication )\n    # frappe.msgprint(str(doc1.name))\n    doc1.quoted = 1\n    frappe.db.set_value(doc1.doctype, doc1.name, 'quoted', 1)\n    # doc1.save()\n    # frappe.db.commit()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-02 10:45:42.182149",
  "module": null,
  "name": "Set Other Allowance In Employee Doctype",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Promotion",
  "script": "if doc.custom_increment_applied_on == \"Other Allowance\":\n    if not doc.custom_incremented_amount or not doc.current_ctc:\n        frappe.throw(\"Please enter both Current CTC and Incremented Amount.\")\n\n    \ndoc.revised_ctc = float(doc.current_ctc) + float(doc.custom_incremented_amount)\n\n    # Update Employee's allowance\nemp = frappe.get_doc(\"Employee\", doc.employee)\nif doc.custom_incremented_amount > 0:\n    if doc.custom_increment_applied_on == \"Other Allowance\":\n        emp.custom_other_alllowance = float(emp.custom_other_alllowance or 0) + doc.custom_incremented_amount\n\n    elif doc.custom_increment_applied_on == \"Basic\":\n        emp.custom_basic_salary = float(emp.custom_basic_salary or 0) + doc.custom_incremented_amount\n\n\nemp.save()\n\n\n    # Check if increment was already applied\n    # if emp.custom_increment_applied_on == \"Other Allowance\":\n    #     frappe.throw(\"Increment has already been applied to Other Allowance for this employee\")\n\n    # # Calculate new values (with proper null checks)\n    # current_allowance = flt(emp.custom_other_allowance) if emp.custom_other_allowance else 0\n    # new_allowance = current_allowance + flt(doc.incremented_amount)\n    \n    # current_total = flt(emp.custom_total_salary) if emp.custom_total_salary else flt(emp.custom_basic_salary or 0) + current_allowance\n    # new_total = current_total + flt(doc.incremented_amount)\n\n    # # Update all fields\n    # emp.update({\n    #     \"custom_other_allowance\": new_allowance,\n    #     \"custom_total_salary\": new_total,\n    #     \"custom_increment_applied_on\": \"Other Allowance\"\n    # })\n    \n    # # Save with proper error handling\n    # try:\n    #     emp.save()\n    #     frappe.db.commit()  # Explicit commit\n    #     frappe.msgprint(f\"\"\"\n    #         Successfully updated:\n    #         - Other Allowance: AED {new_allowance}\n    #         - Total Salary: AED {new_total}\n    #         for {doc.employee}\n    #     \"\"\")\n    # except Exception as e:\n    #     frappe.db.rollback()\n    #     frappe.throw(f\"Failed to update: {str(e)}\")\n# Should be 'Currency' or 'Float'\n    \n    # Print all field names\n    # curr_date = frappe.utils.nowdate()\n    # curr_date_arr = curr_date.split(\"-\")\n    \n    # curr_year = curr_date_arr[0]\n    \n    # first_day_of_year = frappe.utils.formatdate(f\"{curr_year}-01-01\", \"yyyy-MM-dd\")\n    # last_day_of_year = frappe.utils.formatdate(f\"{curr_year}-12-31\", \"yyyy-MM-dd\")\n    \n\n    # new_item = frappe.get_doc({\n    #     'doctype': 'Additional Salary',\n    #     'employee': doc.employee,\n    #     'salary_component': 'Other Allowance',\n    #     'amount': doc.revised_ctc,\n    #     'currency': doc.salary_currency,\n    #     'company': doc.company,\n    #     'is_recurring': 1,\n    #     'from_date': first_day_of_year,\n    #     'to_date': last_day_of_year,\n    # })\n    # new_item.insert()\n    # new_item.save()\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-01 17:08:15.856801",
  "module": null,
  "name": "Set Other Allowance on Cancelling Employee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Promotion",
  "script": "\n\nemp_pr_list = frappe.get_list(\"Employee Promotion\",\n                    filters={\n                        'employee' : doc.employee ,\n                        'docstatus' : 1 ,\n                        'name' : ['!=',doc.name] ,\n                    },\n                    order_by='promotion_date desc', )\n                    \n\nif emp_pr_list :\n    emp_pr_doc = frappe.get_doc(\"Employee Promotion\",emp_pr_list[0].name)\n    emp_doc = frappe.get_doc(\"Employee\",doc.employee)\n    emp_doc.custom_other_alllowance = emp_pr_doc.revised_ctc\n    emp_doc.save()\n    \n    \nelse :\n    emp_doc = frappe.get_doc(\"Employee\",doc.employee)\n    emp_doc.custom_other_alllowance = doc.current_ctc\n    emp_doc.save()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-03-06 10:50:15.312315",
  "module": null,
  "name": "Set Other Allowance From Employee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Additional Salary",
  "script": "    \n#                                   # Umair's script\n\n# employee = doc.employee\n# payroll_date = doc.payroll_date\n# # frappe.msgprint(str(doc.payroll_date))\n# filters = {\n#     'employee': employee,\n#     'start_date': ['<=', payroll_date]\n# }\n\n\n\n# shift_assignment_record = frappe.db.get_list(\n#     'Shift Assignment',\n#     filters=filters,\n#     order_by='start_date desc',\n#     limit=1\n# )\n\n# # if shift_assignment_record:\n# #     shift_names = [record['name'] for record in shift_assignment_record]\n    \n# #     for shift in shift_assignment_record:\n# #         end_date = shift.get('end_date')  \n        \n# #         if end_date:  \n            \n# #             if end_date >= payroll_date:\n                \n# #                 filters['end_date'] = ['>=', payroll_date]\n# #         else:\n# #             pass\n\n\n\n# # frappe.msgprint(str(shift_assignment_record))\n# if shift_assignment_record:\n#     shift_assignment_name = shift_assignment_record[0].name\n#     # frappe.msgprint(str(shift_assignment_name))\n#     shift_type_field_in_shift_assignment = frappe.db.get_value(\"Shift Assignment\",shift_assignment_name,'shift_type')\n#     required_hours_in_shift_type = frappe.db.get_value('Shift Type',shift_type_field_in_shift_assignment,'required_hours')\n#     if required_hours_in_shift_type:\n#         doc.custom_per_day_working_hours = required_hours_in_shift_type\n#     else:\n#         frappe.msgprint('required hours in shift type is empty!')\n# else:\n#     default_shift = frappe.db.get_value(\"Employee\",employee,'default_shift')\n#     if default_shift:\n#         required_hours = frappe.db.get_value('Shift Type', default_shift, 'required_hours')\n#         if required_hours:\n#             doc.custom_per_day_working_hours = required_hours\n#         else:\n#             frappe.msgprint(\"Employee don't have shift assignment and their default shift also don't have required hours\")\n#         # doc.custom_per_day_working_hours = default_shift\n#         # frappe.msgprint('not done')\n#     else:\n#         frappe.msgprint(\"Employee don't have shift assignment and their default shift is also empty!\")\n\n  \n    \n    \n     \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n                              # Sufyan's script\n\nif doc.salary_component == 'Other Allowance' and doc.custom_overtime_calculation != 1:\n    other_allowance = frappe.db.get_value(\"Employee\", doc.employee, 'custom_other_alllowance')\n    doc.amount = other_allowance\n\nif doc.salary_component == 'Basic' and doc.custom_overtime_calculation != 1:\n    basic = frappe.db.get_value(\"Employee\", doc.employee, 'custom_basic_salary')\n    doc.amount = basic\n\nif doc.salary_component == 'House Rent Allowance' and doc.custom_overtime_calculation != 1:\n    house_rent_allowance = frappe.db.get_value(\"Employee\", doc.employee, 'custom_house_rent_allowance')\n    doc.amount = house_rent_allowance\n\nif doc.salary_component == 'Transport Allowance' and doc.custom_overtime_calculation != 1:\n    transport_allowance = frappe.db.get_value(\"Employee\", doc.employee, 'custom_transportation_allowance')\n    doc.amount = transport_allowance\n\nif doc.salary_component == 'Bonus' and doc.custom_overtime_calculation != 1:\n    bonus = frappe.db.get_value(\"Employee\", doc.employee, 'custom_bonus')\n    doc.amount = bonus\n\nif doc.salary_component == 'Accommodation Allowance' and doc.custom_overtime_calculation != 1:\n    accommodation = frappe.db.get_value(\"Employee\", doc.employee, 'custom_accommodation_allowance')\n    doc.amount = accommodation\n\nif doc.custom_overtime_calculation == 1 :\n    per_hr_amount = doc.custom_basic / (doc.custom_total_monthly_days * doc.custom_per_day_working_hours )\n    if not doc.custom_overtime_hours :\n        doc.custom_overtime_hours = 0\n    ot_amount = per_hr_amount * doc.custom_overtime_hours\n    \n    doc.custom_overtime_amount = ot_amount\n    doc.amount = ot_amount\n    \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-02 15:51:48.917500",
  "module": null,
  "name": "Remove Quoted From Fabrication List On Cancelling Quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "\nif doc.custom_multi_fabrication_to_quotation :\n\n    for fab in doc.custom_multi_fabrication_to_quotation:\n     \n        doc1 = frappe.get_doc(\"Fabrication List\" , fab.fabrication )\n        # frappe.msgprint(str(doc1.name))\n        doc1.quoted = 0\n        frappe.db.set_value(doc1.doctype, doc1.name, 'quoted', 0)\n        # doc1.save()\n        # frappe.db.commit()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-03 15:12:22.709261",
  "module": null,
  "name": "Updating Fabrication Table in Quotation Doctype",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "\n\nso = ''\n\n\n\nfor row in doc.items :\n    if row.against_sales_order :\n        so = row.against_sales_order\n        break\n        \nif so :\n    so_doc = frappe.get_doc('Sales Order',so)\n    \n    if so_doc.custom_ref_quotation :\n        \n        q_doc = frappe.get_doc(\"Quotation\", so_doc.custom_ref_quotation)    \n        \n        if q_doc.custom_fabrication_template :\n            \n            for row in q_doc.custom_fabrication_template :\n                frm = row.from_range\n                to = row.to_range\n                d_q = row.delivered_qty\n                \n                for x in doc.items :\n                    itm_doc = frappe.get_doc(\"Item\" , x.item_code)\n                    rang = max(itm_doc.custom_s1, itm_doc.custom_s2, itm_doc.custom_s3, itm_doc.custom_s4)\n                    \n                    if rang > 0 :\n                        \n                        if frm <= rang <= to :\n                            d_q = d_q + x.qty\n                        \n                \n                frappe.db.set_value(row.doctype , row.name , \"delivered_qty\" , d_q)            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-03 15:14:30.912497",
  "module": null,
  "name": "Updating Fabrication Table On Cancel Event",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "\n\n\n\n\n\nso = ''\n\n\n\nfor row in doc.items :\n    if row.against_sales_order :\n        so = row.against_sales_order\n        break\n        \nif so :\n    so_doc = frappe.get_doc('Sales Order',so)\n    \n    if so_doc.custom_ref_quotation :\n        \n        q_doc = frappe.get_doc(\"Quotation\", so_doc.custom_ref_quotation)    \n        \n        if q_doc.custom_fabrication_template :\n            \n            for row in q_doc.custom_fabrication_template :\n                frm = row.from_range\n                to = row.to_range\n                d_q = row.delivered_qty\n                \n                for x in doc.items :\n                    itm_doc = frappe.get_doc(\"Item\" , x.item_code)\n                    rang = max(itm_doc.custom_s1, itm_doc.custom_s2, itm_doc.custom_s3, itm_doc.custom_s4)\n                    \n                    if rang > 0 :\n                        \n                        if frm <= rang <= to :\n                            d_q = d_q - x.qty\n                        \n                \n                frappe.db.set_value(row.doctype , row.name , \"delivered_qty\" , d_q)            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-03 16:36:46.829793",
  "module": null,
  "name": "Quotation Fabrication calculate amount field",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "for row in doc.custom_fabrication_template:\n    row.amount = row.rate * row.quantity",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-15 18:09:45.192004",
  "module": null,
  "name": "Deduction Message",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "a = doc.gross_pay\nb = doc.total_deduction\ntwentyPercentOfA = a * 0.20\nif b > twentyPercentOfA and doc.company == \"SASCO Industries\":\n    frappe.throw(\"Deduction is more then 20% of Gross Salary\")\n# else: \n#     frappe.throw(\"Deduction is NOT more then 20% of Gross Salary\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-15 11:32:39.718763",
  "module": null,
  "name": "Salary Register",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "WPS Report",
  "script": "# Initialize total salary variable\ntotal_salary = 0\n\n# Set up filters including custom_sponsorship\nfilters = {\n    'start_date': ['>=', doc.from_date],\n    'end_date': ['<=', doc.to_date]\n}\n\n# Add optional filters only if they are provided\nif doc.employee:\n    filters['employee'] = doc.employee\nif doc.company:\n    filters['company'] = doc.company\nif doc.currency:\n    filters['currency'] = doc.currency\nif doc.sponsorship:  # Adding filter for custom_sponsorship\n    filters['custom_sponsorship'] = doc.sponsorship\n\n# Fetch Salary Slips based on the filters\nsalary_slips = frappe.get_all('Salary Slip', filters=filters)\n\n# Clear existing rows in the Salary Register Table\ndoc.salary_register_table = []\n\n# Loop through salary slips and populate child table\nfor slip in salary_slips:\n    salary_slip = frappe.get_doc('Salary Slip', slip.name)\n    employee = frappe.get_doc('Employee', salary_slip.employee)\n    \n    # Add a new row to the child table\n    row = doc.append('salary_register_table', {})\n\n    # Set values for each column\n    row.salary_slip_id = salary_slip.name\n    if salary_slip.name:\n        row.fixed_salary = frappe.db.get_value(\"Salary Slip\", salary_slip.name, 'net_pay')\n    row.employee_id = employee.name\n    row.employee_name = employee.first_name\n    row.custom_sponsorship = employee.custom_sponsorship  # Fetch sponsorship field\n    row.date_of_joining = employee.date_of_joining\n    row.branch = employee.branch\n    row.department = employee.department\n    row.designation = employee.designation\n    row.company = employee.company\n    row.start_date = salary_slip.start_date\n    row.end_date = salary_slip.end_date\n    row.leave_without_pay = salary_slip.leave_without_pay\n    row.payment_days = salary_slip.payment_days\n    \n    # Set additional fields from Employee document\n    row.bank_name = employee.bank_name\n    row.employee_mol = employee.custom_employee_mol\n    row.routing_code = employee.custom_routing_code\n    row.employee_account_number = employee.bank_ac_no\n\n    # Fetch Earnings from Salary Slip\n    for earning in salary_slip.earnings:\n        if earning.salary_component == \"Accommodation Allowance\":\n            row.accommodation_allowance = earning.amount\n        elif earning.salary_component == \"Basic\":\n            row.basic = earning.amount\n        elif earning.salary_component == \"Incentive OT\":\n            row.incentive_ot = earning.amount\n        elif earning.salary_component == \"Normal OT\":\n            row.normal_ot = earning.amount\n        elif earning.salary_component == \"Other Allowance\":\n            row.other_allowance = earning.amount\n        elif earning.salary_component == \"Transport Allowance\":\n            row.transportation_allowance = earning.amount\n\n    # Fetch Deductions from Salary Slip\n    for deduction in salary_slip.deductions:\n        if deduction.salary_component == \"Absent ( With Permission )\":\n            row.absent_with_permission = deduction.amount\n        elif deduction.salary_component == \"Absent ( Without Permission )\":\n            row.absent_without_permission = deduction.amount\n        elif deduction.salary_component == \"Bank Charges\":\n            row.bank_charges = deduction.amount\n        elif deduction.salary_component == \"Traffic Fine\":\n            row.traffic_fine = deduction.amount\n\n    # Fetch Loans from Salary Slip\n    total_loan_payment = sum(loan.total_payment for loan in salary_slip.loans)\n    row.total_loan_payment = total_loan_payment\n\n    # Set additional Salary Slip fields\n    row.gross_pay = salary_slip.gross_pay\n    row.total_deduction = salary_slip.total_deduction\n    row.net_pay = salary_slip.net_pay\n    \n    # Calculate total salary of the employee\n    row.total_salary_of_employee = (\n        row.fixed_salary +\n        (row.variable_pay_hra_amount or 0) +\n        (row.variable_pay_mda_amount or 0) +\n        (row.variable_pay_oa_amount or 0) +\n        (row.variable_pay_ota_amount or 0) +\n        (row.variable_pay_cna_amount or 0) +\n        (row.variable_pay_le_amount or 0) +\n        (row.variable_pay_apa_amount or 0)\n    )\n\n    # Calculate the total salary by summing all specified fields\n    total_salary = total_salary + row.total_salary_of_employee\n\n# Set the calculated total salary to the main doc field\ndoc.total_salary_of_the_file = total_salary\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "Hourly",
  "modified": "2024-09-25 18:21:29.859462",
  "module": null,
  "name": "Submitting Event After One Day",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "\n\ncur = frappe.utils.get_datetime(frappe.utils.now())\n\nevent_list = frappe.get_list(\"Event\",\n                filters={\n                    'status' : 'Open' ,\n                    'workflow_state': 'Draft'    \n                })\n\nif event_list:\n    for event in event_list:\n        event_doc = frappe.get_doc(\"Event\", event.name)\n        start = frappe.utils.get_datetime(event_doc.starts_on)\n        \n        time_diff = frappe.utils.time_diff_in_seconds(cur, start)\n        \n        # (24 * 3600 = 86400 seconds)\n        if time_diff >= 86400 :\n            frappe.db.set_value('Event',event_doc.name,'status','Closed')    \n            frappe.db.set_value('Event',event_doc.name,'workflow_state','Pending for Approval')\n            frappe.db.set_value('Event',event_doc.name,'custom_event_status','Missed')\n        \n\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-22 16:08:22.826600",
  "module": null,
  "name": "Calculating overtime hours",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "if doc.shift:\n    she = frappe.get_doc(\"Shift Type\",doc.shift)\n\n\ndoc.custom_overtime_hours = doc.working_hours - she.required_hours ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-02 17:05:23.152977",
  "module": null,
  "name": "Calculating the difference b/w start km and end km",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Logistics Buses",
  "script": "# Initialize totals\r\ntotal_distance_covered = 0\r\ntotal_fuel_consumption = 0\r\ntotal_fuel_qty = 0\r\n\r\n# Check if logistics_table exists\r\nif doc.logistics_table:\r\n    for row in doc.logistics_table:\r\n        # Calculate distance covered\r\n        row.distance_covered = row.end_km - row.start_km\r\n        \r\n        # Ensure distance_covered is valid before processing\r\n        if row.distance_covered is not None:\r\n            total_distance_covered = total_distance_covered + row.distance_covered\r\n            \r\n            # Ensure row.float_value is converted to float if it's a string\r\n            if row.float_value is not None:\r\n                row.float_value = float(row.float_value)  # Convert to float\r\n\r\n                # Calculate fuel consumption\r\n                row.fuel_consumption = row.distance_covered * row.float_value\r\n            else:\r\n                row.fuel_consumption = 0\r\n\r\n            # Ensure fuel_rate_per_litre is also converted to float\r\n            row.fuel_rate_per_litre = float(row.fuel_rate_per_litre) if row.fuel_rate_per_litre else 0\r\n            \r\n            # Calculate fuel consumption amount\r\n            row.fuel_consumption_amount = row.fuel_consumption * row.fuel_rate_per_litre\r\n            total_fuel_qty = total_fuel_qty + row.fuel_consumption\r\n            \r\n            # Accumulate total fuel consumption\r\n            total_fuel_consumption = total_fuel_consumption + row.fuel_consumption_amount\r\n\r\n# Set the total values in the parent document\r\ndoc.total_fuel_consumption = total_fuel_consumption\r\ndoc.total_distance_covered = total_distance_covered\r\ndoc.total_fuel_qty = total_fuel_qty\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-26 14:14:57.106006",
  "module": null,
  "name": "Calculate the differnence b/w start km and end km in logistic car",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Logistic Car",
  "script": "for row in doc.logistics_table:\n    \n    row.distance_covered = row.end_km - row.start_km",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-30 15:38:08.807344",
  "module": null,
  "name": "Calculate the totla distance covered and fuel consumption in logistic car",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Logistic Car",
  "script": "total_distance_covered = 0\ntotal_fuel_consumption = 0\nif doc.logistics_table:\n    for row in doc.logistics_table:\n        total_distance_covered =  total_distance_covered + row.distance_covered\n        total_fuel_consumption = total_fuel_consumption + row.fuel_consumption\n    \n    \n    \n    doc.total_fuel_consumption = total_fuel_consumption * 1\n    doc.total_distance_covered = total_distance_covered * 1",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-02 17:25:48.943444",
  "module": null,
  "name": "Calculate the total distance covered and fuel consumption",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Logistic Car",
  "script": "# Initialize totals\r\ntotal_distance_covered = 0\r\ntotal_fuel_consumption = 0\r\ntotal_fuel_qty = 0\r\n\r\n# Check if logistics_table exists\r\nif doc.table_vgam:\r\n    for row in doc.table_vgam:\r\n        # Calculate distance covered\r\n       \r\n        row.distance_covered = row.end_km - row.start_km\r\n        \r\n        # Ensure distance_covered is valid before processing\r\n        if row.distance_covered is not None:\r\n            total_distance_covered = total_distance_covered + row.distance_covered\r\n            \r\n            # Ensure row.float_value is converted to float if it's a string\r\n            if row.float_value is not None:\r\n                row.float_value = float(row.float_value)  # Convert to float\r\n\r\n                # Calculate fuel consumption\r\n                row.fuel_consumption = row.distance_covered * row.float_value\r\n            else:\r\n                row.fuel_consumption = 0\r\n\r\n            # Ensure fuel_rate_per_litre is also converted to float\r\n            row.fuel_rate_per_litre = float(row.fuel_rate_per_litre) if row.fuel_rate_per_litre else 0\r\n            \r\n            # Calculate fuel consumption amount\r\n            row.fuel_consumption_amount = row.fuel_consumption * row.fuel_rate_per_litre\r\n            total_fuel_qty = total_fuel_qty + row.fuel_consumption\r\n            \r\n            # Accumulate total fuel consumption\r\n            total_fuel_consumption = total_fuel_consumption + row.fuel_consumption_amount\r\n\r\n# Set the total values in the parent document\r\ndoc.total_fuel_consumption = total_fuel_consumption\r\ndoc.total_distance_covered = total_distance_covered\r\ndoc.total_fuel_qty = total_fuel_qty\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-02 17:32:15.211776",
  "module": null,
  "name": "Fetch fuel consumption km to rate in delivery stop table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Trip",
  "script": "total_fuel_consumed = 0\r\ntotal_distance = 0\r\ntotal_fuel_amount = 0\r\nve = frappe.get_doc(\"Vehicle\", doc.vehicle)\r\n\r\n# Check odometer readings before processing delivery stops\r\nif doc.custom_end_trip_value < doc.custom_start_trip_value:\r\n    frappe.throw(\"Please check odometer readings\")\r\n\r\nfor row in doc.delivery_stops:\r\n    row.custom_rate = ve.custom_per_km_fuel_consumption\r\n    \r\n    row.custom_total_value = row.distance * row.custom_rate\r\n    row.custom_fuel_consumption = row.custom_total_value * row.custom_fuel_value\r\n    # Accumulate total fuel consumed and total distance\r\n    total_fuel_consumed = total_fuel_consumed + row.custom_total_value\r\n    total_distance = total_distance + row.distance\r\n    total_fuel_amount = total_fuel_amount + row.custom_fuel_consumption\r\n# Set total values in the document after the loop\r\ndoc.custom_total_fuel_qty_consumed = total_fuel_consumed\r\ndoc.custom_total_distance_covered_km = total_distance\r\ndoc.custom_total_fuel_consumption_amount = total_fuel_amount",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-29 10:31:27.680774",
  "module": null,
  "name": "Calculate Profit Loss",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Costing Sheet",
  "script": "\n\n\n# if doc.fabrication_list :\n    \n#     doc.accessory_item = []\n#     doc.material_summary = []\n#     doc.costing_sheet_item = []\n    \n#     fl_doc = frappe.get_doc('Fabrication List', doc.fabrication_list)\n    \n#     # doc.material_summary = fl_doc.material_summary\n    \n    \n    \n    \n#     if fl_doc.acc_item :\n        \n#         for row1 in fl_doc.material_summary :\n            \n#             doc.append('material_summary',{\n#                 'parent_finished_good' : row1.parent_finished_good ,\n#                 'material_item_code' : row1.material_item_code ,\n#                 'material_item_brand' : row1.material_item_brand ,\n#                 'material_item_uom' : row1.material_item_uom ,\n#                 'material_item_qty' : row1.material_item_qty ,\n#                 'sum_of_fl_item_qty' : row1.sum_of_fl_item_qty ,\n#                 'fl_item_gauge' : row1.fl_item_gauge ,\n#                 'sum_of_duct_weight' : row1.sum_of_duct_weight ,\n#                 'sum_of_duct_area_with_seam' : row1.sum_of_duct_area_with_seam ,\n#             })\n            \n#             doc.append('costing_sheet_item',{\n#                 'item_code' : row1.material_item_code ,\n#                 'item_name' : row1.material_item_code ,\n#                 'parent_finished_goods_item' : row1.parent_finished_good ,\n#                 'finished_goods_item' : None ,\n#                 'uom' : row1.material_item_uom ,\n#                 'quantity' : row1.material_item_qty ,\n#             })\n            \n            \n        \n        \n        \n#         for row in fl_doc.acc_item :\n            \n#             doc.append('accessory_item',{\n#                 'item_code' : row.item_code ,\n#                 'item_name' : row.item_name ,\n#                 'uom' : row.uom ,\n#                 'quantity' : row.qty ,\n#             })\n            \n\n########################################################################################################################\n\n# date_str\ntotal_amount = 0\n\nfor row in doc.costing_sheet_item:\n    row.grand_cost = (row.per_unit_cost or 0) * (row.quantity or 0)\n    total_amount = total_amount + row.grand_cost\n    itm_price_list = frappe.db.get_list('Item Price',\n                            \n                            filters={\n                                'item_code': row.item_code,\n                                'uom': row.uom,\n                                'price_list': doc.price_list,\n                                'buying': 1,\n                                'valid_from': ['<=', doc.date]\n                            },\n                            fields=['name', 'price_list_rate', 'valid_upto'],\n                            order_by='valid_from DESC',\n                            limit_page_length=1\n                     )\n\n    if itm_price_list:\n\n        if itm_price_list[0].valid_upto :\n            if str(doc.date) <= str(itm_price_list[0].valid_upto) :\n                row.per_unit_cost = itm_price_list[0].price_list_rate\n                row.grand_cost = row.per_unit_cost * row.quantity\n            \n        else :\n            row.per_unit_cost = itm_price_list[0].price_list_rate\n            row.grand_cost = row.per_unit_cost * row.quantity\n            \ndoc.total_amount = total_amount\n\n\nfor row in doc.accessory_item:\n    \n    itm_price_list = frappe.db.get_list('Item Price',\n                            \n                            filters={\n                                'item_code': row.item_code,\n                                'uom': row.uom,\n                                'price_list': doc.price_list,\n                                'buying': 1,\n                                'valid_from': ['<=', doc.date]\n                            },\n                            fields=['name', 'price_list_rate', 'valid_upto'],\n                            order_by='valid_from DESC',\n                            limit_page_length=1\n                     )\n\n    if itm_price_list:\n\n        # frappe.msgprint(str(itm_price))\n        \n        if itm_price_list[0].valid_upto :\n            if str(doc.date) <= str(itm_price_list[0].valid_upto) :\n                row.rate = itm_price_list[0].price_list_rate\n                row.amount = row.rate * row.quantity\n            \n        else :\n            row.rate = itm_price_list[0].price_list_rate\n            row.amount = row.rate * row.quantity\n\n        \n\n\n\n\n\n\n\n\n\n\n\n\n\ndoc.grand_cost_plus_margin = doc.grand_cost + doc.margin_amount\n\ndoc.profit__loss = doc.total_quotation_cost - doc.grand_cost_plus_margin\n\nif doc.order_sqm and doc.order_sqm > 0 :\n    doc.per_sqm_cost = doc.grand_cost_plus_margin / doc.order_sqm\n    \nelse :\n    doc.per_sqm_cost = 0\n    \n    \n    \n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:44:21.769932",
  "module": null,
  "name": "Calculate the total amount of salary",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Offer",
  "script": "total_amount = 0 \n\nfor row in doc.custom_salary_details:\n    if row.amount is not None:  # Check if row.amount is not None\n        total_amount = total_amount + row.amount  # Use += for simplicity\n\ndoc.custom_total_salary_amount = total_amount\n\n\n\n\n\n\n\n\n\nstate = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.custom_hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.custom_hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name) \n    elif state == 'Pending By CEO':\n        doc.custom_cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\n    elif state == 'Approved':\n        doc.custom_director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_director', full_name)\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.custom_cao == None:\n#     doc.custom_cao = 'Mahmoud Elseyoufi'\n# if doc.custom_director == None:\n#     doc.custom_director = 'Dr. Bilal Taha'\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:34:02.155549",
  "module": null,
  "name": "Fetching interviewer table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Interview Evaluation Form",
  "script": "# Initialize job_offer_doc to None\r\njob_offer_doc = None\r\n\r\n# Fetch the Interview document\r\nif doc.interview:\r\n    job_offer_doc = frappe.get_doc(\"Interview\", doc.interview)\r\n\r\n# Clear the existing rows in table_aumx\r\ndoc.table_aumx = []\r\n\r\n# Check if job_offer_doc was successfully fetched\r\nif job_offer_doc:\r\n    # Loop through the interview details and append new rows\r\n    for asset in job_offer_doc.interview_details:\r\n        new_row = doc.append(\"table_aumx\", {})\r\n        new_row.interviewer = asset.interviewer\r\n      # Adjust this field as per your DocType\r\nelse:\r\n    # Optionally handle the case where job_offer_doc is not found\r\n    frappe.msgprint(\"No interview document found.\")\r\n\r\n\r\nstate = doc.workflow_state\r\n# frappe.msgprint(str(state))\r\nuser = frappe.session.user\r\n\r\nfull_name = frappe.db.get_value('User', user, 'full_name')\r\n\r\n\r\nif full_name:\r\n    if state == 'Pending By HR User':\r\n        doc.hod = full_name  \r\n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \r\n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \r\n\r\n    elif state == 'Pending By CAO':\r\n        doc.hr_user = full_name  \r\n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \r\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\r\n    elif state == 'Pending by CEO':\r\n        doc.cao = full_name \r\n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\r\n    elif state == 'Approved':\r\n        doc.director = full_name \r\n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\r\nelse:\r\n    frappe.msgprint('User id is not defined.')",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-07 11:48:24.289796",
  "module": null,
  "name": "Deduction Absents For Local Staff",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "emp_doc = frappe.get_doc('Employee', doc.employee)\nemp_group = emp_doc.custom_employee_group\nif emp_group == 'Staff - Local':\n    doc.absent_days = 0\n    doc.payment_days = doc.total_working_days\n    \n\n\n        \n        \n        \n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "Daily Long",
  "modified": "2024-10-17 16:44:33.881267",
  "module": null,
  "name": "Absent Notification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "previous_absences = frappe.get_all('Attendance', \n                                   filters={\n                                       'employee': doc.employee,\n                                       'attendance_date': ['between', [frappe.utils.add_days(doc.attendance_date, -2), frappe.utils.add_days(doc.attendance_date, -1)]],\n                                       'status': 'Absent'\n                                   },\n                                   fields=['employee_name', 'attendance_date'])\n\n\nif doc.status == 'Absent' and len(previous_absences) == 2:\n    # Send email notification\n    subject = \"Employee Absent for 3 Consecutive Days\"\n    message = f\"Employee {doc.employee} {doc.employee_name} has been absent for more than 3 days. Please review the attendance records.\"\n  \n    \n    frappe.sendmail(\n        # recipients=['ghaith.albarmawi@sowaan.com'],\n           recipients=['hr1@sascco.com','hr6@sascco.com','hr@sascco.net','elseyoufi.cao@sascco.com'],\n        subject=subject,\n        message=message\n    )",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 10:59:36.267538",
  "module": null,
  "name": "Calculating the total amount of tables",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Petty Cash Request - Visa Expenses",
  "script": "# # Initialize amounts\n# table_total_workpermit = 0\n# table_total_visa = 0\n# table_total_in_and_out = 0\n# table_la_app = 0\n# table_loss_job_ins = 0\n# table_medical = 0\n# table_id = 0\n# table_residency = 0\n# table_chq_amount = 0\n# tot_wor_per = 0\n# tot_lc_app = 0\n# tot_visa = 0\n# tot_in_and_out = 0\n# tot_loss_job_ins = 0\n# tot_med = 0\n# tot_id = 0\n# tot_res = 0\n# tot_chq_amount = 0\nfor row in doc.table_lrmw:\n    row.chq_amount = row.work_permit_amount + row.lc_approval + row.in_and_out + row.visa + row.medical + row.loss_job_ins + row.residency + row.id\n    # table_total_workpermit = table_total_workpermit + row.work_permit_amount if row.work_permit_amount is not None else 0  # Use 0 if row.amount is None\n    # table_total_visa = table_total_visa + row.visa if row.visa is not None else 0 \n    # table_total_in_and_out = table_total_in_and_out + row.in_and_out if row.in_and_out is not None else 0\n    # table_la_app = table_la_app + row.lc_approval if row.lc_approval is not None else 0\n    # table_loss_job_ins = table_loss_job_ins + row.loss_job_ins if row.loss_job_ins is not None else 0\n    # table_medical = table_medical + row.medical if row.medical is not None else 0\n    # table_id = table_id + row.id if row.id is not None else 0\n    # table_residency = table_residency + row.residency if row.residency is not None else 0\n    # table_chq_amount = table_chq_amount + row.chq_amount if row.chq_amount is not None else 0\nfor n in doc.petty_cash_job_offer:   \n    n.chq_amount = n.work_permit + n.lc_approval + n.visa + n.in_and_out + n.loss_job_ins + n.medical + n.id + n.residency\n    # tot_wor_per = tot_wor_per + n.work_permit if n.work_permit is not None else 0  # Use 0 if n.amount is None\n    # tot_lc_app = tot_lc_app + n.lc_approval if n.lc_approval is not None else 0\n    # tot_visa = tot_visa + n.visa if n.visa is not None else 0\n    # tot_in_and_out = tot_in_and_out + n.in_and_out if n.in_and_out is not None else 0\n    # tot_loss_job_ins = tot_loss_job_ins + n.loss_job_ins if n.loss_job_ins is not None else 0\n    # tot_med = tot_med + n.medical if n.medical is not None else 0\n    # tot_id = tot_id + n.id if n.id is not None else 0\n    # tot_res = tot_res + n.residency if n.id is not None else 0\n    # tot_chq_amount = tot_chq_amount + n.chq_amount if n.chq_amount is not None else 0\n# Ensure doc.sub_total and doc.subtotal are initialized\n# doc.total_work_permit = table_total_workpermit   \n# doc.total_lc_approval = table_la_app \n# doc.total_visa = table_total_visa\n# doc.total_in_and_out = table_total_in_and_out\n# doc.total_loss_job_ins = table_loss_job_ins\n# doc.total_medical = table_medical\n# doc.total_id = table_id \n# doc.total_residency = table_residency\n# doc.total_chq_amount = table_chq_amount\n# doc.total_work_permit_job_offer = tot_wor_per\n# doc.total_lc_approval_job_offer = tot_lc_app\n# doc.total_in_and_out_job_offer = tot_in_and_out\n# doc.total_loss_job_ins_job_offer = tot_loss_job_ins\n# doc.total_medical_job_offer = tot_med\n# doc.total_id_offer = tot_id\n# doc.total_residency_job_offer = tot_res\n# doc.total_chq_a_mount_job_offer = tot_chq_amount\n# doc.total_visa_job_offer = tot_visa\n# # Calculate grand total\n# doc.grandtotal = (\n#     (doc.total_work_permit or 0) + \n#     (doc.total_lc_approval or 0) + \n#     (doc.total_visa or 0) + \n#     (doc.total_in_and_out or 0) + \n#     (doc.total_loss_job_ins or 0) + \n#     (doc.total_medical or 0) + \n#     (doc.total_id or 0) + \n#     (doc.total_residency or 0) + \n#     (doc.total_chq_amount or 0) + \n#     (doc.total_work_permit_job_offer or 0) + \n#     (doc.total_lc_approval_job_offer or 0) + \n#     (doc.total_in_and_out_job_offer or 0) + \n#     (doc.total_loss_job_ins_job_offer or 0) + \n#     (doc.total_medical_job_offer or 0) + \n#     (doc.total_id_offer or 0) + \n#     (doc.total_residency_job_offer or 0) + \n#     (doc.total_chq_a_mount_job_offer or 0) + \n#     (doc.total_visa_job_offer or 0)\n# )\n# frappe.msgprint(str(doc.workflow_state))\nstate = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\nif state == 'Pending by CEO':\n    # frappe.msgprint(str(doc.workflow_state))    \n    # frappe.msgprint('hy')    \n    doc.cao = full_name \n    frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    # frappe.msgprint(str(doc.cao))  \nelif state == 'Approved':\n    doc.ceo = full_name \n    frappe.db.set_value(doc.doctype, doc.name, 'ceo', full_name)\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-17 09:46:22.422884",
  "module": null,
  "name": "Calculate the Notice Period Days From Notice Period Month",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Job Offer",
  "script": "if doc.custom_notice_period_for_staff:\n        # Use conditional logic to set the days based on selected period\n        if doc.custom_notice_period_for_staff == \"1 month\":\n            doc.custom_notice_period_days = 30\n        elif doc.custom_notice_period_for_staff == \"2 months\":\n            doc.custom_notice_period_days = 60\n        elif doc.custom_notice_period_for_staff == \"3 months\":\n            doc.custom_notice_period_days = 90\n        else:\n            doc.custom_notice_period_days = 0",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2024-10-18 18:07:04.667766",
  "module": null,
  "name": "Freeze Customer based on CR Expiry Date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Customer",
  "script": "customer = frappe.get_all(\"Customer\", fields=[\"name\", \"custom_cr_expiry\"])\n\nfor cus in customer:\n    if str(cus.custom_cr_expiry) <= str(frappe.utils.today()):\n        frappe.db.set_value(\"Customer\", cus.name, \"is_frozen\", 1)\n        frappe.db.set_value(\"Customer\", cus.name, \"disabled\", 1)",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:41:57.730930",
  "module": null,
  "name": "Get name for approvals and restrict hr to comment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Application",
  "script": "if doc.workflow_state == \"Pending By HR User\" and  doc.custom_comment == None:\n  frappe.throw(\"you cannot proceed until you fill comment\")\n  \n  \n  \n  \n  \nstate = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.custom_hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hod', full_name)  \n    elif state == 'Pending By CAO':\n        doc.custom_hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name)  \n    elif state == 'Pending By CEO':\n        doc.custom_cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\n    elif state == 'Approved':\n        doc.custom_director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_director', full_name)\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.custom_cao == None:\n#     doc.custom_cao = 'Mahmoud Elseyoufi'\n# if doc.custom_director == None:\n#     doc.custom_director = 'Dr. Bilal Taha'\n        # frappe.db.set_value(doc.doctype, doc.name, 'custom_director', Dr. Bilal Taha)\n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:38:21.843620",
  "module": "HR",
  "name": "Get Approval Names",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fuel Form",
  "script": "state = doc.workflow_state\n# frappe.msgprint(str(state))\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    elif state == 'Pending By CEO':\n        doc.cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    elif state == 'Approved':\n        doc.director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.cao == None:\n#     doc.cao = 'Mahmoud Elseyoufi'\n# if doc.director == None:\n#     doc.director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:41:07.119617",
  "module": "HR",
  "name": "Get Approval Names for print format",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Clearance Form",
  "script": "state = doc.workflow_state\n# frappe.msgprint(str(state))\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    elif state == 'Pending By CEO':\n        doc.cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    elif state == 'Approved':\n        doc.director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.cao == None:\n#     doc.cao = 'Mahmoud Elseyoufi'\n# if doc.director == None:\n#     doc.director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:41:20.052467",
  "module": "HR",
  "name": "Get Names of approvals for pf",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sim Card",
  "script": "state = doc.workflow_state\n# frappe.msgprint(str(state))\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \n    elif state == 'Pending By CEO':\n        doc.cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    elif state == 'Approved':\n        doc.director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.cao == None:\n#     doc.cao = 'Mahmoud Elseyoufi'\n# if doc.director == None:\n#     doc.director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:41:28.672424",
  "module": null,
  "name": "Get Approvals Name",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Promotion",
  "script": "state = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.custom_hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.custom_hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name)  \n    elif state == 'Pending By CEO':\n        doc.custom_cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\n    elif state == 'Approved':\n        doc.custom_director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_director', full_name)\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.custom_cao == None:\n#     doc.custom_cao = 'Mahmoud Elseyoufi'\n# if doc.custom_director == None:\n#     doc.custom_director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:41:36.450425",
  "module": "HR",
  "name": "Get approval names in loan application",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Loan Application",
  "script": "state = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.custom_hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.custom_hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name)  \n    elif state == 'Pending By CEO':\n        doc.custom_cao = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\n    elif state == 'Approved':\n        doc.custom_director = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_director', full_name)\n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.custom_cao == None:\n#     doc.custom_cao = 'Mahmoud Elseyoufi'\n# if doc.custom_director == None:\n#     doc.custom_director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-25 11:38:11.774601",
  "module": null,
  "name": "Get names of approval for rejoining",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Rejoining Form",
  "script": "state = doc.workflow_state\n# frappe.msgprint(str(state))\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    if state == 'Pending By HR User':\n        doc.hod = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hod', full_name)  \n        # frappe.msgprint(f\"Custom HOD set to: {full_name}\") \n\n    elif state == 'Pending By CAO':\n        doc.hr_user = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'hr_user', full_name)  \n        # frappe.msgprint(f\"Custom HRM set to: {full_name}\")\n    elif state == 'Pending By CEO':\n        doc.cao = full_name\n        frappe.db.set_value(doc.doctype, doc.name, 'cao', full_name)\n    elif state == 'Approved':\n        doc.director = full_name\n        frappe.db.set_value(doc.doctype, doc.name, 'director', full_name)\nelse:\n    frappe.msgprint('User id is not defined.')\n# if doc.cao == None:\n#     doc.cao = 'Mahmoud Elseyoufi'\n# if doc.director == None:\n#     doc.director = 'Dr. Bilal Taha'",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-27 10:14:42.707116",
  "module": null,
  "name": "Notification For Project",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Project",
  "script": "\r\n\r\ndef send_email_notifications(doc):\r\n    # Check if any status is \"Requested\"\r\n    requested_products = []\r\n    \r\n    for d in doc.custom_product_approval:\r\n        if d.sample_status == \"Requested\" or \\\r\n           d.material_submittal_status == \"Requested\" or \\\r\n           d.pre_qualification_submittal == \"Requested\":\r\n            requested_products.append({\r\n                \"product\": d.product,\r\n                \"pre_qualification_submittal\": d.pre_qualification_submittal,\r\n                \"material_submittal_status\": d.material_submittal_status,\r\n                \"sample_status\": d.sample_status\r\n            })\r\n    \r\n    if requested_products:\r\n        # Get email addresses of Estimation Manager and Sales Manager\r\n        role_filters = [\r\n            [\"role\", \"=\", \"Estimation Manager\"],\r\n            [\"role\", \"=\", \"Sales Manager\"]\r\n        ]\r\n        \r\n        managers = frappe.get_all('User',\r\n                                   filters={\"enabled\": 1},\r\n                                   or_filters=role_filters,\r\n                                   pluck='email')\r\n        \r\n        if managers:\r\n            # Prepare email content\r\n            subject = \"Action Required: Product Status Update\"\r\n            \r\n            # Create the table for requested products\r\n            table_rows = ''.join(f\"\"\"\r\n            <tr>\r\n                <td>{d['product']}</td>\r\n                <td style=\"text-align:center;\">{d['pre_qualification_submittal']}</td>\r\n                <td style=\"text-align:center;\">{d['material_submittal_status']}</td>\r\n                <td style=\"text-align:center;\">{d['sample_status']}</td>\r\n            </tr>\r\n            \"\"\" for d in requested_products)\r\n\r\n            message = f\"\"\"\r\n            <p>Dear Team,</p>\r\n            <p>Please note that the following product statuses have been set to \"Requested\":</p>\r\n            <table style=\"border-collapse: collapse; width: 100%;\">\r\n                <thead>\r\n                    <tr>\r\n                        <th style=\"border: 1px solid #ddd; padding: 8px;\">Product</th>\r\n                        <th style=\"border: 1px solid #ddd; padding: 8px;\">Pre-Qualification Submittal</th>\r\n                        <th style=\"border: 1px solid #ddd; padding: 8px;\">Material Submittal Status</th>\r\n                        <th style=\"border: 1px solid #ddd; padding: 8px;\">Sample Status</th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    {table_rows}\r\n                </tbody>\r\n            </table>\r\n            <br>\r\n            <p>Project Name: {doc.name}</p>\r\n            <p>Assigned Owner: {doc.custom_project_owner__assigned}</p>\r\n            <p>Sales Personnel: {doc.custom_sales_personnel}</p>\r\n            <p>Project Status: {doc.custom_project_status}</p>\r\n            <p>Live Status: {doc.custom_project_live_status}</p>\r\n            <p>Company: {doc.company}</p>\r\n            <p>Please take the necessary actions.</p>\r\n            <p>Best regards,<br>SowaanERP</p>\r\n            \"\"\"\r\n            \r\n            # Send email\r\n            frappe.sendmail(recipients=managers, subject=subject, message=message)\r\n\r\n# Trigger the function on project update\r\nif doc.custom_product_approval:\r\n    send_email_notifications(doc)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-22 15:39:58.411304",
  "module": null,
  "name": "Calculate Total Numbers",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Camp Contract",
  "script": "doc.total_value = doc.room_rate_per_month + doc.laundry + doc.food_rate",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-05 14:55:48.310823",
  "module": null,
  "name": "Set Encashment Account",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Encashment",
  "script": "emp_base = frappe.db.get_value('Salary Structure Assignment', {'employee_name': doc.employee_name},'base')\n# frappe.msgprint(str(emp_base))\nif emp_base:\n    doc.encashment_amount = doc.encashment_days * emp_base\nelse:\n    frappe.msgprint(f\"Base salary for employee '{doc.employee_name}' not found\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-23 10:59:33.497855",
  "module": null,
  "name": "Send Email to employees",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Training Event",
  "script": "all_emails = []\n\nfor employee in doc.employees:\n    if employee.custom_email:\n        all_emails.append(employee.custom_email)\n\nif all_emails:\n    try:\n        frappe.sendmail(\n            recipients=all_emails,\n            subject=f\"{doc.training_program} - Training Event Notification\",\n            message=f\"\"\"\n                <p>Dear Employee,</p>\n                <p>This is to notify you about the upcoming training event titled \"{doc.training_program}\".</p>\n                <p>Event Details:</p>\n                <p>Start Time: {doc.start_time}</p>\n                <p>End Time: {doc.end_time}</p>\n                <p>Location: {doc.location}</p>\n                <p>Please make sure to attend.</p>\n                <p>For any further details, feel free to contact the HR Department.</p>\n            \"\"\",\n            reference_doctype=doc.doctype,\n            reference_name=doc.name\n        )\n        frappe.msgprint(\"Emails have been sent successfully.\")\n    except Exception as e:\n        \n        frappe.msgprint(f\"Error sending emails: {str(e)}\")\n        \n       \n       \nelse:\n    frappe.msgprint(\"No employee email addresses found.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-23 10:59:02.338607",
  "module": null,
  "name": "Calculate Late Days",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Rejoining Form",
  "script": "reported_on = doc.get(\"reported_on\")\nto_date = doc.get(\"to\")\n\nif reported_on and to_date:\n        if reported_on > to_date:\n            # Calculate late days\n            late_days = (reported_on - to_date).days\n            doc.set(\"late_days\", late_days)  # Update late_days\n        else:\n            doc.set(\"late_days\", 0)  # Set late_days to 0 if not late\nelse:\n        doc.set(\"late_days\", 0)  # Reset late_days if dates are missing",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 18:07:40.395013",
  "module": null,
  "name": "fetch material request which linked only to supplier quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "if doc.material_request:\r\n    table_netp_entries = []\r\n\r\n    for x in doc.material_request:\r\n        mt_req_doc = frappe.get_doc(\"Material Request\", x.material_request)\r\n        \r\n        # Only consider submitted Material Requests\r\n        if mt_req_doc.docstatus == 1:\r\n            new_child = doc.append('table_netp', {\r\n                'material_request': mt_req_doc.name\r\n            })\r\n            \r\n            # Query Supplier Quotations directly linked to material_request\r\n            direct_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_material_request_ref\": x.material_request})\r\n            \r\n            for req in direct_supplier_quotations:\r\n                supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", req.name)\r\n                \r\n                # Only consider submitted Supplier Quotations\r\n                if supplier_quotation_doc.docstatus == 1:\r\n                    # Fetch items from the Supplier Quotation Item table\r\n                    for item in supplier_quotation_doc.items:\r\n                        item_master_doc = frappe.get_doc(\"Item\", item.item_code)\r\n                        reorder_level = item_master_doc.reorder_levels[0].warehouse_reorder_level if item_master_doc.reorder_levels else None\r\n                        last_purchase_rate = item_master_doc.last_purchase_rate\r\n\r\n                        # Append each item with additional fields\r\n                        table_netp_entries.append({\r\n                            'parent': new_child.name,\r\n                            'material_request': x.material_request,\r\n                            'supplier_quotation': req.name,\r\n                            'item_code': item.item_code,\r\n                            'uom': item.uom,\r\n                            'qty': item.qty,\r\n                            'rate': item.rate,\r\n                            'amount': item.amount,\r\n                            'brand': item.custom_brands,\r\n                            'delivery_date': item.custom_delivery_date,\r\n                            'request_for_quotation': None,  # No RFQ reference\r\n                            'quality_of_products': supplier_quotation_doc.custom_quality_of_products,\r\n                            'previous_experience': supplier_quotation_doc.custom_previous_experience,\r\n                            're_order_level': reorder_level,\r\n                            'last_purchase_rate': last_purchase_rate,\r\n                            'supplier': supplier_quotation_doc.supplier,\r\n                            'supplier_name': supplier_quotation_doc.supplier_name\r\n                        })\r\n                else:\r\n                    # Log or handle the cancelled Supplier Quotation case\r\n                    frappe.msgprint(f\"Supplier Quotation {req.name} is cancelled and will be skipped.\")\r\n\r\n    doc.set('table_netp', table_netp_entries)\r\n    \r\n    \r\n    \r\n    \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n################################# Average Consumption For Last 90 Days #################################  (Sufyan Script)\r\n\r\nif doc.table_netp:\r\n    \r\n    from_date = frappe.utils.add_days(frappe.utils.getdate(doc.date), -90)\r\n    \r\n    for x in doc.table_netp:\r\n        total_qty = 0\r\n\r\n        st_ledger_entry_list = frappe.get_all(\r\n            'Stock Ledger Entry',\r\n            filters={\r\n                'item_code': x.item_code,\r\n                'company': doc.company,\r\n                'voucher_type': ['in', ['Stock Entry', 'Delivery Note']],\r\n                'posting_date': ['>', from_date],\r\n                'posting_date': ['<=', doc.date]\r\n            },\r\n            fields=['item_code', 'voucher_type', 'voucher_no', 'actual_qty']\r\n        )\r\n        \r\n\r\n        filtered_entries = []\r\n        for entry in st_ledger_entry_list:\r\n            \r\n            if entry.voucher_type == 'Stock Entry':\r\n                se_type = frappe.db.get_value('Stock Entry', entry.voucher_no, 'stock_entry_type')\r\n                \r\n                if se_type in ['Material Issue', 'Material Consumption for Manufacture'] :\r\n                    filtered_entries.append(entry)\r\n            \r\n            elif entry.voucher_type == 'Delivery Note':\r\n                filtered_entries.append(entry)\r\n\r\n\r\n        if filtered_entries:\r\n            for entry in filtered_entries:\r\n                total_qty = total_qty + entry.actual_qty\r\n            if total_qty < 0:\r\n                total_qty = -total_qty\r\n\r\n        x.average_consumption = total_qty\r\n                \r\n################################# Average Consumption For Last 90 Days #################################  (Sufyan Script)            \r\n      \r\n      \r\n      \r\n      \r\n      \r\n      \r\n      \r\n            \r\n\r\n                \r\n              \r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-28 11:23:08.947943",
  "module": null,
  "name": "filtered items of material request",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "if doc.material_request:\n    print_table_entries = []\n\n    # Set to keep track of unique supplier quotations\n    unique_supplier_quotations = set()\n\n    for x in doc.material_request:\n        mt_req_doc = frappe.get_doc(\"Material Request\", x.material_request)\n        \n        # Only consider submitted Material Requests\n        if mt_req_doc.docstatus == 1:\n            # Retrieve Supplier Quotations directly linked to the material_request\n            direct_supplier_quotations = frappe.get_list(\"Supplier Quotation\", filters={\"custom_material_request_ref\": x.material_request})\n            \n            for req in direct_supplier_quotations:\n                supplier_quotation_id = req.name\n                \n                # Check for unique supplier quotations to avoid duplicates\n                if supplier_quotation_id not in unique_supplier_quotations:\n                    unique_supplier_quotations.add(supplier_quotation_id)\n                    \n                    supplier_quotation_doc = frappe.get_doc(\"Supplier Quotation\", supplier_quotation_id)\n                    \n                    # Only consider submitted Supplier Quotations\n                    if supplier_quotation_doc.docstatus == 1:\n                        # Append a new entry to print_table\n                        print_table_entries.append({\n                            'material_request': mt_req_doc.name,\n                            'supplier_quotation': supplier_quotation_id,\n                            'supplier': supplier_quotation_doc.supplier,\n                            'supplier_name': supplier_quotation_doc.supplier_name\n                        })\n\n    # Set print_table_entries to doc's print_table field\n    doc.set('print_table', print_table_entries)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-10-29 16:49:21.714891",
  "module": null,
  "name": "Get Approval Names in PO",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Order",
  "script": "state = doc.workflow_state\nuser = frappe.session.user\n\nfull_name = frappe.db.get_value('User', user, 'full_name')\n\n\nif full_name:\n    # if state == 'Pending for Approval':\n    #     doc.custom_pm = full_name  \n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_pm', full_name)  \n    if state == 'Approved by Cost Controller':\n        doc.custom_cc = full_name  \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_cc', full_name)  \n    elif state == 'Approved by Accounts':\n        doc.custom_ad = full_name \n        frappe.db.set_value(doc.doctype, doc.name, 'custom_ad', full_name)\n    # elif state == 'Approved by CEO':\n    #     doc.custom_ceo = full_name \n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_ceo', full_name)\n    # elif state == 'Pending By Director':\n    #     frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\n# else:\n#     frappe.msgprint('User id is not defined.')",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-13 15:46:24.629843",
  "module": null,
  "name": "Annual Leave Calculation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "employee_id = doc.employee\r\nstart_date = doc.start_date\r\nend_date = doc.end_date\r\n\r\ntotal_annual_leave_days = 0\r\n\r\n# Fetch full-day leave records\r\nfull_day_records = frappe.get_list(\r\n    \"Attendance\",\r\n    filters={\r\n        \"employee\": employee_id,\r\n        \"attendance_date\": [\"between\", [start_date, end_date]],\r\n        \"status\": \"On Leave\",\r\n        \"leave_type\": [\"in\", [\"SASCO Annual Leave (Staff)\", \"SASCO Annual Leave (Labor)\", \"Annual Leave Staff (Al Mabani)\", \"Annual Leave Labor (Al Mabani)\"]]\r\n    },\r\n    fields=[\"attendance_date\"]\r\n)\r\n\r\n# Count full days\r\ntotal_annual_leave_days = total_annual_leave_days + len(full_day_records)\r\n\r\n# Fetch half-day leave records\r\nhalf_day_records = frappe.get_list(\r\n    \"Attendance\",\r\n    filters={\r\n        \"employee\": employee_id,\r\n        \"attendance_date\": [\"between\", [start_date, end_date]],\r\n        \"status\": \"Half Day\",\r\n        \"leave_application\": [\"is\", \"set\"],  # Ensure a linked leave application exists\r\n        \"leave_type\": [\"in\", [\"SASCO Annual Leave (Staff)\", \"SASCO Annual Leave (Labor)\", \"Annual Leave Labor (Al Mabani)\", \"Annual Leave Staff (Al Mabani)\"]]\r\n    },\r\n    fields=[\"attendance_date\"]\r\n)\r\n\r\n# Count half days\r\ntotal_annual_leave_days = total_annual_leave_days + 0.5 * len(half_day_records)\r\n\r\n# Assign the calculated total annual leave days to the document\r\ndoc.custom_annual_leave_days = total_annual_leave_days\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-12 10:16:19.920702",
  "module": null,
  "name": "Calculating the total salary on employee doctype",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "doc.custom_total_salary = (\r\n    (float(doc.custom_basic_salary) if doc.custom_basic_salary else 0) +\r\n    (float(doc.custom_other_alllowance) if doc.custom_other_alllowance else 0) +\r\n    (float(doc.custom_transportation_allowance_) if doc.custom_transportation_allowance_ else 0) +\r\n    (float(doc.custom_house_rent_allowance_) if doc.custom_house_rent_allowance_ else 0) +\r\n    (float(doc.custom_bonus_) if doc.custom_bonus_ else 0) +\r\n    (float(doc.custom_accommodation_allowance_) if doc.custom_accommodation_allowance_ else 0) +\r\n    (float(doc.custom_food_charges) if doc.custom_food_charges else 0) +\r\n    (float(doc.custom_travel_allowance) if doc.custom_travel_allowance else 0) +\r\n    (float(doc.custom_nature_of_work_allowance) if doc.custom_nature_of_work_allowance else 0) +\r\n    (float(doc.custom_telephone_allowance) if doc.custom_telephone_allowance else 0)\r\n  \r\n)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-16 15:14:24.515825",
  "module": null,
  "name": "Get Sales Order Item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Manufacture Order",
  "script": "\n\n\n############################################# RAW MATERIAL SUMMARY #############################################\ntol = 0\ntol_doc = frappe.get_doc('Manufacturing Order Settings')\nif tol_doc.tolerance :\n    for x in tol_doc.tolerance :\n        if x.company == doc.company :\n            tol = (x.tolerance or 0)\n\n\n# tol = frappe.db.get_single_value('Manufacturing Order Settings' , 'tolerance')\n\n\nif doc.raw_material_item :\n    for row in doc.raw_material_item :\n        row.coil_item_max_qty = row.coil_item_qty + (row.coil_item_qty * tol/100)\n        row.coil_item_remaining_qty = row.coil_item_max_qty\n        row.coil_item_used_qty = 0\n        \nif doc.raw_material_summary :\n    for row in doc.raw_material_summary :\n        row.material_item_max_qty = row.material_item_qty + (row.material_item_qty * tol/100)\n        row.material_item_remaining_qty = row.material_item_max_qty\n        row.material_item_used_qty = 0\n############################################# RAW MATERIAL SUMMARY #############################################\n\n\n\n\n\n\n\n        \n        \n        \n\n############################################# ACCESSORY SUMMARY #############################################\nif doc.accessory_summary :\n    for row in doc.accessory_summary :\n        row.amount = row.qty * row.rate\n        row.max_qty = row.qty + ( row.qty * tol/100 )\n        row.remaining_qty = row.max_qty\n        row.used_qty = 0\n        row.se_max_qty = row.qty + ( row.qty * tol/100 )\n        row.se_remaining_qty = row.se_max_qty\n        row.se_used_qty = 0\n############################################# ACCESSORY SUMMARY #############################################\n\n\n\n\n\n\n\n\n\n\n############################################# ACCESSORY SUMMARY WITH FG BATCH SR #############################################\ntotal_ac_itm_qty = 0\ntotal_ac_itm_amount = 0\n\ndoc.accessory_summary_with_fg_batch_sr = []\nif doc.fabrication_list :\n    fab_doc = frappe.get_doc( 'Fabrication List' , doc.fabrication_list )\n\n    unique_items = {}\n    if fab_doc.accessory:\n        for row in fab_doc.accessory:\n            unique_key = ( row.child_finished_good_item , row.child_finished_good_uom , row.fg_batch_sr )\n            \n            if unique_key not in unique_items:\n                unique_items[unique_key] = {\n                    \"item_code\" : row.child_finished_good_item,\n                    \"item_name\" : row.child_finished_good_item_name,\n                    \"fg_batch_sr\" : row.fg_batch_sr ,\n                    \"uom\" : row.child_finished_good_uom,\n                    \"qty\" : row.child_finished_good_qty\n                }\n            else:\n                unique_items[unique_key][\"qty\"] = unique_items[unique_key][\"qty\"] + row.child_finished_good_qty\n    \n        for key, value in unique_items.items():\n            \n            acc_bin_rate = 0\n            bin_list = frappe.get_list(\"Bin\",\n                            filters={\n                                'item_code' : value[\"item_code\"] ,\n                            },\n                            fields=['valuation_rate']\n                        )\n            if bin_list :\n                acc_bin_rate = bin_list[0].valuation_rate\n                \n            if acc_bin_rate == 0 :\n                itm_list = frappe.get_list(\"Item\",\n                            filters={\n                                'item_code' : value[\"item_code\"] ,\n                            },\n                            fields=['valuation_rate']\n                        )\n                if itm_list :\n                    acc_bin_rate = itm_list[0].valuation_rate\n                \n            \n            doc.append(\"accessory_summary_with_fg_batch_sr\", {\n                \"item_code_linked\": value[\"item_code\"],\n                \"item_name\" : value[\"item_name\"],\n                \"fg_batch_sr\" : value[\"fg_batch_sr\"] ,\n                \"uom\": value[\"uom\"],\n                \"qty\": value[\"qty\"],\n                \"rate\": acc_bin_rate,\n                \"amount\": acc_bin_rate * value[\"qty\"],\n            })\n            total_ac_itm_qty = total_ac_itm_qty + value[\"qty\"]\n            total_ac_itm_amount = total_ac_itm_amount + (acc_bin_rate * value[\"qty\"])\n            \n            \ndoc.total_accessory_item_quantity = total_ac_itm_qty\ndoc.total_accessory_item_amount = total_ac_itm_amount\ndoc.total_accessory_item_amount_ = total_ac_itm_amount\n############################################# ACCESSORY SUMMARY WITH FG BATCH SR #############################################\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n############################################# RAW MATERIAL SUMMARY #############################################\ntotal_rm_cost = 0\ntotal_rm_qty = 0\nt_amount = 0\nif doc.raw_material_item :\n    for row in doc.raw_material_item :\n        \n        acc_bin_rate = 0\n        bin_list = frappe.get_list(\"Bin\",\n                        filters={\n                            'item_code' : row.coil_item_code_rm ,\n                        },\n                        fields=['valuation_rate']\n                    )\n        if bin_list :\n            acc_bin_rate = bin_list[0].valuation_rate\n            \n        if acc_bin_rate == 0 :\n            itm_list = frappe.get_list(\"Item\",\n                        filters={\n                            'item_code' : row.coil_item_code_rm ,\n                        },\n                        fields=['valuation_rate']\n                    )\n            if itm_list :\n                acc_bin_rate = itm_list[0].valuation_rate\n        \n        \n        row.costing_rate = acc_bin_rate\n        if not row.costing_rate :\n            row.costing_rate = 0\n            \n        if not row.coil_item_qty :\n            row.coil_item_qty = 0\n        \n        t_amount = row.costing_rate * row.coil_item_qty\n        total_rm_qty = total_rm_qty + row.coil_item_qty\n        total_rm_cost = total_rm_cost + t_amount\n        \ndoc.total_raw_material_quantity = total_rm_qty\ndoc.total_raw_material_cost_ = total_rm_cost\ndoc.total_raw_material_cost = total_rm_cost\n############################################# RAW MATERIAL SUMMARY #############################################\n\n\n\n\n\n\n\n\n\n\n########################################## CONSUMABLE COST ##########################################\ntotal_consumable_qty = 0\ntotal_consumable_cost = 0\n\nif doc.consumable_cost :\n    \n    for row in doc.consumable_cost :\n        \n        row.amount = (row.quantity or 0) * (row.rate or 0)\n        row.max_quantity = (row.quantity or 0) + ( (row.quantity or 0) * tol/100 )\n        row.remaining_quantity = row.max_quantity\n        row.used_quantity = 0\n        \n        \n        row.se_max_quantity = (row.quantity or 0) + ( (row.quantity or 0) * tol/100 )\n        row.se_remaining_quantity = row.se_max_quantity\n        row.se_used_quantity = 0\n        \n        \n        total_consumable_qty = total_consumable_qty + (row.quantity or 0)\n        total_consumable_cost = total_consumable_cost + (row.amount or 0)\n        \ndoc.total_consumable_quantity = total_consumable_qty\ndoc.total_consumable_cost = total_consumable_cost\ndoc.total_consumable_cost_1 = total_consumable_cost\n########################################## CONSUMABLE COST ##########################################\n\n\n\n\n\n\n\n\n\n\n\n########################################## DELIVERY COST ##########################################\ntotal_delivery_qty = 0\ntotal_delivery_cost = 0\n\nif doc.delivery_cost :\n    \n    for row in doc.delivery_cost :\n        \n        row.amount = (row.quantity or 0) * (row.rate or 0)\n        total_delivery_qty = total_delivery_qty + (row.quantity or 0)\n        total_delivery_cost = total_delivery_cost + (row.amount or 0)\n        \ndoc.total_delivery_quantity = total_delivery_qty\ndoc.total_delivery_cost = total_delivery_cost\ndoc.total_delivery_cost1 = total_delivery_cost\n########################################## DELIVERY COST ##########################################\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n############################################# ITEM TABLE SUMMARY #############################################\ntotal_spl_area_sqm = 0\ntotal_fg_qty = 0\n\nif doc.item_table :\n    for row in doc.item_table :\n        \n        if not row.rate :\n            row.rate = 0\n        if not row.quantity :\n            row.quantity = 0\n        row.amount = row.quantity * row.rate    \n        \n        total_spl_area_sqm = total_spl_area_sqm + ( row.spl_area_sqm or 0 )\n        total_fg_qty = total_fg_qty + row.quantity\n        \n        material_cost = 0\n        acc_cost = 0\n        consumable_cost = 0\n        delivery_cost = 0\n        oh_cost = 0\n        \n        if doc.raw_material_item :\n            for y in doc.raw_material_item :\n                if row.item_code == y.fg_batch_sr :\n                    material_cost = material_cost + (y.costing_rate * y.coil_item_qty)\n        row.material_cost = material_cost\n        \n        \n        if doc.accessory_summary_with_fg_batch_sr :\n            for a in doc.accessory_summary_with_fg_batch_sr :\n                if row.item_code == a.fg_batch_sr :\n                    acc_cost = acc_cost + ( a.amount or 0 )\n        row.accessory_cost = acc_cost\n                \n                \n\ndoc.total_spl_area_sqm = total_spl_area_sqm     \ndoc.total_fg_item_quantity = total_fg_qty\n\n\ntotal_fab_cost = 0\ntotal_grand_cost = 0\ndoc.distributed_fg_cost = []\nif doc.item_table :\n    for row in doc.item_table :\n        consumable_cost = 0\n        delivery_cost = 0\n        oh_cost = 0\n        \n        spl_area_sqm = ( row.spl_area_sqm or 0 )\n        \n        if doc.total_spl_area_sqm > 0 :\n            spl_percent = (spl_area_sqm*100)/doc.total_spl_area_sqm\n        else :\n            spl_percent = 0\n        \n        row.consumable_cost = ( ((doc.total_consumable_cost or 0)/100) * spl_percent)\n        row.delivery_cost = ( ((doc.total_delivery_cost or 0)/100) * spl_percent)\n        row.over_head_cost = ( ((doc.total_over_head_cost or 0)/100) * spl_percent)\n        \n        \n        row.grand_cost = row.material_cost + row.accessory_cost + row.consumable_cost + row.delivery_cost + row.over_head_cost + row.fabrication_cost\n        total_grand_cost = total_grand_cost + row.grand_cost\n        if spl_area_sqm > 0 :\n            row.per_unit_cost = row.grand_cost / spl_area_sqm\n        else :\n            row.per_unit_cost = 0\n            \n        \n        total_fab_cost = total_fab_cost + row.fabrication_cost \n        doc.append('distributed_fg_cost', {\n            \n            'parent_finished_goods_item' : row.parent_finished_goods_item ,\n            'item_code' : row.item_code ,\n            'uom' : row.uom ,\n            'spl_area_sqm' : row.spl_area_sqm ,\n            'duct_range' : row.duct_range ,\n            \n            'material_cost' : row.material_cost ,\n            'accessory_cost' : row.accessory_cost ,\n            'consumable_cost' : row.consumable_cost ,\n            'delivery_cost' : row.delivery_cost ,\n            'over_head_cost' : row.over_head_cost ,\n            'fabrication_cost' : row.fabrication_cost ,\n            \n            'per_unit_cost' : row.per_unit_cost ,\n            'grand_cost' : row.grand_cost ,\n        })    \n\n        \ndoc.total_fabrication_cost = total_fab_cost     \ndoc.total_operation_cost_ = total_fab_cost\ndoc.total_fg_item_amount = total_grand_cost\ndoc.total_fg_item_amount_ = total_grand_cost\ndoc.per_unit_spl_area_sqm_cost = doc.total_fg_item_amount / doc.total_spl_area_sqm\n    \nif not doc.total_over_head_cost_ :\n    doc.total_over_head_cost_ = 0\n\n\n\nif total_fg_qty == 0 :\n    doc.per_unit_over_head_cost = 0\nelse :\n    doc.per_unit_over_head_cost = doc.total_over_head_cost_ / total_fg_qty\n############################################# ITEM TABLE SUMMARY #############################################\n\n\n\n\n\n\n############################################# JOB CARD #############################################\ntotal_time_spent = 0\ntotal_opr_cost = 0\nif doc.job_card :\n    \n    for row in doc.job_card :\n        \n        if row.start == 1 and row.end == 1 :\n            \n            row.operation_cost = row.time_spent * (row.per_hour_rate / 3600)\n            \n            total_time_spent = total_time_spent + row.time_spent\n            total_opr_cost = total_opr_cost + row.operation_cost\n            \n            \n\ndoc.total_time_spent = total_time_spent\ndoc.total_operation_cost = total_opr_cost\n# doc.total_operation_cost_ = total_opr_cost\n############################################# JOB CARD #############################################\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    \n    \ndoc.grand_total = doc.total_raw_material_cost + doc.total_accessory_item_amount_ + doc.total_operation_cost_ + doc.total_consumable_cost + doc.total_delivery_cost   \n\n\ndoc.total_over_head_cost_ = doc.grand_total * (doc.additional_over_head_cost_percentage/100)\n\ndoc.total_over_head_cost = doc.total_over_head_cost_\n\ndoc.grand_total = doc.grand_total + doc.total_over_head_cost\n\n\n\n\n\n\n\n############################################# DUCT ITEM PROPORTIONAL COST #############################################\ndoc.duct_item = []\n\nif doc.duct_and_acc_item :\n    t_duct_itm_qty = 0\n    \n    for row in doc.duct_and_acc_item :\n        t_duct_itm_qty = t_duct_itm_qty + row.spl_area_sqm\n        \n        sub_grand_cost = 0\n        if doc.item_table :\n            for a in doc.item_table :\n                if row.item_code == a.parent_finished_goods_item and row.duct_range == a.duct_range :\n                    sub_grand_cost = sub_grand_cost + a.grand_cost\n        \n        row.grand_cost = sub_grand_cost\n        \n    for row in doc.duct_and_acc_item :   \n        \n        cost = 0\n        if t_duct_itm_qty > 0 :\n            cost = doc.grand_total * (row.spl_area_sqm / t_duct_itm_qty)\n            \n        doc.append('duct_item',{\n            'item_code' : row.item_code ,\n            'item_name' : row.item_name ,\n            'uom' : row.uom ,\n            'qty' : row.qty ,\n            'spl_area_sqm' : row.spl_area_sqm ,\n            'cost' : cost ,\n        })\n############################################# DUCT ITEM PROPORTIONAL COST #############################################\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-12 10:35:17.520920",
  "module": null,
  "name": "Remove Start Date If Duplicate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Manufacture Order",
  "script": "\ndoc.start_time = None\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-14 18:49:05.136497",
  "module": null,
  "name": "Add Salaries to Table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "WPS Report",
  "script": "print(a)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-02 16:09:55.025185",
  "module": null,
  "name": "fetch salary details from job offer to employee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "if doc.custom_job_offer:\r\n    job = frappe.get_doc(\"Job Offer\", doc.custom_job_offer)\r\n    \r\n    if job.custom_salary_details:\r\n        for row in job.custom_salary_details:\r\n            if row.salary_component == \"Basic\":\r\n               doc.custom_basic_salary =  row.amount\r\n            elif row.salary_component == \"House Rent Allowance\":\r\n                doc.custom_house_rent_allowance = row.amount\r\n            elif row.salary_component == \"Transport Allowance\":\r\n                doc.custom_transportation_allowance = row.amount\r\n            elif row.salary_component == \"Other Allowance\":\r\n                doc.custom_other_alllowance = row.amount\r\n            elif row.salary_component == \"Bonus\":\r\n                doc.custom_bonus = row.amount\r\n            elif row.salary_component == \"Accommodation Allowance\":\r\n                doc.custom_accomodation_allowance = row.amount\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-06 12:04:18.130874",
  "module": null,
  "name": "calculating the encashment amount",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Encashment",
  "script": "doc.encashment_amount = (doc.encashment_days * doc.custom_basic) if doc.encashment_days and doc.custom_basic else 0\r\n\r\n\r\n\r\n\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-11 10:17:33.052220",
  "module": null,
  "name": "test555",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Encashment",
  "script": "doc.encashment_amount = (doc.encashment_days * doc.custom_basic) if doc.encashment_days and doc.custom_basic else 0\r\n\r\n\r\n\r\n\r\n\r\nstate = doc.workflow_state\r\nuser = frappe.session.user\r\nfull_name = frappe.db.get_value('User', user, 'full_name')\r\n\r\n\r\nif full_name:\r\n        if state == 'Pending By Account Manager':\r\n            doc.custom_hr_user = full_name  \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name)  \r\n\r\n\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-06 13:40:33.603654",
  "module": null,
  "name": "get approval name",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Encashment",
  "script": "state = doc.workflow_state\r\nuser = frappe.session.user\r\nfull_name = frappe.db.get_value('User', user, 'full_name')\r\n\r\n# Check if the script has already run for this document\r\n  # Check if script has already run\r\nif full_name:\r\n        if state == 'Pending by Account Manager':\r\n            doc.custom_hr_user = full_name  \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_hr_user', full_name)  \r\n        elif state == 'Pending by Finance Manager':\r\n            doc.custom_account_manager = full_name \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_account_manager', full_name)\r\n        elif state == 'Pending By CAO':\r\n            doc.custom_finance_manager = full_name \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_finance_manager', full_name)\r\n        elif state == 'Pending by CEO':\r\n            doc.custom_cao = full_name \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_cao', full_name)\r\n        elif state == 'Approved':\r\n            doc.custom_ceo = full_name \r\n            frappe.db.set_value(doc.doctype, doc.name, 'custom_ceo', full_name)\r\n\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-27 14:55:36.543437",
  "module": null,
  "name": "Get Fabrication Records",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication Filter",
  "script": "\n\n\ndoc.fabrication_filter_items = []\ndoc.parent_item = []\n\n     \nif doc.filtered_fabrication_list :\n    unique_items = {}\n    parent_unique_codes = {}\n\n    for fab in doc.filtered_fabrication_list :\n\n        fab_doc = frappe.get_doc('Fabrication List',fab.fabrication)\n        \n        \n        for row in fab_doc.fabrication_table :\n            unique_key = (row.fg_batch_sr)\n            if unique_key not in unique_items:\n                unique_items[unique_key] = {\n                    \"item_code\" : row.fg_batch_sr,\n                    \"parent_item\" : row.spl_item_fg_code ,\n                    \"qty\" : row.fl_item_qty,\n                }\n            else:\n                unique_items[unique_key][\"qty\"] = unique_items[unique_key][\"qty\"] + row.fl_item_qty\n                \n            \n            key = (row.spl_item_fg_code)\n    \n            if key not in parent_unique_codes:\n                parent_unique_codes[key] = {\n                    \"spl_item_fg_code\": row.spl_item_fg_code ,\n                    \"spl_qty_in_pcs\": float(row.spl_qty_in_pcs or 0),\n                    \"spl_area_sqm\": float(row.spl_area_sqm or 0),\n                    \"spl_item_fg_uom\": row.spl_item_fg_uom\n                }\n            else:\n                parent_unique_codes[key][\"spl_qty_in_pcs\"] = parent_unique_codes[key][\"spl_qty_in_pcs\"] + float(row.spl_qty_in_pcs or 0)\n                parent_unique_codes[key][\"spl_area_sqm\"] = parent_unique_codes[key][\"spl_qty_in_pcs\"] + float(row.spl_area_sqm or 0)\n                \n        \n        for key, value in parent_unique_codes.items() :\n            doc.append(\"parent_item\",{\n                \"parent_item\": value[\"spl_item_fg_code\"],\n                \"spl_area_sqm\": value[\"spl_area_sqm\"], \n                \"cam_item_qty\": value[\"spl_qty_in_pcs\"],\n                \"fg_item_uom\": value[\"spl_item_fg_uom\"],\n            })\n            \n            \n        \n        for row in fab_doc.accessory :\n            unique_key = (row.child_finished_good_item)\n            if unique_key not in unique_items:\n                unique_items[unique_key] = {\n                    \"item_code\" : row.child_finished_good_item,\n                    \"parent_item\" : row.parent_finished_good_item ,\n                    \"qty\" : row.child_finished_good_qty,\n                }\n            else:\n                unique_items[unique_key][\"qty\"] = unique_items[unique_key][\"qty\"] + row.child_finished_good_qty\n                \n        for key, value in unique_items.items():\n            doc.append(\"fabrication_filter_items\", {\n                \"item\": value[\"item_code\"],\n                \"parent_item\": value[\"parent_item\"], \n                \"quantity\": value[\"qty\"],\n            })        \n                    \n        \n        \n    \n                    \n                    \n                    \n                    \n                    \n                    \n                    \n                    \n    \n\n    \n    \n                        \n                        \n                        \n                        \n                    \n                    \n            \n            \n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-06 13:10:13.909879",
  "module": null,
  "name": "Leave Salary",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Salary",
  "script": "################   Umair Work    #################\n\nlast_leave_list = frappe.get_all('Leave Salary', filters={'employee': doc.employee, 'name': [\"!=\", doc.name], 'docstatus': 1}, fields=['from_dat', 'to', 'total_day'], order_by=\"creation desc\")\nlast_leave = last_leave_list[0] if last_leave_list else None\nif last_leave:\n    doc.from_date = last_leave.from_dat\n    doc.to_date = last_leave.to\n    doc.total_days = last_leave.total_day\nelse:\n    doc.from_date = None\n    doc.to_date = None\n    doc.total_days = None\n    \n##################################################\n\n\n\n\n\n\n\nif not doc.calculate_manual:\n    joining_date = frappe.db.get_value(\"Employee\", doc.employee, \"date_of_joining\")\n    to_date = frappe.utils.getdate(doc.to)\n    from_date = doc.from_dat\n    relieving_date = frappe.db.get_value(\"Employee\", doc.employee, \"relieving_date\")\n    \n    if joining_date:\n        joining_date = frappe.utils.getdate(joining_date)\n        \n        one_year_later = frappe.utils.add_days(joining_date, 365)\n        current_date = frappe.utils.getdate(frappe.utils.nowdate())\n        \n        if current_date >= one_year_later:\n            if from_date and to_date:\n                if relieving_date:\n                    relieving_date = frappe.utils.getdate(relieving_date)\n                    \n                    if relieving_date < to_date:\n                        frappe.throw(f\"Adjusting end date to relieving date {relieving_date}.\")\n                        to_date = relieving_date\n                        \n                total_days = frappe.utils.date_diff(to_date, from_date)+1\n                doc.total_day = total_days\n                abscent_days = frappe.db.count('Attendance', filters={\n                    'status': 'Absent',\n                    \"docstatus\" : 1,\n                    'attendance_date': ['between', [doc.from_dat, doc.to]],\n                    'employee': doc.employee\n                })\n                # frappe.msgprint(\"Abscnt Days:\" + str(abscent_days))\n                total_leave_days1 = frappe.db.sql(\"\"\"\n                    SELECT SUM(e.total_leave_days) \n                    FROM `tabLeave Application` as e\n                    WHERE e.employee = %(employee)s\n                    AND e.leave_type NOT IN ('Sick Leave SASCO', 'Sick Leave Al Mabani')\n                    # AND e.from_date BETWEEN %(from_dat)s AND %(to_date)s\n                    AND from_date >= %(from_dat)s\n                    AND to_date <= %(to_date)s\n                    AND status = \"Approved\"\n                \"\"\", {\n                    'employee': doc.employee,\n                    'from_dat': doc.from_dat,\n                    'to_date': doc.to\n                }, as_dict=True)\n                # frappe.msgprint(\"Leave Days:\" + str(total_leave_days1))\n    \n                total_leave_days2 = frappe.db.sql(\"\"\"\n                    SELECT SUM(total_leave_days) \n                    FROM `tabLeave Application`\n                    WHERE employee = %(employee)s\n                    AND leave_type NOT IN ('Sick Leave SASCO', 'Sick Leave Al Mabani')\n                    AND from_date <= %(from_dat)s\n                    AND to_date >= %(from_dat)s\n                    AND status = \"Approved\"\n                \"\"\", {\n                    'employee': doc.employee,\n                    'from_dat': doc.from_dat,\n                    'to_date': doc.to\n                }, as_dict=True)\n                # frappe.msgprint(\"Leave Days:\" + str(total_leave_days2))\n                total_leave_days3 = frappe.db.sql(\"\"\"\n                    SELECT SUM(total_leave_days) \n                    FROM `tabLeave Application`\n                    WHERE employee = %(employee)s\n                    AND leave_type NOT IN ('Sick Leave SASCO', 'Sick Leave Al Mabani')\n                    AND from_date >= %(to_date)s\n                    AND to_date <= %(to_date)s\n                    AND status = \"Approved\"\n                \"\"\", {\n                    'employee': doc.employee,\n                    'from_dat': doc.from_dat,\n                    'to_date': doc.to\n                }, as_dict=True)\n                # frappe.msgprint(\"Leave Days:\" + str(total_leave_days3))\n                # Get the sum values from the result\n                # total_leave_dayss1 = total_leave_days1[0].get('SUM(e.total_leave_days)', 0) if total_leave_days1 and total_leave_days1[0].get('SUM(total_leave_days)') is not None else 0\n                total_leave_dayss1 = list(total_leave_days1[0].values())[0] if total_leave_days1 else 0\n                total_leave_dayss2 = list(total_leave_days2[0].values())[0] if total_leave_days2 else 0\n                total_leave_dayss3 = list(total_leave_days3[0].values())[0] if total_leave_days3 else 0\n                total_leave_dayss1 = total_leave_dayss1 or 0\n                total_leave_dayss2 = total_leave_dayss2 or 0\n                total_leave_dayss3 = total_leave_dayss3 or 0\n                # total_leave_dayss2 = total_leave_days2[0].get('SUM(total_leave_days)', 0) if total_leave_days2 and total_leave_days2[0].get('SUM(total_leave_days)') is not None else 0\n                # total_leave_dayss3 = total_leave_days3[0].get('SUM(total_leave_days)', 0) if total_leave_days3 and total_leave_days3[0].get('SUM(total_leave_days)') is not None else 0\n                payble_days = total_days - (abscent_days + (total_leave_dayss1 + total_leave_dayss2 + total_leave_dayss3))\n                # frappe.msgprint(\"Leave Days:\" + str(total_leave_days3))\n                y = total_days/365\n                d = y * 30\n                unpaid_days = total_leave_dayss1 + total_leave_dayss2 + total_leave_dayss3\n                doc.unpaid_days = unpaid_days\n                unp = (2.5/30) * unpaid_days\n                bd = d - unp\n                doc.payable_leave_days = bd\n                # basic = frappe.db.get_value(\"Employee\", doc.employee, \"custom_basic_salary\")\n                basic = doc.basic\n                amount = (basic/30)*bd\n                doc.encashment_amount = amount\n                \n            else:\n                frappe.throw(\"Please specify both 'From Date' and 'To Date'.\")\n        else:\n            frappe.throw(\"The employee has not completed one year yet.\")\n        \n        \n        \n        \nif doc.calculate_manual:\n    to_date = frappe.utils.getdate(doc.to)\n    from_date = doc.from_dat\n    total_days = frappe.utils.date_diff(to_date, from_date)+1\n    doc.total_day = total_days\n    amount = 0\n    y = doc.total_day/365\n    d = y * 30\n    unpaid_days = (doc.unpaid_days or 0)\n    unp = (2.5/30) * unpaid_days\n    bd = d - unp\n    doc.payable_leave_days = bd\n    basic = doc.basic\n    amount = (basic/30)*bd\n    doc.encashment_amount = round(amount)\n        \n        \n        \n        \n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-03-25 11:36:34.011845",
  "module": null,
  "name": "get attendance list",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Attendance",
  "script": "\n\nget_attendance_list = frappe.db.sql(f\"\"\"\n    SELECT * FROM `tabAttendance` WHERE status='Present';\"\"\")\n    \nfrappe.response[\"messgae\"] = get_attendance_list",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-03-25 11:36:40.207864",
  "module": null,
  "name": "Late Approval",
  "rate_limit_count": 0,
  "rate_limit_seconds": 0,
  "reference_doctype": "Attendance",
  "script": "approval = frappe.get_all(\"Late Approval Request\", filters={\n    \"employee\":[\"=\",doc.employee],\n    \"docstatus\": [\"=\", 1],\n    \"late_date\": [\"=\", doc.attendance_date]\n})\n\nif(len(approval) > 0):\n    doc.late_approved = True",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-22 12:12:48.423304",
  "module": null,
  "name": "Creating Quarter Leave Application on Submitting Quarter Attendance",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\n    \n    \n    \n    \n    \nif doc.custom_quarter_day ==  1 and doc.status == 'Present' :\n    \n    \n    la_doc = frappe.get_doc({\n        \"doctype\": \"Leave Application\",\n        \"employee\": doc.employee ,\n        \"leave_type\" : \"Leave Without Pay\",\n        \"from_date\": doc.attendance_date ,\n        \"to_date\": doc.attendance_date ,\n        \"custom_quarter_day\": 1 ,\n        \"total_leave_days\" : 0.25 ,\n        \"status\": \"Approved\",\n        \"docstatus\": 1 ,\n    })\n        \n    la_doc.insert()\n\n    \n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-22 12:14:23.933292",
  "module": null,
  "name": "Removing Leave From Attendance",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\n\n\n\n\nif doc.custom_quarter_day == 1 and doc.status == 'Present' :\n    \n    att_list = frappe.get_list(\"Attendance\",\n                    filters={\n                        \"employee\" : doc.employee ,\n                        \"attendance_date\" : doc.attendance_date ,\n                        # \"status\" : \"On Leave\" ,\n                        \n                    }, fields = ['name','status'] )\n            \n    l = len(att_list)        \n            \n    # frappe.msgprint(str(l))        \n                    \n    if len(att_list) == 2 :\n        \n        \n        if att_list[0].status == 'On Leave' :\n            att_doc = frappe.get_doc(\"Attendance\",att_list[0].name)\n            # frappe.msgprint(str(att_doc.name))\n            att_doc.cancel()\n            att_doc.delete()\n            \n        elif att_list[1].status == 'On Leave' :\n            att_doc = frappe.get_doc(\"Attendance\",att_list[1].name)\n            # frappe.msgprint(str(att_doc.name))\n            att_doc.cancel()\n            att_doc.delete()\n\n    \n\n    \n    \n    \n    \n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-22 16:28:33.096961",
  "module": null,
  "name": "IN OUT According to Shift Type",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\nt_w_h = 0\nemp_doc = frappe.get_doc(\"Employee\",doc.employee)\nif emp_doc.custom_overtime_status != 'YES' :\n\n    if doc.status == 'Present':\n        if doc.shift and doc.in_time and doc.out_time:\n            \n            \n            shift_doc = frappe.get_doc(\"Shift Type\", doc.shift)\n            s_t = frappe.utils.get_time(shift_doc.start_time)\n            e_t = frappe.utils.get_time(shift_doc.end_time)\n            \n            \n            \n            \n            in_time = frappe.utils.get_time(doc.in_time)\n            out_time = frappe.utils.get_time(doc.out_time)\n           \n            \n            final_in_time = []\n            final_out_time = []\n            \n            if s_t >= in_time:\n                final_in_time = s_t\n            else:\n                final_in_time = in_time\n                \n            if e_t <= out_time:\n                final_out_time = e_t\n            else:\n                final_out_time = out_time    \n            \n            final_in_time = frappe.utils.format_time(final_in_time)\n            final_out_time = frappe.utils.format_time(final_out_time)\n            \n           \n            \n    \n            t_w_h = frappe.utils.time_diff_in_hours(final_out_time, final_in_time)\n            doc.working_hours = t_w_h\n            \n# if doc.status == 'Present':           \n#     shift_doc = frappe.get_doc(\"Shift Type\", doc.shift)\n#     Quarter_threshold = float(shift_doc.custom_working_hours_threshold_for_quarter)\n#     Half_threshold = float(shift_doc.working_hours_threshold_for_half_day)\n    \n#     if Half_threshold < t_w_h < Quarter_threshold:\n#         doc.custom_quarter_day = 1\n            \n            \n            \n            # doc.update()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-06 16:40:14.219875",
  "module": null,
  "name": "Creating Quarter Leave From Quarter Attendance And Also Update Table In Attendance",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\n\n\nif doc.in_time and doc.out_time :\n    in_time = doc.in_time\n    out_time = doc.out_time\n    shift = doc.shift\n    \n    \n    time_difference = frappe.utils.get_datetime(out_time) - frappe.utils.get_datetime(in_time)\n    hours_difference = time_difference.total_seconds() / 3600\n    \n    \n    shift_doc = frappe.get_doc(\"Shift Type\", doc.shift)\n    \n    \n    Quarter_threshold = float(shift_doc.custom_working_hours_threshold_for_quarter)\n    Half_threshold = float(shift_doc.working_hours_threshold_for_half_day)\n    \n\n    if Half_threshold < hours_difference < Quarter_threshold:\n        doc.custom_quarter_day = 1\n        \n        q_from_time = frappe.utils.get_time(doc.out_time)\n        \n        la_doc = frappe.get_doc({\n            \"doctype\": \"Leave Application\",\n            \"employee\": doc.employee ,\n            \"leave_type\" : \"Leave Without Pay\",\n            \"from_date\": doc.attendance_date ,\n            \"to_date\": doc.attendance_date ,\n            \"custom_created_from_attendance\" : 1 ,\n            \"custom_quarter_day\": 1 ,\n            \"custom_from_time\" : q_from_time ,\n            \"total_leave_days\" : 0.25 ,\n            \"status\": \"Approved\",\n            \"docstatus\": 1 ,\n        })\n        la_doc.insert()\n        \n       \n        doc.append('custom_leave_applications', {\n            'leave_application': la_doc.name ,\n            'type': 'Quarter Day' ,\n            'from_time': la_doc.custom_from_time ,\n            'to_time' : la_doc.custom_to_time\n        })\n        # doc.db_update()\n        \n            \n                    \n                    \n                    \n                    \n                    \n                    \n                    \n                    \n                    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-08-23 11:04:43.290216",
  "module": null,
  "name": "Over Time Calculation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "def safe_time_diff_in_hours(start_time, end_time):\n    \"\"\"Calculate the time difference in hours using frappe.utils, handling None values.\"\"\"\n    if start_time is None or end_time is None:\n        # frappe.msgprint(\"Cannot calculate time difference because one or both times are None.\")\n        return 0.0\n    try:\n        # Convert times to strings in the format required by frappe.utils.time_diff_in_hours\n        start_time_str = str(start_time)\n        end_time_str = str(end_time)\n        \n        # Calculate the time difference in hours\n        time_diff = frappe.utils.time_diff_in_hours(end_time_str, start_time_str)\n        return time_diff\n    except Exception as e:\n        # frappe.msgprint(f\"Error calculating time difference: {e}\")\n        return 0.0\n\nemployee = frappe.get_doc(\"Employee\", doc.employee)\n\nif doc.shift:\n    shift = frappe.get_doc(\"Shift Type\", doc.shift)\n\n# Ensure all required fields are present\nif doc.in_time and doc.out_time and shift.start_time and shift.end_time and employee.custom_overtime_status == \"Yes\":\n    # Get times and convert them\n    in_time = frappe.utils.get_time(doc.in_time)\n    out_time = frappe.utils.get_time(doc.out_time)\n    shift_in_time = frappe.utils.get_time(shift.start_time)\n    shift_out_time = frappe.utils.get_time(shift.end_time)\n\n    # Print times for debugging\n    # frappe.msgprint(f\"In Time: {in_time}\")\n    # frappe.msgprint(f\"Out Time: {out_time}\")\n    # frappe.msgprint(f\"Shift Start Time: {shift_in_time}\")\n    # frappe.msgprint(f\"Shift End Time: {shift_out_time}\")\n\n    # Check for None values\n    if None in (in_time, out_time, shift_in_time, shift_out_time):\n        # Print which values are None\n        if in_time is None:\n            frappe.msgprint(\"In Time is None.\")\n        if out_time is None:\n            frappe.msgprint(\"Out Time is None.\")\n        if shift_in_time is None:\n            frappe.msgprint(\"Shift Start Time is None.\")\n        if shift_out_time is None:\n            frappe.msgprint(\"Shift End Time is None.\")\n        \n        # frappe.msgprint(\"One or more time values are None. Check the input data.\")\n        doc.custom_over_time_hours = 0.0\n    else:\n        # Calculate early arrival time\n        if in_time < shift_in_time:\n            # frappe.msgprint(f\"Condition in_time < shift_in_time is True: {in_time} < {shift_in_time}\")\n            early_arrival_time = safe_time_diff_in_hours(shift_in_time, in_time)\n            # frappe.msgprint(f\"Early Arrival Time: {early_arrival_time} hours\")\n        else:\n            early_arrival_time = 0.0\n            # frappe.msgprint(\"No early arrival time to calculate.\")\n\n        # Calculate late departure time\n        if out_time > shift_out_time:\n            # frappe.msgprint(f\"Condition out_time > shift_out_time is True: {out_time} > {shift_out_time}\")\n            late_departure_time = safe_time_diff_in_hours(out_time, shift_out_time)\n            # frappe.msgprint(f\"Late Departure Time: {late_departure_time} hours\")\n        else:\n            late_departure_time = 0.0\n            # frappe.msgprint(\"No late departure time to calculate.\")\n\n        # Total overtime is the sum of early arrival and late departure times\n        total_hours = early_arrival_time + late_departure_time\n        # frappe.msgprint(f\"Total Overtime Hours: {total_hours} hours\")\n        if total_hours < 0 :\n            total_hours = -1 * (total_hours)\n        doc.custom_over_time_hours = total_hours\nelse:\n    # frappe.msgprint(\"Required fields are missing or employee does not have overtime status enabled.\")\n    doc.custom_over_time_hours = 0.0\n\n\n\n\n\n\n\n\n\n\n\n\n# # Retrieve employee and shift records\n# employee = frappe.get_doc(\"Employee\", doc.employee)\n# if doc.shift:\n#     shift = frappe.get_doc(\"Shift Type\", doc.shift)\n\n# # Ensure all required fields are present\n# if doc.in_time and doc.out_time and shift.end_time and employee.custom_overtime_status == \"Yes\":\n#     in_time = frappe.utils.get_time(doc.in_time)\n#     out_time_time = frappe.utils.get_time(doc.out_time)\n    \n#     shift_in_time = frappe.utils.get_time(shift.start_time)\n#     shift_out_time = frappe.utils.get_time(shift.end_time)\n    \n#     final_in_time = frappe.utils.format_time(in_time)\n#     final_out_time = frappe.utils.format_time(out_time_time)\n    \n#     final_shift_in_time = frappe.utils.format_time(shift_in_time)\n#     final_shift_out_time = frappe.utils.format_time(shift_out_time)\n            \n           \n            \n    \n#      # Calculate early arrival time\n#     early_arrival_time = frappe.utils.time_diff_in_hours(final_shift_in_time , final_shift_in_time)\n#     # Calculate overtime (late departure time)\n#     late_departure_time = frappe.utils.time_diff_in_hours(final_out_time , final_shift_out_time)\n    \n#     total = frappe.utils.time_diff_in_hours(late_departure_time, early_arrival_time)\n#     total_hours = total.total_seconds() / 3600.0\n#     frappe.msgprint(total_hours)\n#     doc.custom_over_time_hours = total_hours\n    \n    \n    \n    \n\n   \n#     # if out_time_time > shift_time:\n        \n#     #     total = frappe.utils.time_diff_in_hours(final_out_time, final_shift_time)\n#     #     # total_hours = total.total_seconds() / 3600.0\n#     #     doc.custom_over_time_hours = total\n#     # else:\n#     #     doc.custom_over_time_hours = 0.0\n# else:\n#     doc.custom_over_time_hours = 0.0\n   ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-09-26 19:00:40.094170",
  "module": null,
  "name": "in out test",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\nemp_doc = frappe.get_doc(\"Employee\",doc.employee)\n\n\nif doc.shift and doc.in_time and doc.out_time:\n    \n    shift_doc = frappe.get_doc(\"Shift Type\", doc.shift)\n    s_t = frappe.utils.get_time(shift_doc.start_time)\n    e_t = frappe.utils.get_time(shift_doc.end_time)\n    \n    shift_start_time = frappe.utils.get_datetime(str(doc.in_time.date()) + \" \" + str(s_t))\n    shift_end_time = frappe.utils.get_datetime(str(doc.in_time.date()) + \" \" + str(e_t))\n    \n    emp_ch_list = frappe.get_list(\"Employee Checkin\",\n                    filters={\n                        'employee': doc.employee,\n                        'time': [\"Between\", (doc.in_time, doc.out_time)],\n                    },\n                    order_by='time',)\n    \n    total_working_seconds = 0\n    total_overtime_seconds = 0\n    last_checkin_time = None\n    last_log_type = None\n    \n    for emp_ch in emp_ch_list:\n        emp_ch_doc = frappe.get_doc(\"Employee Checkin\", emp_ch.name)\n        \n        checkin_time = frappe.utils.get_datetime(emp_ch_doc.time)\n        \n        if checkin_time < shift_start_time:\n            overtime_start_time = checkin_time\n            checkin_time = shift_start_time\n            \n            time_diff = frappe.utils.time_diff_in_seconds(checkin_time, overtime_start_time)\n            total_overtime_seconds = total_overtime_seconds + time_diff\n        elif checkin_time > shift_end_time:\n            \n            overtime_end_time = checkin_time\n            checkin_time = shift_end_time\n            time_diff = frappe.utils.time_diff_in_seconds(overtime_end_time, checkin_time)\n            total_overtime_seconds = total_overtime_seconds + time_diff\n        \n        if emp_ch_doc.log_type == \"IN\":\n            if last_log_type != \"IN\":\n                last_checkin_time = checkin_time\n            last_log_type = \"IN\"\n        \n        elif emp_ch_doc.log_type == \"OUT\" and last_checkin_time:\n            if last_log_type == \"IN\":\n                if checkin_time > shift_end_time:\n                    checkin_time = shift_end_time\n                \n                time_diff = frappe.utils.time_diff_in_seconds(checkin_time, last_checkin_time)\n                total_working_seconds = total_working_seconds + time_diff\n                last_checkin_time = None\n            \n            last_log_type = \"OUT\"\n    \n    \n    if last_checkin_time:\n        if last_checkin_time < shift_end_time:\n            last_checkin_time = shift_end_time\n        overtime_end_time = frappe.utils.get_datetime(str(doc.out_time.date()) + \" \" + str(doc.out_time.time()))\n        if last_checkin_time < overtime_end_time:\n            time_diff = frappe.utils.time_diff_in_seconds(overtime_end_time, last_checkin_time)\n            total_overtime_seconds = total_overtime_seconds + time_diff\n\n    total_working_hours = total_working_seconds / 3600\n    total_overtime_hours = total_overtime_seconds / 3600\n\n    total_working_hours = round(total_working_hours, 2)\n    total_overtime_hours = round(total_overtime_hours, 2)\n\n\n    doc.working_hours = total_working_hours\n    \n    \n    \n    \n    \n    \n    \n    total_seconds_in_company = 0\n    last_checkin_time = None\n  \n    for emp_ch in emp_ch_list:\n        emp_ch_doc = frappe.get_doc(\"Employee Checkin\", emp_ch.name)\n        checkin_time = frappe.utils.get_datetime(emp_ch_doc.time)\n    \n        if emp_ch_doc.log_type == \"IN\":\n            if last_checkin_time is None:\n                last_checkin_time = checkin_time\n        elif emp_ch_doc.log_type == \"OUT\" and last_checkin_time:\n            time_diff = frappe.utils.time_diff_in_seconds(checkin_time, last_checkin_time)\n            total_seconds_in_company = total_seconds_in_company + time_diff\n            last_checkin_time = None\n    \n    total_hours_in_company = total_seconds_in_company / 3600\n    total_hours_in_company = round(total_hours_in_company, 2)\n    \n    if emp_doc.custom_overtime_status == 'Yes' :\n        doc.custom_over_time_hours = total_hours_in_company - total_working_hours\n            \n            \n            \n            \n            \n            \n            \n            \n            \nif doc.status == 'On Leave':\n\n    start_datetime = frappe.utils.get_datetime(doc.attendance_date)\n    end_datetime = frappe.utils.add_to_date(start_datetime, hours=23, minutes=59, seconds=59)\n\n    emp_ch_list = frappe.get_list(\"Employee Checkin\",\n            filters={\n                'employee': doc.employee,\n                'time': [\"Between\", (start_datetime, end_datetime)],\n            },\n            order_by='time',)\n\n    if emp_ch_list :\n\n        shift_doc = frappe.get_doc(\"Shift Type\", doc.shift)\n        s_t = frappe.utils.get_time(shift_doc.start_time)\n        e_t = frappe.utils.get_time(shift_doc.end_time)\n        \n        shift_start_time = frappe.utils.get_datetime(str(doc.attendance_date) + \" \" + str(s_t))\n        shift_end_time = frappe.utils.get_datetime(str(doc.attendance_date) + \" \" + str(e_t))\n    \n            \n        \n        total_working_seconds = 0\n        total_overtime_seconds = 0\n        last_checkin_time = None\n        last_log_type = None\n        \n        for emp_ch in emp_ch_list:\n            emp_ch_doc = frappe.get_doc(\"Employee Checkin\", emp_ch.name)\n            \n            checkin_time = frappe.utils.get_datetime(emp_ch_doc.time)\n            \n            if checkin_time < shift_start_time:\n                overtime_start_time = checkin_time\n                checkin_time = shift_start_time\n                \n                time_diff = frappe.utils.time_diff_in_seconds(checkin_time, overtime_start_time)\n                total_overtime_seconds = total_overtime_seconds + time_diff\n            elif checkin_time > shift_end_time:\n                \n                overtime_end_time = checkin_time\n                checkin_time = shift_end_time\n                time_diff = frappe.utils.time_diff_in_seconds(overtime_end_time, checkin_time)\n                total_overtime_seconds = total_overtime_seconds + time_diff\n            \n            if emp_ch_doc.log_type == \"IN\":\n                if last_log_type != \"IN\":\n                    last_checkin_time = checkin_time\n                last_log_type = \"IN\"\n            \n            elif emp_ch_doc.log_type == \"OUT\" and last_checkin_time:\n                if last_log_type == \"IN\":\n                    if checkin_time > shift_end_time:\n                        checkin_time = shift_end_time\n                    \n                    time_diff = frappe.utils.time_diff_in_seconds(checkin_time, last_checkin_time)\n                    total_working_seconds = total_working_seconds + time_diff\n                    last_checkin_time = None\n                \n                last_log_type = \"OUT\"\n        \n        \n        if last_checkin_time:\n            if last_checkin_time < shift_end_time:\n                last_checkin_time = shift_end_time\n            overtime_end_time = frappe.utils.get_datetime(str(doc.out_time.date()) + \" \" + str(doc.out_time.time()))\n            if last_checkin_time < overtime_end_time:\n                time_diff = frappe.utils.time_diff_in_seconds(overtime_end_time, last_checkin_time)\n                total_overtime_seconds = total_overtime_seconds + time_diff\n    \n        total_working_hours = total_working_seconds / 3600\n        total_overtime_hours = total_overtime_seconds / 3600\n    \n        total_working_hours = round(total_working_hours, 2)\n        total_overtime_hours = round(total_overtime_hours, 2)\n    \n\n        total_seconds_in_company = 0\n        last_checkin_time = None\n        \n        for emp_ch in emp_ch_list:\n            emp_ch_doc = frappe.get_doc(\"Employee Checkin\", emp_ch.name)\n            checkin_time = frappe.utils.get_datetime(emp_ch_doc.time)\n        \n            if emp_ch_doc.log_type == \"IN\":\n                if last_checkin_time is None:\n                    last_checkin_time = checkin_time\n        \n            elif emp_ch_doc.log_type == \"OUT\" and last_checkin_time:\n                time_diff = frappe.utils.time_diff_in_seconds(checkin_time, last_checkin_time)\n                total_seconds_in_company = total_seconds_in_company + time_diff\n                last_checkin_time = None\n        \n    \n        total_hours_in_company = total_seconds_in_company / 3600\n        total_hours_in_company = round(total_hours_in_company, 2)\n        \n        \n        \n        \n        if emp_doc.custom_overtime_status == 'Yes' :\n            doc.custom_over_time_hours = total_hours_in_company - total_working_hours\n \n            \n            \n            \n            \n            \n            \n            \n            \n      ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-23 13:25:34.187631",
  "module": null,
  "name": "Overtime Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance",
  "script": "\n\n\not_st = frappe.db.get_value(\"Employee\",doc.employee,'custom_overtime_status')\n\nif ot_st != 'Yes' :\n    frappe.db.set_value(\"Attendance\",doc.name,'custom_overtime_hours',0)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-27 14:00:12.588347",
  "module": null,
  "name": "Setting Project Visit Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Event",
  "script": "if doc.custom_project:\n    frappe.db.set_value(\"Project\", doc.custom_project, \"custom_project_status\", \"Visited\")\n       ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-27 15:44:50.327696",
  "module": null,
  "name": "Checking number of Sales Plan on Projects",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Event",
  "script": "\nif doc.custom_project:\n    # Count remaining records with this custom_project (excluding current doc)\n    remaining_count = frappe.db.count(\n        doc.doctype,\n        filters={\n            \"custom_project\": doc.custom_project,\n            \"name\": [\"!=\", doc.name]  # Exclude current document\n        }\n    )\n    \n    # If this is the last record, update project status to \"Not Visited\"\n    if remaining_count == 0:\n        frappe.db.set_value(\"Project\", doc.custom_project, \"custom_project_status\", \"Not Visited\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-12 09:51:55.896221",
  "module": null,
  "name": "Update Finished Goods Quantity In Manufacture Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "\n\n# if doc.custom_manufacture_order :\n#     mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n#     for x in doc.custom_finished_goods :\n        \n#         for y in mo_doc.item_table :\n            \n#             if x.finished_goods_item == y.item_code :\n                \n#                 if not y.used_quantity :\n#                     y.used_quantity = 0\n                \n#                 used_qty = y.used_quantity + x.incoming_quantity\n                \n                \n#                 frappe.db.set_value( y.doctype , y.name , 'used_quantity' , used_qty )\n                \n#                 rem_qty = y.max_quantity - used_qty\n                \n#                 frappe.db.set_value( y.doctype , y.name , 'remaining_quantity' , rem_qty )\n                \n#                 # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                \n#                 break\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# if doc.custom_manufacture_order :\n#     mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n#     for x in doc.custom_finished_goods :\n        \n#         for y in mo_doc.raw_material_item :\n            \n#             if x.finished_goods_item == y.coil_item_code_rm :\n                \n#                 if not y.coil_item_used_qty :\n#                     y.coil_item_used_qty = 0\n                \n#                 used_qty = y.coil_item_used_qty + x.incoming_quantity\n                \n                \n#                 frappe.db.set_value( y.doctype , y.name , 'coil_item_used_qty' , used_qty )\n                \n#                 rem_qty = y.coil_item_max_qty - used_qty\n                \n#                 frappe.db.set_value( y.doctype , y.name , 'coil_item_remaining_qty' , rem_qty )\n                \n#                 # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                \n#                 break\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nif doc.custom_manufacture_order :\n    mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n    for x in doc.items :\n        \n        \n        if x.custom_raw_material == 1 :\n            for y in mo_doc.raw_material_summary :\n                \n                if x.item_code == y.material_item_code and x.uom == y.material_item_uom :\n                    \n                    if not y.material_item_used_qty :\n                        y.material_item_used_qty = 0\n                    \n                    used_qty = y.material_item_used_qty + x.qty\n                    \n                    \n                    frappe.db.set_value( y.doctype , y.name , 'material_item_used_qty' , used_qty )\n                    \n                    rem_qty = y.material_item_max_qty - used_qty\n                    \n                    frappe.db.set_value( y.doctype , y.name , 'material_item_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n        \n        \n        elif x.custom_accessory_item == 1 :\n            for z in mo_doc.accessory_summary :\n                \n                if x.item_code == z.item_code_linked and x.uom == z.uom :\n                    \n                    if not z.used_qty :\n                        z.used_qty = 0\n                    \n                    used_qty = z.used_qty + x.qty\n                    \n                    \n                    frappe.db.set_value( z.doctype , z.name , 'used_qty' , used_qty )\n                    \n                    rem_qty = z.max_qty - used_qty\n                    \n                    frappe.db.set_value( z.doctype , z.name , 'remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n                \n        \n        elif x.custom_consumable_item == 1 :\n            for a in mo_doc.consumable_cost :\n                \n                if x.item_code == a.item and x.uom == a.uom :\n                    \n                    if not a.used_quantity :\n                        a.used_quantity = 0\n                    \n                    used_qty = a.used_quantity + x.qty\n                    \n                    \n                    frappe.db.set_value( a.doctype , a.name , 'used_quantity' , used_qty )\n                    \n                    rem_qty = a.max_quantity - used_qty\n                    \n                    frappe.db.set_value( a.doctype , a.name , 'remaining_quantity' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n\n\n\n\n\n\n\n\n\n\n\n\n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-12 09:52:54.667427",
  "module": null,
  "name": "Update Finished Goods Quantity In Manufacture Order On Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "\n\n# if doc.custom_manufacture_order :\n#     mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n#     for x in doc.custom_finished_goods :\n        \n#         for y in mo_doc.item_table :\n            \n#             if x.finished_goods_item == y.item_code :\n                \n#                 if not y.used_quantity :\n#                     y.used_quantity = 0\n                \n#                 used_qty = y.used_quantity - x.incoming_quantity\n                \n                \n#                 frappe.db.set_value( y.doctype , y.name , 'used_quantity' , used_qty )\n                \n#                 rem_qty = y.max_quantity - used_qty\n                \n#                 frappe.db.set_value( y.doctype , y.name , 'remaining_quantity' , rem_qty )\n                \n#                 # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                \n#                 break\n            \n            \n            \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nif doc.custom_manufacture_order :\n    mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n    for x in doc.items :\n        \n        if x.custom_raw_material == 1 :\n            for y in mo_doc.raw_material_summary :\n                \n                if x.item_code == y.material_item_code and x.uom == y.material_item_uom :\n                    \n                    if not y.material_item_used_qty :\n                        y.material_item_used_qty = 0\n                    \n                    used_qty = y.material_item_used_qty - x.qty\n                    \n                    \n                    frappe.db.set_value( y.doctype , y.name , 'material_item_used_qty' , used_qty )\n                    \n                    rem_qty = y.material_item_max_qty - used_qty\n                    \n                    frappe.db.set_value( y.doctype , y.name , 'material_item_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n                \n        \n        elif x.custom_accessory_item == 1 :\n            for z in mo_doc.accessory_summary :\n                \n                if x.item_code == z.item_code_linked and x.uom == z.uom :\n                    \n                    if not z.used_qty :\n                        z.used_qty = 0\n                    \n                    used_qty = z.used_qty - x.qty\n                    \n                    \n                    frappe.db.set_value( z.doctype , z.name , 'used_qty' , used_qty )\n                    \n                    rem_qty = z.max_qty - used_qty\n                    \n                    frappe.db.set_value( z.doctype , z.name , 'remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n                \n        \n        elif x.custom_consumable_item == 1 :\n            for a in mo_doc.consumable_cost :\n                \n                if x.item_code == a.item and x.uom == a.uom :\n                    \n                    if not a.used_quantity :\n                        a.used_quantity = 0\n                    \n                    used_qty = a.used_quantity - x.qty\n                    \n                    \n                    frappe.db.set_value( a.doctype , a.name , 'used_quantity' , used_qty )\n                    \n                    rem_qty = a.max_quantity - used_qty\n                    \n                    frappe.db.set_value( a.doctype , a.name , 'remaining_quantity' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n            \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-29 14:19:01.505017",
  "module": null,
  "name": "Checking Project Sales Plan",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Project",
  "script": "sales_plan = frappe.db.exists(\n        \"Event\",\n        {\"custom_project\": doc.name}\n    )\n    \nif sales_plan:\n    doc.custom_project_status = \"Visited\"\n\nelse:\n    doc.custom_project_status = \"Not Visited\"",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-12 11:55:56.785872",
  "module": null,
  "name": "Update Raw Material Quantity In Manufacture Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "\n\nif doc.custom_manufacture_order and doc.custom_manufacture_order_purpose == 'Material Consumption' :\n    mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n    for x in doc.items :\n        \n        if x.custom_raw_material == 1 :\n        \n            for y in mo_doc.raw_material_item :\n                \n                if x.item_code == y.coil_item_code_rm and x.custom_finished_goods_item == y.fl_item :\n                    \n                    if not y.coil_item_used_qty :\n                        y.coil_item_used_qty = 0\n                    \n                    used_qty = y.coil_item_used_qty + x.qty\n                    \n                    \n                    frappe.db.set_value( y.doctype , y.name , 'coil_item_used_qty' , used_qty )\n                    \n                    rem_qty = y.coil_item_max_qty - used_qty\n                    \n                    frappe.db.set_value( y.doctype , y.name , 'coil_item_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n              \n              \n                \n        elif x.custom_accessory_item == 1 :\n        \n            for z in mo_doc.accessory_summary :\n                \n                if x.item_code == z.item_code_linked and x.uom == z.uom :\n                    \n                    if not z.se_used_qty :\n                        z.se_used_qty = 0\n                    \n                    used_qty = z.se_used_qty + x.qty\n                    \n                    \n                    frappe.db.set_value( z.doctype , z.name , 'se_used_qty' , used_qty )\n                    \n                    rem_qty = z.se_max_qty - used_qty\n                    \n                    frappe.db.set_value( z.doctype , z.name , 'se_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n                \n        \n        \n        elif x.custom_consumable_item == 1 :\n        \n            for a in mo_doc.consumable_cost :\n                \n                if x.item_code == a.item and x.uom == a.uom :\n                    \n                    if not a.se_used_quantity :\n                        a.se_used_quantity = 0\n                    \n                    used_qty = a.se_used_quantity + x.qty\n                    \n                    \n                    frappe.db.set_value( a.doctype , a.name , 'se_used_quantity' , used_qty )\n                    \n                    rem_qty = a.se_max_quantity - used_qty\n                    \n                    frappe.db.set_value( a.doctype , a.name , 'se_remaining_quantity' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-12 11:59:20.652461",
  "module": null,
  "name": "Update Raw Material Quantity In Manufacture Order On Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "\n\nif doc.custom_manufacture_order and doc.custom_manufacture_order_purpose == 'Material Consumption' :\n    mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n    for x in doc.items :\n        \n        if x.custom_raw_material == 1 :\n        \n            for y in mo_doc.raw_material_item :\n                \n                if x.item_code == y.coil_item_code_rm and x.custom_finished_goods_item == y.fl_item :\n                    \n                    if not y.coil_item_used_qty :\n                        y.coil_item_used_qty = 0\n                    \n                    used_qty = y.coil_item_used_qty - x.qty\n                    \n                    \n                    frappe.db.set_value( y.doctype , y.name , 'coil_item_used_qty' , used_qty )\n                    \n                    rem_qty = y.coil_item_max_qty - used_qty\n                    \n                    frappe.db.set_value( y.doctype , y.name , 'coil_item_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n        \n                \n        elif x.custom_accessory_item == 1 :\n        \n            for z in mo_doc.accessory_summary :\n                \n                if x.item_code == z.item_code_linked and x.uom == z.uom :\n                    \n                    if not z.se_used_qty :\n                        z.se_used_qty = 0\n                    \n                    used_qty = z.se_used_qty - x.qty\n                    \n                    \n                    frappe.db.set_value( z.doctype , z.name , 'se_used_qty' , used_qty )\n                    \n                    rem_qty = z.se_max_qty - used_qty\n                    \n                    frappe.db.set_value( z.doctype , z.name , 'se_remaining_qty' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n                \n        \n        elif x.custom_consumable_item == 1 :\n        \n            for a in mo_doc.consumable_cost :\n                \n                if x.item_code == a.item and x.uom == a.uom :\n                    \n                    if not a.se_used_quantity :\n                        a.se_used_quantity = 0\n                    \n                    used_qty = a.se_used_quantity - x.qty\n                    \n                    \n                    frappe.db.set_value( a.doctype , a.name , 'se_used_quantity' , used_qty )\n                    \n                    rem_qty = a.se_max_quantity - used_qty\n                    \n                    frappe.db.set_value( a.doctype , a.name , 'se_remaining_quantity' , rem_qty )\n                    \n                    # frappe.msgprint( str(y.doctype) + \" \" + str(y.name) + \" \" + str(y.used_quantity)  + \" \" + str(used_qty) )\n                    \n                    break\n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-13 12:11:47.738375",
  "module": null,
  "name": "Insert Additional Cost Row",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "\n\nif doc.docstatus != 1 :\n\n    if doc.custom_manufacture_order and doc.custom_manufacture_order_purpose == 'Finished Goods Creation' :\n        \n        cost = 0\n        per_unit_cost = 0\n        \n        total_over_head_cost = frappe.db.get_value('Manufacture Order' , doc.custom_manufacture_order, 'total_over_head_cost')\n        total_operation_cost = frappe.db.get_value('Manufacture Order' , doc.custom_manufacture_order, 'total_operation_cost_')\n        total_fg_item_quantity = frappe.db.get_value('Manufacture Order' , doc.custom_manufacture_order, 'total_fg_item_quantity')\n        \n        if total_fg_item_quantity > 0 :\n            per_unit_cost = (total_over_head_cost + total_operation_cost) / total_fg_item_quantity\n            \n        \n        # acc = frappe.db.get_single_value('Manufacturing Order Settings', 'over_head_cost_valuation_account')\n    \n    \n        t_qty = 0\n        mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n        \n        for x in doc.items :\n            for y in mo_doc.item_table :\n                if x.item_code == y.item_code :\n                    t_qty = t_qty + x.qty\n                    break\n        \n        \n        \n        if mo_doc.per_unit_over_head_cost :\n            cost = per_unit_cost * t_qty\n        \n        \n        # doc.additional_costs = []\n        # doc.append('additional_costs' , {\n        #     'expense_account' : acc ,\n        #     'description' : \"Over Head Cost\" ,\n        #     'amount' : cost  ,\n        # })\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    # if doc.custom_manufacture_order and doc.custom_manufacture_order_purpose == 'Material Consumption' :\n        \n    #     x=1\n    #     if doc.items :\n    #         for x in doc.items :\n                \n    #             bin_list = frappe.db.get_list('Bin',\n    #                             filters={\n    #                                 'item_code' : x.item_code ,\n    #                                 'warehouse' : x.s_warehouse ,\n    #                             },\n    #                             fields = ['name', 'actual_qty']\n    #                         )\n                \n    #             if bin_list :\n                    \n    #                 for y in bin_list :\n\n    #                     # frappe.db.set_value('Bin', y.name, 'valuation_rate', x.custom_manufacture_order_rate)\n    #                     # frappe.db.set_value('Bin', y.name, 'stock_value', bin_doc.actual_qty * bin_doc.valuation_rate )\n                        \n    #                     bin_doc = frappe.get_doc('Bin', y.name)\n    #                     bin_doc.delete(\n    #                         ignore_permissions = True\n    #                         )\n                        \n                        \n                        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        \n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-29 10:10:12.585986",
  "module": null,
  "name": "Check Parent Finished Good From Duct Table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication List",
  "script": "\n\n########################################################## GroupBy Duct / Accessory Item #############################################################\ndoc.duct_and_acc_item = []\ndoc.acc_item = []\ndoc.acc_item1 = []\n\nfab_unique_items = {}\n\nif doc.fabrication_table:\n    \n    for row in doc.fabrication_table:\n        unique_key = row.spl_item_fg_code\n        \n        if unique_key not in fab_unique_items:\n            fab_unique_items[unique_key] = {\n                \"item_code\" : row.spl_item_fg_code,\n                \"item_name\" : row.spl_item_fg_name,\n                \"uom\" : row.spl_item_fg_uom,\n                \"qty\" : row.spl_qty_in_pcs,\n                \"spl_area_sqm\" : row.spl_area_sqm,\n                \"spl_weight_kg\" : row.spl_weight_kg,\n                \"duct_range\" : row.duct_range ,\n            }\n        else:\n            fab_unique_items[unique_key][\"qty\"] = fab_unique_items[unique_key][\"qty\"] + row.spl_qty_in_pcs\n            fab_unique_items[unique_key][\"spl_area_sqm\"] = fab_unique_items[unique_key][\"spl_area_sqm\"] + row.spl_area_sqm\n            fab_unique_items[unique_key][\"spl_weight_kg\"] = fab_unique_items[unique_key][\"spl_weight_kg\"] + row.spl_weight_kg\n            \n            \n            \n    for key, value in fab_unique_items.items():\n        doc.append(\"duct_and_acc_item\", {\n            # \"parent_fg\": 1,\n            \"item_code\": value[\"item_code\"],\n            \"item_name\" : value[\"item_name\"],\n            \"uom\": value[\"uom\"],\n            \"qty\": value[\"qty\"],\n            \"spl_area_sqm\": value[\"spl_area_sqm\"],\n            \"spl_weight_kg\": value[\"spl_weight_kg\"],\n            \"duct_range\" : value[\"duct_range\"]\n        })\n        \n        \n\n\n\nunique_items = {}\n\nif doc.accessory:\n    for row in doc.accessory:\n        unique_key = (row.child_finished_good_item, row.child_finished_good_uom)\n        \n        if unique_key not in unique_items:\n            unique_items[unique_key] = {\n                \"item_code\" : row.child_finished_good_item,\n                \"item_name\" : row.child_finished_good_item_name,\n                \"uom\" : row.child_finished_good_uom,\n                \"qty\" : row.child_finished_good_qty\n            }\n        else:\n            unique_items[unique_key][\"qty\"] = unique_items[unique_key][\"qty\"] + row.child_finished_good_qty\n\n    for key, value in unique_items.items():\n        doc.append(\"acc_item\", {\n            # \"accessory\": 1,\n            \"item_code\": value[\"item_code\"],\n            \"item_name\" : value[\"item_name\"],\n            \"uom\": value[\"uom\"],\n            \"qty\": value[\"qty\"],\n        })\n    for key, value in unique_items.items():\n        doc.append(\"acc_item1\", {\n            # \"accessory\": 1,\n            \"item_code\": value[\"item_code\"],\n            \"item_name\" : value[\"item_name\"],\n            \"uom\": value[\"uom\"],\n            \"qty\": value[\"qty\"],\n        })\n###################################################### GroupBy Duct / Accessory Item #########################################################\n        \n\n\n\n\n\n\n###################################################### GroupBy Material Item #########################################################\ndoc.material_summary = []\ndoc.material_list1 = []\n\nmat_unique_items = {}\n\n# doc.material_list1 = doc.material_list\n# frappe.db.set_value('Fabrication List' , doc.name , 'material_list1' , doc.material_list)\n\nif doc.material_list:\n    \n    for row in doc.material_list:\n        \n        \n        doc.append('material_list1',{\n            \n            'fl_item' : row.fl_item  ,\n            'fl_item_link' : row.fl_item_link  ,\n            'fl_item_uom' : row.fl_item_uom  ,\n            'fl_item_uom_link' : row.fl_item_uom_link  ,\n            'fl_item_brand' : row.fl_item_brand  ,\n            'fl_item_brand_link' : row.fl_item_brand_link  ,\n            'fl_item_specification' : row.fl_item_specification  ,\n            'fl_item_group' : row.fl_item_group  ,\n            'fl_item_group_link' : row.fl_item_group_link  ,\n            \n            \n            \n            \n            'spl_item_fg_code' : row.spl_item_fg_code  ,\n            'spl_item_fg_code_link' : row.spl_item_fg_code_link  ,\n            'spl_item_fg_name' : row.spl_item_fg_name  ,\n            'spl_item_fg_uom' : row.spl_item_fg_uom  ,\n            'spl_item_fg_uom_link' : row.spl_item_fg_uom_link  ,\n            'spl_item_fg_brand' : row.spl_item_fg_brand  ,\n            'spl_item_fg_brand_link' : row.spl_item_fg_brand_link  ,\n            'spl_item_fg_specification' : row.spl_item_fg_specification  ,\n            'spl_item_fg_item_group' : row.spl_item_fg_item_group  ,\n            'spl_item_fg_item_group_link' : row.spl_item_fg_item_group_link  ,\n            \n            \n            \n            \n            'coil_item_code_rm' : row.coil_item_code_rm ,\n            'coil_item_code_rm_link' : row.coil_item_code_rm_link ,\n            'coil_item_uom' : row.coil_item_uom ,\n            'coil_item_uom_link' : row.coil_item_uom_link ,\n            'coil_item_brand' : row.coil_item_brand ,\n            'coil_item_brand_link' : row.coil_item_brand_link ,\n            'coil_item_specification' : row.coil_item_specification ,\n            'coil_item_group' : row.coil_item_group ,\n            'coil_item_group_link' : row.coil_item_group_link ,\n            'coil_item_qty' : row.coil_item_qty ,\n            \n            \n            \n            \n            'fl_item_gauge' : row.fl_item_gauge  ,\n            'sum_of_fl_item_qty' : row.sum_of_fl_item_qty  ,\n            'auto_fold_qty' : row.auto_fold_qty  ,\n            'nesting_qty' : row.nesting_qty  ,\n            \n            \n            \n            'sum_of_duct_weight' : row.sum_of_duct_weight  ,\n            'sum_of_duct_area_with_seam' : row.sum_of_duct_area_with_seam  ,\n            'fg_batch_sr' : row.fg_batch_sr  ,\n            \n        \n        })\n        \n        \n        \n        unique_key = (row.coil_item_code_rm, row.coil_item_uom, row.coil_item_brand, row.spl_item_fg_code, row.fl_item_gauge )\n        \n        if unique_key not in mat_unique_items:\n            mat_unique_items[unique_key] = {\n                \"parent_finished_good\" : row.spl_item_fg_code ,\n                \"item_code\" : row.coil_item_code_rm,\n                \"item_brand\" : row.coil_item_brand,\n                \"uom\" : row.coil_item_uom,\n                \"qty\" : row.coil_item_qty,\n                \"fl_item_gauge\" : row.fl_item_gauge ,\n                \"sum_of_fl_item_qty\" : row.sum_of_fl_item_qty,\n                \"sum_of_duct_weight\" : row.sum_of_duct_weight ,\n                \"sum_of_duct_area_with_seam\" : row.sum_of_duct_area_with_seam ,\n                \"fl_item_specification\" : row.fl_item_specification ,\n            }\n        else:\n            mat_unique_items[unique_key][\"qty\"] = mat_unique_items[unique_key][\"qty\"] + row.coil_item_qty\n            mat_unique_items[unique_key][\"sum_of_fl_item_qty\"] = mat_unique_items[unique_key][\"sum_of_fl_item_qty\"] + row.sum_of_fl_item_qty\n            mat_unique_items[unique_key][\"sum_of_duct_weight\"] = mat_unique_items[unique_key][\"sum_of_duct_weight\"] + row.sum_of_duct_weight\n            mat_unique_items[unique_key][\"sum_of_duct_area_with_seam\"] = mat_unique_items[unique_key][\"sum_of_duct_area_with_seam\"] + row.sum_of_duct_area_with_seam\n\n    for key, value in mat_unique_items.items():\n        doc.append(\"material_summary\", {\n            \"parent_finished_good\": value[\"parent_finished_good\"],\n            \"material_item_code\": value[\"item_code\"],\n            \"material_item_brand\" : value[\"item_brand\"],\n            \"material_item_uom\": value[\"uom\"],\n            \"material_item_qty\": value[\"qty\"],\n            \"fl_item_gauge\": value[\"fl_item_gauge\"],\n            \"sum_of_fl_item_qty\": value[\"sum_of_fl_item_qty\"],\n            \"sum_of_duct_weight\": value[\"sum_of_duct_weight\"],\n            \"sum_of_duct_area_with_seam\": value[\"sum_of_duct_area_with_seam\"],\n            \"fl_item_specification\" : value[\"fl_item_specification\"] ,\n        })\n###################################################### GroupBy Material Item #########################################################\n\n\n\n\n\n\n\n\n################################################## Check Parent Finished Good From Duct Table #####################################################\nif doc.accessory :\n    for acc in doc.accessory :\n        sig = 0\n        for fab in doc.fabrication_table :\n            \n            if fab.spl_item_fg_code == acc.parent_finished_good_item :\n                sig = 1\n                break\n        if sig == 0:\n            frappe.throw(f'Parent FG {acc.parent_finished_good_item} of Accessory Table is not define in the Duct Table.')\n            \n\n\nif doc.material_list :\n    for mat in doc.material_list :\n        sig1 = 0\n        for fab in doc.fabrication_table :\n            if fab.spl_item_fg_code == mat.spl_item_fg_code :\n                sig1 = 1\n                break\n        if sig1 == 0 :\n            frappe.throw(f'Parent FG {mat.spl_item_fg_code} in Raw Materials Table is not define in the Duct Table.')\n################################################## Check Parent Finished Good From Duct Table #####################################################\n\n                \n\n\n\n\n\n\n\n\n\n################################################## Fabrication List Table #####################################################\n\ndoc.fabrication_list_table = []\n\nif doc.fabrication_table :\n    \n    for row in doc.fabrication_table :\n        \n        doc.append('fabrication_list_table',{\n            'fl_item_ref_notes' : row.fl_item_ref_notes ,\n            'fl_item' : row.fl_item ,\n            'fl_item_name' : row.fl_item_name ,\n            'dim_1' : row.dim_1 ,\n            'dim_2' : row.dim_2 ,\n            'dim_3' : row.dim_3 ,\n            'dim_4' : row.dim_4 ,\n            'pl_item_length__angle' : row.pl_item_length__angle ,\n            'fl_item_gauge' : row.fl_item_gauge ,\n            'fl_item_qty' : row.fl_item_qty ,\n            'duct_connector_1' : row.duct_connector_1 ,\n            'duct_connector_2' : row.duct_connector_2 ,\n            # 'fl_item_vanes_splitter_qty_1' : row.fl_item_vanes_splitter_qty_1 ,\n            # 'fl_item_duct_seam_1' : row.fl_item_duct_seam_1 ,\n            'cam_item_vanes_splitter_qty_1' : row.cam_item_vanes_splitter_qty_1 ,\n            'cam_item_duct_seam_1' : row.cam_item_duct_seam_1 ,\n            'duct_range' : row.duct_range ,\n            'fl_item_specification' : row.fl_item_specification ,\n        })\n\n\n################################################## Fabrication List Table #####################################################\n\n\n\n\n################################################## Auto Fold List #####################################################\ndoc.auto_fold_list = []\n\nif doc.fabrication_table :\n    \n    for row in doc.fabrication_table :\n        \n        if row.fl_item_specification in ['Straight.', 'Straight'] and ( float(row.pl_item_length__angle) == 1220 or float(row.pl_item_length__angle) == 1200 ) :\n        \n            coil_item_qty = 0\n            coil_item_uom = None\n            if doc.material_list :\n                for row1 in doc.material_list :\n                    if row1.fl_item == row.fl_item :\n                        coil_item_qty = row1.coil_item_qty\n                        coil_item_uom = row1.coil_item_uom\n                        break\n                        \n            \n            doc.append('auto_fold_list',{\n                'fl_item' : row.fl_item ,\n                'fl_item_specification' : row.fl_item_specification ,\n                'dim_1' : row.dim_1 ,\n                'dim_2' : row.dim_2 ,\n                'dim_3' : row.dim_3 ,\n                'dim_4' : row.dim_4 ,\n                'pl_item_length__angle' : row.pl_item_length__angle ,\n                'fl_item_gauge' : row.fl_item_gauge ,\n                'fl_item_qty' : row.fl_item_qty ,\n                'duct_connector_1' : row.duct_connector_1 ,\n                'duct_connector_2' : row.duct_connector_2 ,\n                'coil_item_qty' : coil_item_qty ,\n                'coil_item_uom' : coil_item_uom ,\n                'duct_range' : row.duct_range ,\n                \n            })\n    \n################################################## Auto Fold List #####################################################\n\n\n################################################## Auto Fold Summary #####################################################\ndoc.auto_fold_summary = []\ntotal_fl_item_qty = 0\ntotal_coil_item_qty = 0\n\nif doc.auto_fold_list :\n    \n    autofold_unique_items = {}\n    total_fl_item_qty = 0\n    total_coil_item_qty = 0\n    \n    for row in doc.auto_fold_list:\n        unique_key = ( row.fl_item_gauge , row.pl_item_length__angle, row.coil_item_uom, row.duct_range )\n        \n        if unique_key not in autofold_unique_items:\n            autofold_unique_items[unique_key] = {\n                \"fl_item_name_description\" : row.fl_item_specification,\n                \"fl_item_gauge\" : row.fl_item_gauge,\n                \"fl_item_qty\" : row.fl_item_qty,\n                \"coil_item_qty\" : row.coil_item_qty,\n                \"pl_item_length__angle\" : row.pl_item_length__angle,\n                \"coil_item_uom\" : row.coil_item_uom,\n                \"duct_range\" : row.duct_range ,\n            }\n        else:\n            autofold_unique_items[unique_key][\"fl_item_qty\"] = autofold_unique_items[unique_key][\"fl_item_qty\"] + row.fl_item_qty\n            autofold_unique_items[unique_key][\"coil_item_qty\"] = autofold_unique_items[unique_key][\"coil_item_qty\"] + row.coil_item_qty\n            \n        total_fl_item_qty = total_fl_item_qty + row.fl_item_qty\n        total_coil_item_qty = total_coil_item_qty + row.coil_item_qty\n            \n    for key, value in autofold_unique_items.items():\n        doc.append(\"auto_fold_summary\", {\n            \"fl_item_name_description\": value[\"fl_item_name_description\"],\n            \"fl_item_gauge\" : value[\"fl_item_gauge\"],\n            \"fl_item_qty\": value[\"fl_item_qty\"],\n            \"coil_item_qty\": value[\"coil_item_qty\"],\n            \"pl_item_length__angle\": value[\"pl_item_length__angle\"],\n            \"coil_item_uom\": value[\"coil_item_uom\"],\n            \"duct_range\" : value[\"duct_range\"] ,\n        })\n    \n    \ndoc.total_fl_item_qty = total_fl_item_qty\ndoc.total_coil_item_qty = total_coil_item_qty\n\n    \n\n\n\n        \n    \n################################################## Auto Fold Summary #####################################################\n\n\n\n\n\n\n\n\n\n\n\n    \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-02-07 17:46:00.296202",
  "module": null,
  "name": "Unique Product Bundle Items",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Product Bundle",
  "script": "if doc.items:\n    item_dict = {}\n\n    for row in doc.items:\n        item_code = row.item_code\n\n        if item_code in item_dict:\n            item_dict[item_code][\"qty\"] = item_dict[item_code][\"qty\"] + row.qty  # Summing qty\n        else:\n            item_dict[item_code] = {\n                \"qty\": row.qty,\n                \"description\": row.description,\n                \"uom\": row.uom\n            }\n\n\n    doc.items = []\n\n\n    for item_code, values in item_dict.items():\n        doc.append(\"items\", {\n            \"item_code\": item_code,\n            \"qty\": values[\"qty\"],\n            \"description\": values[\"description\"],\n            \"uom\": values[\"uom\"]\n        })\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-12 13:57:03.703266",
  "module": null,
  "name": "Calculate Days Before And After Joining And Relieving",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "doc.custom_days_before_joining = 0\r\ndoc.custom_days_after_relieving = 0\r\n\r\njoining_date =frappe.db.get_value('Employee' , doc.employee , 'date_of_joining' )\r\nrelieving_date = frappe.db.get_value('Employee' , doc.employee , 'relieving_date' )\r\n\r\n\r\n\r\nif joining_date :\r\n    \r\n    if str(doc.start_date) < str(joining_date) :\r\n        \r\n        days_before = frappe.utils.date_diff(joining_date , doc.start_date)\r\n        \r\n        # frappe.msgprint(str(days_before))\r\n        \r\n        doc.custom_days_before_joining = days_before\r\n    \r\n\r\n\r\n\r\nif relieving_date :\r\n    \r\n    if str(relieving_date) < str(doc.end_date) :\r\n        \r\n        days_after = frappe.utils.date_diff(doc.end_date , relieving_date)\r\n        \r\n        # frappe.msgprint(str(days_after))\r\n        \r\n        doc.custom_days_after_relieving = days_after",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save (Submitted Document)",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-11 16:15:06.567900",
  "module": null,
  "name": "Job Card Update",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Manufacture Order",
  "script": "############################################# JOB CARD #############################################\ntotal_time_spent = 0\ntotal_opr_cost = 0\n\nif doc.job_card :\n    \n    for row in doc.job_card :\n        \n        if row.start == 1 and row.end == 1 :\n            row.operation_cost = row.time_spent * (row.per_hour_rate / 3600)\n            total_time_spent = total_time_spent + row.time_spent\n            total_opr_cost = total_opr_cost + row.operation_cost\n            \n            \ndoc.total_time_spent = total_time_spent\ndoc.total_operation_cost = total_opr_cost\n# doc.total_operation_cost_ = total_opr_cost\n############################################# JOB CARD #############################################\n\n\n\n\n\n\n\n\n\n########################################## CONSUMABLE COST ##########################################\ntotal_consumable_qty = 0\ntotal_consumable_cost = 0\n\nif doc.consumable_cost :\n    \n    for row in doc.consumable_cost :\n        \n        row.amount = (row.quantity or 0) * (row.rate or 0)\n        total_consumable_qty = total_consumable_qty + (row.quantity or 0)\n        total_consumable_cost = total_consumable_cost + (row.amount or 0)\n        \ndoc.total_consumable_quantity = total_consumable_qty\ndoc.total_consumable_cost = total_consumable_cost\ndoc.total_consumable_cost_1 = total_consumable_cost\n########################################## CONSUMABLE COST ##########################################\n\n\n\n\n\n########################################## DELIVERY COST ##########################################\ntotal_delivery_qty = 0\ntotal_delivery_cost = 0\n\nif doc.delivery_cost :\n    \n    for row in doc.delivery_cost :\n        \n        row.amount = (row.quantity or 0) * (row.rate or 0)\n        total_delivery_qty = total_delivery_qty + (row.quantity or 0)\n        total_delivery_cost = total_delivery_cost + (row.amount or 0)\n        \ndoc.total_delivery_quantity = total_delivery_qty\ndoc.total_delivery_cost = total_delivery_cost\ndoc.total_delivery_cost1 = total_delivery_cost\n########################################## DELIVERY COST ##########################################\n\n\n\n\n\n\n\ndoc.grand_total = doc.total_raw_material_cost + doc.total_accessory_item_amount_ + doc.total_operation_cost_ + doc.total_consumable_cost + doc.total_delivery_cost       \n\n\ndoc.total_over_head_cost_ = doc.grand_total * (doc.additional_over_head_cost_percentage/100)\n\ndoc.total_over_head_cost = doc.total_over_head_cost_\n\ndoc.grand_total = doc.grand_total + doc.total_over_head_cost\n\n\n\n\n\n\n\n\n\n############################################# DUCT ITEM PROPORTIONAL COST #############################################\ndoc.duct_item = []\n\nif doc.duct_and_acc_item :\n    t_duct_itm_qty = 0\n    for row in doc.duct_and_acc_item :\n        t_duct_itm_qty = t_duct_itm_qty + row.qty\n        \n    for row in doc.duct_and_acc_item :   \n        cost = 0\n        if t_duct_itm_qty > 0 :\n            cost = doc.grand_total * (row.qty / t_duct_itm_qty)\n        \n        doc.append('duct_item',{\n            'item_code' : row.item_code ,\n            'item_name' : row.item_name ,\n            'uom' : row.uom ,\n            'qty' : row.qty ,\n            'cost' : cost ,\n        })\n        \n############################################# DUCT ITEM PROPORTIONAL COST #############################################        \n        \n        \n        \n        \n        \n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 18:06:17.708147",
  "module": null,
  "name": "Check Remaining RM Qty From Manufacture Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "\n\n\n\n\nif doc.custom_manufacture_order :\n    mo_doc = frappe.get_doc('Manufacture Order', doc.custom_manufacture_order)\n    \n    for x in doc.items :\n        \n        if x.custom_raw_material == 1 :\n            for y in mo_doc.raw_material_summary :\n                \n                if x.item_code == y.material_item_code and x.uom == y.material_item_uom :\n                    \n                    if x.qty > y.material_item_remaining_qty :\n                        frappe.throw(f\"Insufficient remaining quantity for item {x.item_code}. Required: {x.qty}, Available: {y.material_item_remaining_qty}\")\n                    \n                    break\n        \n        \n        elif x.custom_accessory_item == 1 :\n            \n            for z in mo_doc.accessory_summary :\n                \n                if x.item_code == z.item_code_linked and x.uom == z.uom :\n                    \n                    if x.qty > z.remaining_qty :\n                        frappe.throw(f\"Insufficient remaining quantity for item {x.item_code}. Required: {x.qty}, Available: {z.remaining_qty}\")\n                    \n                    break\n        \n        \n                \n                \n        elif x.custom_consumable_item == 1 :\n            \n            for a in mo_doc.consumable_cost :\n                \n                if x.item_code == a.item and x.uom == a.uom :\n                    \n                    if x.qty > a.remaining_quantity :\n                        frappe.throw(f\"Insufficient remaining quantity for item {x.item_code}. Required: {x.qty}, Available: {a.remaining_quantity}\")\n                    \n                    break\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n################################# Average Consumption For Last 90 Days #################################  (Sufyan Script)\n\nif doc.items:\n    \n    from_date = frappe.utils.add_days(frappe.utils.getdate(doc.transaction_date), -90)\n    \n    for x in doc.items:\n        total_qty = 0\n\n        st_ledger_entry_list = frappe.get_all(\n            'Stock Ledger Entry',\n            filters={\n                'item_code': x.item_code,\n                'company': doc.company,\n                'voucher_type': ['in', ['Stock Entry', 'Delivery Note']],\n                'posting_date': ['>', from_date],\n                'posting_date': ['<=', doc.transaction_date]\n            },\n            fields=['item_code', 'voucher_type', 'voucher_no', 'actual_qty']\n        )\n        \n\n        filtered_entries = []\n        for entry in st_ledger_entry_list:\n            \n            if entry.voucher_type == 'Stock Entry':\n                se_type = frappe.db.get_value('Stock Entry', entry.voucher_no, 'stock_entry_type')\n                \n                if se_type in ['Material Issue', 'Material Consumption for Manufacture'] :\n                    filtered_entries.append(entry)\n            \n            elif entry.voucher_type == 'Delivery Note':\n                filtered_entries.append(entry)\n\n\n        if filtered_entries:\n            for entry in filtered_entries:\n                total_qty = total_qty + entry.actual_qty\n            if total_qty < 0:\n                total_qty = -total_qty\n\n        x.custom_average_consumption = total_qty\n                \n################################# Average Consumption For Last 90 Days #################################  (Sufyan Script)            \n            \n\n                \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-07 17:56:53.723206",
  "module": null,
  "name": "test200",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee",
  "script": "\n\n\n\n\n# hrs_list = frappe.db.get_list('Additional Salary',\n#             filters={\n#                 'custom_overtime_hours': None \n#             })\n\n# hrs_list = frappe.db.sql(\"\"\"\n#     SELECT name FROM `tabAdditional Salary`\n#     WHERE custom_basic IS NULL\n# \"\"\", as_dict=True)\n\n\n\n# if hrs_list :\n#     for row in hrs_list :\n#         frappe.msgprint(str(row.name))\n#         frappe.db.set_value('Additional Salary', row.name, 'custom_basic', 0)\n\n\n\n\n# itm_list = frappe.db.get_list('Item',\n#                 filters = {\n#                     # 'disabled' : 0 ,\n#                     # 'custom_barcode' : ['!=' , None]\n#                 },\n                # limit=200\n            # )\n# frappe.msgprint(str(itm_list))\n\n# if itm_list :\n    \n    # for row in itm_list :\n        \n        # itm_doc = frappe.get_doc('Item', row.name)\n        # itm_doc.custom_barcode = row.name\n        # itm_doc.save()\n        \n        # frappe.db.set_value('Item', row.name, 'custom_barcode', None)\n\n        # itm_doc.append('barcodes',\n        # {\n        #     'barcode' : doc.name\n        # })\n\n\n\n# itm_doc = frappe.get_doc('Item', '50')\n# # itm_doc.validate()\n# itm_doc.validate_uom()\n# itm_doc.validate_description()\n# itm_doc.add_default_uom_in_conversion_factor_table()\n# itm_doc.validate_conversion_factor()\n# itm_doc.validate_item_type()\n# itm_doc.validate_naming_series()\n# itm_doc.check_for_active_boms()\n# itm_doc.fill_customer_code()\n# itm_doc.check_item_tax()\n# itm_doc.validate_barcode()\n# # itm_doc.validate_warehouse_for_reorder()\n# itm_doc.update_bom_item_desc()\n\n# itm_doc.validate_has_variants()\n# itm_doc.validate_attributes_in_variants()\n# itm_doc.validate_stock_exists_for_template_item()\n# itm_doc.validate_attributes()\n# itm_doc.validate_variant_attributes()\n# itm_doc.validate_variant_based_on_change()\n# itm_doc.validate_fixed_asset()\n# itm_doc.clear_retain_sample()\n# itm_doc.validate_retain_sample()\n# itm_doc.validate_uom_conversion_factor()\n# itm_doc.validate_customer_provided_part()\n# itm_doc.update_defaults_from_item_group()\n# itm_doc.validate_item_defaults()\n# itm_doc.validate_auto_reorder_enabled_in_stock_settings()\n# itm_doc.cant_change()\n# itm_doc.validate_item_tax_net_rate_range()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# itm_doc = frappe.get_doc('Item','17')\n# itm_doc.disable = 1\n# itm_doc.disable = 0\n# itm_doc.save()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-03-28 09:30:15.197031",
  "module": null,
  "name": "Deduct Count From Manufacture Order Job Operations On Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Operations Transfers",
  "script": "\n\n\n\n\n\n\nif doc.manufacture_order and doc.quality_operation == 1 :\n    \n    mo_doc = frappe.get_doc('Manufacture Order', doc.manufacture_order)\n    \n    if doc.item :\n        \n        for row in doc.item :\n            \n            if row.quality_status == 'Pass' :\n                \n                for row1 in mo_doc.item_table :\n                    \n                    if row1.item_code == row.item_code :\n                        \n                        frappe.db.set_value( row1.doctype , row1.name , 'pass_count' , row1.pass_count-1)\n                        break\n\n\n\n\n\n\nif doc.job_operation_row_name :\n    \n    mo_doc = frappe.get_doc(\"Manufacture Order\", doc.manufacture_order)\n    \n    if mo_doc.job_card :\n        \n        for row in mo_doc.job_card :\n            \n            if row.name == doc.job_operation_row_name :\n                \n                frappe.db.set_value(row.doctype , row.name, \"operations_transfers_created\", row.operations_transfers_created - 1)\n                break\n    \n    # frappe.db.set_value( doc.doctype, doc.name, \"job_operation_row_name\", None)\n    doc.job_operation_row_name = None",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-03-28 09:28:49.484155",
  "module": null,
  "name": "Update Pass Count in Manufacture Order Item Table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Operations Transfers",
  "script": "\n\n\nif doc.manufacture_order and doc.quality_operation == 1 :\n    \n    mo_doc = frappe.get_doc('Manufacture Order', doc.manufacture_order)\n    \n    if doc.item :\n        \n        for row in doc.item :\n            \n            if row.quality_status == 'Pass' :\n                \n                for row1 in mo_doc.item_table :\n                    \n                    if row1.item_code == row.item_code :\n                        \n                        frappe.db.set_value( row1.doctype , row1.name , 'pass_count' , row1.pass_count+1)\n                        break\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-09 10:23:12.132011",
  "module": null,
  "name": "setting barcode number in inverntory",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# doc.custom_barcode = doc.item_code\n\nsig = 0\n\nif doc.barcodes :\n    \n    for row in doc.barcodes :\n        \n        if row.barcode == doc.item_code :\n            sig = 1\n            break\n        \n    if sig == 0 :\n        doc.append('barcodes',\n        {\n            'barcode' : doc.item_code\n        })\n            \nelse :\n    doc.append('barcodes',\n    {\n        'barcode' : doc.item_code\n    })\n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-10 16:04:20.563549",
  "module": null,
  "name": "Testing Barcode",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "\n\n\n\n# doc.custom_barcode_attach = doc.custom_barcode\n\n\n\n# frappe.msgprint(str(doc.custom_barcode))\n\n# frappe.msgprint(str(doc.custom_barcode_attach))\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-14 14:40:56.181518",
  "module": null,
  "name": "Update Manufacture Order On Cancelling Journal Entry",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Journal Entry",
  "script": "\n\nif doc.custom_manufacture_order :\n    frappe.db.set_value('Manufacture Order', doc.custom_manufacture_order, 'jv_created', 0)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-04-18 18:25:00.855468",
  "module": null,
  "name": "Cancel Journal Entry",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Manufacture Order",
  "script": "\n\n\n\nje_list = frappe.get_list(\"Journal Entry\",\n                filters={\n                    'custom_manufacture_order' : doc.name ,\n                    'docstatus' : 1 ,\n          })\n\n\n\nif je_list :\n    \n    for je in je_list :\n        je_doc = frappe.get_doc(\"Journal Entry\", je.name)\n        je_doc.cancel()\n    \n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-20 13:57:24.274852",
  "module": null,
  "name": "Create Quotation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Fabrication Filter",
  "script": "\n\n\n\nif doc.fabrication_filter_items :\n    \n    q_doc = frappe.new_doc('Quotation')\n    q_doc.quotation_to = 'Customer'\n    q_doc.party_name = doc.customer\n    q_doc.company = doc.company\n    q_doc.custom_multi_fabrication = 1\n    q_doc.custom_fabrication_filter = doc.name\n    \n    \n    for row in doc.fabrication_filter_items :\n        q_doc.append('items',{\n            'item_code' : row.item ,\n            'qty' : row.quantity ,\n            'custom_spl_area_sqm' : row.spl_area_sqm ,\n            'custom_spl_weight_kg' : row.spl_weight_kg\n            # 'uom' : row.uom\n        })\n        \n    q_doc.insert()\n    \n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 14:08:35.036295",
  "module": null,
  "name": "Set Parent Items",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "\n\n\n\nif doc.custom_parent_item :\n    \n    for x in doc.custom_parent_item :\n        sel_qty = 0\n\n        for y in doc.items :\n            if x.parent_item == y.custom_parent_item_1 :\n                sel_qty = sel_qty + y.qty\n                \n        x.selected_child_item_qty = sel_qty\n        x.selected_cam_item_qty = (sel_qty / x.child_item_qty) * x.cam_item_qty\n        x.selected_spl_area_sqm = (sel_qty / x.child_item_qty) * x.spl_area_sqm \n        \n        \n        \n        \n        \n        \n        \n        \n    \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 13:31:56.694184",
  "module": null,
  "name": "Set Child Qty In Parent Table",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "\n\n\nif doc.custom_parent_item :\n    for x in doc.custom_parent_item :\n        \n        \n        total_child_qty = 0\n        for y in doc.items :\n            \n            if x.parent_item == y.custom_parent_item_1 :\n                total_child_qty = total_child_qty + y.qty\n                \n        x.child_item_qty = total_child_qty\n                \n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 14:23:08.108114",
  "module": null,
  "name": "Update Sales Order Parent Item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "\n\nif doc.custom_sales_order :\n    \n    so_doc = frappe.get_doc('Sales Order', doc.custom_sales_order)\n    \n    \n    if so_doc.custom_parent_item and doc.custom_parent_item :\n        \n        for x in doc.custom_parent_item :\n            selected_cam_item_qty = 0\n            selected_spl_area_sqm = 0\n            \n            for y in so_doc.custom_parent_item :\n                \n                if x.parent_item == y.parent_item :\n                    \n                    selected_cam_item_qty = (y.selected_cam_item_qty or 0) + x.selected_cam_item_qty\n                    selected_spl_area_sqm = (y.selected_spl_area_sqm or 0) + x.selected_spl_area_sqm\n                    \n                    frappe.db.set_value( y.doctype, y.name, 'selected_cam_item_qty', selected_cam_item_qty )\n                    frappe.db.set_value( y.doctype, y.name, 'selected_spl_area_sqm', selected_spl_area_sqm )\n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 14:23:55.226759",
  "module": null,
  "name": "Update Sales Order Parent Item On Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "\n\nif doc.custom_sales_order :\n    \n    so_doc = frappe.get_doc('Sales Order', doc.custom_sales_order)\n    \n    \n    if so_doc.custom_parent_item and doc.custom_parent_item :\n        \n        for x in doc.custom_parent_item :\n            selected_cam_item_qty = 0\n            selected_spl_area_sqm = 0\n            \n            for y in so_doc.custom_parent_item :\n                \n                if x.parent_item == y.parent_item :\n                    \n                    selected_cam_item_qty = (y.selected_cam_item_qty or 0) - x.selected_cam_item_qty\n                    selected_spl_area_sqm = (y.selected_spl_area_sqm or 0) - x.selected_spl_area_sqm\n                    \n                    frappe.db.set_value( y.doctype, y.name, 'selected_cam_item_qty', selected_cam_item_qty )\n                    frappe.db.set_value( y.doctype, y.name, 'selected_spl_area_sqm', selected_spl_area_sqm )\n            ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-05-28 15:37:43.337066",
  "module": null,
  "name": "Average Consumption For Last 30 Days",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Quotation Comparison",
  "script": "\n\n\nif doc.table_netp:\n\n    from_date = frappe.utils.add_days(frappe.utils.getdate(doc.date), -90)\n    total_qty = 0\n\n    for x in doc.table_netp:\n        st_ledger_entry_list = frappe.get_all('Stock Ledger Entry',\n                                    filters={\n                                        'item_code': x.item_code,\n                                        'company': doc.company,\n                                        'voucher_type': 'Stock Entry',\n                                        'posting_date': ['>', from_date],\n                                        'posting_date': ['<=', doc.date]\n                                    },\n                                    fields=['item_code', 'warehouse', 'voucher_no', 'actual_qty']\n                                )\n            \n        if st_ledger_entry_list :\n            st_ledger_entry_list = [    entry for entry in st_ledger_entry_list\n                                        if frappe.db.get_value('Stock Entry', entry.voucher_no, 'stock_entry_type') == 'Material Issue'\n                                   ]\n                                 \n        \n        if st_ledger_entry_list :\n            frappe.msgprint(str(st_ledger_entry_list))                           \n        \n            for entry in st_ledger_entry_list :\n                total_qty = total_qty + entry.actual_qty\n            if total_qty < 0 :\n                total_qty = total_qty * (-1)\n            frappe.msgprint(str(total_qty))\n                \n        x.average_consumption = total_qty\n                \n            \n            \n\n                \n                ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-01 10:54:32.548252",
  "module": null,
  "name": "testmaaz",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "About Us Settings",
  "script": "frappe.msgprint(\"save\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-01 10:54:15.827305",
  "module": null,
  "name": "estmz2",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "About Us Settings",
  "script": "frappe.msgprint(\"sumit\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-02 10:27:28.636971",
  "module": null,
  "name": "allowance cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Promotion",
  "script": "emp = frappe.get_doc('Employee', doc.employee)\nincrement = float(doc.custom_incremented_amount or 0)\n\nif increment > 0:\n    if doc.custom_increment_applied_on == \"Other Allowance\":\n        emp.custom_other_alllowance = float(emp.custom_other_alllowance or 0) - increment\n\n    elif doc.custom_increment_applied_on == \"Basic\":\n        emp.custom_basic_salary = float(emp.custom_basic_salary or 0) - increment\n\nemp.save()\n\n\n\n\n\n#     filters={custom_other_allowance\n#         'employee': doc.employee,custom_other_allowance\n#         'docstatus': 1,\n#         'name': ['!=', doc.name],\n#     },\n# #    order_by='promotion_date desc',\n# )\n\n# emp_doc = frappe.get_doc(\"Employee\", doc.employee)\n\n# if emp_pr_list:\n#     emp_pr_doc = frappe.get_doc(\"Employee Promotion\", emp_pr_list[0].name)\n\n#     # Restore based on what was last applied\n#     if emp_pr_doc.custom_increment_applied_on == \"Other Allowance\":\n#         emp_doc.custom_other_allowance = (\n#             (emp_doc.custom_other_allowance or 0) - (doc.custom_incremented_amount or 0)\n#             + (emp_pr_doc.custom_incremented_amount or 0)\n#         )\n\n#     elif emp_pr_doc.custom_increment_applied_on == \"Basic\":\n#         emp_doc.custom_basic = (\n#             (emp_doc.custom_basic or 0) - (doc.custom_incremented_amount or 0)\n#             + (emp_pr_doc.custom_incremented_amount or 0)\n#         )\n\n#     # Restore total salary\n#     emp_doc.custom_total_salary = emp_pr_doc.revised_ctc or 0\n\n# else:\n#     # No previous promotion exists  rollback to original\n#     if doc.custom_increment_applied_on == \"Other Allowance\":\n#         emp_doc.custom_other_allowance = (\n#             (emp_doc.custom_other_allowance or 0) - (doc.custom_incremented_amount or 0)\n#         )\n\n#     elif doc.custom_increment_applied_on == \"Basic\":\n#         emp_doc.custom_basic = (\n#             (emp_doc.custom_basic or 0) - (doc.custom_incremented_amount or 0)\n#         )\n\n#     emp_doc.custom_total_salary = doc.current_ctc or 0\n\n# emp_doc.save()\n\n\n\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-12 10:16:11.756220",
  "module": null,
  "name": "Fixed Days Salary",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "if doc.company == \"AL MABANI AL UMUMIYYAH LTD\":\r\n    doc.total_working_days = 30\r\n    doc.payment_days = 30",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-12 13:24:57.468160",
  "module": null,
  "name": "Number of days calculation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "if doc.start_date and doc.end_date:\r\n    try:\r\n        start = frappe.utils.getdate(doc.start_date)\r\n        end = frappe.utils.getdate(doc.end_date)\r\n        total_days = (end - start).days + 1\r\n        doc.custom_days = total_days\r\n    except Exception as e:\r\n        frappe.log_error(f\"Custom Days Script Error: {e}\", \"Salary Slip Script Error\")\r\n        doc.custom_days = 0\r\nelse:\r\n    doc.custom_days = 0",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-04-09 14:35:15.879470",
  "module": null,
  "name": "Send Expiry Notification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Factory Approval",
  "script": "registration_list = frappe.db.get_all('Factory Approval', fields=[\"name\"])\nfor reg in registration_list:\n    try:\n        reg_doc = frappe.get_doc('Factory Approval', reg.name)\n        if not reg_doc.company_registration_details:\n            continue\n            \n        for row in reg_doc.company_registration_details:\n            if not row.expiry_date:\n                continue\n                \n            expiry_date = frappe.utils.getdate(row.expiry_date)\n            today = frappe.utils.getdate()\n            \n            row.status = 'Expired' if expiry_date < today else 'Active'\n            \n            days_remaining = (expiry_date - today).days if expiry_date >= today else 0\n            if days_remaining <= 7:\n                status_color = \"red\" if expiry_date < today else \"orange\"\n                status_text = row.status\n                table_html = f\"\"\"\n                <table border=\"1\" style=\"width:100%;border-collapse: collapse;text-align:center;\">\n                    <thead>\n                        <tr style=\"background-color: #f2f2f2;\">\n                            <th>City</th>\n                            <th>Document Type</th>\n                            <th>Document Name</th>\n                            <th>Authority</th>\n                            <th>Reference #</th>\n                            <th>Issuance Date</th>\n                            <th>Expiry Date</th>\n                            <th>Classification</th>\n                            <th>Status</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <tr>\n                            <td>{row.city or ''}</td>\n                            <td>{row.document_type or ''}</td>\n                            <td>{row.document_name or ''}</td>\n                            <td>{row.authority_name or ''}</td>\n                            <td>{row.document_ref_number or ''}</td>\n                            <td>{frappe.utils.format_date(row.issuance_date) if row.issuance_date else ''}</td>\n                            <td>{frappe.utils.format_date(row.expiry_date)}</td>\n                            <td>{row.classification or ''}</td>\n                            <td style=\"color: {status_color}\">{status_text}</td>\n                        </tr>\n                    </tbody>\n                </table>\n                \"\"\"\n                \n                doc_link = frappe.utils.get_url_to_form(reg_doc.doctype, reg_doc.name)\n                \n                if expiry_date < today:\n                    expiry_status_message = \"This certificate has expired.\"\n                elif expiry_date == today:\n                    expiry_status_message = \"This certificate expires today.\"\n                else:\n                    expiry_status_message = f\"This certificate will expire in {days_remaining} days.\"\n                    \n                message = f\"\"\"\n                    <div style=\"font-family: Arial, sans-serif; line-height: 1.6;\">\n                    <h3>Certificate Expiry Notification</h3>\n                    <p>Dear Sir/Madam,</p>\n                    <p>The following certificates require your attention:</p>\n                    {table_html}\n                    <p>{expiry_status_message}</p>\n                    <p>Please renew and upload updated certificates with new validity dates.</p>\n                    <p>Link to document: <a href=\"{doc_link}\">{reg_doc.name}</a></p>\n                    <p>Regards,<br>System Notifications</p>\n                </div>\n                \"\"\"\n                \n                recipients = set()\n                for role in ['Sales Coordinator', 'Sales Manager', 'HR Manager', 'Accounts Manager']:\n                    users = frappe.get_all(\"Has Role\", \n                                         filters={\"role\": role}, \n                                         fields=[\"parent\"],\n                                         distinct=True)\n                    \n                    for user in users:\n                        email = frappe.db.get_value(\"User\", user.parent, \"email\")\n                        if email:\n                            employee = frappe.db.get_value(\"Employee\", \n                                                         {\"user_id\": email}, \n                                                         [\"company\"], \n                                                         as_dict=True)\n                            if employee and employee.company == reg_doc.company_name:\n                                recipients.add(email)\n                \n                if recipients:\n                    frappe.sendmail(\n                        recipients=list(recipients),\n                        subject=f\"Certificate Expiry Notification - {reg_doc.company_name or reg_doc.name}\",\n                        message=message,\n                        reference_doctype=reg_doc.doctype,\n                        reference_name=reg_doc.name\n                    )\n        \n        reg_doc.save(ignore_permissions=True)\n        \n    except Exception as e:\n        frappe.log_error(f\"Error processing Factory Approval {reg.name}: {str(e)}\")\n        continue",
  "script_type": "Scheduler Event"
 }
]